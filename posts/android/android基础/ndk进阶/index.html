<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>NDK进阶 - 夏洛魂的个人博客</title><meta name="Description" content="个人笔记本"><meta property="og:title" content="NDK进阶" />
<meta property="og:description" content="NDK进阶 NDK与JNI基础 参考链接 https://www.jianshu.com/p/87ce6f565d37 NDK与JNI基础.mhtml 什么是JNI? JNI,全称为Java Native Interface,即Java本地" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-12-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NDK进阶"/>
<meta name="twitter:description" content="NDK进阶 NDK与JNI基础 参考链接 https://www.jianshu.com/p/87ce6f565d37 NDK与JNI基础.mhtml 什么是JNI? JNI,全称为Java Native Interface,即Java本地"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/x64dbg%E4%B9%8Bsearchandreplacemem/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "NDK进阶",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/ndk%E8%BF%9B%E9%98%B6\/"
        },"genre": "posts","keywords": "NDK","wordcount":  8018 ,
        "url": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/ndk%E8%BF%9B%E9%98%B6\/","datePublished": "2021-12-28T00:00:00+00:00","dateModified": "2021-12-28T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "夏洛魂"},"author": {
                "@type": "Person",
                "name": "夏洛魂"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夏洛魂的个人博客">主页</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夏洛魂的个人博客">主页</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于作者</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">NDK进阶</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>夏洛魂</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/android%E5%9F%BA%E7%A1%80/"><i class="far fa-folder fa-fw"></i>Android基础</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-12-28">2021-12-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8018 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ndk进阶">NDK进阶</a>
      <ul>
        <li><a href="#ndk与jni基础">NDK与JNI基础</a>
          <ul>
            <li><a href="#参考链接">参考链接</a></li>
            <li><a href="#什么是jni">什么是JNI?</a></li>
            <li><a href="#jnienv是什么">JNIEnv是什么?</a></li>
            <li><a href="#jnienv与javavm的区别">JNIEnv与JavaVM的区别</a></li>
            <li><a href="#jnienv的作用">JNIEnv的作用</a></li>
          </ul>
        </li>
        <li><a href="#jni接口追踪">JNI接口追踪</a>
          <ul>
            <li><a href="#jnitrace">jnitrace</a></li>
            <li><a href="#hook_artjs">hook_art.js</a></li>
            <li><a href="#frida查看native层调用栈">Frida查看Native层调用栈</a></li>
            <li><a href="#systemload函数追踪">System.load函数追踪</a></li>
          </ul>
        </li>
        <li><a href="#jnihook">JNIHook</a>
          <ul>
            <li><a href="#准备一个apk">准备一个apk</a>
              <ul>
                <li><a href="#java层">Java层</a></li>
                <li><a href="#native层">Native层</a></li>
              </ul>
            </li>
            <li><a href="#替换方式">替换方式</a></li>
            <li><a href="#hook方式">Hook方式</a></li>
          </ul>
        </li>
        <li><a href="#动态注册">动态注册</a>
          <ul>
            <li><a href="#示例代码">示例代码</a>
              <ul>
                <li><a href="#java层-1">Java层</a></li>
                <li><a href="#native层-1">Native层</a></li>
              </ul>
            </li>
            <li><a href="#源码分析">源码分析</a>
              <ul>
                <li><a href="#artmethod结构体">ArtMethod结构体</a></li>
              </ul>
            </li>
            <li><a href="#二次注册">二次注册</a>
              <ul>
                <li><a href="#参考链接-1">参考链接</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#调用jni中的方法">调用JNI中的方法</a>
          <ul>
            <li><a href="#frida">Frida</a>
              <ul>
                <li><a href="#准备一个so文件">准备一个so文件</a>
                  <ul>
                    <li><a href="#java层-2">Java层</a></li>
                    <li><a href="#native层-2">Native层</a></li>
                  </ul>
                </li>
                <li><a href="#开始调用">开始调用</a></li>
              </ul>
            </li>
            <li><a href="#unidbg">unidbg</a>
              <ul>
                <li><a href="#测试">测试</a></li>
                <li><a href="#调用so中的静态方法">调用so中的静态方法</a>
                  <ul>
                    <li><a href="#准备一个so文件-1">准备一个so文件</a>
                      <ul>
                        <li><a href="#java层-3">Java层</a></li>
                        <li><a href="#native层-3">Native层</a></li>
                      </ul>
                    </li>
                    <li><a href="#开始调用-1">开始调用</a></li>
                  </ul>
                </li>
                <li><a href="#调用so中的实例方法-无java方法">调用so中的实例方法-无java方法</a>
                  <ul>
                    <li><a href="#准备一个so文件-2">准备一个so文件</a>
                      <ul>
                        <li><a href="#java层-4">Java层</a></li>
                        <li><a href="#native">Native</a></li>
                      </ul>
                    </li>
                    <li><a href="#开始调用-2">开始调用</a></li>
                  </ul>
                </li>
                <li><a href="#调用so中的实例方法-有java方法">调用so中的实例方法-有Java方法</a>
                  <ul>
                    <li><a href="#准备一个so文件-3">准备一个so文件</a>
                      <ul>
                        <li><a href="#java层-5">Java层</a></li>
                        <li><a href="#native层-4">Native层</a></li>
                      </ul>
                    </li>
                    <li><a href="#开始调用-3">开始调用</a></li>
                  </ul>
                </li>
                <li><a href="#hook初窥">Hook初窥</a>
                  <ul>
                    <li><a href="#准备一个so文件-4">准备一个so文件</a>
                      <ul>
                        <li><a href="#java层-6">Java层</a></li>
                        <li><a href="#native层-5">Native层</a></li>
                      </ul>
                    </li>
                    <li><a href="#开始调用-4">开始调用</a></li>
                  </ul>
                </li>
                <li><a href="#源代码">源代码</a></li>
                <li><a href="#注意">注意</a>
                  <ul>
                    <li><a href="#原因">原因</a></li>
                  </ul>
                </li>
                <li><a href="#参考文档">参考文档</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#反射">反射</a>
          <ul>
            <li><a href="#参考链接-2">参考链接</a></li>
            <li><a href="#从源码中学习">从源码中学习</a></li>
            <li><a href="#示例">示例</a>
              <ul>
                <li><a href="#java层-7">Java层</a></li>
                <li><a href="#native层-6">Native层</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#oncreate函数native化">OnCreate函数Native化</a>
          <ul>
            <li><a href="#java层-8">Java层</a></li>
            <li><a href="#native层-7">Native层</a></li>
            <li><a href="#源代码-1">源代码</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="ndk进阶">NDK进阶</h1>
<h2 id="ndk与jni基础">NDK与JNI基础</h2>
<h3 id="参考链接">参考链接</h3>
<p><a href="https://www.jianshu.com/p/87ce6f565d37" target="_blank" rel="noopener noreffer">https://www.jianshu.com/p/87ce6f565d37</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/NDK%E4%B8%8EJNI%E5%9F%BA%E7%A1%80.mhtml" rel="">NDK与JNI基础.mhtml</a></p>
<h3 id="什么是jni">什么是JNI?</h3>
<p>JNI,全称为Java Native Interface,即Java本地接口,JNI是Java调用Native语言的一种特性.通过JNI可以使得Java与C/C++交互.</p>
<h3 id="jnienv是什么">JNIEnv是什么?</h3>
<p>JNIEnv是一个线程相关的结构体,该结构体代表了Java在本线程的执行环境.</p>
<h3 id="jnienv与javavm的区别">JNIEnv与JavaVM的区别</h3>
<p><strong>JavaVM</strong>: 是Java虚拟机在JNI层的代表,JNI全局仅仅只有一个.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">vm</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">reserved</span><span class="p">);</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="nf">JNI_OnUnload</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">vm</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">reserved</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>JNIEnv</strong>: JavaVM在线程中的代码,每个线程都有一个,JNI可能有非常多个JNIEnv.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_myapplication_MainActivity_stringFromJNI</span><span class="p">(</span>
        <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
        <span class="n">jobject</span> <span class="cm">/* this */</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">&#34;Hello from C++&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="jnienv的作用">JNIEnv的作用</h3>
<p><strong>调用Java函数</strong>: JNIEnv代表了Java执行环境,能够使用JNIEnv调用Java中的代码.</p>
<p><strong>操作Java函数</strong>: Java对象传入JNI层就是jobject对象,需要使用JNIEnv来操作这个Java对象.</p>
<h2 id="jni接口追踪">JNI接口追踪</h2>
<h3 id="jnitrace">jnitrace</h3>
<p><a href="https://github.com/chame1eon/jnitrace" target="_blank" rel="noopener noreffer">https://github.com/chame1eon/jnitrace</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">#安装</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">jnitrace</span>

<span class="c1">#使用</span>
<span class="n">jnitrace</span> <span class="o">-</span><span class="n">l</span> <span class="n">libnative</span><span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">so</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">myapplication</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="hook_artjs">hook_art.js</h3>
<p><a href="https://github.com/lasting-yang/frida_hook_libart" target="_blank" rel="noopener noreffer">https://github.com/lasting-yang/frida_hook_libart</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">#使用</span>
<span class="n">frida</span> <span class="o">-</span><span class="n">U</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">pause</span> <span class="o">-</span><span class="n">f</span> <span class="n">package_name</span> <span class="o">-</span><span class="n">l</span> <span class="n">hook_art</span><span class="o">.</span><span class="n">js</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="frida查看native层调用栈">Frida查看Native层调用栈</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1">#不是很准确</span>
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;CCCryptorCreate called from:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
        <span class="n">Thread</span><span class="o">.</span><span class="n">backtrace</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">Backtracer</span><span class="o">.</span><span class="n">ACCURATE</span><span class="p">)</span>
        <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">DebugSymbol</span><span class="o">.</span><span class="n">fromAddress</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="systemload函数追踪">System.load函数追踪</h3>
<p>Java层通过以下代码进行so的加载.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="o">{</span>
   <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luomd5&#34;</span><span class="o">);</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loadLibrary</span><span class="o">(</span><span class="n">String</span> <span class="n">libname</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">loadLibrary0</span><span class="o">(</span><span class="n">Reflection</span><span class="o">.</span><span class="na">getCallerClass</span><span class="o">(),</span> <span class="n">libname</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来查看Android源码,跟踪Runtime类的loadLibrary0函数.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//源码跟踪
</span><span class="c1">//http://aospxref.com/android-8.1.0_r81/xref/libcore/ojluni/src/main/java/java/lang/Runtime.java
</span><span class="c1"></span>
<span class="n">loadLibrary0</span><span class="o">(</span><span class="n">String</span> <span class="n">libname</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span>
<span class="o">-&gt;</span><span class="n">doLoad</span>
<span class="o">-&gt;</span><span class="n">nativeLoad</span>
<span class="o">-&gt;</span><span class="n">JVM_NativeLoad</span>
<span class="o">-&gt;</span><span class="n">LoadNativeLibrary</span>
<span class="o">-&gt;</span><span class="n">OpenNativeLibrary</span>

<span class="c1">//http://aospxref.com/android-8.1.0_r81/xref/system/core/libnativeloader/native_loader.cpp?r=&amp;mo=19529&amp;fi=523#523
</span><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="n">OpenNativeLibrary</span><span class="o">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="o">,</span>
                        <span class="n">int32_t</span> <span class="n">target_sdk_version</span><span class="o">,</span>
                        <span class="kd">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="o">,</span>
                        <span class="n">jobject</span> <span class="n">class_loader</span><span class="o">,</span>
                        <span class="n">jstring</span> <span class="n">library_path</span><span class="o">,</span>
                        <span class="n">bool</span> <span class="o">*</span><span class="n">needs_native_bridge</span><span class="o">,</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="n">error_msg</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">class_loader</span> <span class="o">==</span> <span class="n">nullptr</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="o">*</span><span class="n">needs_native_bridge</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">dlopen</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">RTLD_NOW</span><span class="o">);</span>

        <span class="c1">//---
</span><span class="c1"></span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">android_dlopen_ext</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">RTLD_NOW</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">extinfo</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">nullptr</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">dlerror</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过以上代码,我们可以知道Android系统有两种方式可以加载so文件.</p>
<ul>
<li>dlopen</li>
<li>android_dlopen_ext</li>
</ul>
<p>所以说,我们可以通过以下代码Hook上述两个函数,来查看我们想要的so是通过哪种方式加载的,进而执行下一步操作.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">hook_dlopen</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;dlopen&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dlopen:&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;android_dlopen_ext&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;android_dlopen_ext:&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>

            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">setImmediate</span><span class="p">(</span><span class="nx">hook_dlopen</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">frida -U -f com.example.luomd5 -l .\LuoHook.js --no-pause
</code></pre></td></tr></table>
</div>
</div><h2 id="jnihook">JNIHook</h2>
<h3 id="准备一个apk">准备一个apk</h3>
<h4 id="java层">Java层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//Java层
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">com.example.luomd5</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luomd5.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luomd5&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luomd5&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">mdString</span><span class="o">(</span><span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="native层">Native层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luomd5_MainActivity_mdString</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="k">return</span>  <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="替换方式">替换方式</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">hook_dlopen</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;dlopen&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="c1">//console.log(&#34;dlopen:&#34;, path);
</span><span class="c1"></span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;android_dlopen_ext&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="c1">//console.log(&#34;android_dlopen_ext:&#34;, path);
</span><span class="c1"></span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;libluomd5.so&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;found [android_dlopen_ext:]&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//找到要Hook函数的地址
</span><span class="c1"></span>                <span class="kd">var</span> <span class="nx">mdString_addr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s2">&#34;libluomd5.so&#34;</span><span class="p">,</span> <span class="s2">&#34;Java_com_example_luomd5_MainActivity_mdString&#34;</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;mdString_addr: &#34;</span><span class="p">,</span> <span class="nx">mdString_addr</span><span class="p">)</span>

                <span class="kd">var</span> <span class="nx">md5string</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">mdString_addr</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">]);</span>
                <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">mdString_addr</span><span class="p">,</span> <span class="k">new</span> <span class="nx">NativeCallback</span><span class="p">((</span><span class="nx">env</span><span class="p">,</span> <span class="nx">jclass</span><span class="p">,</span> <span class="nx">jstring</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                    <span class="c1">//打印原参数
</span><span class="c1"></span>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">tryGetEnv</span><span class="p">().</span><span class="nx">getStringUtfChars</span><span class="p">(</span><span class="nx">jstring</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">readCString</span><span class="p">())</span>
                    <span class="c1">//构造新参数
</span><span class="c1"></span>                    <span class="kd">var</span> <span class="nx">newJSTRING</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">tryGetEnv</span><span class="p">().</span><span class="nx">newStringUtf</span><span class="p">(</span><span class="s1">&#39;XiaLuoHun 1234&#39;</span><span class="p">);</span>
                    <span class="c1">//调用
</span><span class="c1"></span>                    <span class="kd">var</span> <span class="nx">retval</span> <span class="o">=</span> <span class="nx">md5string</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span> <span class="nx">jclass</span><span class="p">,</span> <span class="nx">newJSTRING</span><span class="p">);</span>
                    <span class="c1">//打印返回值
</span><span class="c1"></span>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;retval: &#34;</span><span class="p">,</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">tryGetEnv</span><span class="p">().</span><span class="nx">getStringUtfChars</span><span class="p">(</span><span class="nx">retval</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">readCString</span><span class="p">());</span>
                    <span class="k">return</span> <span class="nx">retval</span>

                <span class="p">},</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">]))</span>

            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">setImmediate</span><span class="p">(</span><span class="nx">hook_dlopen</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="hook方式">Hook方式</h3>
<p>也可以通过下述代码进行Hook,查看Native层函数的参数和返回值.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">hook_dlopen</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;dlopen&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="c1">//console.log(&#34;dlopen:&#34;, path);
</span><span class="c1"></span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&#34;android_dlopen_ext&#34;</span><span class="p">),</span> <span class="p">{</span>
        <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pathptr</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pathptr</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">pathptr</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pathptr</span><span class="p">).</span><span class="nx">readCString</span><span class="p">();</span>
                <span class="c1">//console.log(&#34;android_dlopen_ext:&#34;, path);
</span><span class="c1"></span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&#34;libluomd5.so&#34;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;found [android_dlopen_ext:]&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">mdString_addr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s2">&#34;libluomd5.so&#34;</span><span class="p">,</span> <span class="s2">&#34;Java_com_example_luomd5_MainActivity_mdString&#34;</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;mdString_addr: &#34;</span><span class="p">,</span> <span class="nx">mdString_addr</span><span class="p">)</span>
                <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">mdString_addr</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">onEnter</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">getEnv</span><span class="p">();</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;arg2 jstring: &#34;</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">getStringUtfChars</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">NULL</span><span class="p">).</span><span class="nx">readCString</span><span class="p">())</span>

                    <span class="p">},</span>
                    <span class="nx">onLeave</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">getEnv</span><span class="p">();</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;retval jstring: &#34;</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">getStringUtfChars</span><span class="p">(</span><span class="nx">retval</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">).</span><span class="nx">readCString</span><span class="p">())</span>
                    <span class="p">}</span>
                <span class="p">})</span>

            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">setImmediate</span><span class="p">(</span><span class="nx">hook_dlopen</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="动态注册">动态注册</h2>
<p>动态注册的JNI函数在native层实现的函数名称不定,并且不一定要求相应函数是导出类型,比静态注册更安全.</p>
<p>通过以下函数即可完成动态注册.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="n">jint</span> <span class="n">RegisterNatives</span><span class="p">(</span><span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="k">const</span> <span class="n">JNINativeMethod</span><span class="o">*</span> <span class="n">methods</span><span class="p">,</span><span class="n">jint</span> <span class="n">nMethods</span><span class="p">)</span>
<span class="c1">//第一个参数clazz, native函数所在的类,可通过FindClass这个JNI函数获取(将类名的&#34;.&#34;符号换成&#34;/&#34;)
</span><span class="c1">//第二个参数methods, 是一个数组,其中包含函数的一些签名信息以及对应在native层的函数指针
</span><span class="c1">//第三个参数nMethods, 是methods数组的数量
</span></code></pre></td></tr></table>
</div>
</div><h3 id="示例代码">示例代码</h3>
<h4 id="java层-1">Java层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luomd5</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luomd5.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luomd5&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luomd5&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">mdString</span><span class="o">(</span><span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="native层-1">Native层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define NELEM(x) ((int) (sizeof(x) / sizeof((x)[0])))
</span><span class="cp"></span>
<span class="n">jstring</span> <span class="nf">LuoNativeFunc</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">method_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="s">&#34;mdString&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">LuoNativeFunc</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">registerMethods</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">className</span><span class="p">,</span>
                           <span class="n">JNINativeMethod</span> <span class="o">*</span><span class="n">gMethods</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numMethods</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">RegisterNatives</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">gMethods</span><span class="p">,</span> <span class="n">numMethods</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_FALSE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">JNI_TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span> <span class="o">*</span><span class="n">vm</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">JNI_VERSION_1_6</span><span class="p">)</span> <span class="o">!=</span> <span class="n">JNI_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 注册native方法
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registerMethods</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&#34;com/example/luomd5/MainActivity&#34;</span><span class="p">,</span> <span class="n">method_table</span><span class="p">,</span>
                         <span class="n">NELEM</span><span class="p">(</span><span class="n">method_table</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/LuoMd5_%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C.7z" rel="">LuoMd5_动态注册.7z</a></p>
<h3 id="源码分析">源码分析</h3>
<p>动态注册的主要函数是RegisterNatives,下面从Android源码中分析该函数流程.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://aospxref.com/android-8.1.0_r81/xref/art/runtime/jni_internal.cc#2241
</span><span class="c1"></span><span class="n">RegisterNatives</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span><span class="n">jclass</span> <span class="n">java_class</span><span class="p">,</span><span class="k">const</span> <span class="n">JNINativeMethod</span><span class="o">*</span> <span class="n">methods</span><span class="p">,</span><span class="n">jint</span> <span class="n">method_count</span><span class="p">){</span>
	<span class="c1">//---
</span><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">jint</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">method_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
      <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sig</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">signature</span><span class="p">;</span>
      <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">fnPtr</span> <span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fnPtr</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ReportInvalidJNINativeMethod</span><span class="p">(</span><span class="n">soa</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="s">&#34;method name&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ReportInvalidJNINativeMethod</span><span class="p">(</span><span class="n">soa</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="s">&#34;method signature&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="n">fnPtr</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ReportInvalidJNINativeMethod</span><span class="p">(</span><span class="n">soa</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">Get</span><span class="p">(),</span> <span class="s">&#34;native function&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">JNI_ERR</span><span class="p">;</span>
    <span class="p">}</span>
	<span class="c1">//---
</span><span class="c1"></span>	<span class="n">ArtMethod</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>  
	<span class="n">m</span> <span class="o">=</span> <span class="n">FindMethod</span><span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="n">current_class</span><span class="p">.</span><span class="n">Ptr</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
	<span class="c1">//---
</span><span class="c1"></span>	<span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">final_function_ptr</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">RegisterNative</span><span class="p">(</span><span class="n">fnPtr</span><span class="p">,</span> <span class="n">is_fast</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">-&gt;</span> <span class="n">RegisterNative</span><span class="p">(</span><span class="n">fnPtr</span><span class="p">,</span> <span class="n">is_fast</span><span class="p">);</span>
<span class="o">-&gt;</span> <span class="n">SetEntryPointFromJni</span><span class="p">(</span><span class="n">new_native_method</span><span class="p">);</span>
<span class="o">-&gt;</span> <span class="n">SetEntryPointFromJniPtrSize</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">kRuntimePointerSize</span><span class="p">);</span>
<span class="o">-&gt;</span> <span class="n">SetDataPtrSize</span><span class="p">(</span><span class="n">entrypoint</span><span class="p">,</span> <span class="n">pointer_size</span><span class="p">);</span>
<span class="o">-&gt;</span> <span class="n">SetNativePointer</span><span class="p">(</span><span class="n">DataOffset</span><span class="p">(</span><span class="n">pointer_size</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">pointer_size</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>SetNativePointer里面的代码,意思就是将上述找到的Native函数指针fnPtr赋值给下方ArtMethod类中的<strong>ptr_sized_fields_</strong> 结构体中的**data_**字段.</p>
<h4 id="artmethod结构体">ArtMethod结构体</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://aospxref.com/android-8.1.0_r81/xref/art/runtime/art_method.h
</span><span class="c1"></span><span class="k">class</span> <span class="nc">ArtMethod</span><span class="p">{</span>
 <span class="k">protected</span><span class="o">:</span>
  <span class="c1">// Field order required by test &#34;ValidateFieldOrderOfJavaCppUnionClasses&#34;.
</span><span class="c1"></span>  <span class="c1">// The class we are a part of.
</span><span class="c1"></span>  <span class="n">GcRoot</span><span class="o">&lt;</span><span class="n">mirror</span><span class="o">::</span><span class="n">Class</span><span class="o">&gt;</span> <span class="n">declaring_class_</span><span class="p">;</span>

  <span class="c1">// Access flags; low 16 bits are defined by spec.
</span><span class="c1"></span>  <span class="c1">// Getting and setting this flag needs to be atomic when concurrency is
</span><span class="c1"></span>  <span class="c1">// possible, e.g. after this method&#39;s class is linked. Such as when setting
</span><span class="c1"></span>  <span class="c1">// verifier flags and single-implementation flag.
</span><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">access_flags_</span><span class="p">;</span>

  <span class="cm">/* Dex file fields. The defining dex file is available via declaring_class_-&gt;dex_cache_ */</span>

  <span class="c1">// Offset to the CodeItem.
</span><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">dex_code_item_offset_</span><span class="p">;</span>

  <span class="c1">// Index into method_ids of the dex file associated with this method.
</span><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">dex_method_index_</span><span class="p">;</span>

  <span class="cm">/* End of dex file fields. */</span>

  <span class="c1">// Entry within a dispatch table for this method. For static/direct methods the index is into
</span><span class="c1"></span>  <span class="c1">// the declaringClass.directMethods, for virtual methods the vtable and for interface methods the
</span><span class="c1"></span>  <span class="c1">// ifTable.
</span><span class="c1"></span>  <span class="kt">uint16_t</span> <span class="n">method_index_</span><span class="p">;</span>

  <span class="c1">// The hotness we measure for this method. Managed by the interpreter. Not atomic, as we allow
</span><span class="c1"></span>  <span class="c1">// missing increments: if the method is hot, we will see it eventually.
</span><span class="c1"></span>  <span class="kt">uint16_t</span> <span class="n">hotness_count_</span><span class="p">;</span>

  <span class="c1">// Fake padding field gets inserted here.
</span><span class="c1"></span>
  <span class="c1">// Must be the last fields in the method.
</span><span class="c1"></span>  <span class="k">struct</span> <span class="nc">PtrSizedFields</span> <span class="p">{</span>
    <span class="c1">// Short cuts to declaring_class_-&gt;dex_cache_ member for fast compiled code access.
</span><span class="c1"></span>    <span class="n">mirror</span><span class="o">::</span><span class="n">MethodDexCacheType</span><span class="o">*</span> <span class="n">dex_cache_resolved_methods_</span><span class="p">;</span>

    <span class="c1">// Pointer to JNI function registered to this method, or a function to resolve the JNI function,
</span><span class="c1"></span>    <span class="c1">// or the profiling data for non-native methods, or an ImtConflictTable, or the
</span><span class="c1"></span>    <span class="c1">// single-implementation of an abstract/interface method.
</span><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">data_</span><span class="p">;</span>

    <span class="c1">// Method dispatch from quick compiled code invokes this pointer which may cause bridging into
</span><span class="c1"></span>    <span class="c1">// the interpreter.
</span><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">entry_point_from_quick_compiled_code_</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">ptr_sized_fields_</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="二次注册">二次注册</h3>
<p><strong>Native层Hook思路</strong>:通过调用RegisterNatives方法注册函数,那我们可以再次调用RegisterNatives方法进行注册,覆盖掉先前注册的函数,从而实现Hook.</p>
<h4 id="参考链接-1">参考链接</h4>
<p><a href="https://sanfengandroid.github.io/2021/02/28/simple-java-native-hook/" target="_blank" rel="noopener noreffer">https://sanfengandroid.github.io/2021/02/28/simple-java-native-hook/</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/%E4%B8%80%E7%A7%8D%E9%80%9A%E7%94%A8%E8%B6%85%E7%AE%80%E5%8D%95%E7%9A%84Android_Java_Native%E6%96%B9%E6%B3%95Hook.mhtml" rel="">一种通用超简单的Android_Java_Native方法Hook.mhtml</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/fake-linker-main.zip" rel="">fake-linker-main.zip</a></p>
<h2 id="调用jni中的方法">调用JNI中的方法</h2>
<h3 id="frida">Frida</h3>
<h4 id="准备一个so文件">准备一个so文件</h4>
<h5 id="java层-2">Java层</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">stringFromJNI</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">stringFromJNI</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">LuoAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">n1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="native层-2">Native层</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_stringFromJNI</span><span class="p">(</span>
        <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
        <span class="n">jobject</span> <span class="cm">/* this */</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">&#34;Hello from C++&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_LuoAdd</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">jint</span> <span class="n">n1</span><span class="p">,</span> <span class="n">jint</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_mdString</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="开始调用">开始调用</h4>
<p>下述代码,用来示例抽取原Apk的so库,用Frida直接来调用其中的方法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
    <span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">module_luomd5</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s2">&#34;/data/app/libluodst.so&#34;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">mdString_address</span> <span class="o">=</span> <span class="nx">module_luomd5</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s2">&#34;Java_com_example_luodst_MainActivity_mdString&#34;</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;mdString_address: &#34;</span><span class="p">,</span> <span class="nx">mdString_address</span><span class="p">)</span>
    
        <span class="kd">var</span> <span class="nx">mdString</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">mdString_address</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">,</span> <span class="s2">&#34;pointer&#34;</span><span class="p">]);</span>
        <span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">getEnv</span><span class="p">();</span>

        <span class="c1">//mdString是个静态Native函数
</span><span class="c1"></span>        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">mdString</span><span class="p">(</span><span class="nx">env</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">newStringUtf</span><span class="p">(</span><span class="s2">&#34;Hello XiaLuoHun!&#34;</span><span class="p">))</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;result: &#34;</span><span class="p">,</span> <span class="nx">env</span><span class="p">.</span><span class="nx">getStringUtfChars</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">).</span><span class="nx">readCString</span><span class="p">())</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nx">setImmediate</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">frida -U com.android.settings -l .\LuoHook.js
</code></pre></td></tr></table>
</div>
</div><h3 id="unidbg">unidbg</h3>
<p>unidbg是一个基于unicorn的逆向工具,可以直接调用Android和iOS中的so文件.</p>
<p><a href="https://github.com/zhkl0228/unidbg" target="_blank" rel="noopener noreffer">https://github.com/zhkl0228/unidbg</a></p>
<h4 id="测试">测试</h4>
<p>将Unidbg整个项目下载下来,用IDEA打开,运行其中一个测试项目,若能正常输出,则配置正确.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Unidbg%e6%b5%8b%e8%af%95.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/Unidbg%E6%B5%8B%E8%AF%95.png, images/Unidbg%e6%b5%8b%e8%af%95.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/Unidbg%E6%B5%8B%E8%AF%95.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/Unidbg%E6%B5%8B%E8%AF%95.png"
        title="Unidbg测试" /></p>
<h4 id="调用so中的静态方法">调用so中的静态方法</h4>
<h5 id="准备一个so文件-1">准备一个so文件</h5>
<h6 id="java层-3">Java层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>

        <span class="n">String</span> <span class="n">strSample</span> <span class="o">=</span> <span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;mdString: &#34;</span> <span class="o">+</span> <span class="n">mdString</span><span class="o">(</span><span class="n">strSample</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="native层-3">Native层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_mdString</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="开始调用-1">开始调用</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e9%9d%99%e6%80%81%e6%96%b9%e6%b3%95.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95.png, images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e9%9d%99%e6%80%81%e6%96%b9%e6%b3%95.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95.png"
        title="调用so中的静态方法" /></p>
<p>将上述so文件放到资源目录下,新建一个类开始写代码.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.unidbg.AndroidEmulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.LibraryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.arm.backend.DynarmicFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidEmulatorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.memory.Memory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AbstractJni</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">MainActivity</span> <span class="n">mainActivity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;load offset=&#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
        <span class="n">mainActivity</span><span class="o">.</span><span class="na">crack</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AndroidEmulator</span> <span class="n">emulator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">VM</span> <span class="n">vm</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DvmClass</span> <span class="n">dvmClass</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MainActivity</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1.创建Android模拟器实例
</span><span class="c1"></span>        <span class="n">emulator</span> <span class="o">=</span> <span class="n">AndroidEmulatorBuilder</span>
                <span class="o">.</span><span class="na">for32Bit</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addBackendFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">DynarmicFactory</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="c1">//2.获取操作内存的接口
</span><span class="c1"></span>        <span class="n">Memory</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">getMemory</span><span class="o">();</span>
        <span class="c1">//3.设置Android SDK 版本
</span><span class="c1"></span>        <span class="n">LibraryResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AndroidResolver</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
        <span class="n">memory</span><span class="o">.</span><span class="na">setLibraryResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
        <span class="c1">//4.创建虚拟机
</span><span class="c1"></span>        <span class="n">vm</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">createDalvikVM</span><span class="o">();</span>
        <span class="c1">//5.是否打印日志
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setVerbose</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">//6.设置jni
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setJni</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//7.加载目标so文件
</span><span class="c1"></span>        <span class="n">DalvikModule</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libluodst.so&#34;</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//8.调用JNI_OnLoad
</span><span class="c1"></span>        <span class="n">dm</span><span class="o">.</span><span class="na">callJNI_OnLoad</span><span class="o">(</span><span class="n">emulator</span><span class="o">);</span>
        <span class="c1">//9.配置Native方法类名
</span><span class="c1"></span>        <span class="n">dvmClass</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="s">&#34;com/example/luodst/MainActivity&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">crack</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//10.执行JNI方法
</span><span class="c1"></span>
        <span class="c1">//示例
</span><span class="c1"></span>        <span class="n">DvmObject</span> <span class="n">result1</span> <span class="o">=</span> <span class="n">dvmClass</span><span class="o">.</span><span class="na">callStaticJniMethodObject</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="s">&#34;mdString(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="o">,</span> <span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result1 =&gt; &#34;</span> <span class="o">+</span> <span class="n">result1</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="调用so中的实例方法-无java方法">调用so中的实例方法-无java方法</h4>
<p><strong>so中的Native层无Java方法调用</strong>.</p>
<h5 id="准备一个so文件-2">准备一个so文件</h5>
<h6 id="java层-4">Java层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>

        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;LuoAdd: &#34;</span> <span class="o">+</span> <span class="n">LuoAdd</span><span class="o">(</span><span class="n">10</span><span class="o">,</span> <span class="n">20</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">LuoAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">n1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">n2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="native">Native</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_LuoAdd</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">jint</span> <span class="n">n1</span><span class="p">,</span> <span class="n">jint</span> <span class="n">n2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="开始调用-2">开始调用</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%951.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%951.png, images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%951.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%951.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%951.png"
        title="调用so中的实例方法1" /></p>
<p>将上述so文件放到资源目录下,新建一个类开始写代码.</p>
<p><strong>这里需要注意的是</strong>:在Unidbg中新建的测试类,要和so中的Native所在的类要一致.</p>
<p>当so中的实例方法没有调用Java方法时,在Unidbg中也可以用静态方法的调用方式来模拟调用.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.unidbg.AndroidEmulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.LibraryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.arm.backend.DynarmicFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidEmulatorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.memory.Memory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AbstractJni</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">MainActivity</span> <span class="n">mainActivity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;load offset=&#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
        <span class="n">mainActivity</span><span class="o">.</span><span class="na">crack</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AndroidEmulator</span> <span class="n">emulator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">VM</span> <span class="n">vm</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DvmClass</span> <span class="n">dvmClass</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MainActivity</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1.创建Android模拟器实例
</span><span class="c1"></span>        <span class="n">emulator</span> <span class="o">=</span> <span class="n">AndroidEmulatorBuilder</span>
                <span class="o">.</span><span class="na">for32Bit</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addBackendFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">DynarmicFactory</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="c1">//2.获取操作内存的接口
</span><span class="c1"></span>        <span class="n">Memory</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">getMemory</span><span class="o">();</span>
        <span class="c1">//3.设置Android SDK 版本
</span><span class="c1"></span>        <span class="n">LibraryResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AndroidResolver</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
        <span class="n">memory</span><span class="o">.</span><span class="na">setLibraryResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
        <span class="c1">//4.创建虚拟机
</span><span class="c1"></span>        <span class="n">vm</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">createDalvikVM</span><span class="o">();</span>
        <span class="c1">//5.是否打印日志
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setVerbose</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">//6.设置jni
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setJni</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//7.加载目标so文件
</span><span class="c1"></span>        <span class="n">DalvikModule</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libluodst.so&#34;</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//8.调用JNI_OnLoad
</span><span class="c1"></span>        <span class="n">dm</span><span class="o">.</span><span class="na">callJNI_OnLoad</span><span class="o">(</span><span class="n">emulator</span><span class="o">);</span>
        <span class="c1">//9.配置Native方法类名
</span><span class="c1"></span>        <span class="n">dvmClass</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="s">&#34;com/example/luodst/MainActivity&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">crack</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//10.执行JNI方法
</span><span class="c1"></span>
        <span class="c1">//示例
</span><span class="c1"></span>        <span class="n">DvmObject</span><span class="o">&lt;?&gt;</span> <span class="n">obj1</span> <span class="o">=</span> <span class="n">ProxyDvmObject</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">vm</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="na">callJniMethodInt</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="s">&#34;LuoAdd(II)I&#34;</span><span class="o">,</span> <span class="n">10</span><span class="o">,</span> <span class="n">20</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result =&gt; &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="调用so中的实例方法-有java方法">调用so中的实例方法-有Java方法</h4>
<p><strong>so中的Native层有Java方法调用</strong>.</p>
<h5 id="准备一个so文件-3">准备一个so文件</h5>
<h6 id="java层-5">Java层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>

        <span class="n">String</span> <span class="n">strSample</span> <span class="o">=</span> <span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&#34;Refmd5: &#34;</span> <span class="o">+</span> <span class="n">Refmd5</span><span class="o">(</span><span class="n">strSample</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">Javamd5</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">string</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">MessageDigest</span> <span class="n">md5</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">md5</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;MD5&#34;</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="na">digest</span><span class="o">(</span><span class="n">string</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">0xff</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="s">&#34;0&#34;</span> <span class="o">+</span> <span class="n">temp</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">temp</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">Refmd5</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="native层-4">Native层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_Refmd5</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;com/example/luodst/MainActivity&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">Javamd5</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;Javamd5&#34;</span><span class="p">,</span>
                                         <span class="s">&#34;(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="p">);</span>
    <span class="n">jstring</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="p">(</span><span class="n">jstring</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">Javamd5</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">strMd5</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="开始调用-3">开始调用</h5>
<p>上述样例so中的Native方法调用了apk中的Java方法,直接在Unidbg中模拟调用是不行的,会报以下错误.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%952.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952.png, images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%952.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952.png"
        title="调用so中的实例方法2" /></p>
<p>需要在Unidbg的<strong>AbstractJni.java</strong>文件中补Java方法.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%952_1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952_1.png, images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%952_1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952_1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%952_1.png"
        title="调用so中的实例方法2_1" /></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/AbstractJni_%E8%A1%A5Java%E6%96%B9%E6%B3%95.java" rel="">AbstractJni_补Java方法.java</a></p>
<p><strong>这里需要注意的是</strong>:在Unidbg中新建的测试类,要和so中的Native所在的类要一致.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.unidbg.AndroidEmulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.LibraryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.arm.backend.DynarmicFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidEmulatorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.memory.Memory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AbstractJni</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">MainActivity</span> <span class="n">mainActivity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;load offset=&#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
        <span class="n">mainActivity</span><span class="o">.</span><span class="na">crack</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AndroidEmulator</span> <span class="n">emulator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">VM</span> <span class="n">vm</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DvmClass</span> <span class="n">dvmClass</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MainActivity</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1.创建Android模拟器实例
</span><span class="c1"></span>        <span class="n">emulator</span> <span class="o">=</span> <span class="n">AndroidEmulatorBuilder</span>
                <span class="o">.</span><span class="na">for32Bit</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addBackendFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">DynarmicFactory</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="c1">//2.获取操作内存的接口
</span><span class="c1"></span>        <span class="n">Memory</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">getMemory</span><span class="o">();</span>
        <span class="c1">//3.设置Android SDK 版本
</span><span class="c1"></span>        <span class="n">LibraryResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AndroidResolver</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
        <span class="n">memory</span><span class="o">.</span><span class="na">setLibraryResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
        <span class="c1">//4.创建虚拟机
</span><span class="c1"></span>        <span class="n">vm</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">createDalvikVM</span><span class="o">();</span>
        <span class="c1">//5.是否打印日志
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setVerbose</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">//6.设置jni
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setJni</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//7.加载目标so文件
</span><span class="c1"></span>        <span class="n">DalvikModule</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libluodst.so&#34;</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//8.调用JNI_OnLoad
</span><span class="c1"></span>        <span class="n">dm</span><span class="o">.</span><span class="na">callJNI_OnLoad</span><span class="o">(</span><span class="n">emulator</span><span class="o">);</span>
        <span class="c1">//9.配置Native方法类名
</span><span class="c1"></span>        <span class="n">dvmClass</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="s">&#34;com/example/luodst/MainActivity&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">crack</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//10.执行JNI方法
</span><span class="c1"></span>
        <span class="c1">//示例
</span><span class="c1"></span>        <span class="n">DvmObject</span><span class="o">&lt;?&gt;</span> <span class="n">obj2</span> <span class="o">=</span> <span class="n">ProxyDvmObject</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">vm</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">DvmObject</span> <span class="n">result3</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="na">callJniMethodObject</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="s">&#34;Refmd5(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="o">,</span> <span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result3 =&gt; &#34;</span> <span class="o">+</span> <span class="n">result3</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="hook初窥">Hook初窥</h4>
<h5 id="准备一个so文件-4">准备一个so文件</h5>
<h6 id="java层-6">Java层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>

        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>
        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">mdString</span><span class="o">(</span><span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="native层-5">Native层</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="cp">#include</span><span class="cpf">&lt;android/log.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;bitset&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define TAG &#34;[LuoHun]: &#34; </span><span class="c1">// 这个是自定义的LOG的标识
</span><span class="c1"></span><span class="cp">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG ,__VA_ARGS__) </span><span class="c1">// 定义LOGD类型
</span><span class="c1"></span><span class="cp">#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,TAG ,__VA_ARGS__) </span><span class="c1">// 定义LOGI类型
</span><span class="c1"></span><span class="cp">#define LOGW(...) __android_log_print(ANDROID_LOG_WARN,TAG ,__VA_ARGS__) </span><span class="c1">// 定义LOGW类型
</span><span class="c1"></span><span class="cp">#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR,TAG ,__VA_ARGS__) </span><span class="c1">// 定义LOGE类型
</span><span class="c1"></span><span class="cp">#define LOGF(...) __android_log_print(ANDROID_LOG_FATAL,TAG ,__VA_ARGS__) </span><span class="c1">// 定义LOGF类型
</span><span class="c1"></span>
<span class="kt">bool</span> <span class="nf">function_check_tracerPID</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">;</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_name</span> <span class="o">=</span> <span class="s">&#34;/proc/pid/status&#34;</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="n">file_name</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">file_name</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;pid&#34;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">pid</span><span class="p">));</span>
    <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;replace file name =&gt; %s&#34;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">myfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">in</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myfile</span><span class="p">.</span><span class="n">is_open</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">getline</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">size_t</span> <span class="n">TracerPid_pos</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;TracerPid&#34;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">TracerPid_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;file line =&gt; %s&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">c_str</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;trace pid =&gt; %s, i want to exit.&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nb">true</span> <span class="p">;</span>
<span class="c1">//                    kill(pid, 9);
</span><span class="c1"></span>                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">myfile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">b</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">system_getproperty_check</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">man</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">mod</span><span class="p">[</span><span class="mi">156</span><span class="p">];</span>
    <span class="cm">/* A length 0 value indicates that the property is not defined */</span>
    <span class="kt">int</span> <span class="n">lman</span> <span class="o">=</span> <span class="n">__system_property_get</span><span class="p">(</span><span class="s">&#34;ro.product.manufacturer&#34;</span><span class="p">,</span> <span class="n">man</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">lmod</span> <span class="o">=</span> <span class="n">__system_property_get</span><span class="p">(</span><span class="s">&#34;ro.product.model&#34;</span><span class="p">,</span> <span class="n">mod</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">lman</span> <span class="o">+</span> <span class="n">lmod</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pname</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#34;%s/%s&#34;</span><span class="p">,</span> <span class="n">lman</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">man</span> <span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">lmod</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">mod</span> <span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span><span class="s">&#34;Nexus&#34;</span><span class="p">)</span>  <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span><span class="s">&#34;OnePlus&#34;</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">b</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="n">LOGE</span><span class="p">(</span><span class="s">&#34;[LuoHun device]: [%s] result is =&gt; %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pname</span> <span class="o">?</span> <span class="nl">pname</span> <span class="p">:</span> <span class="s">&#34;N/A&#34;</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_mdString</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="n">jclass</span> <span class="n">buildClazz</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;android/os/Build&#34;</span><span class="p">);</span>
    <span class="n">jfieldID</span> <span class="n">FINGERPRINT</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticFieldID</span><span class="p">(</span><span class="n">buildClazz</span><span class="p">,</span><span class="s">&#34;FINGERPRINT&#34;</span><span class="p">,</span><span class="s">&#34;Ljava/lang/String;&#34;</span><span class="p">);</span>
    <span class="n">jstring</span> <span class="n">fingerprint</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">jstring</span><span class="o">&gt;</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticObjectField</span><span class="p">(</span><span class="n">buildClazz</span><span class="p">,</span> <span class="n">FINGERPRINT</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span> <span class="n">function_check_tracerPID</span><span class="p">()</span> <span class="o">||</span>  <span class="n">system_getproperty_check</span><span class="p">()</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">,</span> <span class="n">JNI_FALSE</span><span class="p">),</span><span class="s">&#34;aosp&#34;</span><span class="p">)){</span>
        <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span><span class="mi">9</span><span class="p">);</span>
<span class="cm">/*        int a,b,c;
</span><span class="cm">        a=1;
</span><span class="cm">        b=0;
</span><span class="cm">        c=a/b;*/</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述Narive层添加了反调试代码,如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">if</span><span class="p">(</span> <span class="n">function_check_tracerPID</span><span class="p">()</span> <span class="o">||</span>  <span class="n">system_getproperty_check</span><span class="p">()</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">fingerprint</span><span class="p">,</span> <span class="n">JNI_FALSE</span><span class="p">),</span><span class="s">&#34;aosp&#34;</span><span class="p">)){</span>
        <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span><span class="mi">9</span><span class="p">);</span>
<span class="cm">/*      int a,b,c;
</span><span class="cm">        a=1;
</span><span class="cm">        b=0;
</span><span class="cm">        c=a/b;*/</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="开始调用-4">开始调用</h5>
<p>首先需要在AbstractJni.java文件中补方法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="k">case</span> <span class="s">&#34;android/os/Build-&gt;FINGERPRINT:Ljava/lang/String;&#34;</span><span class="o">:</span>
	<span class="k">return</span> <span class="k">new</span> <span class="n">StringObject</span><span class="o">(</span><span class="n">vm</span><span class="o">,</span> <span class="s">&#34;LuoHun&#34;</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>直接在Unidbg中调用so的mdString方法是不行的,因为so层有反调试,从上面Native层代码可以看到function_check_tracerPID这个函数检测TracerPid,这在Unidbg中是没用的,system_getproperty_check这个函数是检测手机型号,Unidbg这里是&quot;Nexus&quot;,这个函数会返回真,进行执行kill函数.下面我们在Unidbg中Hook这个函数,让他返回False.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.unidbg.AndroidEmulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.Emulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.LibraryResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.Module</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.arm.HookStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.arm.backend.DynarmicFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.hook.HookContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.hook.ReplaceCallback</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.hook.hookzz.Dobby</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidEmulatorBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.AndroidResolver</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.unidbg.memory.Memory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AbstractJni</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="n">MainActivity</span> <span class="n">mainActivity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MainActivity</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;load offset=&#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
        <span class="n">mainActivity</span><span class="o">.</span><span class="na">crack</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AndroidEmulator</span> <span class="n">emulator</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">VM</span> <span class="n">vm</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DvmClass</span> <span class="n">dvmClass</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Module</span> <span class="n">module</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">MainActivity</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1.创建Android模拟器实例
</span><span class="c1"></span>        <span class="n">emulator</span> <span class="o">=</span> <span class="n">AndroidEmulatorBuilder</span>
                <span class="o">.</span><span class="na">for32Bit</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addBackendFactory</span><span class="o">(</span><span class="k">new</span> <span class="n">DynarmicFactory</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="c1">//2.获取操作内存的接口
</span><span class="c1"></span>        <span class="n">Memory</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">getMemory</span><span class="o">();</span>
        <span class="c1">//3.设置Android SDK 版本
</span><span class="c1"></span>        <span class="n">LibraryResolver</span> <span class="n">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AndroidResolver</span><span class="o">(</span><span class="n">23</span><span class="o">);</span>
        <span class="n">memory</span><span class="o">.</span><span class="na">setLibraryResolver</span><span class="o">(</span><span class="n">resolver</span><span class="o">);</span>
        <span class="c1">//4.创建虚拟机
</span><span class="c1"></span>        <span class="n">vm</span> <span class="o">=</span> <span class="n">emulator</span><span class="o">.</span><span class="na">createDalvikVM</span><span class="o">();</span>
        <span class="c1">//5.是否打印日志
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setVerbose</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">//6.设置jni
</span><span class="c1"></span>        <span class="n">vm</span><span class="o">.</span><span class="na">setJni</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//7.加载目标so文件
</span><span class="c1"></span>        <span class="n">DalvikModule</span> <span class="n">dm</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;unidbg-android/src/test/resources/example_binaries/armeabi-v7a/libluodst.so&#34;</span><span class="o">),</span> <span class="kc">false</span><span class="o">);</span>

        <span class="c1">//开始Hook
</span><span class="c1"></span>        <span class="n">module</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="na">getModule</span><span class="o">();</span>
        <span class="n">Dobby</span> <span class="n">dobby</span> <span class="o">=</span> <span class="n">Dobby</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">emulator</span><span class="o">);</span>
        <span class="c1">//使用ida pro查看导出方法名，尝试hook
</span><span class="c1"></span>        <span class="n">dobby</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="n">module</span><span class="o">.</span><span class="na">findSymbolByName</span><span class="o">(</span><span class="s">&#34;_Z24system_getproperty_checkv&#34;</span><span class="o">),</span> <span class="k">new</span> <span class="n">ReplaceCallback</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// 使用Dobby inline hook导出函数
</span><span class="c1"></span>            <span class="nd">@Override</span>
            <span class="c1">//contextk可以拿到参数，originFunction是原方法的地址
</span><span class="c1"></span>            <span class="kd">public</span> <span class="n">HookStatus</span> <span class="nf">onCall</span><span class="o">(</span><span class="n">Emulator</span><span class="o">&lt;?&gt;</span> <span class="n">emulator</span><span class="o">,</span> <span class="n">HookContext</span> <span class="n">context</span><span class="o">,</span> <span class="kt">long</span> <span class="n">originFunction</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//System.out.println(&#34;create_thread_check_traceid.onCall function address =&gt; 0x&#34; + Long.toHexString(originFunction));
</span><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;_Z24system_getproperty_checkv&#34;</span><span class="o">);</span>
                <span class="c1">//return HookStatus.RET(emulator, originFunction);
</span><span class="c1"></span>                <span class="c1">//return null;
</span><span class="c1"></span>                <span class="k">return</span> <span class="n">HookStatus</span><span class="o">.</span><span class="na">LR</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postCall</span><span class="o">(</span><span class="n">Emulator</span><span class="o">&lt;?&gt;</span> <span class="n">emulator</span><span class="o">,</span> <span class="n">HookContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34; calling _Z14function_checkv .... return false&#34;</span><span class="o">);</span>

               <span class="c1">//context.getIntArg(0);
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">},</span> <span class="kc">false</span><span class="o">);</span>


        <span class="c1">//8.调用JNI_OnLoad
</span><span class="c1"></span>        <span class="n">dm</span><span class="o">.</span><span class="na">callJNI_OnLoad</span><span class="o">(</span><span class="n">emulator</span><span class="o">);</span>
        <span class="c1">//9.配置Native方法类名
</span><span class="c1"></span>        <span class="n">dvmClass</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="na">resolveClass</span><span class="o">(</span><span class="s">&#34;com/example/luodst/MainActivity&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">crack</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//10.执行JNI方法
</span><span class="c1"></span>
        <span class="c1">//示例
</span><span class="c1"></span>        <span class="n">DvmObject</span><span class="o">&lt;?&gt;</span> <span class="n">obj2</span> <span class="o">=</span> <span class="n">ProxyDvmObject</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">vm</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">DvmObject</span> <span class="n">result</span> <span class="o">=</span> <span class="n">obj2</span><span class="o">.</span><span class="na">callJniMethodObject</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="s">&#34;mdString(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="o">,</span> <span class="s">&#34;Hello XiaLuoHun!&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result =&gt; &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="源代码">源代码</h4>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/LuoDst%E8%B0%83%E7%94%A8jni%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95Unidbg.7z" rel="">LuoDst调用jni中的方法Unidbg.7z</a></p>
<h4 id="注意">注意</h4>
<p>在Unidbg中新建的测试类,要和so中的Native所在的类要一致.</p>
<p>如:apk中的com.example.luodst.MainActivity中有一个Native方法为LuoAdd,</p>
<p>现在要在Unidbg中加载so文件,模拟调用其中Native方法LuoAdd,那么首先要在Unidbg中新建一个类为com.example.luodst.MainActivity,然后写代码模拟调用so中的Native方法.</p>
<h5 id="原因">原因</h5>
<p>是因为在Unidbg中调用so中的Native方法代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="n">DvmObject</span><span class="o">&lt;?&gt;</span> <span class="n">obj1</span> <span class="o">=</span> <span class="n">ProxyDvmObject</span><span class="o">.</span><span class="na">createObject</span><span class="o">(</span><span class="n">vm</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">obj1</span><span class="o">.</span><span class="na">callJniMethodInt</span><span class="o">(</span><span class="n">emulator</span><span class="o">,</span> <span class="s">&#34;LuoAdd(II)I&#34;</span><span class="o">,</span> <span class="n">10</span><span class="o">,</span> <span class="n">20</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result =&gt; &#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到上述调用,代码中只写了<strong>LuoAdd(II)I</strong>,但是so中的LuoAdd方法导出函数名为<strong>Java_com_example_luodst_MainActivity_LuoAdd</strong></p>
<p>Unidbg会根据当前类名全称和上述方法签名进行拼接.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%95%e6%b3%a8%e6%84%8f%e7%82%b9.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E6%B3%A8%E6%84%8F%E7%82%B9.png, images/%e8%b0%83%e7%94%a8so%e4%b8%ad%e7%9a%84%e5%ae%9e%e4%be%8b%e6%96%b9%e6%b3%95%e6%b3%a8%e6%84%8f%e7%82%b9.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E6%B3%A8%E6%84%8F%E7%82%B9.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/images/%E8%B0%83%E7%94%A8so%E4%B8%AD%E7%9A%84%E5%AE%9E%E4%BE%8B%E6%96%B9%E6%B3%95%E6%B3%A8%E6%84%8F%E7%82%B9.png"
        title="调用so中的实例方法注意点" /></p>
<h4 id="参考文档">参考文档</h4>
<p><a href="https://bbs.pediy.com/thread-269239.htm" target="_blank" rel="noopener noreffer">https://bbs.pediy.com/thread-269239.htm</a></p>
<p><a href="https://bbs.pediy.com/thread-269949.htm" target="_blank" rel="noopener noreffer">https://bbs.pediy.com/thread-269949.htm</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/Unidbg%E6%96%87%E6%A1%A3%E6%9B%B4%E6%96%B0%28%E4%B8%80%29.mhtml" rel="">Unidbg文档更新(一).mhtml</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/Unidbg%E6%96%87%E6%A1%A3%E6%85%A2%E6%9B%B4%28%E4%BA%8C%29.mhtml" rel="">Unidbg文档慢更(二).mhtml</a></p>
<h2 id="反射">反射</h2>
<h3 id="参考链接-2">参考链接</h3>
<p><a href="https://www.jianshu.com/p/9be58ee20dee" target="_blank" rel="noopener noreffer">https://www.jianshu.com/p/9be58ee20dee</a></p>
<p><a href="https://www.jianshu.com/p/67081d9b0a9c" target="_blank" rel="noopener noreffer">https://www.jianshu.com/p/67081d9b0a9c</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/Java%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7-%E5%8F%8D%E5%B0%84.mhtml" rel="">Java高级特性-反射.mhtml</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/JNI%E7%9A%84%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%AD%E6%96%87API.mhtml" rel="">JNI的常用方法的中文API.mhtml</a></p>
<h3 id="从源码中学习">从源码中学习</h3>
<p><a href="https://github.com/GravityBox/GravityBox" target="_blank" rel="noopener noreffer">https://github.com/GravityBox/GravityBox</a></p>
<h3 id="示例">示例</h3>
<h4 id="java层-7">Java层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luomd5</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.text.TextUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luomd5.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.security.MessageDigest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.security.NoSuchAlgorithmException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luomd5&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luomd5&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">// Example of a call to a native method
</span><span class="c1"></span>        <span class="n">TextView</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="na">sampleText</span><span class="o">;</span>

        <span class="n">String</span> <span class="n">strSample</span> <span class="o">=</span> <span class="s">&#34;XiaLuoHun&#34;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;mdString: &#34;</span> <span class="o">+</span> <span class="n">mdString</span><span class="o">(</span><span class="n">strSample</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> <span class="o">+</span>
                <span class="s">&#34;Javamd5: &#34;</span> <span class="o">+</span> <span class="n">Javamd5</span><span class="o">(</span><span class="n">strSample</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> <span class="o">+</span>
                <span class="s">&#34;Refmd5: &#34;</span> <span class="o">+</span> <span class="n">Refmd5</span><span class="o">(</span><span class="n">strSample</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span> <span class="o">+</span>
                <span class="s">&#34;Refmd5Sec: &#34;</span> <span class="o">+</span> <span class="n">Refmd5Sec</span><span class="o">(</span><span class="n">strSample</span><span class="o">);</span>

        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">Javamd5</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">TextUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">string</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">MessageDigest</span> <span class="n">md5</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">md5</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&#34;MD5&#34;</span><span class="o">);</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="na">digest</span><span class="o">(</span><span class="n">string</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">StringBuilder</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">byte</span> <span class="n">b</span> <span class="o">:</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">0xff</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">temp</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="s">&#34;0&#34;</span> <span class="o">+</span> <span class="n">temp</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">result</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">temp</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">mdString</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">Refmd5</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">Refmd5Sec</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="native层-6">Native层</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;md5.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">__attribute__</span> <span class="p">((</span><span class="n">visibility</span><span class="p">(</span><span class="s">&#34;hidden&#34;</span><span class="p">)))</span>
<span class="n">jstring</span> <span class="n">JNICALL</span> <span class="n">LuoDynamicNative</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
                                 <span class="n">jobject</span> <span class="cm">/* this */</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">&#34;Hello from C++ LuoHun&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luomd5_MainActivity_mdString</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="n">MD5</span><span class="p">(</span><span class="n">szString</span><span class="p">).</span><span class="n">toStr</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">strMd5</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luomd5_MainActivity_Refmd5</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//md5 = MessageDigest.getInstance(&#34;MD5&#34;);
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clsMessageDigest</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;java/security/MessageDigest&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">getInstance</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">clsMessageDigest</span><span class="p">,</span> <span class="s">&#34;getInstance&#34;</span><span class="p">,</span>
                                                   <span class="s">&#34;(Ljava/lang/String;)Ljava/security/MessageDigest;&#34;</span><span class="p">);</span>
    <span class="n">jstring</span> <span class="n">strMD5</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="s">&#34;MD5&#34;</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">objMD5</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticObjectMethod</span><span class="p">(</span><span class="n">clsMessageDigest</span><span class="p">,</span> <span class="n">getInstance</span><span class="p">,</span> <span class="n">strMD5</span><span class="p">);</span>

    <span class="c1">//byte[] bytes = md5.digest(string.getBytes());
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clsString</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;java/lang/String&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">getBytes</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsString</span><span class="p">,</span> <span class="s">&#34;getBytes&#34;</span><span class="p">,</span> <span class="s">&#34;()[B&#34;</span><span class="p">);</span>
    <span class="n">jbyteArray</span> <span class="n">jbAry</span> <span class="o">=</span> <span class="p">(</span><span class="n">jbyteArray</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">getBytes</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">digest</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMessageDigest</span><span class="p">,</span> <span class="s">&#34;digest&#34;</span><span class="p">,</span> <span class="s">&#34;([B)[B&#34;</span><span class="p">);</span>
    <span class="n">jbyteArray</span> <span class="n">jbAryResult</span> <span class="o">=</span> <span class="p">(</span><span class="n">jbyteArray</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">objMD5</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">jbAry</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">cmd5</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">GetByteArrayElements</span><span class="p">(</span><span class="n">jbAryResult</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">dest</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#34;%02x&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">cmd5</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">dest</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luomd5_MainActivity_Refmd5Sec</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;com/example/luomd5/MainActivity&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">Javamd5</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;Javamd5&#34;</span><span class="p">,</span>
                                         <span class="s">&#34;(Ljava/lang/String;)Ljava/lang/String;&#34;</span><span class="p">);</span>
    <span class="n">jstring</span> <span class="n">strMd5</span> <span class="o">=</span> <span class="p">(</span><span class="n">jstring</span><span class="p">)</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">Javamd5</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">strMd5</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/LuoMd5_%E5%8F%8D%E5%B0%84.7z" rel="">LuoMd5_反射.7z</a></p>
<h2 id="oncreate函数native化">OnCreate函数Native化</h2>
<h3 id="java层-8">Java层</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.LayoutInflater</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.view.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luodst.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="c1">// Used to load the &#39;luodst&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luodst&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

<span class="cm">/*    @Override
</span><span class="cm">    protected void onCreate(Bundle savedInstanceState) {
</span><span class="cm">        super.onCreate(savedInstanceState);
</span><span class="cm">
</span><span class="cm">        binding = ActivityMainBinding.inflate(getLayoutInflater());
</span><span class="cm">
</span><span class="cm">        setContentView(binding.getRoot());
</span><span class="cm">
</span><span class="cm">        // Example of a call to a native method
</span><span class="cm">        TextView tv = binding.sampleText;
</span><span class="cm">        tv.setText(stringFromJNI());
</span><span class="cm">    }*/</span>

    <span class="kd">protected</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * A native method that is implemented by the &#39;luodst&#39; native library,
</span><span class="cm">     * which is packaged with this application.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">stringFromJNI</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="native层-7">Native层</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_stringFromJNI</span><span class="p">(</span>
        <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
        <span class="n">jobject</span> <span class="cm">/* this */</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">hello</span> <span class="o">=</span> <span class="s">&#34;Hello from C++&#34;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">hello</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luodst_MainActivity_onCreate</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span>
                                              <span class="n">jobject</span> <span class="n">saved_instance_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//super.onCreate(savedInstanceState);
</span><span class="c1"></span>    <span class="c1">//方式一
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clsAppCompatActivity1</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;androidx/appcompat/app/AppCompatActivity&#34;</span><span class="p">);</span>
    <span class="c1">//方式二
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectClass</span><span class="p">(</span><span class="n">thiz</span><span class="p">);</span>
    <span class="n">jclass</span> <span class="n">clsAppCompatActivity2</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetSuperclass</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">);</span>

    <span class="n">jmethodID</span> <span class="n">onCreate</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsAppCompatActivity1</span><span class="p">,</span> <span class="s">&#34;onCreate&#34;</span><span class="p">,</span>
                                          <span class="s">&#34;(Landroid/os/Bundle;)V&#34;</span><span class="p">);</span>
    <span class="c1">//调用父类方法
</span><span class="c1"></span>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallNonvirtualVoidMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">clsAppCompatActivity1</span><span class="p">,</span> <span class="n">onCreate</span><span class="p">,</span> <span class="n">saved_instance_state</span><span class="p">);</span>

    <span class="c1">//binding = ActivityMainBinding.inflate(getLayoutInflater());
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">getLayoutInflater</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;getLayoutInflater&#34;</span><span class="p">,</span>
                                                   <span class="s">&#34;()Landroid/view/LayoutInflater;&#34;</span><span class="p">);</span>
    <span class="n">jclass</span> <span class="n">clsActivityMainBinding</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span>
            <span class="s">&#34;com/example/luodst/databinding/ActivityMainBinding&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">inflate</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">clsActivityMainBinding</span><span class="p">,</span> <span class="s">&#34;inflate&#34;</span><span class="p">,</span>
                                               <span class="s">&#34;(Landroid/view/LayoutInflater;)Lcom/example/luodst/databinding/ActivityMainBinding;&#34;</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">jbinding</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticObjectMethod</span><span class="p">(</span><span class="n">clsActivityMainBinding</span><span class="p">,</span> <span class="n">inflate</span><span class="p">,</span>
                                                   <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">getLayoutInflater</span><span class="p">));</span>

    <span class="c1">//setContentView(binding.getRoot());
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">getRoot</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsActivityMainBinding</span><span class="p">,</span> <span class="s">&#34;getRoot&#34;</span><span class="p">,</span>
                                         <span class="s">&#34;()Landroid/view/View;&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">setContentView</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;setContentView&#34;</span><span class="p">,</span>
                                                <span class="s">&#34;(Landroid/view/View;)V&#34;</span><span class="p">);</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallVoidMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">setContentView</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">jbinding</span><span class="p">,</span> <span class="n">getRoot</span><span class="p">));</span>

    <span class="c1">//TextView tv = binding.sampleText;
</span><span class="c1"></span>    <span class="n">jfieldID</span> <span class="n">sampleText</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetFieldID</span><span class="p">(</span><span class="n">clsActivityMainBinding</span><span class="p">,</span> <span class="s">&#34;sampleText&#34;</span><span class="p">,</span>
                                          <span class="s">&#34;Landroid/widget/TextView;&#34;</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">tv</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetObjectField</span><span class="p">(</span><span class="n">jbinding</span><span class="p">,</span> <span class="n">sampleText</span><span class="p">);</span>

    <span class="c1">//tv.setText(stringFromJNI());
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">clsTextView</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;android/widget/TextView&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">setText</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsTextView</span><span class="p">,</span> <span class="s">&#34;setText&#34;</span><span class="p">,</span> <span class="s">&#34;(Ljava/lang/CharSequence;)V&#34;</span><span class="p">);</span>
    <span class="n">jmethodID</span> <span class="n">stringFromJNI</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;stringFromJNI&#34;</span><span class="p">,</span>
                                               <span class="s">&#34;()Ljava/lang/String;&#34;</span><span class="p">);</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallVoidMethod</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="n">setText</span><span class="p">,</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallObjectMethod</span><span class="p">(</span><span class="n">thiz</span><span class="p">,</span> <span class="n">stringFromJNI</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="源代码-1">源代码</h3>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/LuoDstOnCreate%E5%87%BD%E6%95%B0Native%E5%8C%96.7z" rel="">LuoDstOnCreate函数Native化.7z</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-12-28</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ndk/">NDK</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/x64dbg%E4%B9%8Bsearchandreplacemem/" class="prev" rel="prev" title="x64Dbg之SearchAndReplaceMem"><i class="fas fa-angle-left fa-fw"></i>x64Dbg之SearchAndReplaceMem</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">夏洛魂</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">夏洛魂</a></span>&nbsp;|&nbsp;<span class="license">MIT</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
