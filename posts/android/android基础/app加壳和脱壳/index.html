<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>App加壳和脱壳 - 夏洛魂的个人博客</title><meta name="Description" content="个人笔记本"><meta property="og:title" content="App加壳和脱壳" />
<meta property="og:description" content="App加壳和脱壳 目前市场上不加壳的App很少见,可以说要想完成对一个App的逆向分析,脱壳是第一步! ClassLoader JVM的类加载器 三种类加载器 Bootstrap Clas" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-12-15T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="App加壳和脱壳"/>
<meta name="twitter:description" content="App加壳和脱壳 目前市场上不加壳的App很少见,可以说要想完成对一个App的逆向分析,脱壳是第一步! ClassLoader JVM的类加载器 三种类加载器 Bootstrap Clas"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/%E9%82%A3%E4%BA%9B%E5%B9%B4%E9%81%87%E8%BF%87%E7%9A%84%E5%9D%91/vmware/" /><link rel="next" href="https://XiaLuoHun.github.io/posts/x64dbg/x64dbg%E4%B9%8Bsearchandreplacemem/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "App加壳和脱壳",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3\/"
        },"genre": "posts","keywords": "加壳与脱壳","wordcount":  9020 ,
        "url": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3\/","datePublished": "2021-12-15T00:00:00+00:00","dateModified": "2021-12-15T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "夏洛魂"},"author": {
                "@type": "Person",
                "name": "夏洛魂"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夏洛魂的个人博客">主页</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夏洛魂的个人博客">主页</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于作者</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">App加壳和脱壳</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>夏洛魂</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/android%E5%9F%BA%E7%A1%80/"><i class="far fa-folder fa-fw"></i>Android基础</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-12-15">2021-12-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9020 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 19 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#app加壳和脱壳">App加壳和脱壳</a>
      <ul>
        <li><a href="#classloader">ClassLoader</a>
          <ul>
            <li><a href="#jvm的类加载器">JVM的类加载器</a>
              <ul>
                <li><a href="#三种类加载器">三种类加载器</a></li>
                <li><a href="#继承关系">继承关系</a>
                  <ul>
                    <li><a href="#双亲委派">双亲委派</a>
                      <ul>
                        <li><a href="#优点">优点</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li><a href="#类加载时机">类加载时机</a>
                  <ul>
                    <li><a href="#隐式加载">隐式加载</a></li>
                    <li><a href="#显式加载">显式加载</a></li>
                  </ul>
                </li>
                <li><a href="#类装载流程">类装载流程</a></li>
              </ul>
            </li>
            <li><a href="#android的类加载器">Android的类加载器</a>
              <ul>
                <li><a href="#继承关系-1">继承关系</a>
                  <ul>
                    <li><a href="#classloader-1">ClassLoader</a></li>
                    <li><a href="#bootclassloader">BootClassLoader</a></li>
                    <li><a href="#basedexclassloader">BaseDexClassLoader</a></li>
                    <li><a href="#secureclassloader">SecureClassLoader</a></li>
                    <li><a href="#inmemorydexclassloader">InMemoryDexClassLoader</a></li>
                    <li><a href="#pathclassloader">PathClassLoader</a></li>
                    <li><a href="#dexclassloader">DexClassLoader</a></li>
                  </ul>
                </li>
                <li><a href="#源码分析">源码分析</a></li>
                <li><a href="#代码验证">代码验证</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#动态加载示例">动态加载示例</a></li>
        <li><a href="#加壳app运行流程">加壳App运行流程</a>
          <ul>
            <li><a href="#app启动流程">App启动流程</a></li>
            <li><a href="#app运行流程">App运行流程</a></li>
            <li><a href="#加壳应用的运行流程">加壳应用的运行流程</a></li>
            <li><a href="#参考链接">参考链接</a></li>
          </ul>
        </li>
        <li><a href="#生命周期类处理">生命周期类处理</a>
          <ul>
            <li><a href="#解决方案">解决方案</a></li>
            <li><a href="#代码实现">代码实现</a>
              <ul>
                <li><a href="#方案一">方案一</a></li>
                <li><a href="#方案二">方案二</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#加壳技术">加壳技术</a>
          <ul>
            <li><a href="#发展">发展</a>
              <ul>
                <li><a href="#dex加固">Dex加固</a></li>
                <li><a href="#so加固">So加固</a></li>
              </ul>
            </li>
            <li><a href="#识别">识别</a>
              <ul>
                <li><a href="#vmp和dex2c的区分">VMP和Dex2C的区分</a></li>
              </ul>
            </li>
            <li><a href="#各种壳解决方案">各种壳解决方案</a>
              <ul>
                <li><a href="#整体加固">整体加固</a></li>
                <li><a href="#函数抽取">函数抽取</a></li>
                <li><a href="#vmp和dex2c">VMP和Dex2C</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#一代壳dex整体加固">一代壳(Dex整体加固)</a>
          <ul>
            <li><a href="#dalvik">Dalvik</a>
              <ul>
                <li><a href="#dexclassloader-1">DexClassLoader</a></li>
              </ul>
            </li>
            <li><a href="#art">ART</a>
              <ul>
                <li><a href="#inmemorydexclassloader-1">InMemoryDexClassLoader</a></li>
                <li><a href="#dexclassloader-2">DexClassLoader</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#二代壳函数抽取">二代壳(函数抽取)</a>
          <ul>
            <li><a href="#dalvik-1">Dalvik</a>
              <ul>
                <li><a href="#流程图">流程图</a></li>
                <li><a href="#参考链接-1">参考链接</a></li>
              </ul>
            </li>
            <li><a href="#art-1">ART</a>
              <ul>
                <li><a href="#手工抽取思路">手工抽取思路</a></li>
                <li><a href="#示例">示例</a></li>
                <li><a href="#源代码">源代码</a></li>
                <li><a href="#参考链接-2">参考链接</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#fart演变">Fart演变</a>
          <ul>
            <li><a href="#v10-classloader中dump">V1.0: classloader中dump</a>
              <ul>
                <li><a href="#时机">时机</a></li>
                <li><a href="#方式">方式</a></li>
              </ul>
            </li>
            <li><a href="#v20-海量的脱壳点">V2.0 &ldquo;海量&quot;的脱壳点</a>
              <ul>
                <li><a href="#时机-1">时机</a></li>
                <li><a href="#方式-1">方式</a></li>
              </ul>
            </li>
            <li><a href="#v30-优中选优">V3.0 优中选优</a>
              <ul>
                <li><a href="#时机-2">时机</a></li>
                <li><a href="#方式-2">方式</a></li>
              </ul>
            </li>
            <li><a href="#v40-双保险">V4.0 双保险</a></li>
            <li><a href="#fart80源码">Fart8.0源码</a></li>
          </ul>
        </li>
        <li><a href="#youpk">Youpk</a>
          <ul>
            <li><a href="#时机-3">时机</a></li>
            <li><a href="#方式-3">方式</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="app加壳和脱壳">App加壳和脱壳</h1>
<p>目前市场上不加壳的App很少见,可以说要想完成对一个App的逆向分析,脱壳是第一步!</p>
<h2 id="classloader">ClassLoader</h2>
<h3 id="jvm的类加载器">JVM的类加载器</h3>
<h4 id="三种类加载器">三种类加载器</h4>
<ol>
<li>
<p>Bootstrap ClassLoader(引导类加载器)</p>
<p>C/C++代码实现的加载器,用于加载指定JDK的核心类库,比如java.lang、java.uti等这些系统类.Java虚拟机的启动就是通过Bootstrap,该ClassLoader在java里无法获取,负责加载/lib下的类.</p>
</li>
<li>
<p>Extensions ClassLoader(拓展类加载器)</p>
<p>Java中的实现类为ExtClassLoader,提供除了系统类之外的额外功能,可以在java里获取,负责加载/lib/ext下的类.</p>
</li>
<li>
<p>Application ClassLoader(应用程序类加载器)</p>
<p>Java中的实现类为AppClassLoader,是与我们接触最多的类加载器,开发人员写的代码默认就是由它来加载,ClassLoader.getSystemClassLoader返回的就是它.</p>
</li>
</ol>
<h4 id="继承关系">继承关系</h4>
<p>可以自定义类加载器,只需要通过继承java.lang.ClassLoader类的方式来实现自己的类加载器即可.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/JVM%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8%e7%bb%a7%e6%89%bf%e5%85%b3%e7%b3%bb.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png, images/JVM%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8%e7%bb%a7%e6%89%bf%e5%85%b3%e7%b3%bb.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/JVM%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png"
        title="JVM类加载器继承关系" /></p>
<h5 id="双亲委派">双亲委派</h5>
<p>双亲委派模式的工作原理:如果一个类加载器收到了类加载请求,它并不会自己先去加载,而是把这个请求委托给父类的加载器去执行,如果父类加载器还存在其父类加载器,则进一步向上委托,依次递归,请求最终将到达顶层的启动类加载器,如果父类加载器可以完成类加载任务,就成功返回,倘若父类加载器无法完成此加载任务,子加载器才会尝试自己去加载,这就是双亲委派模式.即每个儿子都不愿意干活,每次有活都丢给父亲去干,直到父亲说这件事我也干不了时,儿子自己想办法去完成,这个就是双亲委派.</p>
<h6 id="优点">优点</h6>
<ol>
<li>避免重复加载,如果已经加载过依次Class,可以直接读取已经加载的Class.</li>
<li>更加安全,无法自定义类来替代系统的类,可以防止核心API库被随意篡改.</li>
</ol>
<h4 id="类加载时机">类加载时机</h4>
<h5 id="隐式加载">隐式加载</h5>
<ul>
<li>创建类的实例.</li>
<li>访问类的静态变量,或者为静态变量赋值.</li>
<li>调用类的静态方法.</li>
<li>使用反射方式来强制创建某个类或接口对应的java.lang.Class对象.</li>
<li>初始化某个类的子类.</li>
</ul>
<h5 id="显式加载">显式加载</h5>
<ul>
<li>使用LoadClass()加载.</li>
<li>使用forName()加载.</li>
</ul>
<h4 id="类装载流程">类装载流程</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%b1%bb%e5%8a%a0%e8%bd%bd.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%B1%BB%E5%8A%A0%E8%BD%BD.png, images/%e7%b1%bb%e5%8a%a0%e8%bd%bd.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%B1%BB%E5%8A%A0%E8%BD%BD.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%B1%BB%E5%8A%A0%E8%BD%BD.png"
        title="类加载" /></p>
<ol>
<li>装载,查找和导入Class文件.</li>
<li>链接,其中解析步骤是可以选择的.
<ol>
<li>检查,检查载入的class文件数据的正确性.</li>
<li>准备,给类的静态变量分配存储空间.</li>
<li>解析,将符号引用转成直接引用.</li>
</ol>
</li>
<li>初始化,即调用<clinit>函数,对静态变量,静态代码块执行初始化工作.</li>
</ol>
<h3 id="android的类加载器">Android的类加载器</h3>
<h4 id="继承关系-1">继承关系</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Android%e7%9a%84%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Android%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.png, images/Android%e7%9a%84%e7%b1%bb%e5%8a%a0%e8%bd%bd%e5%99%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Android%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Android%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.png"
        title="Android的类加载器" /></p>
<p>上图为Android系统中的ClassLoader的继承关系图,其中InMemoryDexClassLoader为Android8.0新引入的ClassLoader</p>
<h5 id="classloader-1">ClassLoader</h5>
<p>为抽象类.</p>
<h5 id="bootclassloader">BootClassLoader</h5>
<p>预加载常用类,单例模式.与Java中的BootClassLoader不同,它并不是由C/C++代码实现,而是由Java实现的.</p>
<h5 id="basedexclassloader">BaseDexClassLoader</h5>
<p>是InMemoryDexClassLoader、PathClassLoader、DexClassLoader的父类.<strong>类加载的主要逻辑</strong>都是在BaseDexClassLoader完成的.</p>
<h5 id="secureclassloader">SecureClassLoader</h5>
<p>继承了抽象类ClassLoader,扩展了ClassLoader类加入了权限方面的功能,加强了安全性,其子类URLClassLoader是用URL路径从jar文件中加载类和资源.</p>
<h5 id="inmemorydexclassloader">InMemoryDexClassLoader</h5>
<p>Android8.0新引入的,可以直接从内存中加载dex.</p>
<h5 id="pathclassloader">PathClassLoader</h5>
<p>是<strong>Android默认使用的类加载器</strong>,一个apk中的Activity等类便是在其中加载.</p>
<h5 id="dexclassloader">DexClassLoader</h5>
<p>可以加载任意目录下的dex/jar/apk/zip文件,比PathClassLoader更灵活,是实现插件化、热修复以及dex加壳的重点.</p>
<h4 id="源码分析">源码分析</h4>
<p>每个ClassLoader在构造时都会传一个父ClassLoader,遵循双亲委派机制.下图以PathClassLoader为例.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/PathClassLoader.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/PathClassLoader.png, images/PathClassLoader.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/PathClassLoader.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/PathClassLoader.png"
        title="PathClassLoader" /></p>
<h4 id="代码验证">代码验证</h4>
<p>本次主要验证Activity是否由PathClassLoader加载,以及双亲委派机制.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luoclassloader</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;[LuoHun] &#34;</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="n">tstClassLoader</span><span class="o">();</span>

    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">tstClassLoader</span><span class="o">()</span> <span class="o">{</span>
 <span class="n">ClassLoader</span> <span class="n">thisClassLoader</span> <span class="o">=</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;app: &#34;</span> <span class="o">+</span> <span class="n">thisClassLoader</span><span class="o">);</span>
        <span class="n">ClassLoader</span> <span class="n">parentClassLoader</span> <span class="o">=</span> <span class="n">thisClassLoader</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">parentClassLoader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;this: &#34;</span> <span class="o">+</span> <span class="n">thisClassLoader</span> <span class="o">+</span> <span class="s">&#34; --&gt;parent: &#34;</span> <span class="o">+</span> <span class="n">parentClassLoader</span><span class="o">);</span>
            <span class="n">thisClassLoader</span> <span class="o">=</span> <span class="n">parentClassLoader</span><span class="o">;</span>
            <span class="n">parentClassLoader</span> <span class="o">=</span> <span class="n">thisClassLoader</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;root: &#34;</span> <span class="o">+</span> <span class="n">thisClassLoader</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上述代码输出结果如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">app : dalvik.system.PathClassLoader
this: dalvik.system.PathClassLoader --&gt;parent: java.lang.BootClassLoader
root: java.lang.BootClassLoader
</code></pre></td></tr></table>
</div>
</div><h2 id="动态加载示例">动态加载示例</h2>
<p>本次主要使用DexClassLoader,实现一个简单的动态加载Dex文件,并调用其中的某个方法.</p>
<ol>
<li>用As建立一个空工程,新建一个类,写一个测试方法.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LuoTst</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;[LuoHun] &#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fun1</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;org.example.luodst.fun1&#34;</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>编译上述工程,从apk中提取出Dex文件,传到手机的临时目录中.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">adb push classes.dex /data/local/tmp
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>用As建立另一个工程,来加载上述Dex文件,并调用上述的测试函数fun1.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luoloaddex</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dalvik.system.DexClassLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="n">Context</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>

        <span class="c1">//org.example.luodst.LuoTst
</span><span class="c1"></span>        <span class="n">tstDexClassLoader</span><span class="o">(</span><span class="n">appContext</span><span class="o">,</span> <span class="s">&#34;/data/local/tmp/classes.dex&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tstDexClassLoader</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">strDexFilePath</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">File</span> <span class="n">optFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;opt_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">libFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;lib_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

        <span class="cm">/*
</span><span class="cm">        参数一: String dexPath, Dex文件路径
</span><span class="cm">        参数二: String optimizedDirectory, Dex优化目录
</span><span class="cm">        Android中内存中不会出现上述参数一的Dex文件, 会先优化,然后运行,优化后为.odex文件
</span><span class="cm">        参数三: String librarySearchPath, 库搜索路径,jni有so文件
</span><span class="cm">        参数四: ClassLoader parent, 类加载器
</span><span class="cm">        * */</span>

        <span class="n">DexClassLoader</span> <span class="n">dexClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">strDexFilePath</span><span class="o">,</span>
                <span class="n">optFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">libFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">dexClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;org.example.luodst.LuoTst&#34;</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">clazz</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                    <span class="n">Method</span> <span class="n">func1Method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;fun1&#34;</span><span class="o">);</span>
                    <span class="n">func1Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/DexClassLoader%e5%8a%a0%e8%bd%bd%e7%a4%ba%e4%be%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/DexClassLoader%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B.png, images/DexClassLoader%e5%8a%a0%e8%bd%bd%e7%a4%ba%e4%be%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/DexClassLoader%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/DexClassLoader%E5%8A%A0%E8%BD%BD%E7%A4%BA%E4%BE%8B.png"
        title="DexClassLoader加载示例" /></p>
<h2 id="加壳app运行流程">加壳App运行流程</h2>
<h3 id="app启动流程">App启动流程</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/App%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png, images/App%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.png"
        title="App启动流程" /></p>
<p>通过Zygote进程到最终进入到app进程世界，我们可以看到ActivityThread.main()是进入App世界的大门.</p>
<p>下面列出ActivityThread这个类中比较重要的成员和字段.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ActivityThread</span> <span class="o">{</span>

    <span class="c1">//保存创建的ActivityThread实例.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">ActivityThread</span> <span class="n">sCurrentActivityThread</span><span class="o">;</span>

    <span class="c1">//LoadedApk中有mClassLoader成员,即PathClassLoader,App运行过程中用于加载相关四大组件类的ClassLoader
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ArrayMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">LoadedApk</span><span class="o">&gt;&gt;</span> <span class="n">mPackages</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayMap</span><span class="o">&lt;&gt;();</span>

    <span class="c1">//用于获取当前虚拟机创建的ActivityThread实例.
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ActivityThread</span> <span class="nf">currentActivityThread</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sCurrentActivityThread</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="c1">//---
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ActivityThread.main()函数是java中的入口main函数,这里会启动主消息循环,并创建ActivityThread实例,之后调用thread.attach(false)完成一系列初始化准备工作,并完成全局静态变量sCurrentActivityThread的初始化.之后主线程进入消息循环,等待接收来自系统的消息.当收到系统发送来的bindapplication的进程间调用时,调用函数handlebindapplication来处理该请求.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleBindApplication</span><span class="o">(</span><span class="n">AppBindData</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//step 1: 创建LoadedApk对象
</span><span class="c1"></span>    <span class="n">data</span><span class="o">.</span><span class="na">info</span> <span class="o">=</span> <span class="n">getPackageInfoNoCheck</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">appInfo</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">compatInfo</span><span class="o">);</span>
    <span class="o">...</span>
    <span class="c1">//step 2: 创建ContextImpl对象;
</span><span class="c1"></span>    <span class="kd">final</span> <span class="n">ContextImpl</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">ContextImpl</span><span class="o">.</span><span class="na">createAppContext</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">);</span>
 
    <span class="c1">//step 3: 创建Instrumentation
</span><span class="c1"></span>    <span class="n">mInstrumentation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Instrumentation</span><span class="o">();</span>
 
    <span class="c1">//step 4: 创建Application对象;在makeApplication函数中调用了newApplication，在该函数中又调用了app.attach(context)，在attach函数中调用了Application.attachBaseContext函数
</span><span class="c1"></span>    <span class="n">Application</span> <span class="n">app</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">makeApplication</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">restrictedBackupMode</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">mInitialApplication</span> <span class="o">=</span> <span class="n">app</span><span class="o">;</span>
 
    <span class="c1">//step 5: 安装providers
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">ProviderInfo</span><span class="o">&gt;</span> <span class="n">providers</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">providers</span><span class="o">;</span>
    <span class="n">installContentProviders</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="n">providers</span><span class="o">);</span>
 
    <span class="c1">//step 6: 执行Application.Create回调
</span><span class="c1"></span>    <span class="n">mInstrumentation</span><span class="o">.</span><span class="na">callApplicationOnCreate</span><span class="o">(</span><span class="n">app</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>在handleBindApplication函数中第一次进入了app的代码世界,该函数功能是启动一个application,并把系统收集的apk组件等相关信息绑定到application里,在创建完application对象后,接着调用了application的attachBaseContext方法,之后调用了application的onCreate函数.由此可以发现,app的<strong>Application类中的attachBaseContext和onCreate这两个函数是最先获取执行权进行代码执行</strong>的.这也是为什么各家的加固工具的主要逻辑都是通过替换app入口Application,并自实现这两个函数,在这两个函数中进行代码的脱壳以及执行权交付的原因.</p>
<h3 id="app运行流程">App运行流程</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/App%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png, images/App%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/App%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png"
        title="App运行流程" /></p>
<h3 id="加壳应用的运行流程">加壳应用的运行流程</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a0%e5%a3%b3%e5%ba%94%e7%94%a8%e7%9a%84%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E5%8A%A0%E5%A3%B3%E5%BA%94%E7%94%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png, images/%e5%8a%a0%e5%a3%b3%e5%ba%94%e7%94%a8%e7%9a%84%e8%bf%90%e8%a1%8c%e6%b5%81%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E5%8A%A0%E5%A3%B3%E5%BA%94%E7%94%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E5%8A%A0%E5%A3%B3%E5%BA%94%E7%94%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png"
        title="加壳应用的运行流程" /></p>
<p>当壳在函数attachBaseContext和onCreate中执行完加密的Dex文件的解密后,通过自定义的ClassLoader在内存中加载解密后的Dex文件.为了解决后续应用在加载执行解密后的dex文件中的Class和Method的问题,接下来就是通过利用java的反射修复一系列的变量.其中最为重要的一个变量就是应用运行中的ClassLoader,只有ClassLoader被修正后,应用才能够正常的加载并调用Dex中的类和方法,否则的话由于ClassLoader的双亲委派机制,最终会报ClassNotFound异常,应用崩溃退出,这是加固厂商不愿意看到的.由此可见ClassLoader是一个至关重要的变量,所有应用中加载的Dex文件最终都在应用的ClassLoader中.
因此,<strong>只要获取到加固应用最终通过反射设置后的ClassLoader,我们就可以通过一系列反射最终获取到当前应用所加载的解密后的内存中的Dex文件</strong>.</p>
<h3 id="参考链接">参考链接</h3>
<p><a href="https://bbs.pediy.com/thread-252630.htm" target="_blank" rel="noopener noreffer">https://bbs.pediy.com/thread-252630.htm</a></p>
<p>[APP的启动过程][https://shuwoom.com/?p=142]</p>
<p>[实战开发APK安全加固][https://shuwoom.com/?p=360]</p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/APP%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.mhtml" rel="">APP的启动过程.mhtml</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91APK%E5%AE%89%E5%85%A8%E5%8A%A0%E5%9B%BA.mhtml" rel="">实战开发APK安全加固.mhtml</a></p>
<h2 id="生命周期类处理">生命周期类处理</h2>
<p>DexClassLoader加载的类是没有组件生命周期的,也就是说即使DexClassLoader通过对Apk的的动态加载完成了对组件类的加载,但是当系统启动该组件时,依然会出现类失败的异常.</p>
<h3 id="解决方案">解决方案</h3>
<p>此时有两种解决方案:</p>
<ol>
<li>替换系统组件类加载器为我们的DexClassLoader,同时设置DexClassLoader的parent为系统组件类加载器.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e7%b1%bb%e5%a4%84%e7%90%86%e6%96%b9%e6%a1%88%e4%b8%80.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%B8%80.png, images/%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e7%b1%bb%e5%a4%84%e7%90%86%e6%96%b9%e6%a1%88%e4%b8%80.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%B8%80.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%B8%80.png"
        title="生命周期类处理方案一" /></p>
<ol start="2">
<li>打破原有的双亲关系,在系统组件类加载器和BootClassLoader的中间插入我们自己的DexClassLoader即可.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e7%b1%bb%e5%a4%84%e7%90%86%e6%96%b9%e6%a1%88%e4%ba%8c.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%BA%8C.png, images/%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f%e7%b1%bb%e5%a4%84%e7%90%86%e6%96%b9%e6%a1%88%e4%ba%8c.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%BA%8C.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%B1%BB%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88%E4%BA%8C.png"
        title="生命周期类处理方案二" /></p>
<h3 id="代码实现">代码实现</h3>
<p>用As建立一个空工程,新建一个类,写一个测试Activity.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LuoTstActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;[LuoHun] &#34;</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;org.example.luodst.LuoTstActivity onCreate&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>编译上述工程,从apk中提取出Dex文件,传到手机的临时目录中.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">adb push classes.dex /data/local/tmp
</code></pre></td></tr></table>
</div>
</div><h4 id="方案一">方案一</h4>
<p>用As建立另一个工程,来加载上述Dex文件,使用方案一处理Activity.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luoloaddex</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.ArrayMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.ref.WeakReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dalvik.system.DexClassLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="n">Context</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>
        <span class="n">startTstActivityFirstMethod</span><span class="o">(</span><span class="n">appContext</span><span class="o">,</span> <span class="s">&#34;/data/local/tmp/classes.dex&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startTstActivityFirstMethod</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">strDexFilePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">optFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;opt_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">libFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;lib_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

        <span class="n">DexClassLoader</span> <span class="n">dexClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">strDexFilePath</span><span class="o">,</span>
                <span class="n">optFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">libFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>

        <span class="n">replaceClassLoader</span><span class="o">(</span><span class="n">dexClassLoader</span><span class="o">);</span>

        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">dexClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;org.example.luodst.LuoTstActivity&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">clazz</span><span class="o">));</span>
    <span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replaceClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//ActivityThread类中有一个静态方法currentActivityThread可以获取当前虚拟机创建的ActivityThread实例.
</span><span class="c1"></span>            <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">ActivityThreadClazz</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;android.app.ActivityThread&#34;</span><span class="o">);</span>
            <span class="n">Method</span> <span class="n">currentActivityThread</span> <span class="o">=</span> <span class="n">ActivityThreadClazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;currentActivityThread&#34;</span><span class="o">);</span>
            <span class="n">currentActivityThread</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">activityThreadObj</span> <span class="o">=</span> <span class="n">currentActivityThread</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

            <span class="c1">//final ArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt; mPackages = new ArrayMap&lt;&gt;();
</span><span class="c1"></span>            <span class="n">Field</span> <span class="n">mPackagesField</span> <span class="o">=</span> <span class="n">ActivityThreadClazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mPackages&#34;</span><span class="o">);</span>
            <span class="n">mPackagesField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">ArrayMap</span> <span class="n">mPackagesObj</span> <span class="o">=</span> <span class="o">(</span><span class="n">ArrayMap</span><span class="o">)</span> <span class="n">mPackagesField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">activityThreadObj</span><span class="o">);</span>
            <span class="n">WeakReference</span> <span class="n">wr</span> <span class="o">=</span> <span class="o">(</span><span class="n">WeakReference</span><span class="o">)</span> <span class="n">mPackagesObj</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getPackageName</span><span class="o">());</span>
            <span class="n">Object</span> <span class="n">loadedApkObj</span> <span class="o">=</span> <span class="n">wr</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

            <span class="n">Class</span> <span class="n">loadedApkClazz</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;android.app.LoadedApk&#34;</span><span class="o">);</span>
            <span class="c1">//private ClassLoader mClassLoader;
</span><span class="c1"></span>            <span class="n">Field</span> <span class="n">mClassLoader</span> <span class="o">=</span> <span class="n">loadedApkClazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;mClassLoader&#34;</span><span class="o">);</span>
            <span class="n">mClassLoader</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">mClassLoader</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">loadedApkObj</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="方案二">方案二</h4>
<p>用As建立另一个工程,来加载上述Dex文件,使用方案二处理Activity.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">org.example.luoloaddex</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.content.Intent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.ArrayMap</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.ref.WeakReference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dalvik.system.DexClassLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>

        <span class="n">Context</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">getApplicationContext</span><span class="o">();</span>
        <span class="n">startTstActivitySecondMethod</span><span class="o">(</span><span class="n">appContext</span><span class="o">,</span> <span class="s">&#34;/data/local/tmp/classes.dex&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startTstActivitySecondMethod</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">strDexFilePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">optFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;opt_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">libFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;lib_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

        <span class="c1">//pathClassLoader --&gt; bootClassLoader
</span><span class="c1"></span>        <span class="n">ClassLoader</span> <span class="n">pathClassLoader</span> <span class="o">=</span> <span class="n">MainActivity</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="n">ClassLoader</span> <span class="n">bootClassLoader</span> <span class="o">=</span> <span class="n">pathClassLoader</span><span class="o">.</span><span class="na">getParent</span><span class="o">();</span>

        <span class="c1">//dexClassLoader --&gt; bootClassLoader
</span><span class="c1"></span>        <span class="n">DexClassLoader</span> <span class="n">dexClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">strDexFilePath</span><span class="o">,</span>
                <span class="n">optFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">libFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">bootClassLoader</span><span class="o">);</span>

        <span class="c1">//pathClassLoader --&gt; dexClassLoader
</span><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Field</span> <span class="n">parentField</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&#34;parent&#34;</span><span class="o">);</span>
            <span class="n">parentField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">parentField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">pathClassLoader</span><span class="o">,</span> <span class="n">dexClassLoader</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">dexClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;org.example.luodst.LuoTstActivity&#34;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">context</span><span class="o">.</span><span class="na">startActivity</span><span class="o">(</span><span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">clazz</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="加壳技术">加壳技术</h2>
<h3 id="发展">发展</h3>
<h4 id="dex加固">Dex加固</h4>
<ol>
<li><strong>Dex整体加固</strong>:文件加载和内存加载.</li>
<li><strong>函数抽取</strong>:在函数粒度完成代码的保护.</li>
<li><strong>VMP和Dex2C</strong>:Java函数Native化.</li>
</ol>
<h4 id="so加固">So加固</h4>
<ol>
<li>基于init、init_array以及JNI_Onload函数的加壳.</li>
<li>基于自定义linker的加壳.</li>
</ol>
<h3 id="识别">识别</h3>
<table>
<thead>
<tr>
<th></th>
<th>是否Native化</th>
<th>函数体无效</th>
</tr>
</thead>
<tbody>
<tr>
<td>函数抽取类壳</td>
<td>✘</td>
<td>✔</td>
</tr>
<tr>
<td>VMP壳</td>
<td>✔</td>
<td>Native化</td>
</tr>
<tr>
<td>Dex2C壳</td>
<td>✔</td>
<td>Native化</td>
</tr>
</tbody>
</table>
<h4 id="vmp和dex2c的区分">VMP和Dex2C的区分</h4>
<p><strong>VMP</strong>:核心原理是Dalvik和Art下的解释器,对Smali指令流的解析执行过程.</p>
<p>可参考:https://github.com/chago/ADVMP</p>
<p><strong>Dex2C</strong>:将Java函数转成C函数.</p>
<p>可参考:https://github.com/amimo/dcc</p>
<table>
<thead>
<tr>
<th></th>
<th>注册地址是否相同</th>
<th>函数逻辑是否相似</th>
</tr>
</thead>
<tbody>
<tr>
<td>VMP壳</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>Dex2C壳</td>
<td>✘</td>
<td>✘</td>
</tr>
</tbody>
</table>
<h3 id="各种壳解决方案">各种壳解决方案</h3>
<h4 id="整体加固">整体加固</h4>
<ol>
<li><strong>文件加载</strong>:定位解密文件是关键.</li>
<li><strong>内存加载</strong>:加载时机和内存起始地址时关键.</li>
</ol>
<p><strong>方案</strong>:Dex打开和优化的流程呢以及产出的odex、dex2oat编译的流程和生成的oat文件等等.</p>
<h4 id="函数抽取">函数抽取</h4>
<ol>
<li>类加载和函数执行前的流程解密.</li>
<li>函数执行中动态自解密.</li>
</ol>
<p><strong>方案</strong>:关注被抽取的函数的执行流程是关键! 定位被抽取的函数的恢复时机即可.</p>
<h4 id="vmp和dex2c">VMP和Dex2C</h4>
<ol>
<li>VMP:定位解释器是关键,找到映射关系便可恢复.</li>
<li>Dex2C:基础是编译原理,进行了等价语义转换.彻底还原难度巨大.</li>
</ol>
<p><strong>方案</strong>:关注JNI相关的api调用是关键,也是分析VMP和Dex2C保护的函数的逻辑的关键.</p>
<h2 id="一代壳dex整体加固">一代壳(Dex整体加固)</h2>
<h3 id="dalvik">Dalvik</h3>
<h4 id="dexclassloader-1">DexClassLoader</h4>
<p>通过对Dalvik下<strong>DexClassLoader</strong>加载Dex源码分析,来确定脱壳点.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://androidxref.com/4.4.4_r1/xref/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java
</span><span class="c1"></span>
<span class="n">DexClassLoader</span>
<span class="o">-&gt;</span><span class="p">...</span>
<span class="o">-&gt;</span><span class="p">...</span>
<span class="o">-&gt;</span><span class="p">...</span>
<span class="c1">//进入Native函数
</span><span class="c1"></span><span class="o">-&gt;</span><span class="n">openDexFileNative</span><span class="p">(</span><span class="n">Dalvik_dalvik_system_DexFile_openDexFileNative</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">dvmRawDexFileOpen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">odexOutputName</span><span class="p">,</span> <span class="n">RawDexFile</span><span class="o">**</span> <span class="n">ppRawDexFile</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isBootstrap</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">dvmOptimizeDexFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">dexOffset</span><span class="p">,</span> <span class="kt">long</span> <span class="n">dexLength</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">u4</span> <span class="n">modWhen</span><span class="p">,</span> <span class="n">u4</span> <span class="n">crc</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isBootstrap</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">//---
</span><span class="c1"></span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">kUseValgrind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">kDexOptBin</span> <span class="o">=</span> <span class="s">&#34;/bin/dexopt&#34;</span><span class="p">;</span>
       <span class="c1">//---
</span><span class="c1"></span>	   <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//从上述代码来看,通过调dexopt来对Dex文件进行优化
</span><span class="c1">//查看dexopt源代码
</span><span class="c1">//http://androidxref.com/4.4.4_r1/xref/dalvik/dexopt/OptMain.cpp
</span><span class="c1"></span><span class="n">main</span>
<span class="o">-&gt;</span><span class="n">fromDex</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span>
<span class="o">-&gt;</span><span class="n">dvmContinueOptimization</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">dexOffset</span><span class="p">,</span> <span class="kt">long</span> <span class="n">dexLength</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">u4</span> <span class="n">modWhen</span><span class="p">,</span> <span class="n">u4</span> <span class="n">crc</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isBootstrap</span><span class="p">)</span>
<span class="c1">//http://androidxref.com/4.4.4_r1/xref/dalvik/vm/analysis/DexPrepare.cpp#527
</span><span class="c1">//从上述函数,开始脱壳寻找时机.
</span><span class="c1"></span><span class="o">-&gt;</span><span class="n">rewriteDex</span><span class="p">(</span><span class="n">u1</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">doVerify</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">doOpt</span><span class="p">,</span> <span class="n">DexClassLookup</span><span class="o">**</span> <span class="n">ppClassLookup</span><span class="p">,</span> <span class="n">DvmDex</span><span class="o">**</span> <span class="n">ppDvmDex</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">dvmDexFileOpenPartial</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">DvmDex</span><span class="o">**</span> <span class="n">ppDvmDex</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">dexFileParse</span><span class="p">(</span><span class="k">const</span> <span class="n">u1</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><p>以上过程出现加载的Dex文件起始地址和大小的地方都是脱壳点.</p>
<p>目前网上常用的脱壳点是<strong>dvmDexFileOpenPartial</strong>以及<strong>dexFileParse</strong>函数,从这两个函数开始脱,Dump出来的是odex文件.</p>
<h3 id="art">ART</h3>
<h4 id="inmemorydexclassloader-1">InMemoryDexClassLoader</h4>
<p>通过对ART下<strong>InMemoryDexClassLoader</strong>加载Dex源码分析,来确定脱壳点.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://aospxref.com/android-8.0.0_r36/xref/libcore/dalvik/src/main/java/dalvik/system/InMemoryDexClassLoader.java
</span><span class="c1"></span><span class="n">InMemoryDexClassLoader</span>
<span class="o">-&gt;</span><span class="n">BaseDexClassLoader</span>
<span class="o">-&gt;</span><span class="n">DexPathList</span>
<span class="o">-&gt;</span><span class="n">makeInMemoryDexElements</span>
<span class="o">-&gt;</span><span class="n">DexFile</span>
<span class="o">-&gt;</span><span class="n">openInMemoryDexFile</span>
<span class="o">-&gt;</span><span class="n">native</span> <span class="n">Object</span> <span class="n">createCookieWithDirectBuffer</span><span class="p">(</span><span class="n">ByteBuffer</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">);</span>
  <span class="n">native</span> <span class="n">Object</span> <span class="nf">createCookieWithArray</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">);</span>
<span class="o">-&gt;</span><span class="n">CreateSingleDexFileCookie</span>
<span class="o">-&gt;</span><span class="n">CreateDexFile</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Open</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">OpenCommon</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">DexFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span><span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span><span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>InMemoryDexClassLoader没有生成oat文件的流程,注意以上流程中出现Dex文件起始地址和大小的地方.</p>
<h4 id="dexclassloader-2">DexClassLoader</h4>
<p>通过对ART下<strong>DexClassLoader</strong>加载Dex源码分析,来确定脱壳点.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://aospxref.com/android-8.0.0_r36/xref/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java
</span><span class="c1"></span><span class="n">DexClassLoader</span>
<span class="o">-&gt;</span><span class="n">BaseDexClassLoader</span>
<span class="o">-&gt;</span><span class="n">DexPathList</span>
<span class="o">-&gt;</span><span class="n">makeDexElements</span>
<span class="o">-&gt;</span><span class="n">loadDexFile</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="p">.</span><span class="n">loadDex</span>
<span class="o">-&gt;</span><span class="k">private</span> <span class="n">DexFile</span><span class="p">(</span><span class="n">String</span> <span class="n">sourceName</span><span class="p">,</span> <span class="n">String</span> <span class="n">outputName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">ClassLoader</span> <span class="n">loader</span><span class="p">,</span><span class="n">DexPathList</span><span class="p">.</span><span class="n">Element</span><span class="p">[]</span> <span class="n">elements</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">openDexFile</span>
<span class="o">-&gt;</span><span class="k">private</span> <span class="k">static</span> <span class="n">native</span> <span class="n">Object</span> <span class="n">openDexFileNative</span><span class="p">(</span><span class="n">String</span> <span class="n">sourceName</span><span class="p">,</span> <span class="n">String</span> <span class="n">outputName</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="p">,</span> <span class="n">DexPathList</span><span class="p">.</span><span class="n">Element</span><span class="p">[]</span> <span class="n">elements</span><span class="p">);</span>
<span class="o">-&gt;</span><span class="n">OatFileManager</span><span class="o">::</span><span class="n">OpenDexFilesFromOat</span>  <span class="c1">//最终会调用dex2oat
</span><span class="c1"></span><span class="o">-&gt;</span><span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">MakeUpToDate</span>
<span class="o">-&gt;</span><span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">GenerateOatFileNoChecks</span>
<span class="o">-&gt;</span><span class="n">OatFileAssistant</span><span class="o">::</span><span class="n">Dex2Oat</span>

<span class="c1">//http://aospxref.com/android-8.0.0_r36/xref/art/runtime/oat_file_manager.cc?fi=OpenDexFilesFromOat#OpenDexFilesFromOat
</span><span class="c1">//从上述OatFileManager::OpenDexFilesFromOat这个函数开始分析
</span><span class="c1">//如果说阻断了Dex转Oat过程,系统会尝试加载Dex
</span><span class="c1"></span><span class="n">OatFileManager</span><span class="o">::</span><span class="n">OpenDexFilesFromOat</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">Open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span><span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">DexFile</span><span class="o">&gt;&gt;*</span> <span class="n">dex_files</span><span class="p">)</span>
<span class="o">-&gt;</span><span class="n">File</span> <span class="n">OpenAndReadMagic</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">magic</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span>
  <span class="n">DexFile</span><span class="o">::</span><span class="n">OpenFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span><span class="kt">bool</span> <span class="n">verify</span><span class="p">,</span><span class="kt">bool</span> <span class="n">verify_checksum</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">error_msg</span><span class="p">)</span> 
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">OpenCommon</span>
<span class="o">-&gt;</span><span class="n">DexFile</span><span class="o">::</span><span class="n">DexFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">base</span><span class="p">,</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">location</span><span class="p">,</span><span class="kt">uint32_t</span> <span class="n">location_checksum</span><span class="p">,</span><span class="k">const</span> <span class="n">OatDexFile</span><span class="o">*</span> <span class="n">oat_dex_file</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="二代壳函数抽取">二代壳(函数抽取)</h2>
<h3 id="dalvik-1">Dalvik</h3>
<h4 id="流程图">流程图</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e4%b8%8b%e6%8a%bd%e5%8f%96%e5%a3%b3%e6%b5%81%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Dalvik%E4%B8%8B%E6%8A%BD%E5%8F%96%E5%A3%B3%E6%B5%81%E7%A8%8B.png, images/Dalvik%e4%b8%8b%e6%8a%bd%e5%8f%96%e5%a3%b3%e6%b5%81%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Dalvik%E4%B8%8B%E6%8A%BD%E5%8F%96%E5%A3%B3%E6%B5%81%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/Dalvik%E4%B8%8B%E6%8A%BD%E5%8F%96%E5%A3%B3%E6%B5%81%E7%A8%8B.png"
        title="Dalvik下抽取壳流程" /></p>
<p>上述流程为什么要Hook dexFindClass函数?</p>
<p>我们在Java层主动加载一个类是调用的dexClassLoader.loadClass(可以参考上面的<strong>类加载时机</strong>),来加载类的.因此可以阅读DexClassLoader类的loadClass源码来寻求答案.</p>
<p><a href="http://androidxref.com/4.4.4_r1/xref/libcore/libdvm/src/main/java/java/lang/ClassLoader.java" target="_blank" rel="noopener noreffer">http://androidxref.com/4.4.4_r1/xref/libcore/libdvm/src/main/java/java/lang/ClassLoader.java</a></p>
<h4 id="参考链接-1">参考链接</h4>
<p><a href="http://www.520monkey.com/archives/1115" target="_blank" rel="noopener noreffer">http://www.520monkey.com/archives/1115</a></p>
<p><a href="http://www.520monkey.com/archives/1118" target="_blank" rel="noopener noreffer">http://www.520monkey.com/archives/1118</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/Android%E5%85%8DRoot%E6%9D%83%E9%99%90%E9%80%9A%E8%BF%87Hook%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0%E4%BF%AE%E6%94%B9%E7%A8%8B%E5%BA%8F%E8%BF%90%E8%A1%8C%E6%97%B6%E5%86%85%E5%AD%98%E6%8C%87%E4%BB%A4%E9%80%BB%E8%BE%91.mhtml" rel="">Android免Root权限通过Hook系统函数修改程序运行时内存指令逻辑.mhtml</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/Android%E4%B8%AD%E5%AE%9E%E7%8E%B0%E3%80%8C%E7%B1%BB%E6%96%B9%E6%B3%95%E6%8C%87%E4%BB%A4%E6%8A%BD%E5%8F%96%E6%96%B9%E5%BC%8F%E3%80%8D%E5%8A%A0%E5%9B%BA%E6%96%B9%E6%A1%88%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90.mhtml" rel="">Android中实现「类方法指令抽取方式」加固方案原理解析.mhtml</a></p>
<h3 id="art-1">ART</h3>
<h4 id="手工抽取思路">手工抽取思路</h4>
<ol>
<li>首先要干掉Dex2oat过程,如果不干掉这个过程,系统对抽取的Dex文件进行编译生成了oat文件,那么我们动态修改的Dex中的Smali指令就不会生效!</li>
</ol>
<p>干掉Dex2oat过程可从OatFileAssistant::GenerateOatFileNoChecks这个函数开始分析,因为这个函数内容会调用OatFileAssistant::Dex2Oat这个函数.</p>
<ol start="2">
<li>解析Dex文件格式,找到要抽取函数的CodeItem,记下其中的指令,将其填充为0.</li>
<li>寻找一个Hook时机(ClassLinker::LoadMethod),在系统执行抽取的函数之前,将其原指令填充回去.</li>
</ol>
<h4 id="示例">示例</h4>
<p>本次实现环境:Android8.1</p>
<ol>
<li>准备一个测试Dex文件.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.example.luodst</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LuoTst</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;[LuoHun] &#34;</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fun1</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&#34;org.example.luodst.fun1&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在AndroidStudio中编译上述代码,生成一个测试Dex文件.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e4%ba%8c%e4%bb%a3%e5%a3%b3%e6%8a%bd%e5%8f%96%e5%89%8d.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%89%8D.png, images/%e4%ba%8c%e4%bb%a3%e5%a3%b3%e6%8a%bd%e5%8f%96%e5%89%8d.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%89%8D.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%89%8D.png"
        title="二代壳抽取前" /></p>
<ol start="2">
<li>用010Editor打开上述Dex,找到com.example.luodst.LuoTst类的fun1方法二进制指令,记下原来的并将其填充为0</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">struct class_def_item class_def[1484]	public com.example.luodst.LuoTst	B2DA4h	20h	Fg: Bg:0xE0E0E0	Class ID

struct method_id_item method_id[22370]	void com.example.luodst.LuoTst.fun1()	96C34h	8h	Fg: Bg:0x008080	Method ID
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/010Editor%e5%a1%ab%e5%85%85%e6%96%b9%e6%b3%95%e4%bd%93%e4%b8%ba0.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/010Editor%E5%A1%AB%E5%85%85%E6%96%B9%E6%B3%95%E4%BD%93%E4%B8%BA0.png, images/010Editor%e5%a1%ab%e5%85%85%e6%96%b9%e6%b3%95%e4%bd%93%e4%b8%ba0.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/010Editor%E5%A1%AB%E5%85%85%E6%96%B9%E6%B3%95%E4%BD%93%E4%B8%BA0.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/010Editor%E5%A1%AB%E5%85%85%E6%96%B9%E6%B3%95%E4%BD%93%E4%B8%BA0.png"
        title="010Editor填充方法体为0" /></p>
<p>下面用GDA打开上述修改后的Dex文件,来看下现象.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e4%ba%8c%e4%bb%a3%e5%a3%b3%e6%8a%bd%e5%8f%96%e5%90%8e.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%90%8E.png, images/%e4%ba%8c%e4%bb%a3%e5%a3%b3%e6%8a%bd%e5%8f%96%e5%90%8e.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%90%8E.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E6%8A%BD%E5%8F%96%E5%90%8E.png"
        title="二代壳抽取后" /></p>
<ol start="3">
<li>重新计算上述修改后的Dex文件的checksum和sha值,回写到Dex的文件头部中.</li>
<li>将上述修改后的Dex文件,放到手机的/data/local/tmp目录下.</li>
<li>在调用抽取的的函数之前,将原始指令回填(Hook ClassLinker::LoadMethod),反射调用被抽取的函数.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="c1">//Java
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">com.example.luoclassloader</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">androidx.appcompat.app.AppCompatActivity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.content.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.util.Log</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.example.luoclassloader.databinding.ActivityMainBinding</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">dalvik.system.DexClassLoader</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="n">AppCompatActivity</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TAG</span> <span class="o">=</span> <span class="s">&#34;[LuoHun] &#34;</span><span class="o">;</span>

    <span class="c1">// Used to load the &#39;luoclassloader&#39; library on application startup.
</span><span class="c1"></span>    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&#34;luoclassloader&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">ActivityMainBinding</span> <span class="n">binding</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="n">binding</span> <span class="o">=</span> <span class="n">ActivityMainBinding</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="n">getLayoutInflater</span><span class="o">());</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">getRoot</span><span class="o">());</span>

        <span class="c1">//二代壳
</span><span class="c1"></span>        <span class="n">SecondShell</span><span class="o">();</span>

        <span class="c1">//反射运行抽空的方法
</span><span class="c1"></span>        <span class="n">tstDexClassLoader</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="s">&#34;/data/local/tmp/2.dex&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tstDexClassLoader</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">strDexFilePath</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">optFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;opt_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
        <span class="n">File</span> <span class="n">libFile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getDir</span><span class="o">(</span><span class="s">&#34;lib_dex&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>

        <span class="n">DexClassLoader</span> <span class="n">dexClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">strDexFilePath</span><span class="o">,</span>
                <span class="n">optFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">libFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
                <span class="n">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>

        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">dexClassLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="s">&#34;com.example.luodst.LuoTst&#34;</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="n">Method</span> <span class="n">func1Method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&#34;fun1&#34;</span><span class="o">);</span>
            <span class="n">func1Method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">SecondShell</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//Native
</span><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;android/log.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;asm/fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">//import c header
</span><span class="c1"></span><span class="k">extern</span> <span class="s">&#34;C&#34;</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&#34;hook/dlfcn/dlfcn_compat.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;hook/include/inlineHook.h&#34;</span><span class="cp">
</span><span class="cp"></span><span class="p">}</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
<span class="cp">#define TAG &#34;SecondShell&#34;
</span><span class="cp">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__)
</span><span class="cp"></span><span class="k">struct</span> <span class="nc">DexFile</span> <span class="p">{</span>
    <span class="c1">// Field order required by test &#34;ValidateFieldOrderOfJavaCppUnionClasses&#34;.
</span><span class="c1"></span>    <span class="c1">// The class we are a part of.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">declaring_class_</span><span class="p">;</span>
    <span class="c1">// Access flags; low 16 bits are defined by spec.
</span><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span>
    <span class="cm">/* Dex file fields. The defining dex file is available via declaring_class_-&gt;dex_cache_ */</span>
    <span class="c1">// Offset to the CodeItem.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="nc">ArtMethod</span> <span class="p">{</span>
    <span class="c1">// Field order required by test &#34;ValidateFieldOrderOfJavaCppUnionClasses&#34;.
</span><span class="c1"></span>    <span class="c1">// The class we are a part of.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">declaring_class_</span><span class="p">;</span>
    <span class="c1">// Access flags; low 16 bits are defined by spec.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">access_flags_</span><span class="p">;</span>
    <span class="cm">/* Dex file fields. The defining dex file is available via declaring_class_-&gt;dex_cache_ */</span>
    <span class="c1">// Offset to the CodeItem.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">dex_code_item_offset_</span><span class="p">;</span>
    <span class="c1">// Index into method_ids of the dex file associated with this method.
</span><span class="c1"></span>    <span class="kt">uint32_t</span> <span class="n">dex_method_index_</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="o">**</span><span class="p">(</span><span class="o">*</span><span class="n">oriexecve</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">__argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">__envp</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">**</span><span class="nf">myexecve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">__file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">__argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">__envp</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter execve:%s&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">__file</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">__file</span><span class="p">,</span> <span class="s">&#34;dex2oat&#34;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">oriexecve</span><span class="p">(</span><span class="n">__file</span><span class="p">,</span> <span class="n">__argv</span><span class="p">,</span> <span class="n">__envp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//void ClassLinker::LoadMethod(Thread* self, const DexFile&amp; dex_file, const ClassDataItemIterator&amp; it,Handle&lt;mirror::Class&gt; klass, ArtMethod* dst)
</span><span class="c1">//        art::ClassLinker::LoadMethod(art::DexFile const&amp;, art::ClassDataItemIterator const&amp;, art::Handle&lt;art::mirror::Class&gt;, art::ArtMethod*)
</span><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">oriloadmethod</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">myloadmethod</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,before run loadmethod:&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="k">struct</span> <span class="nc">ArtMethod</span> <span class="o">*</span><span class="n">artmethod</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">ArtMethod</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">DexFile</span> <span class="o">*</span><span class="n">dexfile</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">DexFile</span> <span class="o">*</span><span class="p">)</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:dexfilebegin:%p,size:%d&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span>
         <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span><span class="c1">//0,57344
</span><span class="c1"></span>
    <span class="c1">//dump dex first time
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">dexfilepath</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">dexfilepath</span><span class="p">,</span> <span class="s">&#34;/data/local/tmp/Luo/%d_%d.dex&#34;</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">dexfilepath</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">oriloadmethod</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:code_offset:%d,idx:%d&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
         <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_code_item_offset_</span><span class="p">,</span> <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_method_index_</span><span class="p">);</span>

    <span class="n">byte</span> <span class="o">*</span><span class="n">code_item_addr</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">)</span> <span class="o">+</span> <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_code_item_offset_</span><span class="p">;</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:dexfilebegin:%p,size:%d,beforedumpcodeitem:%p&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
         <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">code_item_addr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_method_index_</span> <span class="o">==</span> <span class="mi">22370</span><span class="p">)</span> <span class="p">{</span><span class="c1">//LuoTst.fun1-&gt;methodidx
</span><span class="c1"></span>        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:dexfilebegin:%p,size:%d,start repire method&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
             <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
        <span class="n">byte</span> <span class="o">*</span><span class="n">code_item_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span> <span class="o">+</span> <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_code_item_offset_</span><span class="p">;</span>
        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:dexfilebegin:%p,size:%d,beforedumpcodeitem:%p&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
             <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">code_item_addr</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mprotect</span><span class="p">(</span><span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">PROT_WRITE</span><span class="p">);</span>

        <span class="n">byte</span> <span class="o">*</span><span class="n">code_item_start</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">code_item_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,enter loadmethod:dexfilebegin:%p,size:%d,code_item_start:%p&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
             <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">code_item_start</span><span class="p">);</span>

        <span class="n">byte</span> <span class="n">inst</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xEB</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
                         <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">code_item_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="c1">//second dump dex
</span><span class="c1"></span>        <span class="n">memset</span><span class="p">(</span><span class="n">dexfilepath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
        <span class="n">sprintf</span><span class="p">(</span><span class="n">dexfilepath</span><span class="p">,</span> <span class="s">&#34;/data/local/tmp/Luo/%d_%d_after.dex&#34;</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">dexfilepath</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">,</span> <span class="n">dexfile</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
            <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;process:%d,after loadmethod:code_offset:%d,idx:%d&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
         <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_code_item_offset_</span><span class="p">,</span> <span class="n">artmethod</span><span class="o">-&gt;</span><span class="n">dex_method_index_</span><span class="p">);</span><span class="c1">//0,57344
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hooklibc</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;go into hooklibc&#34;</span><span class="p">);</span>
    <span class="c1">//7.0 命名空间限制
</span><span class="c1"></span>    <span class="kt">void</span> <span class="o">*</span><span class="n">libc_addr</span> <span class="o">=</span> <span class="n">dlopen_compat</span><span class="p">(</span><span class="s">&#34;libc.so&#34;</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">execve_addr</span> <span class="o">=</span> <span class="n">dlsym_compat</span><span class="p">(</span><span class="n">libc_addr</span><span class="p">,</span> <span class="s">&#34;execve&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">execve_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ELE7EN_OK</span> <span class="o">==</span> <span class="n">registerInlineHook</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">execve_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">myexecve</span><span class="p">,</span>
                                            <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">oriexecve</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ELE7EN_OK</span> <span class="o">==</span> <span class="n">inlineHook</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">execve_addr</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;inlineHook execve success&#34;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;inlineHook execve failure&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hookART</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;go into hookART&#34;</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">libart_addr</span> <span class="o">=</span> <span class="n">dlopen_compat</span><span class="p">(</span><span class="s">&#34;/system/lib/libart.so&#34;</span><span class="p">,</span> <span class="n">RTLD_NOW</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">libart_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">loadmethod_addr</span> <span class="o">=</span> <span class="n">dlsym_compat</span><span class="p">(</span><span class="n">libart_addr</span><span class="p">,</span>
                                             <span class="s">&#34;_ZN3art11ClassLinker10LoadMethodERKNS_7DexFileERKNS_21ClassDataItemIteratorENS_6HandleINS_6mirror5ClassEEEPNS_9ArtMethodE&#34;</span><span class="p">);</span>
<span class="c1">//        _ZN3art11ClassLinker10LoadMethodERKNS_7DexFileERKNS_21ClassDataItemIteratorENS_6HandleINS_6mirror5ClassEEEPNS_9ArtMethodE
</span><span class="c1"></span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loadmethod_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ELE7EN_OK</span> <span class="o">==</span> <span class="n">registerInlineHook</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">loadmethod_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">myloadmethod</span><span class="p">,</span>
                                                <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">oriloadmethod</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ELE7EN_OK</span> <span class="o">==</span> <span class="n">inlineHook</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">loadmethod_addr</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;inlineHook loadmethod success&#34;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;inlineHook loadmethod failure&#34;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="n">Java_com_example_luoclassloader_MainActivity_SecondShell</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//干掉Dex2oat过程
</span><span class="c1"></span>    <span class="n">hooklibc</span><span class="p">();</span>
    <span class="c1">//还原抽取的指令
</span><span class="c1"></span>    <span class="n">hookART</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="源代码">源代码</h4>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/%E4%BA%8C%E4%BB%A3%E5%A3%B3%E7%A4%BA%E4%BE%8B.7z" rel="">二代壳示例.7z</a></p>
<h4 id="参考链接-2">参考链接</h4>
<p>干掉Dex2oat过程:https://github.com/asLody/TurboDex</p>
<p>参考链接:https://bbs.pediy.com/thread-254028.htm</p>
<h2 id="fart演变">Fart演变</h2>
<p><a href="https://bbs.pediy.com/thread-254555.htm" target="_blank" rel="noopener noreffer">https://bbs.pediy.com/thread-254555.htm</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/%E5%AE%89%E5%8D%93APP%E8%84%B1%E5%A3%B3%E7%9A%84%E6%9C%AC%E8%B4%A8%E4%BB%A5%E5%8F%8A%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%8F%91%E7%8E%B0ART%E4%B8%8B%E7%9A%84%E8%84%B1%E5%A3%B3%E7%82%B9.mhtml" rel="">安卓APP脱壳的本质以及如何快速发现ART下的脱壳点.mhtml</a></p>
<h3 id="v10-classloader中dump">V1.0: classloader中dump</h3>
<h4 id="时机">时机</h4>
<ul>
<li>App中的Application类中的attachBaseContext和onCreate函数是App中最先执行的方法.</li>
<li>因此需要选在Application的onCreate函数执行之后才开始被调用的任意一个函数中.</li>
<li>比如选择在ActivityThread中的performLaunchActivity函数作为时机,来获取最终应用的ClassLoader.</li>
</ul>
<h4 id="方式">方式</h4>
<p>获取到应用解密后的Dex文件最终依附的ClassLoader之后,通过Java的反射机制最终获取到对应的DexFile的结构体,并完成Dex的Dump.</p>
<h3 id="v20-海量的脱壳点">V2.0 &ldquo;海量&quot;的脱壳点</h3>
<h4 id="时机-1">时机</h4>
<p>所有类和方法的装载和链接、编译和执行流程之中.</p>
<h4 id="方式-1">方式</h4>
<ul>
<li>ART下DexFile类中定义了两个关键的变量:begin_、size_以及用于获取这两个变量的Begin()和Size()函数.</li>
<li>这两个变量分别代表着当前DexFile对象对应的内存中的Dex文件加载的起始位置和大小.</li>
<li>只要有了这两个值,我们就可以完成对Dex的Dump.</li>
</ul>
<h3 id="v30-优中选优">V3.0 优中选优</h3>
<h4 id="时机-2">时机</h4>
<ul>
<li>找到绕过dex2oat的时机.</li>
<li>类的初始化函数始终运行在ART下的inpterpreter模式.</li>
</ul>
<h4 id="方式-2">方式</h4>
<ul>
<li>在解释执行<clinit>时进行脱壳,实现&quot;绕过&quot;dex2oat.</li>
<li>因此必然进入到interpreter.cc文件中的Execute函数,从而进入ART下的解释器解释执行.</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/CompileMethod.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/CompileMethod.png, images/CompileMethod.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/CompileMethod.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/images/CompileMethod.png"
        title="CompileMethod" /></p>
<h3 id="v40-双保险">V4.0 双保险</h3>
<p>同时在dex2oat和类的初始化流程函数设置&quot;Hook&rdquo;</p>
<h3 id="fart80源码">Fart8.0源码</h3>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/app%E5%8A%A0%E5%A3%B3%E5%92%8C%E8%84%B1%E5%A3%B3/FART_aosp8.0.7z" rel="">FART_aosp8.0.7z</a></p>
<h2 id="youpk">Youpk</h2>
<p><a href="https://bbs.pediy.com/thread-259854.htm" target="_blank" rel="noopener noreffer">https://bbs.pediy.com/thread-259854.htm</a></p>
<h3 id="时机-3">时机</h3>
<p>App启动后10s开始</p>
<h3 id="方式-3">方式</h3>
<ul>
<li>禁用dex2oat:在dex2oat中设置CompilerFilter为仅验证.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//dex2oat.cc
</span><span class="c1"></span><span class="n">compiler_options_</span><span class="o">-&gt;</span><span class="n">SetCompilerFilter</span><span class="p">(</span><span class="n">CompilerFilter</span><span class="o">::</span><span class="n">kVerifyAtRuntime</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>从ClassLinker中遍历DexFile对象并dump</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-12-15</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E5%8A%A0%E5%A3%B3%E4%B8%8E%E8%84%B1%E5%A3%B3/">加壳与脱壳</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E9%82%A3%E4%BA%9B%E5%B9%B4%E9%81%87%E8%BF%87%E7%9A%84%E5%9D%91/vmware/" class="prev" rel="prev" title="VMware内存修改"><i class="fas fa-angle-left fa-fw"></i>VMware内存修改</a>
            <a href="/posts/x64dbg/x64dbg%E4%B9%8Bsearchandreplacemem/" class="next" rel="next" title="x64Dbg之SearchAndReplaceMem">x64Dbg之SearchAndReplaceMem<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">夏洛魂</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">夏洛魂</a></span>&nbsp;|&nbsp;<span class="license">MIT</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
