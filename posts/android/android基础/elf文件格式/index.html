<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>ELF文件格式   夏洛魂的个人博客</title><meta name="author" content="夏洛魂">
<meta name="description" content="ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.
"><meta name="keywords" content='Android'>
  <meta itemprop="name" content="ELF文件格式">
  <meta itemprop="description" content="ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.">
  <meta itemprop="datePublished" content="2021-11-19T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-11-19T00:00:00+00:00">
  <meta itemprop="wordCount" content="7935">
  <meta itemprop="image" content="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png">
  <meta itemprop="keywords" content="Android"><meta property="og:url" content="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/">
  <meta property="og:site_name" content="夏洛魂的个人博客">
  <meta property="og:title" content="ELF文件格式">
  <meta property="og:description" content="ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-11-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-11-19T00:00:00+00:00">
    <meta property="article:tag" content="Android">
    <meta property="og:image" content="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png">
  <meta name="twitter:title" content="ELF文件格式">
  <meta name="twitter:description" content="ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.">
<meta name="application-name" content="夏洛魂">
<meta name="apple-mobile-web-app-title" content="夏洛魂"><meta name="theme-color" data-light="#ffffff" data-dark="#ffffff" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" type="text/html" href="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" title="ELF文件格式   夏洛魂的个人博客" /><link rel="prev" type="text/html" href="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" title="Dex文件格式" /><link rel="next" type="text/html" href="https://XiaLuoHun.top/posts/android/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/kali%E9%85%8D%E7%BD%AE/" title="Kali配置" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "ELF文件格式",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/XiaLuoHun.top\/posts\/android\/android%E5%9F%BA%E7%A1%80\/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/XiaLuoHun.top\/posts\/android\/android%E5%9F%BA%E7%A1%80\/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\/images\/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png",
              "width":  1254 ,
              "height":  790 
            }],"genre": "posts","keywords": "Android","wordcount":  7935 ,
    "url": "https:\/\/XiaLuoHun.top\/posts\/android\/android%E5%9F%BA%E7%A1%80\/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F\/","datePublished": "2021-11-19T00:00:00+00:00","dateModified": "2021-11-19T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "夏洛魂"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item">
              <a class="menu-link" href="/excalidraw/">在线绘图</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于作者</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="输入关键词搜索" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="输入关键词搜索" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item"><a class="menu-link" href="/excalidraw/">在线绘图</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于作者</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"><div class="details collection-details open">
      <div class="details-summary collection-summary">
        <i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i>
        <span class="collection-name" data-collections="合集">Android基础</span>
        <span class="collection-count">7</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content collection-content">
        <nav>
          <ul class="collection-list"><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/android%E5%BC%80%E5%8F%91/" title="Android开发">Android开发</a></li><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/" title="NDK开发">NDK开发</a></li><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/" title="NDK进阶">NDK进阶</a></li><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/arm%E9%80%86%E5%90%91/" title="Arm逆向">Arm逆向</a></li><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" title="Dex文件格式">Dex文件格式</a></li><li class="collection-item"><span class="active" title="ELF文件格式">ELF文件格式</span></li><li class="collection-item"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/android%E9%80%86%E5%90%91%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/android%E9%80%86%E5%90%91%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="Android逆向常用命令">Android逆向常用命令</a></li></ul>
          <div class="collection-nav-simple"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" class="collection-nav-item" rel="prev" title="Dex文件格式"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i></a><span class="text-secondary">6/7</span><a href="/posts/android/android%E5%9F%BA%E7%A1%80/android%E9%80%86%E5%90%91%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/android%E9%80%86%E5%90%91%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="collection-nav-item" rel="next" title="Android逆向常用命令"><i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
        </nav>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>ELF文件格式</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/Luo.png" alt="夏洛魂" data-title="夏洛魂" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;夏洛魂</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/android%E5%9F%BA%E7%A1%80/" class="post-category" title="分类 - Android基础"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Android基础</a> 和 <a href="/collections/android%E5%9F%BA%E7%A1%80/" class="post-collection" title="合集 - Android基础"><i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i> Android基础</a></span></div><div class="post-meta-line"><span title="发布于 2021-11-19 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-11-19">2021-11-19</time></span>&nbsp;<span title="7935 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 8000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 16 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#准备elf文件">准备ELF文件</a></li>
    <li><a href="#文件格式">文件格式</a>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#文件头">文件头</a></li>
        <li><a href="#节">节</a></li>
        <li><a href="#特殊节">特殊节</a></li>
        <li><a href="#符号表">符号表</a></li>
        <li><a href="#哈希表">哈希表</a></li>
        <li><a href="#过程链接表">过程链接表</a></li>
        <li><a href="#全局偏移表">全局偏移表</a></li>
        <li><a href="#重定位表">重定位表</a></li>
        <li><a href="#动态节">动态节</a></li>
        <li><a href="#程序头表">程序头表</a></li>
        <li><a href="#攻防对抗">攻防对抗</a>
          <ul>
            <li><a href="#动态运行-修改api地址">动态运行-修改API地址</a></li>
            <li><a href="#got表hook">Got表Hook</a></li>
            <li><a href="#阅读系统加载动态节数据源码">阅读系统加载动态节数据源码</a></li>
            <li><a href="#抹除文件格式">抹除文件格式</a></li>
            <li><a href="#重建节表">重建节表</a></li>
          </ul>
        </li>
        <li><a href="#参考链接">参考链接</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="「依旧是、江涛如许，雨帆烟笛！」"><p>ELF是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.</p>
<h2 id="准备elf文件" class="heading-element"><span>准备ELF文件</span>
  <a href="#%e5%87%86%e5%a4%87elf%e6%96%87%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight" title="luoelf.c"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello ELF!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" title="makefile脚本"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">AS_PATH</span>  <span class="o">:=</span> /data/local/tmp
</span></span><span class="line"><span class="cl"><span class="nv">ELF_PATH</span> <span class="o">:=</span> E:/SoftWareWork/AndroidStudioWork/LuoELF/app/build/intermediates/cmake/debug/obj/armeabi-v7a
</span></span><span class="line"><span class="cl"><span class="nv">ELF_NAME</span> <span class="o">:=</span> luoelf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">all</span><span class="o">:</span>
</span></span><span class="line"><span class="cl"> adb push <span class="k">$(</span>ELF_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span> <span class="k">$(</span>AS_PATH<span class="k">)</span>
</span></span><span class="line"><span class="cl"> adb shell chmod a+x <span class="k">$(</span>AS_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span>
</span></span><span class="line"><span class="cl"> adb shell <span class="k">$(</span>AS_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="文件格式" class="heading-element"><span>文件格式</span>
  <a href="#%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="概述" class="heading-element"><span>概述</span>
  <a href="#%e6%a6%82%e8%bf%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png" alt="文件格式概述" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png?size=large 2x" data-title="文件格式概述" style="--width: 822px;--aspect-ratio: 822 / 779;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>程序头表指向段,等价于PE中的节,用来描述内存映射.
节头表指向节,类似PE的数据目录,指向各种表.
在Obj文件中段是可选的,在可执行文件中节是可选的,但是NDK编译出的ELF文件,段和节都是有的.</p>
<p>总体来说就是一个ELF文件包含3部分,ELF文件头、节、段.</p>
<p>数据类型:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png" alt="数据类型" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png?size=large 2x" data-title="数据类型" style="--width: 1116px;--aspect-ratio: 1116 / 604;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="文件头" class="heading-element"><span>文件头</span>
  <a href="#%e6%96%87%e4%bb%b6%e5%a4%b4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define EI_NIDENT 16 
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_machine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">e_version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Addr</span> <span class="n">e_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Off</span> <span class="n">e_phoff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Off</span> <span class="n">e_shoff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">e_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_ehsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_phentsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_phnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_shentsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_shnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Half</span> <span class="n">e_shstrndx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Ehdr</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>e_ident:</p>
<p>这16字节是ELF标识,前4字节是文件标志,不可修改.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_ident.png" alt="e_ident" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_ident.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_ident.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_ident.png?size=large 2x" data-title="e_ident" style="--width: 703px;--aspect-ratio: 703 / 902;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>EI_CLASS:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_CLASS.png" alt="EI_CLASS" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_CLASS.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_CLASS.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_CLASS.png?size=large 2x" data-title="EI_CLASS" style="--width: 675px;--aspect-ratio: 675 / 347;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这个字节指明了文件类型.
Android系统不检查这个字节,它是通过判断指令集v7a,v8a来确定是32位还是64位.
IDA检查了这个字节,如果修改了这个字节,IDA就无法反汇编.</p>
<p>EI_DATA:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_DATA.png" alt="EI_DATA" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_DATA.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_DATA.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/EI_DATA.png?size=large 2x" data-title="EI_DATA" style="--width: 750px;--aspect-ratio: 750 / 348;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这个字节决定了接下来ELF文件结构体的解析是按大尾方式还是小尾方式.
Android系统不检查这个字节,默认为小尾方式.
IDA检查了这个字节,如果修改了这个字节,IDA就无法反汇编.</p>
<p>EI_VERSION:</p>
<p>ELF文件头的版本.</p>
<p>e_type:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_type.png" alt="e_type" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_type.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_type.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_type.png?size=large 2x" data-title="e_type" style="--width: 944px;--aspect-ratio: 944 / 696;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这2字节是文件类型.
Android5.0之后,可执行文件全部为so文件.
Android高版本,这2字节只能是03,不能修改.</p>
<p>e_machine:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine1.png" alt="e_machine1" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine1.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine1.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine1.png?size=large 2x" data-title="e_machine1" style="--width: 1049px;--aspect-ratio: 1049 / 916;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine2.png" alt="e_machine2" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine2.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine2.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_machine2.png?size=large 2x" data-title="e_machine2" style="--width: 1374px;--aspect-ratio: 1374 / 675;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这2字节是指令集,可在elf-em.h这个头文件中,查看扩展指令集.
这2字节不可修改.</p>
<p>e_version:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_version.png" alt="e_version" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_version.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_version.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/e_version.png?size=large 2x" data-title="e_version" style="--width: 628px;--aspect-ratio: 628 / 265;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这4字节指明目标文件的版本.
Android系统不检查这4字节.
IDA检查了这4字节,不过影响不大,如果修改了,IDA还是可以反汇编.</p>
<p>e_entry:</p>
<p>这4字节是程序入口点(OEP),是个RVA.
但如果上面e_type的值是02,这个值就是VA.
如果是共享库文件,这4字节是0.
如果是可执行文件,这4字节不是0.
这是共享库文件和可执行文件很重要的差别.</p>
<p>e_phoff:</p>
<p>这4字节是程序头表偏移,如果没有程序头表,该值应为0.</p>
<p>e_shoff:</p>
<p>这4字节是节头表偏移,如果没有节头表,该值应为0.
在Android对抗中,删节表是很常见的.</p>
<p>e_flags:</p>
<p>这4字节是个标志,没什么用.</p>
<p>e_ehsize:</p>
<p>这2字节是ELF文件头大小,以字节为单位.
Android系统,不检查这2字节,默认ELF文件头大小为52字节.
IDA检查了这2字节,如果我们修改了这2字节内容.IDA只会产生警告,影响不大,仍然可以反汇编.</p>
<p>e_phentsize:</p>
<p>这2字节表明程序头表每一个表项的大小,以字节为单位.</p>
<p>e_phnum:</p>
<p>这2字节表明程序头表总共有多少表项,如果没有程序头表,该值应设为0.</p>
<p>e_shentsize:</p>
<p>这2字节表明节头表每一个表项的大小,以字节为单位.</p>
<p>e_shnum:</p>
<p>这2字节表明节头表总共有多少表项,如果没有节头表,该值应设为0.</p>
<p>e_shstrndx:</p>
<p>这2字节是节头表中与节名字表相对应表项的索引.</p>
<h3 id="节" class="heading-element"><span>节</span>
  <a href="#%e8%8a%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">sh_name</span><span class="p">;</span>       <span class="c1">//节名字
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_type</span><span class="p">;</span>       <span class="c1">//节类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_flags</span><span class="p">;</span>      <span class="c1">//节内存属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Addr</span> <span class="n">sh_addr</span><span class="p">;</span>       <span class="c1">//内存地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Off</span> <span class="n">sh_offset</span><span class="p">;</span>      <span class="c1">//文件偏移
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_size</span><span class="p">;</span>       <span class="c1">//节大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_link</span><span class="p">;</span>       <span class="c1">//一个索引值,指向节头表中本节所对应的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_info</span><span class="p">;</span>       <span class="c1">//节的附加信息,根据节的类型不同,本成员的意义也有所不同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_addralign</span><span class="p">;</span>  <span class="c1">//对齐值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_entsize</span><span class="p">;</span>    <span class="c1">//有一些节的内容是一张表,其中每一个表项的大小是固定的,比如符号表.对于这种表来说,本成员指定其每一个表项的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Shdr</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>sh_name:</p>
<p>4字节,是个偏移值,暂记为P1.
首先通过ELF文件头最后一项e_shstrndx拿到节表中节名称表对应表项的索引,
然后在节表中找到该项,找到sh_offset文件偏移值,暂记为P2
最后将P1 + P2,即可得到该节名字的字符串文件偏移值.</p>
<p>sh_type:</p>
<p>4字节,节类型.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">enum</span> <span class="err">&lt;</span><span class="nc">Elf32_Word</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_NULL</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="cm">/* Inactive section header */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_PROGBITS</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> <span class="cm">/* Information defined by the program */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_SYMTAB</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span> <span class="cm">/* Symbol table - not DLL */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_STRTAB</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span> <span class="cm">/* String table */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_RELA</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="cm">/* Explicit addend relocations, Elf64_Rela */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_HASH</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span> <span class="cm">/* Symbol hash table */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_DYNAMIC</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span> <span class="cm">/* Information for dynamic linking */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_NOTE</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span> <span class="cm">/* A Note section */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_NOBITS</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span> <span class="cm">/* Like SHT_PROGBITS with no data */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_REL</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span> <span class="cm">/* Implicit addend relocations, Elf64_Rel */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_SHLIB</span> <span class="o">=</span> <span class="mh">0xA</span><span class="p">,</span> <span class="cm">/* Currently unspecified semantics */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_DYNSYM</span> <span class="o">=</span> <span class="mh">0xD</span><span class="p">,</span> <span class="cm">/* Symbol table for a DLL */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_INIT_ARRAY</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">,</span> <span class="cm">/* Array of constructors */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_FINI_ARRAY</span> <span class="o">=</span> <span class="mh">0xF</span><span class="p">,</span> <span class="cm">/* Array of deconstructors */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_PREINIT_ARRAY</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* Array of pre-constructors */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GROUP</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span> <span class="cm">/* Section group */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_SYMTAB_SHNDX</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span> <span class="cm">/* Extended section indeces */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_NUM</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span> <span class="cm">/* Number of defined types */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">SHT_LOOS</span> <span class="o">=</span> <span class="mh">0x60000000</span><span class="p">,</span> <span class="cm">/* Lowest OS-specific section type */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNU_ATTRIBUTES</span> <span class="o">=</span> <span class="mh">0x6ffffff5</span><span class="p">,</span> <span class="cm">/* Object attribuytes */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNU_HASH</span> <span class="o">=</span> <span class="mh">0x6ffffff6</span><span class="p">,</span> <span class="cm">/* GNU-style hash table */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNU_LIBLIST</span> <span class="o">=</span> <span class="mh">0x6ffffff7</span><span class="p">,</span> <span class="cm">/* Prelink library list */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_CHECKSUM</span> <span class="o">=</span> <span class="mh">0x6ffffff8</span><span class="p">,</span> <span class="cm">/* Checksum for DSO content */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_LOSUNW</span> <span class="o">=</span> <span class="mh">0x6ffffffa</span><span class="p">,</span> <span class="cm">/* Sun-specific low bound */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_SUNW_move</span> <span class="o">=</span> <span class="mh">0x6ffffffa</span><span class="p">,</span> <span class="c1">// Same thing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">SHT_SUNW_COMDAT</span> <span class="o">=</span> <span class="mh">0x6ffffffb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_SUNW_syminfo</span> <span class="o">=</span> <span class="mh">0x6ffffffc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNU_verdef</span> <span class="o">=</span> <span class="mh">0x6ffffffd</span><span class="p">,</span> <span class="cm">/* Version definition section */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNU_verdneed</span> <span class="o">=</span> <span class="mh">0x6ffffffe</span><span class="p">,</span> <span class="cm">/* Version needs section */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_GNY_versym</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Version symbol table */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_HISUNW</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Sun-specific high bound */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_HIOS</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Highest OS-specific section type */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_LOPROC</span> <span class="o">=</span> <span class="mh">0x70000000</span><span class="p">,</span> <span class="cm">/* Start of processor-specific section type */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_HIPROC</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">,</span> <span class="cm">/* End of processor-specific section type */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_LOUSER</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="cm">/* Start of application-specific */</span>
</span></span><span class="line"><span class="cl"> <span class="n">SHT_HIUSER</span> <span class="o">=</span> <span class="mh">0x8fffffff</span> <span class="cm">/* Ennd of application-specific */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">s_type32_e</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>sh_flags:</p>
<p>4字节,由一系列标志比特位组成.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_flags.png" alt="sh_flags" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_flags.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_flags.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_flags.png?size=large 2x" data-title="sh_flags" style="--width: 807px;--aspect-ratio: 807 / 416;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>sh_addr:</p>
<p>4字节,内存地址.</p>
<p>sh_offset:</p>
<p>4字节,文件偏移.</p>
<p>sh_size:</p>
<p>4字节,节大小.</p>
<p>sh_link:</p>
<p>4字节,一个索引值,指向节头表中本节所对应的位置.</p>
<p>sh_info:</p>
<p>4字节,节的附加信息,根据节的类型不同,本成员的意义也有所不同.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_info.png" alt="sh_info" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_info.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_info.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/sh_info.png?size=large 2x" data-title="sh_info" style="--width: 1340px;--aspect-ratio: 1340 / 695;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>sh_addralign:</p>
<p>4字节, 对齐值.</p>
<p>sh_entsize:</p>
<p>4字节,有一些节的内容是一张表,其中每一个表项的大小是固定的,比如符号表,对于这种表来说,本成员指定其每一个表项的大小.</p>
<h3 id="特殊节" class="heading-element"><span>特殊节</span>
  <a href="#%e7%89%b9%e6%ae%8a%e8%8a%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/*节名字不重要,重要的是节的类型.
</span></span></span><span class="line"><span class="cl"><span class="cm">当节名字未被修改过,是具有参考价值的.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">shstrtab</span> <span class="err">节名称表</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">text</span>     <span class="err">代码段</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">bss</span>      <span class="err">数据段</span><span class="p">(</span><span class="err">未初始化</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">data</span>     <span class="err">数据段</span><span class="p">(</span><span class="err">初始化</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">rodata</span>   <span class="err">常量区</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1">//ndk的版本信息,仅供参考
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="n">ident</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">build</span> <span class="o">-</span> <span class="n">id</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">gold</span> <span class="o">-</span> <span class="n">version</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//编译器版本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">comment</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version_r</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">attributes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//调试信息,等价于PDB文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">debug_str</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_abbrev</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_info</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_macinfo</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_frame</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_line</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_loc</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_ranges</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">debug_aranges</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//初始化表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">init_array</span> <span class="c1">//初始化函数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">fini_array</span> <span class="c1">//反初始化函数表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//异常表, 不是ELF的标准,是由操作系统和编译器自定义的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">exidx</span>  <span class="c1">//索引表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">extab</span>  <span class="c1">//异常表
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="符号表" class="heading-element"><span>符号表</span>
  <a href="#%e7%ac%a6%e5%8f%b7%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//符号表
</span></span></span><span class="line"><span class="cl"><span class="c1">//当打包为apk,里面的动态库只有.dynsym
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">dynsym</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">symtab</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//符号表字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">dynstr</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="n">strtab</span></span></span></code></pre></td></tr></table>
</div>
</div><p>符号表项结构:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">st_name</span><span class="p">;</span>     <span class="c1">//符号的名字,指向字符串表的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Addr</span> <span class="n">st_value</span><span class="p">;</span>    <span class="c1">//符号的值, 地址, 是个RVA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">st_size</span><span class="p">;</span>     <span class="c1">//符号的大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_info</span><span class="p">;</span>  <span class="c1">//符号的类型和属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_other</span><span class="p">;</span> <span class="c1">//暂未使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Half</span> <span class="n">st_shndx</span><span class="p">;</span>    <span class="c1">//一个索引值,指向相关联的节在节头表中的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Sym</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>符号表描述了导入和导出,st_value的值为非0,表示是导出为0,则表示是导入.</p>
<p>st_name:</p>
<p>指向字符串表的索引,节头表中的link值说明了是哪个字符串表.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_name.png" alt="st_name" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_name.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_name.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_name.png?size=large 2x" data-title="st_name" style="--width: 1938px;--aspect-ratio: 1938 / 841;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>st_info:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_BIND(i) ((i)&gt;&gt;4) 
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_TYPE(i) ((i)&amp;0xf) 
</span></span></span><span class="line"><span class="cl"><span class="cp">#define ELF32_ST_INFO(b,t) (((b)&lt;&lt;4)+((t)&amp;0xf))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>高4字节是符号绑定.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png" alt="符号绑定" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png?size=large 2x" data-title="符号绑定" style="--width: 514px;--aspect-ratio: 514 / 488;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>低4字节是符号类型.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png" alt="符号类型" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png?size=large 2x" data-title="符号类型" style="--width: 538px;--aspect-ratio: 538 / 644;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>st_shndx:</p>
<p>这里我们导出一个全局变量,来理解下这个字段的意思.</p>
<p>源代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">g_n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello ELF! %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>分析:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx1.png" alt="st_shndx1" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx1.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx1.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx1.png?size=large 2x" data-title="st_shndx1" style="--width: 1946px;--aspect-ratio: 1946 / 796;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>从上图中可以看到,导出的全局变量g_n的RVA为0x2000,大小为4字节,st_shndx字段为22.
那么这个全局变量的值在文件偏移的哪个地方记录呢?
我们去节头表中的第22项看下.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx2.png" alt="st_shndx2" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx2.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx2.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/st_shndx2.png?size=large 2x" data-title="st_shndx2" style="--width: 1969px;--aspect-ratio: 1969 / 1208;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>节头表的第22项,所在的RVA是0x2000,FOA是0x1000,
而全局变量g_n的RVA为0x2000,大小为4字节,
也就是说文件偏移0x1000的地方开始是4字节内容就是全局变量的值,100.</p>
<h3 id="哈希表" class="heading-element"><span>哈希表</span>
  <a href="#%e5%93%88%e5%b8%8c%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//哈希表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">hash</span>      <span class="c1">//旧版,导入导出均可查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">hash</span> <span class="c1">//新版,效率高,只可查导出
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>旧版(.hash):</p>
<p>哈希表结构:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png" alt="哈希表结构" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png?size=large 2x" data-title="哈希表结构" style="--width: 548px;--aspect-ratio: 548 / 311;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>Bucket数组中含有nbucket个项,chain数组中含有nchain个项,序号都从0开始.
Bucket和chain中包含的都是符号表中的索引.hash有可能冲突,chain里面放的就是所有冲突的.
给定一个符号名字,返回一个哈希值x,然后由bucket[x%nbucket]得到一个符号表索引y,
如果索引y对应的符号表项不是想要的符号(通过对比名字),则由chain[y]得到下一个符号表索引z,如果仍不是想要的符号,继续chain[z]…,
如果chain[z]的值为0,说明该符号不存在.</p>
<p>哈希算法:</p>
<p>原始算法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">elf_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Android中的hash算法:</p>
<p>Google并没有用原始的hash算法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//http://androidxref.com/4.0.3_r1/xref/bionic/linker/linker.c#elfhash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>示例:</p>
<p>环境:解压AndroidStudio编译出来的Release版apk,查看其中的so文件.</p>
<p>目标:查找main这个符号.</p>
<ol>
<li>查看.hash数据.</li>
</ol>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png" alt="哈希表示例1" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png?size=large 2x" data-title="哈希表示例1" style="--width: 1857px;--aspect-ratio: 1857 / 1228;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>可以得到:
nbucket = 0x11
nchain = 0x14</p>
<ol start="2">
<li>计算hash%nbucket.</li>
</ol>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png" alt="哈希表示例2" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png?size=large 2x" data-title="哈希表示例2" style="--width: 1168px;--aspect-ratio: 1168 / 826;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>得到的结果y = 10.</p>
<ol start="3">
<li>查找main.</li>
</ol>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png" alt="哈希表示例3" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png?size=large 2x" data-title="哈希表示例3" style="--width: 1927px;--aspect-ratio: 1927 / 1084;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>y = 10,bucket[y] = 7,查看动态符号表的第7项不是main,
chain[7] =  3,查看动态符号表的第3项不是main,
chain[3] = 0x11,查看动态符号表的第17项是main.</p>
<h3 id="过程链接表" class="heading-element"><span>过程链接表</span>
  <a href="#%e8%bf%87%e7%a8%8b%e9%93%be%e6%8e%a5%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">.</span><span class="n">plt</span> <span class="c1">//过程链接,Procedure Link Table
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>外部调用的跳板,是个代理函数.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png" alt="程序链接表" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png?size=large 2x" data-title="程序链接表" style="--width: 1956px;--aspect-ratio: 1956 / 965;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>IDA是通过节表拿到plt节的地址,从而解析plt函数的.
从上图中可以看到每两个plt函数之间的大小为12字节,
假如我们将节表中plt节的偏移加12字节的倍数,IDA解析api就会错位,实际上也确是如此.
这样修改之后不会影响程序的运行,因为程序的运行是不需要节表的.</p>
<h3 id="全局偏移表" class="heading-element"><span>全局偏移表</span>
  <a href="#%e5%85%a8%e5%b1%80%e5%81%8f%e7%a7%bb%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">.</span><span class="n">got</span> <span class="c1">//等价于PE中的IAT表,Global Offset Table
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>记录外部调用的入口地址.</p>
<p>plt和got的关系:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//每调一个api,编译器就会生成一个plt函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">g_printf</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * plt:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   jmp [got]
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * got:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   load1
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * load1:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   dlopen
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   dlsym
</span></span></span><span class="line"><span class="cl"><span class="cm"> *   got = addr
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="重定位表" class="heading-element"><span>重定位表</span>
  <a href="#%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">plt</span> <span class="c1">//修api地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">dyn</span> <span class="c1">//修全局变量
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>项结构:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Addr</span> <span class="n">r_offset</span><span class="p">;</span> <span class="c1">//Rva,修完之后放在哪里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">r_info</span><span class="p">;</span>   <span class="c1">//既给出了重定位所作用的符号表索引,也给出了重定位的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Addr</span> <span class="n">r_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">r_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Sword</span> <span class="n">r_addend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Rela</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>r_info 的宏定义:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#define ELF32_R_SYM(i) ((i)&gt;&gt;8)               </span><span class="c1">//高24位是符号表索引,修的位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define ELF32_R_TYPE(i) ((unsigned char)(i))  </span><span class="c1">//低8位是重定位的类型,如何修
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define ELF32_R_INFO(s,t) (((s)&lt;&lt;8)+(unsigned char)(t))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>示例:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png" alt="重定位表1" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png?size=large 2x" data-title="重定位表1" style="--width: 1882px;--aspect-ratio: 1882 / 1250;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>Elf32_Xword s_entsize = 8, 表示每项为8字节
第一项为 F0 1F 00 00 16 02 00 00
r_offset: 0x1FF0
符号表索引:0x02
重定位类型:0x16</p>
<p>IDA查看偏移:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png" alt="重定位表2" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png?size=large 2x" data-title="重定位表2" style="--width: 1319px;--aspect-ratio: 1319 / 302;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>符号表第2项:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png" alt="重定位表3" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png?size=large 2x" data-title="重定位表3" style="--width: 1903px;--aspect-ratio: 1903 / 480;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="动态节" class="heading-element"><span>动态节</span>
  <a href="#%e5%8a%a8%e6%80%81%e8%8a%82" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">.</span><span class="n">dynamic</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*这里存放了软件运行时所需要的表,操作系统是从这里拿表的.
</span></span></span><span class="line"><span class="cl"><span class="cm">但是这样说又有点矛盾,因为我们前面讲软件的运行是不需要节表的.
</span></span></span><span class="line"><span class="cl"><span class="cm">那么操作系统不通过节表,如何拿到动态节的地址? 段中有描述.*/</span></span></span></code></pre></td></tr></table>
</div>
</div><p>项结构:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Sword</span> <span class="n">d_tag</span><span class="p">;</span>     <span class="c1">//什么表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">union</span> <span class="p">{</span>                 <span class="c1">//在哪里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Elf32_Word</span> <span class="n">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Elf32_Addr</span> <span class="n">d_ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span> <span class="n">d_un</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Dyn</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>d_tag:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/d_tag.png" alt="d_tag" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/d_tag.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/d_tag.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/d_tag.png?size=large 2x" data-title="d_tag" style="--width: 1343px;--aspect-ratio: 1343 / 2371;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>DT_NEEDED:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/DT_NEEDED.png" alt="DT_NEEDED" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/DT_NEEDED.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/DT_NEEDED.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/DT_NEEDED.png?size=large 2x" data-title="DT_NEEDED" style="--width: 1947px;--aspect-ratio: 1947 / 958;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这里面存放的是软件运行所需要的动态库.
前面我们讲符号表和重定位表,都没有提到对应的api在哪个库里面.
假设软件运行需要两个库,libc.so、 libm.so
现在有一个api,操作系统会看这个api在libc.so里面没,
如果不在,就去看libm.so里面有没有这个导出函数.
操作系统就这样遍历需要加载的库,就知道对应的api在哪个库里面了.</p>
<h3 id="程序头表" class="heading-element"><span>程序头表</span>
  <a href="#%e7%a8%8b%e5%ba%8f%e5%a4%b4%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>用来保存程序加载到内存中所需要的信息,用段(segment)来表示,与节头表类似,同样是数组结构.
数组的位置在偏移e_phoff处,每个元素(segment header)的大小为e_phentsize,共有e_phnum个元素.</p>
<p>程序头结构:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">p_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Off</span>  <span class="n">p_offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Addr</span> <span class="n">p_vaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Addr</span> <span class="n">p_paddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">p_filesz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">p_memsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">p_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">Elf32_Word</span> <span class="n">p_align</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">Elf32_Phdr</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>p_type:</p>
<p>类型
PT_NULL:表示该段未使用.
PT_LOAD:表示要将文件中的segment内容映射到进程内存中对应的地址上.
PT_DYNAMIC:动态节.
PT_INTERP:包含interpreter的路径.
PT_HDR:表示程序头表本身.</p>
<p>p_offset:</p>
<p>该段的文件偏移.</p>
<p>p_vaddr:</p>
<p>段数据应该加载到进程的虚拟地址.</p>
<p>p_paddr:</p>
<p>段数据应该加载到进程的物理地址.</p>
<p>p_filesz:</p>
<p>该段的文件大小.</p>
<p>p_memsz:</p>
<p>该段的内存大小.</p>
<p>p_flags:</p>
<p>段的内存属性.</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/p_flags.png" alt="p_flags" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/p_flags.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/p_flags.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/p_flags.png?size=large 2x" data-title="p_flags" style="--width: 848px;--aspect-ratio: 848 / 432;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>p_align:</p>
<p>该段数据的对齐值.</p>
<p>段示例:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png" alt="段示例" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png?size=large 2x" data-title="段示例" style="--width: 1917px;--aspect-ratio: 1917 / 418;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="攻防对抗" class="heading-element"><span>攻防对抗</span>
  <a href="#%e6%94%bb%e9%98%b2%e5%af%b9%e6%8a%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h4 id="动态运行-修改api地址" class="heading-element"><span>动态运行-修改API地址</span>
  <a href="#%e5%8a%a8%e6%80%81%e8%bf%90%e8%a1%8c-%e4%bf%ae%e6%94%b9api%e5%9c%b0%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>要实现的效果是,代码中动态调用libc.so库中的exit函数,通过修改libc.so符号表中的exit函数的地址为任意函数地址,从而使在IDA中静态分析,看到的是调用exit函数,实际上调用的是其他函数.函数前加static关键字,可使该函数不导出.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOINFO_NAME_LEN 128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="nc">soinfo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SOINFO_NAME_LEN</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">phdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">phnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>  <span class="c1">// DO NOT USE, maintained for compatibility.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">dynamic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">wrprotect_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">wrprotect_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">symtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">nbucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">nchain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">bucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">plt_got</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">plt_rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">plt_rel_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">rel_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">plt_rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">plt_rela_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">rela_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">preinit_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">preinit_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">init_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">init_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">fini_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">fini_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ARM_exidx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">ARM_exidx_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">refcount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取模块基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">get_module_base</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">moduleName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/self/maps&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fopen&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">FillSoInfoStruct</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szLibName</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//获取libc.so的模块基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">get_module_base</span><span class="p">(</span><span class="n">szLibName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">libc_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">//拿动态节地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">elf32_hdr</span><span class="o">*</span> <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_hdr</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">elf32_phdr</span><span class="o">*</span> <span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="n">dyn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_DYNAMIC</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">dyn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Dyn</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">dyn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;dyn = %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dyn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//遍历表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//遍历表的操作, Android源码中有写,这里查看的是Android 4.0.3_r1版本的源码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//在xref: /bionic/linker/linker.c中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//搜索DT_HASH
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">;</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nchain</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取函数名对应的符号表的下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">GetSymtabIndex</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szFuncName</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//查询hash表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">elfhash</span><span class="p">(</span><span class="n">szFuncName</span><span class="p">)</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_name</span><span class="p">,</span> <span class="n">szFuncName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//替换后的函数
</span></span></span><span class="line"><span class="cl"><span class="c1">//加static,可使该函数不导出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">fun2</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">fun1</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//soinfo结构体是操作系统内部的结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">soinfo</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//填充soinfo结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FillSoInfoStruct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="s">&#34;libc.so&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">    <span class="c1">//获取libc.so库中的exit函数在符号表中的下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">GetSymtabIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="s">&#34;exit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//修改libc.so库中的exit函数地址为fun2的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">.</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="p">.</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">fun2</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pfnEXIT</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//直接调exit(0), 走的是plt函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="s">&#34;libc.so&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pfnEXIT</span> <span class="n">pfnExit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pfnEXIT</span><span class="p">)</span><span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&#34;exit&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pfnExit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/%E5%8A%A8%E6%80%81%E8%B0%83%E7%94%A8%E4%BF%AE%E6%94%B9api%E5%9C%B0%E5%9D%80.7z">动态调用修改api地址.7z</a></p>
<h4 id="got表hook" class="heading-element"><span>Got表Hook</span>
  <a href="#got%e8%a1%a8hook" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOINFO_NAME_LEN 128
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">struct</span> <span class="nc">soinfo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SOINFO_NAME_LEN</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">phdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">phnum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>  <span class="c1">// DO NOT USE, maintained for compatibility.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">dynamic</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">wrprotect_start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">wrprotect_end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">soinfo</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">symtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">nbucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">nchain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">bucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">plt_got</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">plt_rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">plt_rel_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">rel_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">plt_rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">plt_rela_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">rela</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">rela_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">preinit_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">preinit_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">init_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">init_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">fini_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">fini_array_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ARM_exidx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">ARM_exidx_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">refcount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取模块基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">get_module_base</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">moduleName</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/self/maps&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fopen&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">FillSoInfoStruct</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szLibName</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//获取模块基址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">get_module_base</span><span class="p">(</span><span class="n">szLibName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">libc_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//拿动态节地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">elf32_hdr</span><span class="o">*</span> <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_hdr</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">elf32_phdr</span><span class="o">*</span> <span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="n">dyn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_DYNAMIC</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">dyn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Dyn</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">dyn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//遍历表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//遍历表的操作, Android源码中有写,这里查看的是Android 4.0.3_r1版本的源码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//在xref: /bionic/linker/linker.c中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//搜索DT_HASH
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">;</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nchain</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//第一个重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">si</span><span class="o">-&gt;</span><span class="n">plt_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Rel</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">plt_rel_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//第二个重定位表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">si</span><span class="o">-&gt;</span><span class="n">rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Rel</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">si</span><span class="o">-&gt;</span><span class="n">rel_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//获取函数名对应的符号表的下标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">GetSymtabIndex</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szFuncName</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//查询hash表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">elfhash</span><span class="p">(</span><span class="n">szFuncName</span><span class="p">)</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_name</span><span class="p">,</span> <span class="n">szFuncName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">nIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">fun1</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">size_t</span> <span class="nf">FakeStrlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="nf">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">PFN_STRLEN</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">g_oldpfn</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PFN_STRLEN</span> <span class="n">g_pfnstrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">LuoHook</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">lib</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span><span class="o">**</span> <span class="n">OldAddr</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 1.找到strlen符号索引(哈希表,符号表,字符串表)
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 2.遍历重定位表,修改got地址(重定位表)
</span></span></span><span class="line"><span class="cl"><span class="cm">     **/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//soinfo结构体是操作系统内部的结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">soinfo</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//填充soinfo结构体
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FillSoInfoStruct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">lib</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">GetSymtabIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//修改.rel.plt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">si</span><span class="p">.</span><span class="n">plt_rel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断符号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">plt_rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">nIndex</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//找到Got地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">void</span><span class="o">**</span> <span class="n">got</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)(</span><span class="n">si</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">si</span><span class="p">.</span><span class="n">plt_rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//修改内存保护属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size_t</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">got</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pageSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">pageSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;mprotect&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//保存旧的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">*</span><span class="n">OldAddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">got</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//修改got地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">*</span><span class="n">got</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//.rel.dyn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">si</span><span class="p">.</span><span class="n">rel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//判断符号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">nIndex</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//找到Got地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">void</span><span class="o">**</span> <span class="n">got</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)(</span><span class="n">si</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">si</span><span class="p">.</span><span class="n">rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//修改内存保护属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size_t</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">got</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pageSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">pageSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;mprotect&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//保存旧的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">*</span><span class="n">OldAddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">got</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//修改got地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">*</span><span class="n">got</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Got表Hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//遍历重定位表,修改got地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//有两个重定位表都需要来修
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//.rel.plt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// .rel.dyn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LuoHook</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/luoelf&#34;</span><span class="p">,</span> <span class="s">&#34;strlen&#34;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">FakeStrlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_oldpfn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_pfnstrlen</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//局部变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PFN_STRLEN</span> <span class="n">pfnStrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pfnStrlen</span><span class="p">(</span><span class="s">&#34;12&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//直接调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&#34;123&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/Got%E8%A1%A8Hook.7z">Got表Hook.7z</a></p>
<h4 id="阅读系统加载动态节数据源码" class="heading-element"><span>阅读系统加载动态节数据源码</span>
  <a href="#%e9%98%85%e8%af%bb%e7%b3%bb%e7%bb%9f%e5%8a%a0%e8%bd%bd%e5%8a%a8%e6%80%81%e8%8a%82%e6%95%b0%e6%8d%ae%e6%ba%90%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png" alt="系统加载动态节数据源码" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png?size=large 2x" data-title="系统加载动态节数据源码" style="--width: 2027px;--aspect-ratio: 2027 / 1370;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>从以上代码,我们能够发现两个问题,
①系统读取动态节数据,并没有拿动态节的大小字段,而是通过*d,判断是否是0,若是0,就结束.
②动态节每项8字节,描述了什么表,在哪里.如果动态节中有重复的表,会以最后的表为准(重复的,最后一个会将前面的覆盖掉),这样我们可以在原始动态节的后面伪造数据,只要动态节的结尾是0即可.我们可以将原始动态节的其中一个表多伪造几组假数据,只要动态节的最后,这个表记录的地址是原始的即可.这样修改后,IDA静态分析不会出错,但是IDA的动态调试就会出现问题.</p>
<h4 id="抹除文件格式" class="heading-element"><span>抹除文件格式</span>
  <a href="#%e6%8a%b9%e9%99%a4%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>我们知道程序的运行是不需要节的,需要的是段,因为段描述了内存映射.
但是当程序运行起来的时候,内存已经映射完成,此时我们可以将ELF文件的头以及程序头表抹除,
这样不会影响程序的运行,可以防止别人内存Dump.
如何破这一招?
内存可以抹除文件格式,但是文件不可以,我们可以先内存Dump,
然后从文件中将ELF文件的头以及程序头表复制到Dump出来的文件中.</p>
<h4 id="重建节表" class="heading-element"><span>重建节表</span>
  <a href="#%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h4><p>IDA在解析ELF文件时,会去拿节表中的值,来提高反汇编的效果.而软件的运行,是不需要节表的.所以我们可以修改节表中的内容,来欺骗IDA.如修改节表代码段中的文件偏移或者大小,或者数据段已初始化节中的文件偏移或大小等.</p>
<p>我们如何预防别人这样的操作呢?
我们将节表删了(即将ELF文件头中的e_shoff设置为0)用IDA分析,来和未删节表前来进行对比.</p>
<p>没有节表,IDA的反汇编效果很差,但是有节表,又担心被骗,我们可以根据段来重建节表.</p>
<p>节和段的关系:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png" alt="重建节表" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png?size=large 2x" data-title="重建节表" style="--width: 1254px;--aspect-ratio: 1254 / 790;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>plt:</p>
<p>结构:</p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png" alt="重建节表1" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png?size=large 2x" data-title="重建节表1" style="--width: 1950px;--aspect-ratio: 1950 / 978;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png" alt="重建节表2" srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png?size=small, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png?size=medium 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png?size=large 2x" data-title="重建节表2" style="--width: 1864px;--aspect-ratio: 1864 / 978;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>FOA:</p>
<p>DT_JMPREL表的FOA + SIZE,就是plt表的FOA.</p>
<p>SIZE:</p>
<p>遍历段中的DT_JMPREL,拿重定位的api项数,记为x,plt的头为20字节,每个plt项12字节,则plt节的大小为 12 * x + 20.</p>
<p>text:</p>
<p>FOA:</p>
<p>plt表的FOA + SIZE,就是text表的FOA.</p>
<p>SIZE:</p>
<p>PT_SHT_ARM_EXIDX表的FOA - (plt表的FOA + plt表的SIZE).</p>
<p>数据段:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">.</span><span class="n">data</span> <span class="c1">//初始化数据段,占空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="n">bss</span>  <span class="c1">//未初始化数据段,不占空间
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>根据程序头表中的内存映射,来区分是.data还是.bss,映射内存的是.data,否则是.bss.</p>
<h3 id="参考链接" class="heading-element"><span>参考链接</span>
  <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/ELF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90.pdf">ELF文件格式解析</a></p>
</div><hr class="awesome-hr" />
    <h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" title="Dex文件格式">Dex文件格式</a></li><li>
          <a href="/posts/android/android%E5%9F%BA%E7%A1%80/arm%E9%80%86%E5%90%91/" title="Arm逆向">Arm逆向</a></li><li>
          <a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E8%BF%9B%E9%98%B6/" title="NDK进阶">NDK进阶</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2021-11-19 00:00:00">更新于 2021-11-19&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/android/" class="post-tag" title="标签 - Android">Android</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" class="post-nav-item" rel="prev" title="Dex文件格式"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Dex文件格式</a><a href="/posts/android/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/kali%E9%85%8D%E7%BD%AE/" class="post-nav-item" rel="next" title="Kali配置">Kali配置<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">夏洛魂</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/pace/themes/purple/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"enable":false},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":true,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":1,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"version":"v0.3.16"};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
