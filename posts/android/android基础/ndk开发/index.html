<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>NDK开发 - 夏洛魂的个人博客</title><meta name="Description" content="个人笔记本"><meta property="og:title" content="NDK开发" />
<meta property="og:description" content="NDK开发 概述 全称:Native Development Kit,可让您使用C和C&#43;&#43;等语言以原生代码实现应用的各个部分. 网址 https://developer.android.google.cn/ndk 文件类型 1 2 3 .o 等同于.Obj .a 等同" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-21T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="NDK开发"/>
<meta name="twitter:description" content="NDK开发 概述 全称:Native Development Kit,可让您使用C和C&#43;&#43;等语言以原生代码实现应用的各个部分. 网址 https://developer.android.google.cn/ndk 文件类型 1 2 3 .o 等同于.Obj .a 等同"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/android%E5%BC%80%E5%8F%91/" /><link rel="next" href="https://XiaLuoHun.github.io/posts/android/androidhook/frida%E4%BD%BF%E7%94%A8/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "NDK开发",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/ndk%E5%BC%80%E5%8F%91\/"
        },"genre": "posts","keywords": "NDK开发","wordcount":  7367 ,
        "url": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/ndk%E5%BC%80%E5%8F%91\/","datePublished": "2021-10-21T00:00:00+00:00","dateModified": "2021-10-21T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "夏洛魂"},"author": {
                "@type": "Person",
                "name": "夏洛魂"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夏洛魂的个人博客">主页</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夏洛魂的个人博客">主页</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于作者</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">NDK开发</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>夏洛魂</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/android%E5%9F%BA%E7%A1%80/"><i class="far fa-folder fa-fw"></i>Android基础</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-10-21">2021-10-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 7367 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 15 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ndk开发">NDK开发</a>
      <ul>
        <li><a href="#概述">概述</a>
          <ul>
            <li><a href="#网址">网址</a></li>
            <li><a href="#文件类型">文件类型</a></li>
          </ul>
        </li>
        <li><a href="#编译器">编译器</a>
          <ul>
            <li><a href="#编译示例">编译示例</a>
              <ul>
                <li><a href="#编译">编译</a></li>
                <li><a href="#链接">链接</a></li>
                <li><a href="#将生成的文件传到手机上运行">将生成的文件传到手机上运行</a></li>
                <li><a href="#注意">注意</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#通用编译脚本">通用编译脚本</a>
          <ul>
            <li><a href="#makefile">Makefile</a>
              <ul>
                <li><a href="#概述-1">概述</a>
                  <ul>
                    <li><a href="#效率">效率</a></li>
                    <li><a href="#语法参考">语法参考</a></li>
                  </ul>
                </li>
                <li><a href="#ndk-build脚本">ndk-build脚本</a>
                  <ul>
                    <li><a href="#手工编译示例">手工编译示例</a></li>
                    <li><a href="#利用androidstudio来编译">利用AndroidStudio来编译</a></li>
                    <li><a href="#注意-1">注意</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#cmake编译android主推">Cmake编译(Android主推)</a></li>
          </ul>
        </li>
        <li><a href="#静态库">静态库</a>
          <ul>
            <li><a href="#编译-1">编译</a>
              <ul>
                <li><a href="#手工编译">手工编译</a>
                  <ul>
                    <li><a href="#mou1h">mou1.h</a></li>
                    <li><a href="#mou1c">mou1.c</a></li>
                    <li><a href="#mainc">main.c</a></li>
                    <li><a href="#makefile-1">Makefile</a></li>
                  </ul>
                </li>
                <li><a href="#ndk-build">ndk-build</a></li>
                <li><a href="#cmake编译">Cmake编译</a></li>
              </ul>
            </li>
            <li><a href="#cmake使用第三方静态库">Cmake使用第三方静态库</a></li>
            <li><a href="#优点">优点</a></li>
            <li><a href="#缺点">缺点</a></li>
          </ul>
        </li>
        <li><a href="#动态库">动态库</a>
          <ul>
            <li><a href="#编译-2">编译</a>
              <ul>
                <li><a href="#手动编译">手动编译</a>
                  <ul>
                    <li><a href="#makefile-2">Makefile</a></li>
                    <li><a href="#报错处理">报错处理</a>
                      <ul>
                        <li><a href="#共享库搜索路径">共享库搜索路径</a></li>
                        <li><a href="#示例">示例</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li><a href="#ndk-build-1">ndk-build</a></li>
                <li><a href="#cmake编译-1">Cmake编译</a></li>
              </ul>
            </li>
            <li><a href="#优点-1">优点</a></li>
            <li><a href="#缺点-1">缺点</a></li>
            <li><a href="#查看导出函数">查看导出函数</a></li>
            <li><a href="#函数不导出">函数不导出</a></li>
            <li><a href="#初始化函数">初始化函数</a>
              <ul>
                <li><a href="#不常用">不常用</a></li>
                <li><a href="#常用">常用</a></li>
              </ul>
            </li>
            <li><a href="#动态使用">动态使用</a>
              <ul>
                <li><a href="#相关函数">相关函数</a></li>
                <li><a href="#示例-1">示例</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#android-api">Android API</a>
          <ul>
            <li><a href="#ndk">NDK</a>
              <ul>
                <li><a href="#常用来打日志">常用来打日志</a></li>
                <li><a href="#添加库">添加库</a></li>
              </ul>
            </li>
            <li><a href="#posix">Posix</a>
              <ul>
                <li><a href="#errno">errno</a></li>
                <li><a href="#文件">文件</a>
                  <ul>
                    <li><a href="#相关函数-1">相关函数</a></li>
                    <li><a href="#文件控制">文件控制</a></li>
                    <li><a href="#文件属性">文件属性</a>
                      <ul>
                        <li><a href="#st_mode">st_mode</a></li>
                        <li><a href="#示例-2">示例</a></li>
                      </ul>
                    </li>
                    <li><a href="#目录权限">目录权限</a></li>
                    <li><a href="#权限检查算法">权限检查算法</a></li>
                    <li><a href="#示例-3">示例</a></li>
                  </ul>
                </li>
                <li><a href="#线程">线程</a>
                  <ul>
                    <li><a href="#两种状态">两种状态</a></li>
                    <li><a href="#终止线程">终止线程</a></li>
                    <li><a href="#线程同步">线程同步</a>
                      <ul>
                        <li><a href="#互斥体">互斥体</a></li>
                        <li><a href="#信号量">信号量</a></li>
                      </ul>
                    </li>
                    <li><a href="#示例-4">示例</a></li>
                  </ul>
                </li>
                <li><a href="#进程">进程</a>
                  <ul>
                    <li><a href="#相关函数-2">相关函数</a></li>
                    <li><a href="#创建进程">创建进程</a></li>
                    <li><a href="#虚拟文件系统">虚拟文件系统</a>
                      <ul>
                        <li><a href="#拿cpu信息">拿Cpu信息</a></li>
                        <li><a href="#遍历进程">遍历进程</a></li>
                        <li><a href="#遍历模块">遍历模块</a></li>
                        <li><a href="#读写内存">读写内存</a></li>
                        <li><a href="#进程状态">进程状态</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li><a href="#网络编程">网络编程</a>
                  <ul>
                    <li><a href="#常规socket">常规Socket</a>
                      <ul>
                        <li><a href="#服务端">服务端</a></li>
                        <li><a href="#客户端">客户端</a></li>
                      </ul>
                    </li>
                    <li><a href="#domain-socket">DoMain Socket</a>
                      <ul>
                        <li><a href="#服务端-1">服务端</a></li>
                        <li><a href="#客户端-1">客户端</a></li>
                        <li><a href="#注意-2">注意</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#混合编程jni">混合编程JNI</a>
          <ul>
            <li><a href="#概述-2">概述</a>
              <ul>
                <li><a href="#两边互调应满足以下条件">两边互调应满足以下条件</a></li>
                <li><a href="#名称规范问题">名称规范问题</a></li>
              </ul>
            </li>
            <li><a href="#java调c">Java调C++</a></li>
            <li><a href="#java反射">Java反射</a></li>
            <li><a href="#c调java">C++调Java</a>
              <ul>
                <li><a href="#c操作java中的字符串以及数组">C++操作Java中的字符串以及数组</a></li>
                <li><a href="#c反射调java">C++反射调Java</a></li>
                <li><a href="#加密">加密</a></li>
                <li><a href="#注意-3">注意</a></li>
              </ul>
            </li>
            <li><a href="#源代码">源代码</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="ndk开发">NDK开发</h1>
<h2 id="概述">概述</h2>
<p>全称:Native Development Kit,可让您使用C和C++等语言以原生代码实现应用的各个部分.</p>
<h3 id="网址">网址</h3>
<p><a href="https://developer.android.google.cn/ndk" target="_blank" rel="noopener noreffer">https://developer.android.google.cn/ndk</a></p>
<h3 id="文件类型">文件类型</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">.o 等同于.Obj
.a 等同于.lib
.so等同于.dll
</code></pre></td></tr></table>
</div>
</div><h2 id="编译器">编译器</h2>
<p>目前主要是clang编译器,Gcc编译器已被移除.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Gcc%e5%b7%b2%e8%a2%ab%e7%a7%bb%e9%99%a4.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Gcc%E5%B7%B2%E8%A2%AB%E7%A7%BB%E9%99%A4.png, images/Gcc%e5%b7%b2%e8%a2%ab%e7%a7%bb%e9%99%a4.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Gcc%E5%B7%B2%E8%A2%AB%E7%A7%BB%E9%99%A4.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Gcc%E5%B7%B2%E8%A2%AB%E7%A7%BB%E9%99%A4.png"
        title="Gcc已被移除" /></p>
<p>下载NDK,里面有Clang编译器.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Clang%e7%bc%96%e8%af%91%e5%99%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Clang%E7%BC%96%E8%AF%91%E5%99%A8.png, images/Clang%e7%bc%96%e8%af%91%e5%99%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Clang%E7%BC%96%E8%AF%91%E5%99%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Clang%E7%BC%96%E8%AF%91%E5%99%A8.png"
        title="Clang编译器" /></p>
<h3 id="编译示例">编译示例</h3>
<p>将Clang编译器所在目录加入到环境变量path中,这个目录中有很多做好的cmd文件(如:i686-linux-android16-clang.cmd).</p>
<p>假如说编译Hello.c</p>
<h4 id="编译">编译</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">i686-linux-android16-clang -c -o Hello.o Hello.c
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png, images/%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png"
        title="编译示例1" /></p>
<h4 id="链接">链接</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">i686-linux-android16-clang -o Hello Hello.o
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png, images/%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png"
        title="编译示例2" /></p>
<p>生成的Hello文件格式为Elf.</p>
<h4 id="将生成的文件传到手机上运行">将生成的文件传到手机上运行</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">//传文件到手机上
adb push Hello /data/local/tmp
//进入shell,修改/data/local/tmp/Hello路径权限为可执行
adb shell
chmod a+x /data/local/tmp/Hello
//运行程序
/data/local/tmp/Hello
</code></pre></td></tr></table>
</div>
</div><h4 id="注意">注意</h4>
<p>若要在手机上运行Hello这个程序,需要使用shell命令.若手机有Root权限,该Hello文件执行时也会有Root权限,但是apk文件不会具有Root权限,它只能得到一个带root权限的shell.</p>
<h2 id="通用编译脚本">通用编译脚本</h2>
<h3 id="makefile">Makefile</h3>
<h4 id="概述-1">概述</h4>
<p>假如说10个人开发一个软件,用VS是不行的.</p>
<p>Android NDK工具包中有makefile解释器.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/makefile%e8%a7%a3%e9%87%8a%e5%99%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/makefile%E8%A7%A3%E9%87%8A%E5%99%A8.png, images/makefile%e8%a7%a3%e9%87%8a%e5%99%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/makefile%E8%A7%A3%E9%87%8A%E5%99%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/makefile%E8%A7%A3%E9%87%8A%E5%99%A8.png"
        title="makefile解释器" /></p>
<h5 id="效率">效率</h5>
<p>当生成的某个obj文件没有发生变化时,不重新生成,提高编译效率,可通过判断obj生成时间和.c文件的生成时间,若前者大于后者,则说明不需要重新生成,否则就需要重新生成obj文件.</p>
<h5 id="语法参考">语法参考</h5>
<p><a href="https://github.com/seisman/how-to-write-makefile" target="_blank" rel="noopener noreffer">https://github.com/seisman/how-to-write-makefile</a></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/Makefile%E8%AF%AD%E6%B3%95%E5%8F%82%E8%80%83.pdf" rel="">Makefile语法参考.pdf</a></p>
<h4 id="ndk-build脚本">ndk-build脚本</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/ndk-build%e8%84%9a%e6%9c%ac.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E8%84%9A%E6%9C%AC.png, images/ndk-build%e8%84%9a%e6%9c%ac.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E8%84%9A%E6%9C%AC.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E8%84%9A%E6%9C%AC.png"
        title="ndk-build脚本" /></p>
<h5 id="手工编译示例">手工编译示例</h5>
<ol>
<li>将ndk-build.cmd所在的路径添加到系统环境变量中.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B1.png"
        title="手工编译示例1" /></p>
<ol start="2">
<li>将要编译的文件放到一个名为jni或cpp的文件夹中.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B2.png"
        title="手工编译示例2" /></p>
<ol start="3">
<li>新建一个Android.mk文件.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b3.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B3.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b3.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B3.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B3.png"
        title="手工编译示例3" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b4.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B4.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b4.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B4.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B4.png"
        title="手工编译示例4" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b5.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B5.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b5.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B5.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B5.png"
        title="手工编译示例5" /></p>
<ol start="4">
<li>新建一个Application.mk文件.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b6.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B6.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b6.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B6.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B6.png"
        title="手工编译示例6" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b7.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B7.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b7.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B7.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B7.png"
        title="手工编译示例7" /></p>
<ol start="5">
<li>编译.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">ndk-build
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B8.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B8.png"
        title="手工编译示例8" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b9.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B9.png, images/%e6%89%8b%e5%b7%a5%e7%bc%96%e8%af%91%e7%a4%ba%e4%be%8b9.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B9.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91%E7%A4%BA%E4%BE%8B9.png"
        title="手工编译示例9" /></p>
<ol start="6">
<li>编译清理.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">ndk-build clean
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/ndk-build%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91.7z" rel="">ndk-build手工编译.7z</a></p>
<h5 id="利用androidstudio来编译">利用AndroidStudio来编译</h5>
<ol>
<li>AS新建一个空工程.</li>
<li>将上面的jni或cpp文件夹拷贝到新建的工程中.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%911.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%911.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%911.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%911.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%911.png"
        title="利用AndroidStudio来编译1" /></p>
<ol start="2">
<li>在AS中选择Link C++ Project.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%912.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%912.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%912.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%912.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%912.png"
        title="利用AndroidStudio来编译2" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%913.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%913.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%913.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%913.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%913.png"
        title="利用AndroidStudio来编译3" /></p>
<p>这个地方的右键,其实是在编译脚本中加了一段话.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%914.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%914.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%914.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%914.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%914.png"
        title="利用AndroidStudio来编译4" /></p>
<ol start="4">
<li>指明NDK路径,下载了NDK,默认即可.</li>
<li>指定编译的平台.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%915.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%915.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%915.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%915.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%915.png"
        title="利用AndroidStudio来编译5" /></p>
<ol start="6">
<li>Ctrl + F9 编译工程即可.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%916.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%916.png, images/%e5%88%a9%e7%94%a8AndroidStudio%e6%9d%a5%e7%bc%96%e8%af%916.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%916.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%A9%E7%94%A8AndroidStudio%E6%9D%A5%E7%BC%96%E8%AF%916.png"
        title="利用AndroidStudio来编译6" /></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/ndk-build_AS%E7%BC%96%E8%AF%91.7z" rel="">ndk-build_AS编译.7z</a></p>
<h5 id="注意-1">注意</h5>
<p>用ndk-build编译C++程序需注意,Cmake编译无需注意.
需要设置STL C++异常 Rtti的开关.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/ndk-build%e6%b3%a8%e6%84%8f.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E6%B3%A8%E6%84%8F.png, images/ndk-build%e6%b3%a8%e6%84%8f.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E6%B3%A8%E6%84%8F.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/ndk-build%E6%B3%A8%E6%84%8F.png"
        title="ndk-build注意" /></p>
<h3 id="cmake编译android主推">Cmake编译(Android主推)</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%91%e6%a6%82%e8%bf%b0.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%91%E6%A6%82%E8%BF%B0.png, images/Cmake%e7%bc%96%e8%af%91%e6%a6%82%e8%bf%b0.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%91%E6%A6%82%E8%BF%B0.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%91%E6%A6%82%E8%BF%B0.png"
        title="Cmake编译概述" /></p>
<ol>
<li>新建一个工程,这个工程默认就是CMake编译.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%911.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%911.png, images/Cmake%e7%bc%96%e8%af%911.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%911.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%911.png"
        title="Cmake编译1" /></p>
<ol start="2">
<li>将要编译的文件,放到工程的cpp目录中.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%912.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%912.png, images/Cmake%e7%bc%96%e8%af%912.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%912.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%912.png"
        title="Cmake编译2" /></p>
<ol start="3">
<li>添加编译链接内容.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%913.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%913.png, images/Cmake%e7%bc%96%e8%af%913.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%913.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%913.png"
        title="Cmake编译3" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%914.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%914.png, images/Cmake%e7%bc%96%e8%af%914.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%914.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%914.png"
        title="Cmake编译4" /></p>
<ol start="4">
<li>指定编译的平台.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%915.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%915.png, images/Cmake%e7%bc%96%e8%af%915.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%915.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%915.png"
        title="Cmake编译5" /></p>
<ol start="5">
<li>Ctrl + F9编译工程即可.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e7%bc%96%e8%af%916.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%916.png, images/Cmake%e7%bc%96%e8%af%916.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%916.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E7%BC%96%E8%AF%916.png"
        title="Cmake编译6" /></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/Cmake%E7%BC%96%E8%AF%91.7z" rel="">Cmake编译.7z</a></p>
<h2 id="静态库">静态库</h2>
<p>又称归档文件,当一个工程链接静态库时,只会链接需要的Obj.</p>
<h3 id="编译-1">编译</h3>
<h4 id="手工编译">手工编译</h4>
<p>编译静态库的程序为llvm-ar.exe.</p>
<h5 id="mou1h">mou1.h</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span><span class="kt">void</span> <span class="nf">mou1</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="mou1c">mou1.c</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&#34;mou1.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">void</span> <span class="nf">mou1</span><span class="p">(){</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello mou1</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="mainc">main.c</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&#34;mou1.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="n">mou1</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello Main</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="makefile-1">Makefile</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">NDK_PATH</span> <span class="o">:=</span> D:/AndroidSDK/ndk/21.4.7075529/toolchains/llvm/prebuilt/windows-x86_64/bin
<span class="nv">BUILD_ABI</span> <span class="o">:=</span> i686
<span class="nv">BUILD_PLT_VERSION</span> <span class="o">:=</span> android21
<span class="nv">BUILD_CLANG</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_ABI<span class="k">)</span>-linux-<span class="k">$(</span>BUILD_PLT_VERSION<span class="k">)</span>-clang
<span class="nv">BUILD_AR</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_ABI<span class="k">)</span>-linux-android-ar
<span class="nv">BUILD_MODULE_NAME</span> <span class="o">:=</span> main
<span class="nv">BUILD_LIB_NAME</span> <span class="o">:=</span> libmou.a
<span class="nv">BUILD_FLAGS</span> <span class="o">:=</span> -c
<span class="nv">BUILD_LINKER_FLAGS</span> <span class="o">:=</span> -o <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> main.o mou1.o

<span class="nf">all</span><span class="o">:</span>
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> <span class="k">$(</span>BUILD_FLAGS<span class="k">)</span> main.c mou1.c
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> <span class="k">$(</span>BUILD_LINKER_FLAGS<span class="k">)</span>

<span class="nf">lib</span><span class="o">:</span>
	<span class="k">$(</span>BUILD_AR<span class="k">)</span> r <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span> mou1.o

<span class="nf">install</span><span class="o">:</span>
	adb push <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> /data/local/tmp
	adb shell chmod a+x /data/local/tmp/<span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span>
	adb shell /data/local/tmp/<span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span>

<span class="nf">clean</span><span class="o">:</span>
	del *.o <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/%E9%9D%99%E6%80%81%E5%BA%93%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91.rar" rel="">静态库手工编译.rar</a></p>
<h4 id="ndk-build">ndk-build</h4>
<p>可以放到AS中进行编译.</p>
<ol>
<li>将要编译的源文件放到jni文件夹中.</li>
<li>新建一个Android.mk文件.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="c">#编译静态库
</span><span class="c"></span><span class="nv">LOCAL_PATH</span> <span class="o">:=</span> <span class="k">$(</span>call my-dir<span class="k">)</span>
<span class="err">include</span> <span class="k">$(</span><span class="nv">CLEAR_VARS</span><span class="k">)</span>
<span class="c">#存储要构建的模块的名称
</span><span class="c"></span><span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> mou
<span class="c">#列举源文件
</span><span class="c"></span><span class="nv">LOCAL_SRC_FILES</span> <span class="o">:=</span> mou1.c mou2.c
<span class="c">#包含编译脚本
</span><span class="c"></span><span class="err">include</span> <span class="k">$(</span><span class="nv">BUILD_STATIC_LIBRARY</span><span class="k">)</span>

<span class="c">#使用静态库
</span><span class="c"></span><span class="err">include</span> <span class="k">$(</span><span class="nv">CLEAR_VARS</span><span class="k">)</span>
<span class="nv">LOCAL_MODULE</span> <span class="o">:=</span> main
<span class="nv">LOCAL_SRC_FILES</span> <span class="o">:=</span> main.c
<span class="nv">LOCAL_STATIC_LIBRARIES</span> <span class="o">:=</span> mou
<span class="err">include</span> <span class="k">$(</span><span class="nv">BUILD_EXECUTABLE</span><span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>新建一个Application.mk文件.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">APP_PLATFORM</span> <span class="o">:=</span> android-16
<span class="nv">APP_ABI</span> <span class="o">:=</span> x86_64
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>cmd运行ndk-build进行编译.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93ndk-build.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93ndk-build.png, images/%e9%9d%99%e6%80%81%e5%ba%93ndk-build.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93ndk-build.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93ndk-build.png"
        title="静态库ndk-build" /></li>
</ol>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/%E9%9D%99%E6%80%81%E5%BA%93ndk-build.7z" rel="">静态库ndk-build.7z</a></p>
<h4 id="cmake编译">Cmake编译</h4>
<p>假设编译的为Cpp文件,需要注意头文件加 extern &ldquo;C&rdquo;.</p>
<ol>
<li>新建一个工程.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%911.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%911.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%911.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%911.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%911.png"
        title="静态库Cmake编译1" /></p>
<ol start="2">
<li>在cpp文件夹新建源文件.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%912.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%912.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%912.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%912.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%912.png"
        title="静态库Cmake编译2" /></p>
<ol start="3">
<li>指明要静态编译的文件.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%913.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%913.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%913.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%913.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%913.png"
        title="静态库Cmake编译3" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%914.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%914.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%914.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%914.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%914.png"
        title="静态库Cmake编译4" /></p>
<ol start="4">
<li>修改编译脚本.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%915.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%915.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%915.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%915.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%915.png"
        title="静态库Cmake编译5" /></p>
<ol start="5">
<li>直接编译即可.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%916.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%916.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%916.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%916.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%916.png"
        title="静态库Cmake编译6" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%917.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%917.png, images/%e9%9d%99%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%917.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%917.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%9D%99%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%917.png"
        title="静态库Cmake编译7" /></p>
<h3 id="cmake使用第三方静态库">Cmake使用第三方静态库</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Cmake%e4%bd%bf%e7%94%a8%e7%ac%ac%e4%b8%89%e6%96%b9%e9%9d%99%e6%80%81%e5%ba%93.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E9%9D%99%E6%80%81%E5%BA%93.png, images/Cmake%e4%bd%bf%e7%94%a8%e7%ac%ac%e4%b8%89%e6%96%b9%e9%9d%99%e6%80%81%e5%ba%93.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E9%9D%99%E6%80%81%E5%BA%93.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Cmake%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E9%9D%99%E6%80%81%E5%BA%93.png"
        title="Cmake使用第三方静态库" /></p>
<h3 id="优点">优点</h3>
<p>软件静态链接静态库的时候,只链接需要的代码.</p>
<h3 id="缺点">缺点</h3>
<p>某一个.o文件有Bug,其他已经链接了该静态库的软件需要重新编译链接,维护性差.</p>
<h2 id="动态库">动态库</h2>
<h3 id="编译-2">编译</h3>
<h4 id="手动编译">手动编译</h4>
<h5 id="makefile-2">Makefile</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">NDK_PATH</span> <span class="o">:=</span> D:/AndroidSDK/ndk/21.4.7075529/toolchains/llvm/prebuilt/windows-x86_64/bin
<span class="nv">BUILD_ABI</span> <span class="o">:=</span> i686
<span class="nv">BUILD_PLT_VERSION</span> <span class="o">:=</span> android21
<span class="nv">BUILD_CLANG</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_ABI<span class="k">)</span>-linux-<span class="k">$(</span>BUILD_PLT_VERSION<span class="k">)</span>-clang
<span class="nv">BUILD_AR</span> <span class="o">:=</span> <span class="k">$(</span>BUILD_ABI<span class="k">)</span>-linux-android-ar
<span class="nv">BUILD_MODULE_NAME</span> <span class="o">:=</span> main
<span class="nv">BUILD_LIB_NAME</span> <span class="o">:=</span> libmou.so
<span class="nv">BUILD_FLAGS</span> <span class="o">:=</span> -c
<span class="nv">BUILD_LINKER_FLAGS</span> <span class="o">:=</span> -o <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> main.o <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span>

<span class="nf">all</span><span class="o">:</span>
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> <span class="k">$(</span>BUILD_FLAGS<span class="k">)</span> main.c
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> <span class="k">$(</span>BUILD_LINKER_FLAGS<span class="k">)</span>

<span class="nf">lib</span><span class="o">:</span>
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> -c mou1.c mou2.c
	<span class="k">$(</span>BUILD_CLANG<span class="k">)</span> -o <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span> -fpic -shared mou1.o mou2.o

<span class="nf">install</span><span class="o">:</span>
	adb push <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span> /data/local/tmp
	adb push <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> /data/local/tmp
	adb shell chmod a+x /data/local/tmp/<span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span>
	adb shell /data/local/tmp/<span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span>

<span class="nf">clean</span><span class="o">:</span>
	del *.o <span class="k">$(</span>BUILD_MODULE_NAME<span class="k">)</span> <span class="k">$(</span>BUILD_LIB_NAME<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><p>-fpic 位置无关代码.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="c">#编译动态库
</span><span class="c"></span><span class="err">make</span> <span class="err">lib</span>
<span class="c">#编译可执行文件
</span><span class="c"></span><span class="err">make</span>
<span class="c">#安装可执行文件到Android中并运行
</span><span class="c"></span><span class="err">make</span> <span class="err">install</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/%E5%8A%A8%E6%80%81%E5%BA%93%E6%89%8B%E5%B7%A5%E7%BC%96%E8%AF%91.7z" rel="">动态库手工编译.7z</a></p>
<h5 id="报错处理">报错处理</h5>
<p>需了解Linux共享库搜索规则.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a8%e6%80%81%e5%ba%93%e6%8a%a5%e9%94%991.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%991.png, images/%e5%8a%a8%e6%80%81%e5%ba%93%e6%8a%a5%e9%94%991.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%991.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%991.png"
        title="动态库报错1" /></p>
<h6 id="共享库搜索路径">共享库搜索路径</h6>
<ol>
<li>system/lib</li>
<li>user/lib</li>
<li>环境变量,如果以apk运行,会将/data/data/packageName/lib设为环境变量</li>
</ol>
<h6 id="示例">示例</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//查看环境变量
</span><span class="c1"></span><span class="n">echo</span> <span class="err">$</span><span class="n">LD_LIBRARY_PATH</span>
<span class="c1">//设置临时环境变量, 以:分割环境变量路径
</span><span class="c1"></span><span class="k">export</span> <span class="n">LD_LIBRARY_PATH</span><span class="o">=</span><span class="err">$</span><span class="nl">LD_LIBRARY_PATH</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">tmp</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a8%e6%80%81%e5%ba%93%e6%8a%a5%e9%94%992.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%992.png, images/%e5%8a%a8%e6%80%81%e5%ba%93%e6%8a%a5%e9%94%992.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%992.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93%E6%8A%A5%E9%94%992.png"
        title="动态库报错2" /></p>
<h4 id="ndk-build-1">ndk-build</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a8%e6%80%81%e5%ba%93ndk-build.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93ndk-build.png, images/%e5%8a%a8%e6%80%81%e5%ba%93ndk-build.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93ndk-build.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93ndk-build.png"
        title="动态库ndk-build" /></p>
<p>cmd 输入ndk-build即可编译.</p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/%E5%8A%A8%E6%80%81%E5%BA%93NDK-BUILD.7z" rel="">动态库NDK-BUILD.7z</a></p>
<h4 id="cmake编译-1">Cmake编译</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a8%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%91.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%91.png, images/%e5%8a%a8%e6%80%81%e5%ba%93Cmake%e7%bc%96%e8%af%91.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%91.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E5%BA%93Cmake%E7%BC%96%E8%AF%91.png"
        title="动态库Cmake编译" /></p>
<h3 id="优点-1">优点</h3>
<p>某一个.so文件有Bug,只需重新编译该so文件即可.</p>
<h3 id="缺点-1">缺点</h3>
<ul>
<li>启动速度慢,但可以延迟加载.</li>
<li>软件加载动态库的时候,Dll中的函数代码全部进内存.</li>
</ul>
<h3 id="查看导出函数">查看导出函数</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">命令行 llvm-readelf -s so文件路径
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%9c%8b%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%9C%8B%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png, images/%e7%9c%8b%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%9C%8B%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%9C%8B%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0.png"
        title="看导出函数" /></p>
<h3 id="函数不导出">函数不导出</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//在Linux中 函数默认是导出的,若不导出需加前缀
</span><span class="c1"></span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">visibility</span><span class="p">(</span><span class="s">&#34;hidden&#34;</span><span class="p">)))</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%87%bd%e6%95%b0%e4%b8%8d%e5%af%bc%e5%87%ba.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%BC%E5%87%BA.png, images/%e5%87%bd%e6%95%b0%e4%b8%8d%e5%af%bc%e5%87%ba.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%BC%E5%87%BA.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%87%BD%E6%95%B0%E4%B8%8D%E5%AF%BC%E5%87%BA.png"
        title="函数不导出" /></p>
<h3 id="初始化函数">初始化函数</h3>
<h4 id="不常用">不常用</h4>
<p>之所以说不常用,是因为不方便,每加一个功能都有可能会修改_init中的代码.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%9d%e5%a7%8b%e5%8c%96%e5%87%bd%e6%95%b01.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B01.png, images/%e5%88%9d%e5%a7%8b%e5%8c%96%e5%87%bd%e6%95%b01.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B01.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B01.png"
        title="初始化函数1" /></p>
<h4 id="常用">常用</h4>
<p>方便,名字随意只要声明为构造或析构函数即可,数量不限.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%9d%e5%a7%8b%e5%8c%96%e5%87%bd%e6%95%b02.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B02.png, images/%e5%88%9d%e5%a7%8b%e5%8c%96%e5%87%bd%e6%95%b02.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B02.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9D%E5%A7%8B%E5%8C%96%E5%87%BD%E6%95%B02.png"
        title="初始化函数2" /></p>
<h3 id="动态使用">动态使用</h3>
<h4 id="相关函数">相关函数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span><span class="o">*</span> <span class="nf">dlopen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__flag</span><span class="p">);</span>
<span class="kt">void</span><span class="o">*</span> <span class="nf">dlsym</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__handle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__symbol</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">dladdr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">Dl_info</span><span class="o">*</span> <span class="n">__info</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">dlclose</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__handle</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="示例-1">示例</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%8a%a8%e6%80%81%e4%bd%bf%e7%94%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E4%BD%BF%E7%94%A8.png, images/%e5%8a%a8%e6%80%81%e4%bd%bf%e7%94%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E4%BD%BF%E7%94%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%8A%A8%E6%80%81%E4%BD%BF%E7%94%A8.png"
        title="动态使用" /></p>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/%E5%8A%A8%E6%80%81%E5%BA%93%E4%BD%BF%E7%94%A8.7z" rel="">动态库使用.7z</a></p>
<h2 id="android-api">Android API</h2>
<p>基于Linux内核,遵循Posix标准,也有自己独有的API.</p>
<h3 id="ndk">NDK</h3>
<p>这是独有的API.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/AndroidAPINDK.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK.png, images/AndroidAPINDK.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK.png"
        title="AndroidAPINDK" /></p>
<h4 id="常用来打日志">常用来打日志</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;android/log.h&gt;</span><span class="cp">
</span><span class="cp">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, &#34;Luo&#34;, __VA_ARGS__);
</span><span class="cp">#define LOGW(...) __android_log_print(ANDROID_LOG_WARN, &#34;Luo&#34;, __VA_ARGS__);
</span><span class="cp">#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR, &#34;Luo&#34;, __VA_ARGS__);
</span></code></pre></td></tr></table>
</div>
</div><h4 id="添加库">添加库</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/AndroidAPINDK%e6%b7%bb%e5%8a%a0%e5%ba%93.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK%E6%B7%BB%E5%8A%A0%E5%BA%93.png, images/AndroidAPINDK%e6%b7%bb%e5%8a%a0%e5%ba%93.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK%E6%B7%BB%E5%8A%A0%E5%BA%93.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/AndroidAPINDK%E6%B7%BB%E5%8A%A0%E5%BA%93.png"
        title="AndroidAPINDK添加库" /></p>
<h3 id="posix">Posix</h3>
<p>可移植操作系统接口(Portable Operating System Interface),无窗口API.</p>
<p>Cygwin,该库在Win32系统下实现了POSIX系统调用的API.</p>
<h4 id="errno">errno</h4>
<p>扩展了 C标准的errno,下面是C标准的errno.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C%e6%a0%87%e5%87%86%e7%9a%84errno.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C%E6%A0%87%E5%87%86%E7%9A%84errno.png, images/C%e6%a0%87%e5%87%86%e7%9a%84errno.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C%E6%A0%87%E5%87%86%E7%9A%84errno.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C%E6%A0%87%E5%87%86%E7%9A%84errno.png"
        title="C标准的errno" /></p>
<p>通过查文档可知该函数出错时,errno是否被设置.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/errno%e8%ae%be%e7%bd%ae.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/errno%E8%AE%BE%E7%BD%AE.png, images/errno%e8%ae%be%e7%bd%ae.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/errno%E8%AE%BE%E7%BD%AE.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/errno%E8%AE%BE%E7%BD%AE.png"
        title="errno设置" /></p>
<h4 id="文件">文件</h4>
<h5 id="相关函数-1">相关函数</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//打开
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="c1">//关闭
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">);</span>
<span class="c1">//读
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">);</span>
<span class="c1">//写
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">);</span>   
<span class="c1">//移动文件指针
</span><span class="c1"></span><span class="n">off_t</span> <span class="nf">lseek</span><span class="p">(</span><span class="kt">int</span> <span class="n">fildes</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">);</span>   
<span class="c1">//文件控制
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">fcntl</span><span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__cmd</span><span class="p">,</span> <span class="p">...);</span>
<span class="c1">//指定位置读写
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="nf">pread</span><span class="p">(</span><span class="kt">int</span> <span class="n">fildes</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">nbyte</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">offset</span><span class="p">);</span> 
<span class="n">ssize_t</span> <span class="nf">pwrite</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">offset</span><span class="p">);</span>
<span class="c1">//文件属性
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">stat</span><span class="o">*</span> <span class="n">__buf</span><span class="p">);</span>
<span class="c1">//检查文件权限
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">access</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__mode</span><span class="p">);</span>
<span class="c1">//更改文件权限
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">chmod</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="n">mode_t</span> <span class="n">__mode</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">fchmod</span><span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="n">mode_t</span> <span class="n">__mode</span><span class="p">);</span>
<span class="c1">//创建目录
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">mkdir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="n">mode_t</span> <span class="n">__mode</span><span class="p">);</span>
<span class="c1">//遍历文件
</span><span class="c1"></span><span class="n">DIR</span><span class="o">*</span> <span class="nf">opendir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="文件控制">文件控制</h5>
<p>fcntl的用途之一是针对一个打开的文件,获取或修改访问模式和状态标识.</p>
<p>要获取这些设置,应将fcntl的cmd参数设置为F_GETFL.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//下述到吗可以测试文件是否以同步写方式打开
</span><span class="c1"></span><span class="kt">int</span> <span class="n">nFlags</span><span class="p">;</span>
<span class="n">nFlags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">nFlags</span> <span class="o">&amp;</span> <span class="n">O_SYNC</span><span class="p">){</span>
   <span class="c1">//...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="文件属性">文件属性</h5>
<p>利用系统调用stat(),lstat(),fstat(),可以获取文件相关的信息.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//返回文件的相关信息
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">stat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">stat</span><span class="o">*</span> <span class="n">__buf</span><span class="p">);</span>
<span class="c1">//与stat类似,区别,如果文件属于符号链接,那么返回的信息针对是的符号链接自身
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">lstat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__path</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">stat</span><span class="o">*</span> <span class="n">__buf</span><span class="p">);</span>
<span class="c1">//根据文件描述符获取文件的相关信息
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">fstat</span><span class="p">(</span><span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">stat</span><span class="o">*</span> <span class="n">__buf</span><span class="p">);</span>
<span class="cm">/*
</span><span class="cm">系统调用stat()和lstat()无需对其所操作的文件本身拥有任何的权限,但是针对指定的pathname的父目录要有执行(搜素)权限.而fstat()系统调用只要文件描述符有效,总是成功.
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="st_mode">st_mode</h6>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/st_mode.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/st_mode.png, images/st_mode.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/st_mode.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/st_mode.png"
        title="st_mode" /></p>
<h6 id="示例-2">示例</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">struct</span> <span class="nc">stat</span> <span class="n">statBuf</span><span class="p">;</span>
<span class="n">stat</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/2.txt&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statBuf</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&#34;st_uid = %d st_gid = %d st_size = %lld, st_mode = %o</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
       <span class="n">statBuf</span><span class="p">.</span><span class="n">st_uid</span><span class="p">,</span>
       <span class="n">statBuf</span><span class="p">.</span><span class="n">st_gid</span><span class="p">,</span>
       <span class="n">statBuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span>
       <span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;常规文件</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRUSR</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;拥有读权限</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="目录权限">目录权限</h5>
<p>目录与文件拥有相同的权限方案,只是对3种权限的含义另有所指.</p>
<ul>
<li>读权限:可列出目录之下的内容.</li>
<li>写权限:可在目录创建,删除文件.</li>
<li>可执行权限:可访问目录中的文件(搜索权限).</li>
</ul>
<h5 id="权限检查算法">权限检查算法</h5>
<ul>
<li>对于特权级进程,授予所有访问权限.</li>
<li>若进程的有效用户ID与文件的用户ID相同,内核会根据文件的属主权限,授予进程相应的访问权限.</li>
<li>若进程的有效组ID与文件的组ID相匹配,内核会根据文件的属组权限,授予进程相应的访问权限.</li>
<li>若以上3点都不满足,内核会根据文件的其他权限,授予进程相应的访问权限.</li>
</ul>
<h5 id="示例-3">示例</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;android/log.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG, &#34;Luo&#34;, __VA_ARGS__);
</span><span class="cp">#define LOGW(...) __android_log_print(ANDROID_LOG_WARN, &#34;Luo&#34;, __VA_ARGS__);
</span><span class="cp">#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR, &#34;Luo&#34;, __VA_ARGS__);
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

<span class="cm">/*  FILE* fp = fopen(&#34;/data/local/tmp/1.txt&#34;, &#34;r&#34;);
</span><span class="cm">    if (fp == NULL){
</span><span class="cm">        //当C库函数出错了,会将错误传给全局变量errno
</span><span class="cm">        printf(&#34;fopen error %d\n&#34;, errno);
</span><span class="cm">        //将错误转换为字符串
</span><span class="cm">        perror(&#34;fopen&#34;);
</span><span class="cm">        //传errno,将错误字符串返回,方便界面显示
</span><span class="cm">        char* pErr =  strerror(errno);
</span><span class="cm">        printf(&#34;%s\n&#34;, pErr);
</span><span class="cm">    }*/</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/2.txt&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;open&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;write&#34;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;write bytes: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;lseek&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="n">szBuf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">ssize_t</span> <span class="n">readBytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">szBuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">szBuf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">readBytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;read&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;szBuf = %s readBytes = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">szBuf</span><span class="p">,</span> <span class="n">readBytes</span><span class="p">);</span>

    <span class="c1">//获取文件属性
</span><span class="c1"></span>    <span class="k">struct</span> <span class="nc">stat</span> <span class="n">statBuf</span><span class="p">;</span>
    <span class="n">stat</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/2.txt&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">statBuf</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;st_uid = %d st_gid = %d st_size = %lld, st_mode = %o</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
           <span class="n">statBuf</span><span class="p">.</span><span class="n">st_uid</span><span class="p">,</span>
           <span class="n">statBuf</span><span class="p">.</span><span class="n">st_gid</span><span class="p">,</span>
           <span class="n">statBuf</span><span class="p">.</span><span class="n">st_size</span><span class="p">,</span>
           <span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;常规文件</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">statBuf</span><span class="p">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">S_IRUSR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;拥有读权限</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//修改文件权限 相同Uid才可以修改权限 Root用户除外
</span><span class="c1"></span>    <span class="n">fchmod</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">S_IRWXU</span><span class="p">);</span>

    <span class="c1">//检查文件权限
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/2.txt&#34;</span><span class="p">,</span> <span class="n">W_OK</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;拥有写权限</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="线程">线程</h4>
<h5 id="两种状态">两种状态</h5>
<ul>
<li>连接状态,pthread_join,会阻塞,等待线程结束拿线程返回值.</li>
<li>分离状态,pthread_detach,不会阻塞,节省内存开销.</li>
</ul>
<h5 id="终止线程">终止线程</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">void</span> <span class="nf">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value_ptr</span><span class="p">);</span> 
<span class="k">return</span>
<span class="cm">/*
</span><span class="cm">当一个线程设置了一个取消点,可使用下述API结束那个线程,
</span><span class="cm">那个线程运行到取消点时,会结束线程
</span><span class="cm">但遗憾的是,Android不允许使用此API
</span><span class="cm">*/</span>
<span class="kt">int</span> <span class="n">pthread_cancel</span><span class="p">(</span><span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">);</span> 
</code></pre></td></tr></table>
</div>
</div><h5 id="线程同步">线程同步</h5>
<h6 id="互斥体">互斥体</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//初始化
</span><span class="c1">//可以使用全局变量初始化
</span><span class="c1"></span><span class="n">pthread_mutex_t</span> <span class="n">mutex</span> <span class="o">=</span> <span class="n">PTHREAD_MUTEX_INITIALIZER</span><span class="p">;</span>
<span class="c1">//也可以使用API初始化
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_mutex_init</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="k">restrict</span> <span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_mutexattr_t</span> <span class="o">*</span><span class="k">restrict</span> <span class="n">attr</span><span class="p">);</span>
<span class="c1">//加锁
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_mutex_lock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//取消锁
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">pthread_mutex_unlock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="信号量">信号量</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//初始化
</span><span class="c1">//跨进程使用sem_open
</span><span class="c1">//不跨进程使用sem_init
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">sem_init</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">__sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__shared</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__value</span><span class="p">);</span>
<span class="n">sem_t</span> <span class="o">*</span><span class="nf">sem_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">);</span>
<span class="n">sem_t</span> <span class="o">*</span><span class="nf">sem_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span> 
                <span class="n">mode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="c1">//释放信号量
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">sem_post</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="c1">//等待信号量
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">sem_wait</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="示例-4">示例</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%ba%bf%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BA%BF%E7%A8%8B.png, images/%e7%ba%bf%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BA%BF%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E7%BA%BF%E7%A8%8B.png"
        title="线程" /></p>
<h4 id="进程">进程</h4>
<p>Android将进程相关操作从原来的process.h移动到了unistd.h</p>
<h5 id="相关函数-2">相关函数</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//获取自身进程PID
</span><span class="c1"></span><span class="n">pid_t</span>  <span class="nf">getpid</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="c1">//获取父进程PID
</span><span class="c1"></span><span class="n">pid_t</span>  <span class="nf">getppid</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="c1">//创建进程
</span><span class="c1"></span><span class="n">pid_t</span>  <span class="nf">fork</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="c1">//退进程
</span><span class="c1"></span><span class="n">__noreturn</span> <span class="kt">void</span> <span class="nf">_exit</span><span class="p">(</span><span class="kt">int</span> <span class="n">__status</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">kill</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">__pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__signal</span><span class="p">);</span>
<span class="c1">//信号量
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">sem_init</span><span class="p">(</span><span class="n">sem_t</span><span class="o">*</span> <span class="n">__sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__shared</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__value</span><span class="p">);</span>
<span class="n">sem_t</span> <span class="o">*</span><span class="nf">sem_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">);</span>
<span class="n">sem_t</span> <span class="o">*</span><span class="nf">sem_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oflag</span><span class="p">,</span> 
                <span class="n">mode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_close</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_destroy</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sem_getvalue</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sval</span><span class="p">);</span>
<span class="c1">//内存映射
</span><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">__size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__fd</span><span class="p">,</span> <span class="n">off_t</span> <span class="n">__offset</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">munmap</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">__size</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">msync</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">__size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__flags</span><span class="p">);</span>
<span class="c1">//修改内存保护属性,需要给页首地址,否则会失败
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">mprotect</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">__addr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">__size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__prot</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="创建进程">创建进程</h5>
<p>系统调用fork(),一个进程(父进程)创建一个新进程(子进程),新的子进程获取父进程的栈,数据段,堆和执行文本段的拷贝.</p>
<p>Linux系统中,父子进程关系很密切,同生共死.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%88%9b%e5%bb%ba%e8%bf%9b%e7%a8%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B.png, images/%e5%88%9b%e5%bb%ba%e8%bf%9b%e7%a8%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B.png"
        title="创建进程" /></p>
<h5 id="虚拟文件系统">虚拟文件系统</h5>
<p>Linux搞了一些假文件,通过操作这些假文件,可以访问内核的一些信息,Android中的虚拟文件在根目录的/proc中.</p>
<h6 id="拿cpu信息">拿Cpu信息</h6>
<p>访问/proc/cpuinfo这个文件,就可以拿到Cpu信息.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%8b%bfCpu%e4%bf%a1%e6%81%af.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%8B%BFCpu%E4%BF%A1%E6%81%AF.png, images/%e6%8b%bfCpu%e4%bf%a1%e6%81%af.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%8B%BFCpu%E4%BF%A1%E6%81%AF.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E6%8B%BFCpu%E4%BF%A1%E6%81%AF.png"
        title="拿Cpu信息" /></p>
<h6 id="遍历进程">遍历进程</h6>
<p>/proc目录下的每个以数字命名的文件夹都是一个进程,这些数字代表的是进程PID</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%81%8d%e5%8e%86%e8%bf%9b%e7%a8%8b1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%81%8D%E5%8E%86%E8%BF%9B%E7%A8%8B1.png, images/%e9%81%8d%e5%8e%86%e8%bf%9b%e7%a8%8b1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%81%8D%E5%8E%86%E8%BF%9B%E7%A8%8B1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E9%81%8D%E5%8E%86%E8%BF%9B%E7%A8%8B1.png"
        title="遍历进程1" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="nf">EnumProcess</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">DIR</span> <span class="o">*</span><span class="n">dirp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">dirent</span> <span class="o">*</span><span class="n">direntp</span><span class="p">;</span>
    <span class="n">dirp</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="s">&#34;/proc&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dirp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;can&#39;t open /proc&#34;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
            <span class="n">direntp</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dirp</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">direntp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// /proc目录中以数字开头的是进程
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">direntp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">direntp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//取进程路径,在命令行的第一个参数中,有的系统进程可能无路径
</span><span class="c1"></span>                <span class="kt">char</span> <span class="n">szProcessCmdPath</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="kt">char</span> <span class="n">szProcessPath</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">szProcessCmdPath</span><span class="p">,</span> <span class="s">&#34;/proc/%s/cmdline&#34;</span><span class="p">,</span> <span class="n">direntp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
                <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">szProcessCmdPath</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
                <span class="n">fgets</span><span class="p">(</span><span class="n">szProcessPath</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">szProcessPath</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
                <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;PID:%s ProcessPath:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">direntp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">szProcessPath</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">closedir</span><span class="p">(</span><span class="n">dirp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="遍历模块">遍历模块</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="nf">EnumModule</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x1000</span><span class="p">];</span>
    <span class="c1">//访问/proc每个进程下的maps文件,即可遍历模块
</span><span class="c1"></span>    <span class="c1">//只要root权限的用户才可以遍历别人进程的模块
</span><span class="c1"></span>    <span class="c1">//遍历自身模块,可以写/proc/self/maps
</span><span class="c1"></span>    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/self/maps&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="读写内存">读写内存</h6>
<p>访问/proc/pid/mem文件即可,文件偏移就是内存地址.</p>
<p>Andorid内存搜索工具:GG</p>
<h6 id="进程状态">进程状态</h6>
<p>访问/proc/pid/status文件即可.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e8%bf%9b%e7%a8%8b%e7%8a%b6%e6%80%81.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.png, images/%e8%bf%9b%e7%a8%8b%e7%8a%b6%e6%80%81.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.png"
        title="进程状态" /></p>
<h4 id="网络编程">网络编程</h4>
<h5 id="常规socket">常规Socket</h5>
<p>耗费网络资源</p>
<h6 id="服务端">服务端</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//初始化Socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;socket s = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//绑定
</span><span class="c1"></span>    <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">5566</span><span class="p">);</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;bind s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//监听
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOMAXCONN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;listen s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//接受连接
</span><span class="c1"></span>    <span class="n">socklen_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;accept cs = %d ip:%s port:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span> <span class="n">htons</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;bytes:%d buf:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;close Socket</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="客户端">客户端</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//初始化Socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;socket s = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//绑定
</span><span class="c1"></span>    <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">5566</span><span class="p">);</span>
    <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;connect&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;connect s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//发送数据
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;send bytes:%d buf:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;close Socket</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="domain-socket">DoMain Socket</h5>
<ul>
<li>不耗费网络资源.</li>
<li>无IP和端口概念,用虚拟文件来代替IP地址.</li>
</ul>
<h6 id="服务端-1">服务端</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/un.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//初始化Socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;socket s = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//绑定
</span><span class="c1"></span>    <span class="c1">//删除文件
</span><span class="c1"></span>    <span class="n">unlink</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/myServer&#34;</span><span class="p">);</span>

    <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
    <span class="c1">//协议要用AF_UNIX
</span><span class="c1"></span>    <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="c1">//用文件来代替IP地址
</span><span class="c1"></span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">&#34;/data/local/tmp/myServer&#34;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;bind s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//监听
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOMAXCONN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;listen&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;listen s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//接受连接
</span><span class="c1"></span>    <span class="n">socklen_t</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;accept&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;accept cs = %d ip:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;bytes:%d buf:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;close Socket</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="客户端-1">客户端</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/in.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;linux/un.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//初始化Socket
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;socket s = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//绑定 可以不绑定 绑定是为了让服务器知道是谁连接的
</span><span class="c1"></span>    <span class="n">sockaddr_un</span> <span class="n">clientAddr</span><span class="p">;</span>
    <span class="c1">//协议要用AF_UNIX
</span><span class="c1"></span>    <span class="n">clientAddr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="c1">//用文件来代替IP地址 +Pid 防止文件冲突
</span><span class="c1"></span>    <span class="n">sprintf</span><span class="p">(</span><span class="n">clientAddr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">&#34;/data/local/tmp/myClient_%d&#34;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">clientAddr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">clientAddr</span><span class="p">)){</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;bind&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sockaddr_un</span> <span class="n">serverAddr</span><span class="p">;</span>
    <span class="c1">//协议要用AF_UNIX
</span><span class="c1"></span>    <span class="n">serverAddr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="c1">//用文件来代替IP地址
</span><span class="c1"></span>    <span class="n">strcpy</span><span class="p">(</span><span class="n">serverAddr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">&#34;/data/local/tmp/myServer&#34;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serverAddr</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">serverAddr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;connect&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;connect s = %d ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

    <span class="c1">//发送数据
</span><span class="c1"></span>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;send bytes:%d buf:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;close Socket</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="注意-2">注意</h6>
<p>测试的时候,填写的虚拟Socket文件可能没有权限,需要进root测试,实际apk应用的时候,可以填写apk所在的目录,这样就没有权限问题了.</p>
<h2 id="混合编程jni">混合编程JNI</h2>
<h3 id="概述-2">概述</h3>
<p>Java Native Interface
Java =&gt; JNI =&gt;xxx(动态库 so)
xxx(动态库 so) =&gt; JNI =&gt;Java</p>
<h4 id="两边互调应满足以下条件">两边互调应满足以下条件</h4>
<ul>
<li>so文件应该导出函数,在函数前加JNIEXPORT.</li>
<li>类型匹配,Java要调C++,首先类型应该匹配,在Jni.h中已定义好.</li>
<li>调用约定,在函数前加JNICALL.</li>
</ul>
<p>如果是C++,防止名称粉碎,在函数前加extern &ldquo;C&rdquo;</p>
<h4 id="名称规范问题">名称规范问题</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">为了防止误调so中的导出函数,应以包名_类名_函数名来命名
可以使用javah.exe将编译好的class文件给这个exe,
它会扫描类声明,看到native会自动创建头文件
不过这样还是很麻烦的,AndroidStodio已集成该工具
</code></pre></td></tr></table>
</div>
</div><h3 id="java调c">Java调C++</h3>
<ol>
<li>在Java类中添加声明, 声明前加native关键字.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Java%e8%b0%83C&#43;&#43;1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;1.png, images/Java%e8%b0%83C&#43;&#43;1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;1.png"
        title="Java调C&#43;&#43;1" /></p>
<ol start="2">
<li>Alt + Enter,创建Jni方法.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Java%e8%b0%83C&#43;&#43;2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;2.png, images/Java%e8%b0%83C&#43;&#43;2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;2.png"
        title="Java调C&#43;&#43;2" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Java%e8%b0%83C&#43;&#43;3.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;3.png, images/Java%e8%b0%83C&#43;&#43;3.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;3.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/Java%E8%B0%83C&#43;&#43;3.png"
        title="Java调C&#43;&#43;3" /></p>
<h3 id="java反射">Java反射</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//拿目标对象
</span><span class="c1">//①
</span><span class="c1">// Class cls = MainActivity.class;
</span><span class="c1">//② 本身有对象
</span><span class="c1">//Class cls = this.getClass();
</span><span class="c1">//③ 常用, 通过类名拿
</span><span class="c1"></span><span class="k">try</span> <span class="p">{</span>
    <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">Class</span><span class="p">.</span><span class="n">forName</span><span class="p">(</span><span class="s">&#34;org.example.luojni.MainActivity&#34;</span><span class="p">);</span>

    <span class="c1">//new 对象
</span><span class="c1"></span>    <span class="c1">//不带构造new对象
</span><span class="c1"></span>    <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">newInstance</span><span class="p">();</span>
    <span class="c1">//带构造new对象
</span><span class="c1"></span>    <span class="n">Constructor</span> <span class="n">constructor</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">getConstructor</span><span class="p">();</span>
    <span class="c1">//传构造参数即可
</span><span class="c1"></span>    <span class="n">obj</span> <span class="o">=</span> <span class="n">constructor</span><span class="p">.</span><span class="n">newInstance</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

    <span class="c1">//调方法 传参数是为了防止有歧义,因为函数可以重载
</span><span class="c1"></span>    <span class="c1">//①拿方法
</span><span class="c1"></span>    <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">getMethod</span><span class="p">(</span><span class="s">&#34;MyAdd&#34;</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="k">class</span><span class="err">, </span><span class="nc">int</span><span class="p">.</span><span class="k">class</span><span class="err">);</span>
    <span class="c1">//②拿方法 修改方法的访问权限 当方法为private时 第①种方式会拿不到
</span><span class="c1"></span>    <span class="n">method</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">getDeclaredMethod</span><span class="p">(</span><span class="s">&#34;MyAdd&#34;</span><span class="p">,</span> <span class="kt">int</span><span class="p">.</span><span class="k">class</span><span class="err">, </span><span class="nc">int</span><span class="p">.</span><span class="k">class</span><span class="err">);</span>
    <span class="c1">//修改方法的访问权限
</span><span class="c1"></span>    <span class="n">method</span><span class="p">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="c1">//为了统一 返回值为Object
</span><span class="c1"></span>    <span class="c1">//如果为静态方法 第一个参数给null就可以了
</span><span class="c1"></span>    <span class="n">Object</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">method</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="c1">//若返回值为整型 就转为整型的包装类
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nResult</span> <span class="o">=</span> <span class="p">((</span><span class="n">Integer</span><span class="p">)</span> <span class="n">ret</span><span class="p">).</span><span class="n">intValue</span><span class="p">();</span>

    <span class="c1">//反射字段
</span><span class="c1"></span>    <span class="c1">//①拿字段
</span><span class="c1"></span>    <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">getField</span><span class="p">(</span><span class="s">&#34;mData&#34;</span><span class="p">);</span>
    <span class="c1">//②拿字段 修改字段的访问权限 当字段为private时 第①种方式会拿不到
</span><span class="c1"></span>    <span class="n">field</span> <span class="o">=</span> <span class="n">cls</span><span class="p">.</span><span class="n">getDeclaredField</span><span class="p">(</span><span class="s">&#34;mData&#34;</span><span class="p">);</span>
    <span class="c1">//修改字段的访问权限
</span><span class="c1"></span>    <span class="n">field</span><span class="p">.</span><span class="n">setAccessible</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="c1">//修改字段值
</span><span class="c1"></span>    <span class="n">field</span><span class="p">.</span><span class="n">setInt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">//获取字段值
</span><span class="c1"></span>    <span class="n">nResult</span> <span class="o">=</span> <span class="n">field</span><span class="p">.</span><span class="n">getInt</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>


<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">ClassNotFoundException</span> <span class="o">|</span> <span class="n">NoSuchMethodException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">InstantiationException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Java反射的强大之处在于可以修改方法和字段的访问权限.</p>
<h3 id="c调java">C++调Java</h3>
<h4 id="c操作java中的字符串以及数组">C++操作Java中的字符串以及数组</h4>
<ol>
<li>Java中声明函数,以及使用.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C&#43;&#43;%e6%93%8d%e4%bd%9cJava%e4%b8%ad%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%bb%a5%e5%8f%8a%e6%95%b0%e7%bb%841.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%841.png, images/C&#43;&#43;%e6%93%8d%e4%bd%9cJava%e4%b8%ad%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%bb%a5%e5%8f%8a%e6%95%b0%e7%bb%841.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%841.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%841.png"
        title="C&#43;&#43;操作Java中的字符串以及数组1" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C&#43;&#43;%e6%93%8d%e4%bd%9cJava%e4%b8%ad%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%bb%a5%e5%8f%8a%e6%95%b0%e7%bb%842.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%842.png, images/C&#43;&#43;%e6%93%8d%e4%bd%9cJava%e4%b8%ad%e7%9a%84%e5%ad%97%e7%ac%a6%e4%b8%b2%e4%bb%a5%e5%8f%8a%e6%95%b0%e7%bb%842.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%842.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E6%93%8D%E4%BD%9CJava%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BB%A5%E5%8F%8A%E6%95%B0%E7%BB%842.png"
        title="C&#43;&#43;操作Java中的字符串以及数组2" /></p>
<ol start="2">
<li>C++中操作.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="n">jstring</span> <span class="n">JNICALL</span>
<span class="n">Java_org_example_luojni_MainActivity_fun1</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span>
                                          <span class="n">jobject</span> <span class="n">thiz</span><span class="p">,</span>
                                          <span class="n">jstring</span> <span class="n">str</span><span class="p">,</span>
                                          <span class="n">jbyteArray</span> <span class="n">ary</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//操作Java中的字符串
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nLen</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringLength</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="c1">//传false 说明不拷贝缓冲区,跟Java中用的是同一个缓冲区
</span><span class="c1"></span>    <span class="n">jboolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">psz</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStringUTFChars</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;len = %d str = %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">nLen</span><span class="p">,</span> <span class="n">psz</span><span class="p">);</span>

   <span class="c1">//操作Java中的数组
</span><span class="c1"></span>   <span class="kt">int</span> <span class="n">nCount</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetArrayLength</span><span class="p">(</span><span class="n">ary</span><span class="p">);</span>
   <span class="n">jbyte</span> <span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetByteArrayElements</span><span class="p">(</span><span class="n">ary</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flag</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nCount</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;%d &#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

   <span class="c1">//返回String
</span><span class="c1"></span>    <span class="k">return</span>  <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="s">&#34;Hello Ret&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="c反射调java">C++反射调Java</h4>
<ol>
<li>写一个Java类.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java1.png, images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java1.png"
        title="C&#43;&#43;反射调Java1" /></p>
<ol start="2">
<li>在Java中声明native方法并调用.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java2.png, images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java2.png"
        title="C&#43;&#43;反射调Java2" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java3.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java3.png, images/C&#43;&#43;%e5%8f%8d%e5%b0%84%e8%b0%83Java3.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java3.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/images/C&#43;&#43;%E5%8F%8D%E5%B0%84%E8%B0%83Java3.png"
        title="C&#43;&#43;反射调Java3" /></p>
<ol start="3">
<li>在C++中反射调Java.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//参数信息描述
</span><span class="c1">//I(int) F(float) D(double) J(long) Z(bool) C(char) S(short) Ljava/lang/String(String)
</span><span class="c1">//一维数组 [i(int[])
</span><span class="c1">//二维数组 [[i(int[][])
</span><span class="c1"></span>
<span class="k">extern</span> <span class="s">&#34;C&#34;</span>
<span class="n">JNIEXPORT</span> <span class="kt">void</span> <span class="n">JNICALL</span>
<span class="n">Java_org_example_luojni_MainActivity_fun2</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">thiz</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//反射
</span><span class="c1"></span>    <span class="c1">//拿Java类
</span><span class="c1"></span>    <span class="n">jclass</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;org/example/luojni/MyClass&#34;</span><span class="p">);</span>

    <span class="c1">//new对象
</span><span class="c1"></span>    <span class="c1">//传&#34;&lt;init&gt;&#34; 就是拿构造
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">construct</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="c1">//构造若是有参数就传参, 这个函数是不定参的
</span><span class="c1"></span>    <span class="n">jobject</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">construct</span><span class="p">);</span>

    <span class="c1">//调方法
</span><span class="c1"></span>    <span class="c1">//非静态方法
</span><span class="c1"></span>    <span class="c1">//()V 括号内写参数 后面写返回值
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">fun1</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#34;fun1&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallVoidMethod</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fun1</span><span class="p">);</span>
    <span class="c1">//静态方法
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">fun2</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#34;fun2&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">fun2</span><span class="p">);</span>
    <span class="c1">//示例
</span><span class="c1"></span>    <span class="n">jmethodID</span> <span class="n">Add</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#34;Add&#34;</span><span class="p">,</span> <span class="s">&#34;(II)I&#34;</span><span class="p">);</span>
    <span class="c1">//检查Java中的异常
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionCheck</span><span class="p">()){</span>
        <span class="c1">//打印异常栈信息
</span><span class="c1"></span>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionDescribe</span><span class="p">();</span>
        <span class="c1">//清除异常信息 为了不让程序崩
</span><span class="c1"></span>        <span class="n">env</span><span class="o">-&gt;</span><span class="n">ExceptionClear</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">jint</span> <span class="n">nRet</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

    <span class="c1">//修改字段
</span><span class="c1"></span>    <span class="n">jfieldID</span> <span class="n">mData</span> <span class="o">=</span>  <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetFieldID</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#34;mData&#34;</span><span class="p">,</span> <span class="s">&#34;I&#34;</span><span class="p">);</span>
    <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetIntField</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mData</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

    <span class="c1">//引用计数 我们在C++中New了一个对象 Java虚拟机如何知道何时释放对象
</span><span class="c1"></span>    <span class="c1">//释放字符串或数组对象 可以调env-&gt;Release...
</span><span class="c1"></span>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">DeleteLocalRef</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="加密">加密</h4>
<p>Java的逆向相对于C++来说比较容易,将Java中的所有代码都用C++反射来调用,然后对C++层进行加密.</p>
<h4 id="注意-3">注意</h4>
<p>在C++中反射调Java无视权限(public private).</p>
<h3 id="源代码">源代码</h3>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/ndk%E5%BC%80%E5%8F%91/C&#43;&#43;%E8%B0%83Java.7z" rel="">C++调Java.7z</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-10-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ndk%E5%BC%80%E5%8F%91/">NDK开发</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/android/android%E5%9F%BA%E7%A1%80/android%E5%BC%80%E5%8F%91/" class="prev" rel="prev" title="Android开发"><i class="fas fa-angle-left fa-fw"></i>Android开发</a>
            <a href="/posts/android/androidhook/frida%E4%BD%BF%E7%94%A8/" class="next" rel="next" title="Frida使用">Frida使用<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">夏洛魂</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">夏洛魂</a></span>&nbsp;|&nbsp;<span class="license">MIT</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
