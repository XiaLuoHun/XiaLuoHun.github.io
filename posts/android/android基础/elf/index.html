<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>ELF - 夏洛魂的个人博客</title><meta name="Description" content="个人笔记本"><meta property="og:title" content="ELF" />
<meta property="og:description" content="ELF 是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/elf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-20T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ELF"/>
<meta name="twitter:description" content="ELF 是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/elf/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/%E7%95%8C%E9%9D%A2%E7%BC%96%E7%A8%8B/mfc/" /><link rel="next" href="https://XiaLuoHun.github.io/posts/android/android%E5%9F%BA%E7%A1%80/android%E5%BC%80%E5%8F%91/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "ELF",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/elf\/"
        },"genre": "posts","keywords": "ELF","wordcount":  9915 ,
        "url": "https:\/\/XiaLuoHun.github.io\/posts\/android\/android%E5%9F%BA%E7%A1%80\/elf\/","datePublished": "2021-10-20T00:00:00+00:00","dateModified": "2021-10-20T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "夏洛魂"},"author": {
                "@type": "Person",
                "name": "夏洛魂"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夏洛魂的个人博客">主页</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夏洛魂的个人博客">主页</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于作者</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">ELF</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>夏洛魂</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/android%E5%9F%BA%E7%A1%80/"><i class="far fa-folder fa-fw"></i>Android基础</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-10-20">2021-10-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 9915 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 20 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#elf">ELF</a>
      <ul>
        <li><a href="#准备工作">准备工作</a>
          <ul>
            <li><a href="#准备一个elf文件">准备一个Elf文件</a></li>
            <li><a href="#makefile脚本">makefile脚本</a></li>
          </ul>
        </li>
        <li><a href="#文件格式">文件格式</a>
          <ul>
            <li><a href="#概述">概述</a>
              <ul>
                <li><a href="#数据类型">数据类型</a></li>
              </ul>
            </li>
            <li><a href="#elf文件头">ELF文件头</a>
              <ul>
                <li><a href="#e_ident">e_ident</a>
                  <ul>
                    <li><a href="#ei_class">EI_CLASS</a></li>
                    <li><a href="#ei_data">EI_DATA</a></li>
                    <li><a href="#ei_version">EI_VERSION</a></li>
                  </ul>
                </li>
                <li><a href="#e_type">e_type</a></li>
                <li><a href="#e_machine">e_machine</a></li>
                <li><a href="#e_version">e_version</a></li>
                <li><a href="#e_entry">e_entry</a></li>
                <li><a href="#e_phoff">e_phoff</a></li>
                <li><a href="#e_shoff">e_shoff</a></li>
                <li><a href="#e_flags">e_flags</a></li>
                <li><a href="#e_ehsize">e_ehsize</a></li>
                <li><a href="#e_phentsize">e_phentsize</a></li>
                <li><a href="#e_phnum">e_phnum</a></li>
                <li><a href="#e_shentsize">e_shentsize</a></li>
                <li><a href="#e_shnum">e_shnum</a></li>
                <li><a href="#e_shstrndx">e_shstrndx</a></li>
              </ul>
            </li>
            <li><a href="#节">节</a>
              <ul>
                <li><a href="#sh_name">sh_name</a></li>
                <li><a href="#sh_type">sh_type</a></li>
                <li><a href="#sh_flags">sh_flags</a></li>
                <li><a href="#sh_addr">sh_addr</a></li>
                <li><a href="#sh_offset">sh_offset</a></li>
                <li><a href="#sh_size">sh_size</a></li>
                <li><a href="#sh_link">sh_link</a></li>
                <li><a href="#sh_info">sh_info</a></li>
                <li><a href="#sh_addralign">sh_addralign</a></li>
                <li><a href="#sh_entsize">sh_entsize</a></li>
              </ul>
            </li>
            <li><a href="#特殊节">特殊节</a></li>
            <li><a href="#符号表">符号表</a>
              <ul>
                <li><a href="#符号表项结构">符号表项结构</a>
                  <ul>
                    <li><a href="#st_name">st_name</a></li>
                    <li><a href="#st_info">st_info</a></li>
                    <li><a href="#st_shndx">st_shndx</a>
                      <ul>
                        <li><a href="#源代码">源代码</a></li>
                        <li><a href="#分析">分析</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#哈希表">哈希表</a>
              <ul>
                <li><a href="#旧版hash">旧版(.hash)</a>
                  <ul>
                    <li><a href="#哈希表结构">哈希表结构</a></li>
                    <li><a href="#哈希算法">哈希算法</a>
                      <ul>
                        <li><a href="#原始算法">原始算法</a></li>
                        <li><a href="#android中的hash算法">Android中的hash算法</a></li>
                      </ul>
                    </li>
                    <li><a href="#示例">示例</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#程序链接表">程序链接表</a></li>
            <li><a href="#全局偏移表">全局偏移表</a>
              <ul>
                <li><a href="#plt和got的关系">plt和got的关系</a></li>
              </ul>
            </li>
            <li><a href="#重定位表">重定位表</a>
              <ul>
                <li><a href="#项结构">项结构</a>
                  <ul>
                    <li><a href="#r_info-的宏定义">r_info 的宏定义</a></li>
                  </ul>
                </li>
                <li><a href="#示例-1">示例</a>
                  <ul>
                    <li><a href="#ida查看偏移">IDA查看偏移</a></li>
                    <li><a href="#符号表第2项">符号表第2项</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#动态节">动态节</a>
              <ul>
                <li><a href="#项结构-1">项结构</a>
                  <ul>
                    <li><a href="#d_tag">d_tag</a>
                      <ul>
                        <li><a href="#dt_needed">DT_NEEDED</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#程序头表">程序头表</a>
              <ul>
                <li><a href="#程序头结构">程序头结构</a>
                  <ul>
                    <li><a href="#p_type">p_type</a></li>
                    <li><a href="#p_offset">p_offset</a></li>
                    <li><a href="#p_vaddr">p_vaddr</a></li>
                    <li><a href="#p_paddr">p_paddr</a></li>
                    <li><a href="#p_filesz">p_filesz</a></li>
                    <li><a href="#p_memsz">p_memsz</a></li>
                    <li><a href="#p_flags">p_flags</a></li>
                    <li><a href="#p_align">p_align</a></li>
                  </ul>
                </li>
                <li><a href="#段示例">段示例</a></li>
              </ul>
            </li>
            <li><a href="#攻防对抗">攻防对抗</a>
              <ul>
                <li><a href="#动态运行修改api地址">动态运行,修改api地址</a></li>
                <li><a href="#got表hook">Got表Hook</a></li>
                <li><a href="#阅读系统加载动态节数据源码">阅读系统加载动态节数据源码</a></li>
                <li><a href="#抹除文件格式">抹除文件格式</a></li>
                <li><a href="#重建节表">重建节表</a>
                  <ul>
                    <li><a href="#节和段的关系">节和段的关系</a></li>
                    <li><a href="#plt">plt</a>
                      <ul>
                        <li><a href="#结构">结构</a></li>
                        <li><a href="#foa">FOA</a></li>
                        <li><a href="#size">SIZE</a></li>
                      </ul>
                    </li>
                    <li><a href="#text">text</a>
                      <ul>
                        <li><a href="#foa-1">FOA</a></li>
                        <li><a href="#size-1">SIZE</a></li>
                      </ul>
                    </li>
                    <li><a href="#数据段">数据段</a></li>
                  </ul>
                </li>
                <li><a href="#java函数hook">Java函数Hook</a>
                  <ul>
                    <li><a href="#dalvik虚拟机">Dalvik虚拟机</a>
                      <ul>
                        <li><a href="#java源代码">Java源代码</a></li>
                        <li><a href="#反射调用java中的方法">反射调用Java中的方法</a></li>
                        <li><a href="#getmethodid">GetMethodID</a></li>
                        <li><a href="#jni修改">jni修改</a></li>
                        <li><a href="#注意">注意</a></li>
                        <li><a href="#源代码-1">源代码</a></li>
                      </ul>
                    </li>
                    <li><a href="#art虚拟机">Art虚拟机</a>
                      <ul>
                        <li><a href="#jni修改-1">jni修改</a></li>
                        <li><a href="#源代码-2">源代码</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#参考文档">参考文档</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="elf">ELF</h1>
<p>是UNIX系统实验室(USL)作为应用程序二进制接口(Application Binary Interface,ABI)而开发和发布的,也是Linux的主要可执行文件格式.全称是Executable and Linking Format,这个名字相当关键,包含了ELF所需要支持的两个功能——执行和链接.</p>
<h2 id="准备工作">准备工作</h2>
<h3 id="准备一个elf文件">准备一个Elf文件</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello ELF!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="makefile脚本">makefile脚本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nv">AS_PATH</span>  <span class="o">:=</span> /data/local/tmp
<span class="nv">ELF_PATH</span> <span class="o">:=</span> E:/SoftWareWork/AndroidStudioWork/LuoELF/app/build/intermediates/cmake/debug/obj/armeabi-v7a
<span class="nv">ELF_NAME</span> <span class="o">:=</span> luoelf

<span class="nf">all</span><span class="o">:</span>
 adb push <span class="k">$(</span>ELF_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span> <span class="k">$(</span>AS_PATH<span class="k">)</span>
 adb shell chmod a+x <span class="k">$(</span>AS_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span>
 adb shell <span class="k">$(</span>AS_PATH<span class="k">)</span>/<span class="k">$(</span>ELF_NAME<span class="k">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="文件格式">文件格式</h2>
<h3 id="概述">概述</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f%e6%a6%82%e8%bf%b0.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png, images/%e6%96%87%e4%bb%b6%e6%a0%bc%e5%bc%8f%e6%a6%82%e8%bf%b0.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E6%A6%82%E8%BF%B0.png"
        title="文件格式概述" /></p>
<p>程序头表指向段,等价于PE中的节,用来描述内存映射.
节头表指向节,类似PE的数据目录,指向各种表.
在Obj文件中段是可选的,在可执行文件中节是可选的,但是NDK编译出的ELF文件,段和节都是有的.</p>
<p>总体来说就是一个ELF文件包含3部分,ELF文件头、节、段.</p>
<h4 id="数据类型">数据类型</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png, images/%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png"
        title="数据类型" /></p>
<h3 id="elf文件头">ELF文件头</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#define EI_NIDENT 16 
</span><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span>
 <span class="n">Elf32_Half</span> <span class="n">e_type</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_machine</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">e_version</span><span class="p">;</span>
 <span class="n">Elf32_Addr</span> <span class="n">e_entry</span><span class="p">;</span>
 <span class="n">Elf32_Off</span> <span class="n">e_phoff</span><span class="p">;</span>
 <span class="n">Elf32_Off</span> <span class="n">e_shoff</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">e_flags</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_ehsize</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_phentsize</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_phnum</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_shentsize</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_shnum</span><span class="p">;</span>
 <span class="n">Elf32_Half</span> <span class="n">e_shstrndx</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Elf32_Ehdr</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="e_ident">e_ident</h4>
<p>这16字节是ELF标识,前4字节是文件标志,不可修改.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/e_ident.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_ident.png, images/e_ident.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_ident.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_ident.png"
        title="e_ident" /></p>
<h5 id="ei_class">EI_CLASS</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/EI_CLASS.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_CLASS.png, images/EI_CLASS.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_CLASS.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_CLASS.png"
        title="EI_CLASS" /></p>
<p>这个字节指明了文件类型.
Android系统不检查这个字节,它是通过判断指令集v7a,v8a来确定是32位还是64位.
IDA检查了这个字节,如果修改了这个字节,IDA就无法反汇编.</p>
<h5 id="ei_data">EI_DATA</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/EI_DATA.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_DATA.png, images/EI_DATA.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_DATA.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/EI_DATA.png"
        title="EI_DATA" /></p>
<p>这个字节决定了接下来ELF文件结构体的解析是按大尾方式还是小尾方式.
Android系统不检查这个字节,默认为小尾方式.
IDA检查了这个字节,如果修改了这个字节,IDA就无法反汇编.</p>
<h5 id="ei_version">EI_VERSION</h5>
<p>ELF文件头的版本.</p>
<h4 id="e_type">e_type</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/e_type.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_type.png, images/e_type.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_type.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_type.png"
        title="e_type" /></p>
<p>这2字节是文件类型.
Android5.0之后,可执行文件全部为so文件.
Android高版本,这2字节只能是03,不能修改.</p>
<h4 id="e_machine">e_machine</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/e_machine1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine1.png, images/e_machine1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine1.png"
        title="e_machine1" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/e_machine2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine2.png, images/e_machine2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_machine2.png"
        title="e_machine2" /></p>
<p>这2字节是指令集,可在elf-em.h这个头文件中,查看扩展指令集.
这2字节不可修改.</p>
<h4 id="e_version">e_version</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/e_version.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_version.png, images/e_version.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_version.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/e_version.png"
        title="e_version" /></p>
<p>这4字节指明目标文件的版本.
Android系统不检查这4字节.
IDA检查了这4字节,不过影响不大,如果修改了,IDA还是可以反汇编.</p>
<h4 id="e_entry">e_entry</h4>
<p>这4字节是程序入口点(OEP),是个RVA.
但如果上面e_type的值是02,这个值就是VA.
如果是共享库文件,这4字节是0.
如果是可执行文件,这4字节不是0.
这是共享库文件和可执行文件很重要的差别.</p>
<h4 id="e_phoff">e_phoff</h4>
<p>这4字节是程序头表偏移,如果没有程序头表,该值应为0.</p>
<h4 id="e_shoff">e_shoff</h4>
<p>这4字节是节头表偏移,如果没有节头表,该值应为0.
在Android对抗中,删节表是很常见的.</p>
<h4 id="e_flags">e_flags</h4>
<p>这4字节是个标志,没什么用.</p>
<h4 id="e_ehsize">e_ehsize</h4>
<p>这2字节是ELF文件头大小,以字节为单位.
Android系统,不检查这2字节,默认ELF文件头大小为52字节.
IDA检查了这2字节,如果我们修改了这2字节内容.IDA只会产生警告,影响不大,仍然可以反汇编.</p>
<h4 id="e_phentsize">e_phentsize</h4>
<p>这2字节表明程序头表每一个表项的大小,以字节为单位.</p>
<h4 id="e_phnum">e_phnum</h4>
<p>这2字节表明程序头表总共有多少表项,如果没有程序头表,该值应设为0.</p>
<h4 id="e_shentsize">e_shentsize</h4>
<p>这2字节表明节头表每一个表项的大小,以字节为单位.</p>
<h4 id="e_shnum">e_shnum</h4>
<p>这2字节表明节头表总共有多少表项,如果没有节头表,该值应设为0.</p>
<h4 id="e_shstrndx">e_shstrndx</h4>
<p>这2字节是节头表中与节名字表相对应表项的索引.</p>
<h3 id="节">节</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Word</span> <span class="n">sh_name</span><span class="p">;</span>       <span class="c1">//节名字
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_type</span><span class="p">;</span>       <span class="c1">//节类型
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_flags</span><span class="p">;</span>      <span class="c1">//节内存属性
</span><span class="c1"></span> <span class="n">Elf32_Addr</span> <span class="n">sh_addr</span><span class="p">;</span>       <span class="c1">//内存地址
</span><span class="c1"></span> <span class="n">Elf32_Off</span> <span class="n">sh_offset</span><span class="p">;</span>      <span class="c1">//文件偏移
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_size</span><span class="p">;</span>       <span class="c1">//节大小
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_link</span><span class="p">;</span>       <span class="c1">//一个索引值,指向节头表中本节所对应的位置
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_info</span><span class="p">;</span>       <span class="c1">//节的附加信息,根据节的类型不同,本成员的意义也有所不同
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_addralign</span><span class="p">;</span>  <span class="c1">//对齐值
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">sh_entsize</span><span class="p">;</span>    <span class="c1">//有一些节的内容是一张表,其中每一个表项的大小是固定的,比如符号表.对于这种表来说,本成员指定其每一个表项的大小
</span><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Shdr</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="sh_name">sh_name</h4>
<p>4字节,是个偏移值,暂记为P1.
首先通过ELF文件头最后一项e_shstrndx拿到节表中节名称表对应表项的索引,
然后在节表中找到该项,找到sh_offset文件偏移值,暂记为P2
最后将P1 + P2,即可得到该节名字的字符串文件偏移值.</p>
<h4 id="sh_type">sh_type</h4>
<p>4字节,节类型.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">typedef</span> <span class="k">enum</span> <span class="err">&lt;</span><span class="nc">Elf32_Word</span><span class="o">&gt;</span> <span class="p">{</span>
 <span class="n">SHT_NULL</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="cm">/* Inactive section header */</span>
 <span class="n">SHT_PROGBITS</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> <span class="cm">/* Information defined by the program */</span>
 <span class="n">SHT_SYMTAB</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span> <span class="cm">/* Symbol table - not DLL */</span>
 <span class="n">SHT_STRTAB</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span> <span class="cm">/* String table */</span>
 <span class="n">SHT_RELA</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span> <span class="cm">/* Explicit addend relocations, Elf64_Rela */</span>
 <span class="n">SHT_HASH</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span> <span class="cm">/* Symbol hash table */</span>
 <span class="n">SHT_DYNAMIC</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">,</span> <span class="cm">/* Information for dynamic linking */</span>
 <span class="n">SHT_NOTE</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span> <span class="cm">/* A Note section */</span>
 <span class="n">SHT_NOBITS</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span> <span class="cm">/* Like SHT_PROGBITS with no data */</span>
 <span class="n">SHT_REL</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">,</span> <span class="cm">/* Implicit addend relocations, Elf64_Rel */</span>
 <span class="n">SHT_SHLIB</span> <span class="o">=</span> <span class="mh">0xA</span><span class="p">,</span> <span class="cm">/* Currently unspecified semantics */</span>
 <span class="n">SHT_DYNSYM</span> <span class="o">=</span> <span class="mh">0xD</span><span class="p">,</span> <span class="cm">/* Symbol table for a DLL */</span>
 <span class="n">SHT_INIT_ARRAY</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">,</span> <span class="cm">/* Array of constructors */</span>
 <span class="n">SHT_FINI_ARRAY</span> <span class="o">=</span> <span class="mh">0xF</span><span class="p">,</span> <span class="cm">/* Array of deconstructors */</span>
 <span class="n">SHT_PREINIT_ARRAY</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* Array of pre-constructors */</span>
 <span class="n">SHT_GROUP</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span> <span class="cm">/* Section group */</span>
 <span class="n">SHT_SYMTAB_SHNDX</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span> <span class="cm">/* Extended section indeces */</span>
 <span class="n">SHT_NUM</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span> <span class="cm">/* Number of defined types */</span>

 <span class="n">SHT_LOOS</span> <span class="o">=</span> <span class="mh">0x60000000</span><span class="p">,</span> <span class="cm">/* Lowest OS-specific section type */</span>
 <span class="n">SHT_GNU_ATTRIBUTES</span> <span class="o">=</span> <span class="mh">0x6ffffff5</span><span class="p">,</span> <span class="cm">/* Object attribuytes */</span>
 <span class="n">SHT_GNU_HASH</span> <span class="o">=</span> <span class="mh">0x6ffffff6</span><span class="p">,</span> <span class="cm">/* GNU-style hash table */</span>
 <span class="n">SHT_GNU_LIBLIST</span> <span class="o">=</span> <span class="mh">0x6ffffff7</span><span class="p">,</span> <span class="cm">/* Prelink library list */</span>
 <span class="n">SHT_CHECKSUM</span> <span class="o">=</span> <span class="mh">0x6ffffff8</span><span class="p">,</span> <span class="cm">/* Checksum for DSO content */</span>
 <span class="n">SHT_LOSUNW</span> <span class="o">=</span> <span class="mh">0x6ffffffa</span><span class="p">,</span> <span class="cm">/* Sun-specific low bound */</span>
 <span class="n">SHT_SUNW_move</span> <span class="o">=</span> <span class="mh">0x6ffffffa</span><span class="p">,</span> <span class="c1">// Same thing
</span><span class="c1"></span> <span class="n">SHT_SUNW_COMDAT</span> <span class="o">=</span> <span class="mh">0x6ffffffb</span><span class="p">,</span>
 <span class="n">SHT_SUNW_syminfo</span> <span class="o">=</span> <span class="mh">0x6ffffffc</span><span class="p">,</span>
 <span class="n">SHT_GNU_verdef</span> <span class="o">=</span> <span class="mh">0x6ffffffd</span><span class="p">,</span> <span class="cm">/* Version definition section */</span>
 <span class="n">SHT_GNU_verdneed</span> <span class="o">=</span> <span class="mh">0x6ffffffe</span><span class="p">,</span> <span class="cm">/* Version needs section */</span>
 <span class="n">SHT_GNY_versym</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Version symbol table */</span>
 <span class="n">SHT_HISUNW</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Sun-specific high bound */</span>
 <span class="n">SHT_HIOS</span> <span class="o">=</span> <span class="mh">0x6fffffff</span><span class="p">,</span> <span class="cm">/* Highest OS-specific section type */</span>
 <span class="n">SHT_LOPROC</span> <span class="o">=</span> <span class="mh">0x70000000</span><span class="p">,</span> <span class="cm">/* Start of processor-specific section type */</span>
 <span class="n">SHT_HIPROC</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">,</span> <span class="cm">/* End of processor-specific section type */</span>
 <span class="n">SHT_LOUSER</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">,</span> <span class="cm">/* Start of application-specific */</span>
 <span class="n">SHT_HIUSER</span> <span class="o">=</span> <span class="mh">0x8fffffff</span> <span class="cm">/* Ennd of application-specific */</span>
<span class="p">}</span> <span class="n">s_type32_e</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="sh_flags">sh_flags</h4>
<p>4字节,由一系列标志比特位组成.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/sh_flags.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_flags.png, images/sh_flags.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_flags.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_flags.png"
        title="sh_flags" /></p>
<h4 id="sh_addr">sh_addr</h4>
<p>4字节,内存地址.</p>
<h4 id="sh_offset">sh_offset</h4>
<p>4字节,文件偏移.</p>
<h4 id="sh_size">sh_size</h4>
<p>4字节,节大小.</p>
<h4 id="sh_link">sh_link</h4>
<p>4字节,一个索引值,指向节头表中本节所对应的位置.</p>
<h4 id="sh_info">sh_info</h4>
<p>4字节,节的附加信息,根据节的类型不同,本成员的意义也有所不同.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/sh_info.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_info.png, images/sh_info.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_info.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/sh_info.png"
        title="sh_info" /></p>
<h4 id="sh_addralign">sh_addralign</h4>
<p>4字节, 对齐值.</p>
<h4 id="sh_entsize">sh_entsize</h4>
<p>4字节,有一些节的内容是一张表,其中每一个表项的大小是固定的,比如符号表,对于这种表来说,本成员指定其每一个表项的大小.</p>
<h3 id="特殊节">特殊节</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cm">/*节名字不重要,重要的是节的类型.
</span><span class="cm">当节名字未被修改过,是具有参考价值的.
</span><span class="cm">*/</span>
<span class="p">.</span><span class="n">shstrtab</span> <span class="err">节名称表</span>
<span class="p">.</span><span class="n">text</span>     <span class="err">代码段</span>
<span class="p">.</span><span class="n">bss</span>      <span class="err">数据段</span><span class="p">(</span><span class="err">未初始化</span><span class="p">)</span>
<span class="p">.</span><span class="n">data</span>     <span class="err">数据段</span><span class="p">(</span><span class="err">初始化</span><span class="p">)</span>
<span class="p">.</span><span class="n">rodata</span>   <span class="err">常量区</span>
    
<span class="c1">//ndk的版本信息,仅供参考
</span><span class="c1"></span><span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">android</span><span class="p">.</span><span class="n">ident</span>
<span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">build</span> <span class="o">-</span> <span class="n">id</span>
<span class="p">.</span><span class="n">note</span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">gold</span> <span class="o">-</span> <span class="n">version</span>

<span class="c1">//编译器版本信息
</span><span class="c1"></span><span class="p">.</span><span class="n">comment</span>
<span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version</span>
<span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">version_r</span>
<span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">attributes</span>

<span class="c1">//调试信息,等价于PDB文件
</span><span class="c1"></span><span class="p">.</span><span class="n">debug_str</span>
<span class="p">.</span><span class="n">debug_abbrev</span>
<span class="p">.</span><span class="n">debug_info</span>
<span class="p">.</span><span class="n">debug_macinfo</span>
<span class="p">.</span><span class="n">debug_frame</span>
<span class="p">.</span><span class="n">debug_line</span>
<span class="p">.</span><span class="n">debug_loc</span>
<span class="p">.</span><span class="n">debug_ranges</span>
<span class="p">.</span><span class="n">debug_aranges</span>

<span class="c1">//初始化表
</span><span class="c1"></span><span class="p">.</span><span class="n">init_array</span> <span class="c1">//初始化函数表
</span><span class="c1"></span><span class="p">.</span><span class="n">fini_array</span> <span class="c1">//反初始化函数表
</span><span class="c1"></span>
<span class="c1">//异常表, 不是ELF的标准,是由操作系统和编译器自定义的
</span><span class="c1"></span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">exidx</span>  <span class="c1">//索引表
</span><span class="c1"></span><span class="p">.</span><span class="n">ARM</span><span class="p">.</span><span class="n">extab</span>  <span class="c1">//异常表
</span></code></pre></td></tr></table>
</div>
</div><h3 id="符号表">符号表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//符号表
</span><span class="c1">//当打包为apk,里面的动态库只有.dynsym
</span><span class="c1"></span><span class="p">.</span><span class="n">dynsym</span>
<span class="p">.</span><span class="n">symtab</span>

<span class="c1">//符号表字符串
</span><span class="c1"></span><span class="p">.</span><span class="n">dynstr</span>
<span class="p">.</span><span class="n">strtab</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="符号表项结构">符号表项结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Word</span> <span class="n">st_name</span><span class="p">;</span>     <span class="c1">//符号的名字,指向字符串表的索引
</span><span class="c1"></span> <span class="n">Elf32_Addr</span> <span class="n">st_value</span><span class="p">;</span>    <span class="c1">//符号的值, 地址, 是个RVA
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">st_size</span><span class="p">;</span>     <span class="c1">//符号的大小
</span><span class="c1"></span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_info</span><span class="p">;</span>  <span class="c1">//符号的类型和属性
</span><span class="c1"></span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_other</span><span class="p">;</span> <span class="c1">//暂未使用
</span><span class="c1"></span> <span class="n">Elf32_Half</span> <span class="n">st_shndx</span><span class="p">;</span>    <span class="c1">//一个索引值,指向相关联的节在节头表中的索引
</span><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Sym</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>符号表描述了导入和导出,st_value的值为非0,表示是导出为0,则表示是导入.</p>
<h5 id="st_name">st_name</h5>
<p>指向字符串表的索引,节头表中的link值说明了是哪个字符串表.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/st_name.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_name.png, images/st_name.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_name.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_name.png"
        title="st_name" /></p>
<h5 id="st_info">st_info</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="cp">#define ELF32_ST_BIND(i) ((i)&gt;&gt;4) 
</span><span class="cp">#define ELF32_ST_TYPE(i) ((i)&amp;0xf) 
</span><span class="cp">#define ELF32_ST_INFO(b,t) (((b)&lt;&lt;4)+((t)&amp;0xf))
</span></code></pre></td></tr></table>
</div>
</div><p>高4字节是符号绑定.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%ac%a6%e5%8f%b7%e7%bb%91%e5%ae%9a.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png, images/%e7%ac%a6%e5%8f%b7%e7%bb%91%e5%ae%9a.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%BB%91%E5%AE%9A.png"
        title="符号绑定" /></p>
<p>低4字节是符号类型.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%ac%a6%e5%8f%b7%e7%b1%bb%e5%9e%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png, images/%e7%ac%a6%e5%8f%b7%e7%b1%bb%e5%9e%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%AC%A6%E5%8F%B7%E7%B1%BB%E5%9E%8B.png"
        title="符号类型" /></p>
<h5 id="st_shndx">st_shndx</h5>
<p>这里我们导出一个全局变量,来理解下这个字段的意思.</p>
<h6 id="源代码">源代码</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">int</span> <span class="n">g_n</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

 <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Hello ELF! %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_n</span><span class="p">);</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="分析">分析</h6>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/st_shndx1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx1.png, images/st_shndx1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx1.png"
        title="st_shndx1" /></p>
<p>从上图中可以看到,导出的全局变量g_n的RVA为0x2000,大小为4字节,st_shndx字段为22.
那么这个全局变量的值在文件偏移的哪个地方记录呢?
我们去节头表中的第22项看下.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/st_shndx2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx2.png, images/st_shndx2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/st_shndx2.png"
        title="st_shndx2" /></p>
<p>节头表的第22项,所在的RVA是0x2000,FOA是0x1000,
而全局变量g_n的RVA为0x2000,大小为4字节,
也就是说文件偏移0x1000的地方开始是4字节内容就是全局变量的值,100.</p>
<h3 id="哈希表">哈希表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//哈希表
</span><span class="c1"></span><span class="p">.</span><span class="n">hash</span>      <span class="c1">//旧版,导入导出均可查
</span><span class="c1"></span><span class="p">.</span><span class="n">gnu</span><span class="p">.</span><span class="n">hash</span> <span class="c1">//新版,效率高,只可查导出
</span></code></pre></td></tr></table>
</div>
</div><h4 id="旧版hash">旧版(.hash)</h4>
<h5 id="哈希表结构">哈希表结构</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%bb%93%e6%9e%84.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png, images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%bb%93%e6%9e%84.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%BB%93%E6%9E%84.png"
        title="哈希表结构" /></p>
<p>Bucket数组中含有nbucket个项,chain数组中含有nchain个项,序号都从0开始.
Bucket和chain中包含的都是符号表中的索引.hash有可能冲突,chain里面放的就是所有冲突的.
给定一个符号名字,返回一个哈希值x,然后由bucket[x%nbucket]得到一个符号表索引y,
如果索引y对应的符号表项不是想要的符号(通过对比名字),则由chain[y]得到下一个符号表索引z,如果仍不是想要的符号,继续chain[z]…,
如果chain[z]的值为0,说明该符号不存在.</p>
<h5 id="哈希算法">哈希算法</h5>
<h6 id="原始算法">原始算法</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">elf_hash</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>
 <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span>
   <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
  <span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">g</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="android中的hash算法">Android中的hash算法</h6>
<p>Google并没有用原始的hash算法.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//http://androidxref.com/4.0.3_r1/xref/bionic/linker/linker.c#elfhash
</span><span class="c1"></span><span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_name</span><span class="p">)</span>
<span class="p">{</span>
 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">_name</span><span class="p">;</span>
 <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>

 <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
  <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
  <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="示例">示例</h5>
<p>环境:解压AndroidStudio编译出来的Release版apk,查看其中的so文件.</p>
<p>目标:查找main这个符号.</p>
<ol>
<li>查看.hash数据.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png, images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B1.png"
        title="哈希表示例1" /></p>
<p>可以得到:
nbucket = 0x11
nchain = 0x14</p>
<ol start="2">
<li>计算hash%nbucket.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b2.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png, images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b2.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B2.png"
        title="哈希表示例2" /></p>
<p>得到的结果y = 10.</p>
<ol start="3">
<li>查找main.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b3.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png, images/%e5%93%88%e5%b8%8c%e8%a1%a8%e7%a4%ba%e4%be%8b3.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E5%93%88%E5%B8%8C%E8%A1%A8%E7%A4%BA%E4%BE%8B3.png"
        title="哈希表示例3" /></p>
<p>y = 10,bucket[y] = 7,查看动态符号表的第7项不是main,
chain[7] =  3,查看动态符号表的第3项不是main,
chain[3] = 0x11,查看动态符号表的第17项是main.</p>
<h3 id="程序链接表">程序链接表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="p">.</span><span class="n">plt</span> <span class="c1">//过程链接,Procedure Link Table
</span></code></pre></td></tr></table>
</div>
</div><p>外部调用的跳板,是个代理函数.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%a8%8b%e5%ba%8f%e9%93%be%e6%8e%a5%e8%a1%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png, images/%e7%a8%8b%e5%ba%8f%e9%93%be%e6%8e%a5%e8%a1%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%A8%8B%E5%BA%8F%E9%93%BE%E6%8E%A5%E8%A1%A8.png"
        title="程序链接表" /></p>
<p>IDA是通过节表拿到plt节的地址,从而解析plt函数的.
从上图中可以看到每两个plt函数之间的大小为12字节,
假如我们将节表中plt节的偏移加12字节的倍数,IDA解析api就会错位,实际上也确是如此.
这样修改之后不会影响程序的运行,因为程序的运行是不需要节表的.</p>
<h3 id="全局偏移表">全局偏移表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="p">.</span><span class="n">got</span> <span class="c1">//等价于PE中的IAT表,Global Offset Table
</span></code></pre></td></tr></table>
</div>
</div><p>记录外部调用的入口地址.</p>
<h4 id="plt和got的关系">plt和got的关系</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//每调一个api,编译器就会生成一个plt函数
</span><span class="c1"></span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">g_printf</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">__fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="o">=</span> <span class="n">plt</span><span class="p">;</span>

<span class="cm">/*
</span><span class="cm"> * plt:
</span><span class="cm"> *   jmp [got]
</span><span class="cm"> *
</span><span class="cm"> * got:
</span><span class="cm"> *   load1
</span><span class="cm"> *
</span><span class="cm"> * load1:
</span><span class="cm"> *   dlopen
</span><span class="cm"> *   dlsym
</span><span class="cm"> *   got = addr
</span><span class="cm"> */</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="重定位表">重定位表</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">plt</span> <span class="c1">//修api地址
</span><span class="c1"></span><span class="p">.</span><span class="n">rel</span><span class="p">.</span><span class="n">dyn</span> <span class="c1">//修全局变量
</span></code></pre></td></tr></table>
</div>
</div><h4 id="项结构">项结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Addr</span> <span class="n">r_offset</span><span class="p">;</span> <span class="c1">//Rva,修完之后放在哪里
</span><span class="c1"></span> <span class="n">Elf32_Word</span> <span class="n">r_info</span><span class="p">;</span>   <span class="c1">//既给出了重定位所作用的符号表索引,也给出了重定位的类型
</span><span class="c1"></span><span class="p">}</span> <span class="n">Elf32_Rel</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Addr</span> <span class="n">r_offset</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">r_info</span><span class="p">;</span>
 <span class="n">Elf32_Sword</span> <span class="n">r_addend</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Elf32_Rela</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="r_info-的宏定义">r_info 的宏定义</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#define ELF32_R_SYM(i) ((i)&gt;&gt;8)               </span><span class="c1">//高24位是符号表索引,修的位置
</span><span class="c1"></span><span class="cp">#define ELF32_R_TYPE(i) ((unsigned char)(i))  </span><span class="c1">//低8位是重定位的类型,如何修
</span><span class="c1"></span><span class="cp">#define ELF32_R_INFO(s,t) (((s)&lt;&lt;8)+(unsigned char)(t))
</span></code></pre></td></tr></table>
</div>
</div><h4 id="示例-1">示例</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a81.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png, images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a81.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A81.png"
        title="重定位表1" /></p>
<p>Elf32_Xword s_entsize = 8, 表示每项为8字节
第一项为 F0 1F 00 00 16 02 00 00
r_offset: 0x1FF0
符号表索引:0x02
重定位类型:0x16</p>
<h5 id="ida查看偏移">IDA查看偏移</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a82.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png, images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a82.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A82.png"
        title="重定位表2" /></p>
<h5 id="符号表第2项">符号表第2项</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a83.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png, images/%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a83.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%A1%A83.png"
        title="重定位表3" /></p>
<h3 id="动态节">动态节</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="p">.</span><span class="n">dynamic</span>
<span class="cm">/*这里存放了软件运行时所需要的表,操作系统是从这里拿表的.
</span><span class="cm">但是这样说又有点矛盾,因为我们前面讲软件的运行是不需要节表的.
</span><span class="cm">那么操作系统不通过节表,如何拿到动态节的地址? 段中有描述.*/</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="项结构-1">项结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Sword</span> <span class="n">d_tag</span><span class="p">;</span>     <span class="c1">//什么表
</span><span class="c1"></span> <span class="k">union</span> <span class="p">{</span>                 <span class="c1">//在哪里
</span><span class="c1"></span>  <span class="n">Elf32_Word</span> <span class="n">d_val</span><span class="p">;</span>
  <span class="n">Elf32_Addr</span> <span class="n">d_ptr</span><span class="p">;</span>
 <span class="p">}</span> <span class="n">d_un</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Elf32_Dyn</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="d_tag">d_tag</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/d_tag.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/d_tag.png, images/d_tag.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/d_tag.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/d_tag.png"
        title="d_tag" /></p>
<h6 id="dt_needed">DT_NEEDED</h6>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/DT_NEEDED.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/DT_NEEDED.png, images/DT_NEEDED.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/DT_NEEDED.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/DT_NEEDED.png"
        title="DT_NEEDED" /></p>
<p>这里面存放的是软件运行所需要的动态库.
前面我们讲符号表和重定位表,都没有提到对应的api在哪个库里面.
假设软件运行需要两个库,libc.so、 libm.so
现在有一个api,操作系统会看这个api在libc.so里面没,
如果不在,就去看libm.so里面有没有这个导出函数.
操作系统就这样遍历需要加载的库,就知道对应的api在哪个库里面了.</p>
<h3 id="程序头表">程序头表</h3>
<p>用来保存程序加载到内存中所需要的信息,用段(segment)来表示,与节头表类似,同样是数组结构.
数组的位置在偏移e_phoff处,每个元素(segment header)的大小为e_phentsize,共有e_phnum个元素.</p>
<h4 id="程序头结构">程序头结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
 <span class="n">Elf32_Word</span> <span class="n">p_type</span><span class="p">;</span>
 <span class="n">Elf32_Off</span>  <span class="n">p_offset</span><span class="p">;</span>
 <span class="n">Elf32_Addr</span> <span class="n">p_vaddr</span><span class="p">;</span>
 <span class="n">Elf32_Addr</span> <span class="n">p_paddr</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">p_filesz</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">p_memsz</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">p_flags</span><span class="p">;</span>
 <span class="n">Elf32_Word</span> <span class="n">p_align</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Elf32_Phdr</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="p_type">p_type</h5>
<p>类型
PT_NULL:表示该段未使用.
PT_LOAD:表示要将文件中的segment内容映射到进程内存中对应的地址上.
PT_DYNAMIC:动态节.
PT_INTERP:包含interpreter的路径.
PT_HDR:表示程序头表本身.</p>
<h5 id="p_offset">p_offset</h5>
<p>该段的文件偏移.</p>
<h5 id="p_vaddr">p_vaddr</h5>
<p>段数据应该加载到进程的虚拟地址.</p>
<h5 id="p_paddr">p_paddr</h5>
<p>段数据应该加载到进程的物理地址.</p>
<h5 id="p_filesz">p_filesz</h5>
<p>该段的文件大小.</p>
<h5 id="p_memsz">p_memsz</h5>
<p>该段的内存大小.</p>
<h5 id="p_flags">p_flags</h5>
<p>段的内存属性.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/p_flags.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/p_flags.png, images/p_flags.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/p_flags.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/p_flags.png"
        title="p_flags" /></p>
<h5 id="p_align">p_align</h5>
<p>该段数据的对齐值.</p>
<h4 id="段示例">段示例</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e6%ae%b5%e7%a4%ba%e4%be%8b.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png, images/%e6%ae%b5%e7%a4%ba%e4%be%8b.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E6%AE%B5%E7%A4%BA%E4%BE%8B.png"
        title="段示例" /></p>
<h3 id="攻防对抗">攻防对抗</h3>
<h4 id="动态运行修改api地址">动态运行,修改api地址</h4>
<p>要实现的效果是,代码中动态调用libc.so库中的exit函数,通过修改libc.so符号表中的exit函数的地址为任意函数地址,从而使在IDA中静态分析,看到的是调用exit函数,实际上调用的是其他函数.函数前加static关键字,可使该函数不导出.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define SOINFO_NAME_LEN 128
</span><span class="cp"></span><span class="k">struct</span> <span class="nc">soinfo</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SOINFO_NAME_LEN</span><span class="p">];</span>
    <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">phdr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">phnum</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>  <span class="c1">// DO NOT USE, maintained for compatibility.
</span><span class="c1"></span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">dynamic</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="n">wrprotect_start</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">wrprotect_end</span><span class="p">;</span>

    <span class="n">soinfo</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">symtab</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="n">nbucket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">nchain</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">bucket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">plt_got</span><span class="p">;</span>

    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">plt_rel</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">plt_rel_count</span><span class="p">;</span>

    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">rel_count</span><span class="p">;</span>

    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">plt_rela</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">plt_rela_count</span><span class="p">;</span>

    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">rela</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">rela_count</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">preinit_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">preinit_array_count</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">init_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">init_array_count</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">fini_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">fini_array_count</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ARM_exidx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">ARM_exidx_count</span><span class="p">;</span>
    
    <span class="kt">unsigned</span> <span class="n">refcount</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">_name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//获取模块基址
</span><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">get_module_base</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">moduleName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/self/maps&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fopen&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">FillSoInfoStruct</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szLibName</span><span class="p">){</span>
	<span class="c1">//获取libc.so的模块基址
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">get_module_base</span><span class="p">(</span><span class="n">szLibName</span><span class="p">);</span>
    <span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">libc_base</span><span class="p">;</span>
	
    <span class="c1">//拿动态节地址
</span><span class="c1"></span>    <span class="n">elf32_hdr</span><span class="o">*</span> <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_hdr</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
    <span class="n">elf32_phdr</span><span class="o">*</span> <span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
    <span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="n">dyn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_DYNAMIC</span><span class="p">){</span>
            <span class="n">dyn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Dyn</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">);</span>
            <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">dyn</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;dyn = %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">dyn</span><span class="p">);</span>

    <span class="c1">//遍历表
</span><span class="c1"></span>    <span class="c1">//遍历表的操作, Android源码中有写,这里查看的是Android 4.0.3_r1版本的源码
</span><span class="c1"></span>    <span class="c1">//在xref: /bionic/linker/linker.c中
</span><span class="c1"></span>    <span class="c1">//搜索DT_HASH
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">;</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">){</span>
        <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">++</span><span class="p">){</span>
            <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nchain</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//获取函数名对应的符号表的下标
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">GetSymtabIndex</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szFuncName</span><span class="p">){</span>

    <span class="c1">//查询hash表
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">elfhash</span><span class="p">(</span><span class="n">szFuncName</span><span class="p">)</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">;</span>
    <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_name</span><span class="p">,</span> <span class="n">szFuncName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">nIndex</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//替换后的函数
</span><span class="c1">//加static,可使该函数不导出
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">fun2</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">){</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun2&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">fun1</span><span class="p">(){</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun1&#34;</span><span class="p">);</span>

    <span class="c1">//soinfo结构体是操作系统内部的结构体
</span><span class="c1"></span>    <span class="n">soinfo</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="c1">//填充soinfo结构体
</span><span class="c1"></span>    <span class="n">FillSoInfoStruct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="s">&#34;libc.so&#34;</span><span class="p">);</span>
	
    <span class="c1">//获取libc.so库中的exit函数在符号表中的下标
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">GetSymtabIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="s">&#34;exit&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//修改libc.so库中的exit函数地址为fun2的地址
</span><span class="c1"></span>    <span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">si</span><span class="p">.</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">);</span>
    <span class="n">si</span><span class="p">.</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">fun2</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pfnEXIT</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

    <span class="c1">//直接调exit(0), 走的是plt函数
</span><span class="c1"></span>    <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span><span class="s">&#34;libc.so&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pfnEXIT</span> <span class="n">pfnExit</span> <span class="o">=</span> <span class="p">(</span><span class="n">pfnEXIT</span><span class="p">)</span><span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&#34;exit&#34;</span><span class="p">);</span>
    <span class="n">pfnExit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf/%E5%8A%A8%E6%80%81%E8%B0%83%E7%94%A8%E4%BF%AE%E6%94%B9api%E5%9C%B0%E5%9D%80.7z" rel="">动态调用修改api地址.7z</a></p>
<h4 id="got表hook">Got表Hook</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;jni.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;elf.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#define SOINFO_NAME_LEN 128
</span><span class="cp"></span><span class="k">struct</span> <span class="nc">soinfo</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">SOINFO_NAME_LEN</span><span class="p">];</span>
    <span class="n">Elf32_Phdr</span> <span class="o">*</span><span class="n">phdr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">phnum</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">entry</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">size</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">unused</span><span class="p">;</span>  <span class="c1">// DO NOT USE, maintained for compatibility.
</span><span class="c1"></span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">dynamic</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="n">wrprotect_start</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">wrprotect_end</span><span class="p">;</span>

    <span class="n">soinfo</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span><span class="p">;</span>
    <span class="n">Elf32_Sym</span> <span class="o">*</span><span class="n">symtab</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="n">nbucket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">nchain</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">bucket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">plt_got</span><span class="p">;</span>

    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">plt_rel</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">plt_rel_count</span><span class="p">;</span>

    <span class="n">Elf32_Rel</span> <span class="o">*</span><span class="n">rel</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">rel_count</span><span class="p">;</span>

    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">plt_rela</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">plt_rela_count</span><span class="p">;</span>

    <span class="n">Elf32_Rela</span> <span class="o">*</span><span class="n">rela</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">rela_count</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">preinit_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">preinit_array_count</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">init_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">init_array_count</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">fini_array</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">fini_array_count</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fini_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ARM_exidx</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">ARM_exidx_count</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="n">refcount</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">elfhash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">_name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">g</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">;</span>
        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span><span class="p">;</span>
        <span class="n">h</span> <span class="o">^=</span> <span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//获取模块基址
</span><span class="c1"></span><span class="kt">void</span> <span class="o">*</span><span class="nf">get_module_base</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">moduleName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">260</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;/proc/self/maps&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&#34;fopen&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&#34;%08x&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">FillSoInfoStruct</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szLibName</span><span class="p">){</span>
    <span class="c1">//获取模块基址
</span><span class="c1"></span>    <span class="kt">char</span><span class="o">*</span> <span class="n">libc_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">get_module_base</span><span class="p">(</span><span class="n">szLibName</span><span class="p">);</span>
    <span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">libc_base</span><span class="p">;</span>

    <span class="c1">//拿动态节地址
</span><span class="c1"></span>    <span class="n">elf32_hdr</span><span class="o">*</span> <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_hdr</span><span class="o">*</span><span class="p">)</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
    <span class="n">elf32_phdr</span><span class="o">*</span> <span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">elf32_phdr</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
    <span class="n">Elf32_Dyn</span> <span class="o">*</span><span class="n">dyn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_DYNAMIC</span><span class="p">){</span>
            <span class="n">dyn</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Dyn</span><span class="o">*</span><span class="p">)(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">phdr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">p_vaddr</span><span class="p">);</span>
            <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">dyn</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//遍历表
</span><span class="c1"></span>    <span class="c1">//遍历表的操作, Android源码中有写,这里查看的是Android 4.0.3_r1版本的源码
</span><span class="c1"></span>    <span class="c1">//在xref: /bionic/linker/linker.c中
</span><span class="c1"></span>    <span class="c1">//搜索DT_HASH
</span><span class="c1"></span>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">dynamic</span><span class="p">;</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">){</span>
        <span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">++</span><span class="p">){</span>
            <span class="k">case</span> <span class="nl">DT_HASH</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">nchain</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">))[</span><span class="mi">1</span><span class="p">];</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_STRTAB</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_SYMTAB</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Sym</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_JMPREL</span><span class="p">:</span>
                <span class="c1">//第一个重定位表
</span><span class="c1"></span>                <span class="n">si</span><span class="o">-&gt;</span><span class="n">plt_rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Rel</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_PLTRELSZ</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">plt_rel_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_REL</span><span class="p">:</span>
                <span class="c1">//第二个重定位表
</span><span class="c1"></span>                <span class="n">si</span><span class="o">-&gt;</span><span class="n">rel</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf32_Rel</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">DT_RELSZ</span><span class="p">:</span>
                <span class="n">si</span><span class="o">-&gt;</span><span class="n">rel_count</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//获取函数名对应的符号表的下标
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">GetSymtabIndex</span><span class="p">(</span><span class="n">soinfo</span><span class="o">*</span> <span class="n">si</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szFuncName</span><span class="p">){</span>
    <span class="c1">//查询hash表
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">elfhash</span><span class="p">(</span><span class="n">szFuncName</span><span class="p">)</span> <span class="o">%</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">nbucket</span><span class="p">;</span>
    <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">bucket</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">strtab</span> <span class="o">+</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">symtab</span><span class="p">[</span><span class="n">nIndex</span><span class="p">].</span><span class="n">st_name</span><span class="p">,</span> <span class="n">szFuncName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nIndex</span> <span class="o">=</span> <span class="n">si</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">nIndex</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span> <span class="kt">void</span> <span class="n">fun1</span><span class="p">(){</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">&#34;fun1&#34;</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">size_t</span> <span class="nf">FakeStrlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span><span class="p">){</span>
    <span class="k">return</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="nf">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">PFN_STRLEN</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span><span class="p">);</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">g_oldpfn</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="c1">//全局变量
</span><span class="c1"></span><span class="n">PFN_STRLEN</span> <span class="n">g_pfnstrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">;</span>

<span class="kt">bool</span> <span class="nf">LuoHook</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">lib</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span><span class="o">**</span> <span class="n">OldAddr</span><span class="p">){</span>

    <span class="cm">/*
</span><span class="cm">     * 1.找到strlen符号索引(哈希表,符号表,字符串表)
</span><span class="cm">     * 2.遍历重定位表,修改got地址(重定位表)
</span><span class="cm">     **/</span>

    <span class="c1">//soinfo结构体是操作系统内部的结构体
</span><span class="c1"></span>    <span class="n">soinfo</span> <span class="n">si</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="c1">//填充soinfo结构体
</span><span class="c1"></span>    <span class="n">FillSoInfoStruct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">lib</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">nIndex</span> <span class="o">=</span> <span class="n">GetSymtabIndex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">nIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//修改.rel.plt
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">si</span><span class="p">.</span><span class="n">plt_rel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//判断符号
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">plt_rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">nIndex</span><span class="p">){</span>
            <span class="c1">//找到Got地址
</span><span class="c1"></span>            <span class="kt">void</span><span class="o">**</span> <span class="n">got</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)(</span><span class="n">si</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">si</span><span class="p">.</span><span class="n">plt_rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>

            <span class="c1">//修改内存保护属性
</span><span class="c1"></span>            <span class="n">size_t</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">got</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pageSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="n">pageSize</span><span class="p">,</span>
                    <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>

                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;mprotect&#34;</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">//保存旧的地址
</span><span class="c1"></span>            <span class="o">*</span><span class="n">OldAddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">got</span><span class="p">;</span>
            <span class="c1">//修改got地址
</span><span class="c1"></span>            <span class="o">*</span><span class="n">got</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">//.rel.dyn
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">si</span><span class="p">.</span><span class="n">rel_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//判断符号
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ELF32_R_SYM</span><span class="p">(</span><span class="n">si</span><span class="p">.</span><span class="n">rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_info</span><span class="p">)</span> <span class="o">==</span> <span class="n">nIndex</span><span class="p">){</span>
            <span class="c1">//找到Got地址
</span><span class="c1"></span>            <span class="kt">void</span><span class="o">**</span> <span class="n">got</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)(</span><span class="n">si</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">si</span><span class="p">.</span><span class="n">rel</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r_offset</span><span class="p">);</span>

            <span class="c1">//修改内存保护属性
</span><span class="c1"></span>            <span class="n">size_t</span> <span class="n">pageSize</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGE_SIZE</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)((</span><span class="kt">int</span><span class="p">)</span><span class="n">got</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">pageSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
                         <span class="n">pageSize</span><span class="p">,</span>
                         <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>

                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;mprotect&#34;</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">//保存旧的地址
</span><span class="c1"></span>            <span class="o">*</span><span class="n">OldAddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">got</span><span class="p">;</span>
            <span class="c1">//修改got地址
</span><span class="c1"></span>            <span class="o">*</span><span class="n">got</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>

    <span class="c1">//Got表Hook
</span><span class="c1"></span>    <span class="c1">//遍历重定位表,修改got地址
</span><span class="c1"></span>    <span class="c1">//有两个重定位表都需要来修
</span><span class="c1"></span>    <span class="c1">//.rel.plt
</span><span class="c1"></span>    <span class="c1">// .rel.dyn
</span><span class="c1"></span>    <span class="n">LuoHook</span><span class="p">(</span><span class="s">&#34;/data/local/tmp/luoelf&#34;</span><span class="p">,</span> <span class="s">&#34;strlen&#34;</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">FakeStrlen</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_oldpfn</span><span class="p">);</span>

    <span class="c1">//全局变量
</span><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g_pfnstrlen</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">));</span>

    <span class="c1">//局部变量
</span><span class="c1"></span>    <span class="n">PFN_STRLEN</span> <span class="n">pfnStrlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pfnStrlen</span><span class="p">(</span><span class="s">&#34;12&#34;</span><span class="p">));</span>

    <span class="c1">//直接调
</span><span class="c1"></span>    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&#34;123&#34;</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf/Got%E8%A1%A8Hook.7z" rel="">Got表Hook.7z</a></p>
<h4 id="阅读系统加载动态节数据源码">阅读系统加载动态节数据源码</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e7%b3%bb%e7%bb%9f%e5%8a%a0%e8%bd%bd%e5%8a%a8%e6%80%81%e8%8a%82%e6%95%b0%e6%8d%ae%e6%ba%90%e7%a0%81.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png, images/%e7%b3%bb%e7%bb%9f%e5%8a%a0%e8%bd%bd%e5%8a%a8%e6%80%81%e8%8a%82%e6%95%b0%e6%8d%ae%e6%ba%90%e7%a0%81.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E7%B3%BB%E7%BB%9F%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E8%8A%82%E6%95%B0%E6%8D%AE%E6%BA%90%E7%A0%81.png"
        title="系统加载动态节数据源码" /></p>
<p>从以上代码,我们能够发现两个问题,
①系统读取动态节数据,并没有拿动态节的大小字段,而是通过*d,判断是否是0,若是0,就结束.
②动态节每项8字节,描述了什么表,在哪里.如果动态节中有重复的表,会以最后的表为准(重复的,最后一个会将前面的覆盖掉),这样我们可以在原始动态节的后面伪造数据,只要动态节的结尾是0即可.我们可以将原始动态节的其中一个表多伪造几组假数据,只要动态节的最后,这个表记录的地址是原始的即可.这样修改后,IDA静态分析不会出错,但是IDA的动态调试就会出现问题.</p>
<h4 id="抹除文件格式">抹除文件格式</h4>
<p>我们知道程序的运行是不需要节的,需要的是段,因为段描述了内存映射.
但是当程序运行起来的时候,内存已经映射完成,此时我们可以将ELF文件的头以及程序头表抹除,
这样不会影响程序的运行,可以防止别人内存Dump.
如何破这一招?
内存可以抹除文件格式,但是文件不可以,我们可以先内存Dump,
然后从文件中将ELF文件的头以及程序头表复制到Dump出来的文件中.</p>
<h4 id="重建节表">重建节表</h4>
<p>IDA在解析ELF文件时,会去拿节表中的值,来提高反汇编的效果.而软件的运行,是不需要节表的.所以我们可以修改节表中的内容,来欺骗IDA.如修改节表代码段中的文件偏移或者大小,或者数据段已初始化节中的文件偏移或大小等.</p>
<p>我们如何预防别人这样的操作呢?
我们将节表删了(即将ELF文件头中的e_shoff设置为0)用IDA分析,来和未删节表前来进行对比.</p>
<p>没有节表,IDA的反汇编效果很差,但是有节表,又担心被骗,我们可以根据段来重建节表.</p>
<h5 id="节和段的关系">节和段的关系</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a8.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png, images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a8.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A8.png"
        title="重建节表" /></p>
<h5 id="plt">plt</h5>
<h6 id="结构">结构</h6>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a81.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png, images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a81.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A81.png"
        title="重建节表1" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a82.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png, images/%e9%87%8d%e5%bb%ba%e8%8a%82%e8%a1%a82.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/%E9%87%8D%E5%BB%BA%E8%8A%82%E8%A1%A82.png"
        title="重建节表2" /></p>
<h6 id="foa">FOA</h6>
<p>DT_JMPREL表的FOA + SIZE,就是plt表的FOA.</p>
<h6 id="size">SIZE</h6>
<p>遍历段中的DT_JMPREL,拿重定位的api项数,记为x,plt的头为20字节,每个plt项12字节,则plt节的大小为 12 * x + 20.</p>
<h5 id="text">text</h5>
<h6 id="foa-1">FOA</h6>
<p>plt表的FOA + SIZE,就是text表的FOA.</p>
<h6 id="size-1">SIZE</h6>
<p>PT_SHT_ARM_EXIDX表的FOA - (plt表的FOA + plt表的SIZE).</p>
<h5 id="数据段">数据段</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="p">.</span><span class="n">data</span> <span class="c1">//初始化数据段,占空间
</span><span class="c1"></span><span class="p">.</span><span class="n">bss</span>  <span class="c1">//未初始化数据段,不占空间
</span></code></pre></td></tr></table>
</div>
</div><p>根据程序头表中的内存映射,来区分是.data还是.bss,映射内存的是.data,否则是.bss.</p>
<h4 id="java函数hook">Java函数Hook</h4>
<h5 id="dalvik虚拟机">Dalvik虚拟机</h5>
<p>实验环境为Android4.1.</p>
<p>实验目标:将Java中的加法修改为减法.</p>
<h6 id="java源代码">Java源代码</h6>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%ba1.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA1.png, images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%ba1.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA1.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BA1.png"
        title="Dalvik虚拟机1" /></p>
<h6 id="反射调用java中的方法">反射调用Java中的方法</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">vm</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;JNI_OnLoad&#34;</span><span class="p">);</span>

 <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="n">vm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">JNI_VERSION_1_6</span><span class="p">);</span>
 <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;env = %p&#34;</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>

 <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;org/example/luohook/MainActivity&#34;</span><span class="p">);</span>
 <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;clsMainActivity:%p&#34;</span><span class="p">,</span> <span class="n">clsMainActivity</span><span class="p">);</span>

 <span class="n">jmethodID</span> <span class="n">Construct</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
 <span class="n">jobject</span> <span class="n">objMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="n">Construct</span><span class="p">);</span>

 <span class="n">jmethodID</span> <span class="n">MyAdd</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;MyAdd&#34;</span><span class="p">,</span> <span class="s">&#34;(II)I&#34;</span><span class="p">);</span>
 <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;MyAdd:%p&#34;</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">);</span>

 <span class="kt">int</span> <span class="n">nRet</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">objMainActivity</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
 <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;3 + 5 = %d&#34;</span><span class="p">,</span> <span class="n">nRet</span><span class="p">);</span>

 <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从上面代码中,可以看到比较重要是地方是GetMethodID这个函数,它内部肯定拿到了Java中MyAdd的字节码,我们在Android源码中查看这个函数.</p>
<h6 id="getmethodid">GetMethodID</h6>
<p><a href="http://androidxref.com/4.1.1/xref/dalvik/vm/Jni.cpp" target="_blank" rel="noopener noreffer">http://androidxref.com/4.1.1/xref/dalvik/vm/Jni.cpp</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">static</span> <span class="n">jmethodID</span> <span class="nf">GetMethodID</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span> <span class="n">jclazz</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ScopedJniThreadState</span> <span class="n">ts</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>

    <span class="n">ClassObject</span><span class="o">*</span> <span class="n">clazz</span> <span class="o">=</span> <span class="p">(</span><span class="n">ClassObject</span><span class="o">*</span><span class="p">)</span><span class="n">dvmDecodeIndirectRef</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">self</span><span class="p">(),</span> <span class="n">jclazz</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dvmIsClassInitialized</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dvmInitClass</span><span class="p">(</span><span class="n">clazz</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">dvmCheckException</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">self</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dvmIsInterfaceClass</span><span class="p">(</span><span class="n">clazz</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">Method</span><span class="o">*</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">dvmFindInterfaceMethodHierByDescriptor</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dvmThrowExceptionFmt</span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">exNoSuchMethodError</span><span class="p">,</span>
                <span class="s">&#34;no method with name=&#39;%s&#39; signature=&#39;%s&#39; in interface %s&#34;</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">clazz</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">jmethodID</span><span class="p">)</span><span class="n">meth</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Method</span><span class="o">*</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">dvmFindVirtualMethodHierByDescriptor</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* search private methods and constructors; non-hierarchical */</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="n">dvmFindDirectMethodByDescriptor</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meth</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">dvmIsStaticMethod</span><span class="p">(</span><span class="n">meth</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">IF_ALOGD</span><span class="p">()</span> <span class="p">{</span>
            <span class="kt">char</span><span class="o">*</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">dexProtoCopyMethodDescriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meth</span><span class="o">-&gt;</span><span class="n">prototype</span><span class="p">);</span>
            <span class="n">ALOGD</span><span class="p">(</span><span class="s">&#34;GetMethodID: not returning static method %s.%s %s&#34;</span><span class="p">,</span>
                <span class="n">clazz</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dvmThrowExceptionFmt</span><span class="p">(</span><span class="n">gDvm</span><span class="p">.</span><span class="n">exNoSuchMethodError</span><span class="p">,</span>
            <span class="s">&#34;no method with name=&#39;%s&#39; signature=&#39;%s&#39; in class %s&#34;</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">clazz</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/*
</span><span class="cm">         * The method&#39;s class may not be the same as clazz, but if
</span><span class="cm">         * it isn&#39;t this must be a virtual method and the class must
</span><span class="cm">         * be a superclass (and, hence, already initialized).
</span><span class="cm">         */</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">dvmIsClassInitialized</span><span class="p">(</span><span class="n">meth</span><span class="o">-&gt;</span><span class="n">clazz</span><span class="p">)</span> <span class="o">||</span> <span class="n">dvmIsClassInitializing</span><span class="p">(</span><span class="n">meth</span><span class="o">-&gt;</span><span class="n">clazz</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">jmethodID</span><span class="p">)</span><span class="n">meth</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发现这个函数的返回值为Method结构体,继续在Android源码中查看这个结构体.</p>
<p><a href="http://androidxref.com/4.1.1/xref/dalvik/vm/oo/Object.h" target="_blank" rel="noopener noreffer">http://androidxref.com/4.1.1/xref/dalvik/vm/oo/Object.h</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span>        <span class="n">u1</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span>       <span class="n">u2</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">u4</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>   <span class="n">u8</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">char</span>          <span class="n">s1</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">short</span>         <span class="n">s2</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">int</span>           <span class="n">s4</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">long</span> <span class="kt">long</span>     <span class="n">s8</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">Object</span><span class="p">;</span>

<span class="k">union</span> <span class="nc">JValue</span> <span class="p">{</span>
 <span class="n">u1</span>      <span class="n">z</span><span class="p">;</span>
 <span class="n">s1</span>      <span class="n">b</span><span class="p">;</span>
 <span class="n">u2</span>      <span class="n">c</span><span class="p">;</span>
 <span class="n">s2</span>      <span class="n">s</span><span class="p">;</span>
 <span class="n">s4</span>      <span class="n">i</span><span class="p">;</span>
 <span class="n">s8</span>      <span class="n">j</span><span class="p">;</span>
 <span class="kt">float</span>   <span class="n">f</span><span class="p">;</span>
 <span class="kt">double</span>  <span class="n">d</span><span class="p">;</span>
 <span class="n">Object</span><span class="o">*</span> <span class="n">l</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">DalvikBridgeFunc</span><span class="p">)(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">,</span>
 <span class="k">const</span> <span class="n">Method</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">);</span>

<span class="k">struct</span> <span class="nc">Method</span> <span class="p">{</span>
 <span class="kt">void</span><span class="o">*</span>              <span class="n">clazz</span><span class="p">;</span>
 <span class="n">u4</span>                 <span class="n">accessFlags</span><span class="p">;</span>   <span class="c1">//访问权限
</span><span class="c1"></span> <span class="n">u2</span>                 <span class="n">methodIndex</span><span class="p">;</span>
 <span class="n">u2</span>                 <span class="n">registersSize</span><span class="p">;</span>
 <span class="n">u2</span>                 <span class="n">outsSize</span><span class="p">;</span>
 <span class="n">u2</span>                 <span class="n">insSize</span><span class="p">;</span>
 <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>        <span class="n">name</span><span class="p">;</span>
 <span class="n">DexProto</span>           <span class="n">prototype</span><span class="p">;</span>
 <span class="k">const</span> <span class="kt">char</span><span class="o">*</span>        <span class="n">shorty</span><span class="p">;</span>
 <span class="k">const</span> <span class="n">u2</span><span class="o">*</span>          <span class="n">insns</span><span class="p">;</span>         <span class="c1">//字节码
</span><span class="c1"></span> <span class="kt">int</span>                <span class="n">jniArgInfo</span><span class="p">;</span>
 <span class="n">DalvikBridgeFunc</span>   <span class="n">nativeFunc</span><span class="p">;</span>    <span class="c1">//jni方法
</span><span class="c1"></span> <span class="kt">bool</span>               <span class="n">fastJni</span><span class="p">;</span>
 <span class="kt">bool</span>               <span class="n">noRef</span><span class="p">;</span>
 <span class="kt">bool</span>               <span class="n">shouldTrace</span><span class="p">;</span>
 <span class="k">const</span> <span class="kt">void</span><span class="o">*</span>        <span class="n">registerMap</span><span class="p">;</span>
 <span class="kt">bool</span>               <span class="n">inProfile</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>从上面结构中可以知道,insns字段存放的是方法的字节码.</p>
<h6 id="jni修改">jni修改</h6>
<p>我们在jni中写代码,来修改字节码,从而实现在ManiActivity.OnCreate中调用的MyAdd方法修改为减法,首先,我们修改的操作应该在ManiActivity执行之前.</p>
<ol>
<li>提前加载jni库.</li>
</ol>
<p>写一个类继承Application加载jni库.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b91.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B91.png, images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b91.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B91.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B91.png"
        title="Dalvik虚拟机jni修改1" /></p>
<p>修改AndroidManifest.xml文件.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b92.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B92.png, images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b92.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B92.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B92.png"
        title="Dalvik虚拟机jni修改2" /></p>
<ol start="2">
<li>查看MyAdd的字节码.</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b93.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B93.png, images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b93.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B93.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B93.png"
        title="Dalvik虚拟机jni修改3" /></p>
<ol start="3">
<li>修改.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">void</span> <span class="nf">FakeAdd</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">,</span>
    <span class="n">Method</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;FakeAdd&#34;</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;%p %p %d %d %d&#34;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

    <span class="c1">//2个参数在args[2], args[3]
</span><span class="c1"></span>    <span class="c1">//返回值为int
</span><span class="c1"></span>    <span class="n">pResult</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span><span class="o">*</span> <span class="n">vm</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;JNI_OnLoad&#34;</span><span class="p">);</span>

    <span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">JNI_VERSION_1_6</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;env = %p&#34;</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>

    <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;org/example/luohook/MainActivity&#34;</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;clsMainActivity:%p&#34;</span><span class="p">,</span> <span class="n">clsMainActivity</span><span class="p">);</span>

    <span class="n">jmethodID</span> <span class="n">Construct</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">objMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="n">Construct</span><span class="p">);</span>

    <span class="n">jmethodID</span> <span class="n">MyAdd</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;MyAdd&#34;</span><span class="p">,</span> <span class="s">&#34;(II)I&#34;</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;MyAdd:%p&#34;</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">);</span>

    <span class="n">Method</span><span class="o">*</span> <span class="n">meth</span> <span class="o">=</span> <span class="p">(</span><span class="n">Method</span><span class="o">*</span><span class="p">)</span><span class="n">MyAdd</span><span class="p">;</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;name:%s shorty:%s insns:%p&#34;</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">shorty</span><span class="p">,</span> <span class="n">meth</span><span class="o">-&gt;</span><span class="n">insns</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">nRet</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">objMainActivity</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;3 + 5 = %d&#34;</span><span class="p">,</span> <span class="n">nRet</span><span class="p">);</span>

    <span class="cm">/*   //修改方式1
</span><span class="cm">       //修改内存保护属性
</span><span class="cm">       if (mprotect((void *) ((long long) meth-&gt;insns &amp; ~0xfff),
</span><span class="cm">                    0x1000,
</span><span class="cm">                    PROT_WRITE | PROT_READ) &lt; 0) {
</span><span class="cm">           perror(&#34;mprotect&#34;);
</span><span class="cm">       }
</span><span class="cm">       //可以修改meth-&gt;insns指向的字节码,也可以将meth-&gt;insns指向的地址给换掉
</span><span class="cm">       u2 *pCode = (u2 *) malloc(10);
</span><span class="cm">       pCode[0] = 0x0091;
</span><span class="cm">       pCode[1] = 0x0302;
</span><span class="cm">       pCode[2] = 0x000f;
</span><span class="cm">       meth-&gt;insns = pCode;*/</span>

       <span class="c1">//修改方式2
</span><span class="c1"></span>       <span class="c1">//访问权限加上Native方法,告诉操作系统这是个jni函数
</span><span class="c1"></span>    <span class="n">meth</span><span class="o">-&gt;</span><span class="n">accessFlags</span> <span class="o">|=</span> <span class="n">ACC_NATIVE</span><span class="p">;</span>
    <span class="c1">//修改Native地址
</span><span class="c1"></span>    <span class="n">meth</span><span class="o">-&gt;</span><span class="n">nativeFunc</span> <span class="o">=</span> <span class="n">FakeAdd</span><span class="p">;</span>

    <span class="n">nRet</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallIntMethod</span><span class="p">(</span><span class="n">objMainActivity</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;3 + 5 = %d&#34;</span><span class="p">,</span> <span class="n">nRet</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b94.png"
        data-srcset="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B94.png, images/Dalvik%e8%99%9a%e6%8b%9f%e6%9c%bajni%e4%bf%ae%e6%94%b94.png 1.5x, /posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B94.png 2x"
        data-sizes="auto"
        alt="/posts/android/android%E5%9F%BA%E7%A1%80/elf/images/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAjni%E4%BF%AE%E6%94%B94.png"
        title="Dalvik虚拟机jni修改4" /></p>
<h6 id="注意">注意</h6>
<p>上述方法不适应于Art虚拟机,因为它会在apk安装的时候变为汇编,无字节码.</p>
<h6 id="源代码-1">源代码</h6>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf/Dalvik%E8%99%9A%E6%8B%9F%E6%9C%BAJavaHook.7z" rel="">Dalvik虚拟机JavaHook.7z</a></p>
<h5 id="art虚拟机">Art虚拟机</h5>
<p>实验环境为Android7.0 x86.</p>
<p>即便它是Art虚拟机,但是我们Hook的思路没有变,只是GetMethodID这个函数的返回值类型由原来的Method结构体变为了ArtMethod.需要注意的是Android每个版本,ArtMethod这个结构体都不一样.</p>
<h6 id="jni修改-1">jni修改</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">//访问权限
</span><span class="c1"></span><span class="k">enum</span> <span class="p">{</span>
    <span class="n">ACC_PUBLIC</span>       <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>       <span class="c1">// class, field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_PRIVATE</span>      <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>       <span class="c1">// field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_PROTECTED</span>    <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>       <span class="c1">// field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_STATIC</span>       <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>       <span class="c1">// field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_FINAL</span>        <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">,</span>       <span class="c1">// class, field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_SYNCHRONIZED</span> <span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>       <span class="c1">// method (only allowed on natives)
</span><span class="c1"></span>    <span class="n">ACC_SUPER</span>        <span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>       <span class="c1">// class (not used in Dalvik)
</span><span class="c1"></span>    <span class="n">ACC_VOLATILE</span>     <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>       <span class="c1">// field
</span><span class="c1"></span>    <span class="n">ACC_BRIDGE</span>       <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>       <span class="c1">// method (1.5)
</span><span class="c1"></span>    <span class="n">ACC_TRANSIENT</span>    <span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>       <span class="c1">// field
</span><span class="c1"></span>    <span class="n">ACC_VARARGS</span>      <span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>       <span class="c1">// method (1.5)
</span><span class="c1"></span>    <span class="n">ACC_NATIVE</span>       <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>       <span class="c1">// method
</span><span class="c1"></span>    <span class="n">ACC_INTERFACE</span>    <span class="o">=</span> <span class="mh">0x00000200</span><span class="p">,</span>       <span class="c1">// class, ic
</span><span class="c1"></span>    <span class="n">ACC_ABSTRACT</span>     <span class="o">=</span> <span class="mh">0x00000400</span><span class="p">,</span>       <span class="c1">// class, method, ic
</span><span class="c1"></span>    <span class="n">ACC_STRICT</span>       <span class="o">=</span> <span class="mh">0x00000800</span><span class="p">,</span>       <span class="c1">// method
</span><span class="c1"></span>    <span class="n">ACC_SYNTHETIC</span>    <span class="o">=</span> <span class="mh">0x00001000</span><span class="p">,</span>       <span class="c1">// field, method, ic
</span><span class="c1"></span>    <span class="n">ACC_ANNOTATION</span>   <span class="o">=</span> <span class="mh">0x00002000</span><span class="p">,</span>       <span class="c1">// class, ic (1.5)
</span><span class="c1"></span>    <span class="n">ACC_ENUM</span>         <span class="o">=</span> <span class="mh">0x00004000</span><span class="p">,</span>       <span class="c1">// class, field, ic (1.5)
</span><span class="c1"></span>    <span class="n">ACC_CONSTRUCTOR</span>  <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>       <span class="c1">// method (Dalvik only)
</span><span class="c1"></span>    <span class="n">ACC_DECLARED_SYNCHRONIZED</span> <span class="o">=</span>
    <span class="mh">0x00020000</span><span class="p">,</span>       <span class="c1">// method (Dalvik only)
</span><span class="c1"></span>    <span class="n">ACC_CLASS_MASK</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span> <span class="o">|</span> <span class="n">ACC_INTERFACE</span> <span class="o">|</span> <span class="n">ACC_ABSTRACT</span>
     <span class="o">|</span> <span class="n">ACC_SYNTHETIC</span> <span class="o">|</span> <span class="n">ACC_ANNOTATION</span> <span class="o">|</span> <span class="n">ACC_ENUM</span><span class="p">),</span>
    <span class="n">ACC_INNER_CLASS_MASK</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">ACC_CLASS_MASK</span> <span class="o">|</span> <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_PROTECTED</span> <span class="o">|</span> <span class="n">ACC_STATIC</span><span class="p">),</span>
    <span class="n">ACC_FIELD_MASK</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_PROTECTED</span> <span class="o">|</span> <span class="n">ACC_STATIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span>
     <span class="o">|</span> <span class="n">ACC_VOLATILE</span> <span class="o">|</span> <span class="n">ACC_TRANSIENT</span> <span class="o">|</span> <span class="n">ACC_SYNTHETIC</span> <span class="o">|</span> <span class="n">ACC_ENUM</span><span class="p">),</span>
    <span class="n">ACC_METHOD_MASK</span> <span class="o">=</span>
    <span class="p">(</span><span class="n">ACC_PUBLIC</span> <span class="o">|</span> <span class="n">ACC_PRIVATE</span> <span class="o">|</span> <span class="n">ACC_PROTECTED</span> <span class="o">|</span> <span class="n">ACC_STATIC</span> <span class="o">|</span> <span class="n">ACC_FINAL</span>
     <span class="o">|</span> <span class="n">ACC_SYNCHRONIZED</span> <span class="o">|</span> <span class="n">ACC_BRIDGE</span> <span class="o">|</span> <span class="n">ACC_VARARGS</span> <span class="o">|</span> <span class="n">ACC_NATIVE</span>
     <span class="o">|</span> <span class="n">ACC_ABSTRACT</span> <span class="o">|</span> <span class="n">ACC_STRICT</span> <span class="o">|</span> <span class="n">ACC_SYNTHETIC</span> <span class="o">|</span> <span class="n">ACC_CONSTRUCTOR</span>
     <span class="o">|</span> <span class="n">ACC_DECLARED_SYNCHRONIZED</span><span class="p">),</span>
<span class="p">};</span>

<span class="c1">//需要注意的是这个结构体,Android每个版本都不一样
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">ArtMethod</span> <span class="p">{</span>
    <span class="c1">//GcRoot&lt;mirror::Class&gt; declaring_class_;
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">declaring_class_</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">access_flags_</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">dex_code_item_offset_</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">dex_method_index_</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">method_index_</span><span class="p">;</span>
    <span class="kt">uint16_t</span> <span class="n">hotness_count_</span><span class="p">;</span>
    <span class="n">ArtMethod</span> <span class="o">**</span><span class="n">dex_cache_resolved_methods_</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">dex_cache_resolved_types_</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">entry_point_from_jni_</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">entry_point_from_quick_compiled_code_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span>        <span class="n">u1</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">short</span>       <span class="n">u2</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>         <span class="n">u4</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>   <span class="n">u8</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">char</span>          <span class="n">s1</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">short</span>         <span class="n">s2</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">int</span>           <span class="n">s4</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">signed</span> <span class="kt">long</span> <span class="kt">long</span>     <span class="n">s8</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">Object</span><span class="p">;</span>

<span class="k">union</span> <span class="nc">JValue</span> <span class="p">{</span>
    <span class="n">u1</span>      <span class="n">z</span><span class="p">;</span>
    <span class="n">s1</span>      <span class="n">b</span><span class="p">;</span>
    <span class="n">u2</span>      <span class="n">c</span><span class="p">;</span>
    <span class="n">s2</span>      <span class="n">s</span><span class="p">;</span>
    <span class="n">s4</span>      <span class="n">i</span><span class="p">;</span>
    <span class="n">s8</span>      <span class="n">j</span><span class="p">;</span>
    <span class="kt">float</span>   <span class="n">f</span><span class="p">;</span>
    <span class="kt">double</span>  <span class="n">d</span><span class="p">;</span>
    <span class="n">Object</span><span class="o">*</span> <span class="n">l</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">FakeAdd</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">,</span>
             <span class="n">ArtMethod</span><span class="o">*</span> <span class="n">method</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">Thread</span><span class="o">*</span> <span class="n">self</span><span class="p">){</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;FakeAdd&#34;</span><span class="p">);</span>
    <span class="c1">//LOGD(&#34;%p %p %d %d %d&#34;, args[0],args[1],args[2], args[3],args[4] );
</span><span class="c1"></span>    <span class="c1">//返回值为int
</span><span class="c1"></span><span class="p">}</span>

<span class="n">JNIEXPORT</span> <span class="n">jint</span> <span class="nf">JNI_OnLoad</span><span class="p">(</span><span class="n">JavaVM</span> <span class="o">*</span><span class="n">vm</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">reserved</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;JNI_OnLoad&#34;</span><span class="p">);</span>

    <span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">vm</span><span class="o">-&gt;</span><span class="n">GetEnv</span><span class="p">((</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">,</span> <span class="n">JNI_VERSION_1_6</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;env = %p&#34;</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>

    <span class="n">jclass</span> <span class="n">clsMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="s">&#34;org/example/luohook/MainActivity&#34;</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;clsMainActivity:%p&#34;</span><span class="p">,</span> <span class="n">clsMainActivity</span><span class="p">);</span>

    <span class="n">jmethodID</span> <span class="n">Construct</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;&lt;init&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;()V&#34;</span><span class="p">);</span>
    <span class="n">jobject</span> <span class="n">objMainActivity</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObject</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="n">Construct</span><span class="p">);</span>

    <span class="n">jmethodID</span> <span class="n">MyAdd</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetMethodID</span><span class="p">(</span><span class="n">clsMainActivity</span><span class="p">,</span> <span class="s">&#34;MyAdd&#34;</span><span class="p">,</span> <span class="s">&#34;(II)I&#34;</span><span class="p">);</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;MyAdd:%p&#34;</span><span class="p">,</span> <span class="n">MyAdd</span><span class="p">);</span>

    <span class="n">ArtMethod</span> <span class="o">*</span><span class="n">meth</span> <span class="o">=</span> <span class="p">(</span><span class="n">ArtMethod</span> <span class="o">*</span><span class="p">)</span> <span class="n">MyAdd</span><span class="p">;</span>
    <span class="n">LOGD</span><span class="p">(</span><span class="s">&#34;access_flags_:%p</span><span class="se">\n</span><span class="s">&#34;</span>
         <span class="s">&#34;entry_point_from_jni_:%p</span><span class="se">\n</span><span class="s">&#34;</span>
         <span class="s">&#34;entry_point_from_quick_compiled_code_:%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
         <span class="n">meth</span><span class="o">-&gt;</span><span class="n">access_flags_</span><span class="p">,</span>
         <span class="n">meth</span><span class="o">-&gt;</span><span class="n">entry_point_from_jni_</span><span class="p">,</span>
         <span class="n">meth</span><span class="o">-&gt;</span><span class="n">entry_point_from_quick_compiled_code_</span><span class="p">);</span>

    <span class="c1">//meth-&gt;access_flags_ |= ACC_NATIVE;
</span><span class="c1"></span>    <span class="c1">//meth-&gt;entry_point_from_jni_ = (void*)FakeAdd;
</span><span class="c1"></span>    <span class="c1">//http://androidxref.com/7.0.0_r1/xref/art/runtime/arch/x86/quick_entrypoints_x86.S
</span><span class="c1"></span>    <span class="n">meth</span> <span class="o">-&gt;</span><span class="n">entry_point_from_quick_compiled_code_</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">FakeAdd</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">JNI_VERSION_1_6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="源代码-2">源代码</h6>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf/Art%E8%99%9A%E6%8B%9F%E6%9C%BAJavaHook.7z" rel="">Art虚拟机JavaHook.7z</a></p>
<h3 id="参考文档">参考文档</h3>
<p><a href="/posts/android/android%E5%9F%BA%E7%A1%80/elf/ELF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90.pdf" rel="">ELF文件格式解析.pdf</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-10-20</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/elf/">ELF</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E7%95%8C%E9%9D%A2%E7%BC%96%E7%A8%8B/mfc/" class="prev" rel="prev" title="Mfc"><i class="fas fa-angle-left fa-fw"></i>Mfc</a>
            <a href="/posts/android/android%E5%9F%BA%E7%A1%80/android%E5%BC%80%E5%8F%91/" class="next" rel="next" title="Android开发">Android开发<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">夏洛魂</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">夏洛魂</a></span>&nbsp;|&nbsp;<span class="license">MIT</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
