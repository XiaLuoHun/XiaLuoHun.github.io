<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Frida-Windows   夏洛魂的个人博客</title><meta name="author" content="夏洛魂">
<meta name="description" content="Frida是一个跨平台的Hook框架,支持MacOS、Windows、Linux、IOS以及Android等平台,其官网如下:
https://github.com/frida/frida
frida-tools frida-tools是一个Python包,提供了一些CLI工具,可通过下述命令进行安装.
"><meta name="keywords" content='Frida'>
  <meta itemprop="name" content="Frida-Windows">
  <meta itemprop="description" content="Frida是一个跨平台的Hook框架,支持MacOS、Windows、Linux、IOS以及Android等平台,其官网如下:
https://github.com/frida/frida
frida-tools frida-tools是一个Python包,提供了一些CLI工具,可通过下述命令进行安装.">
  <meta itemprop="datePublished" content="2024-08-08T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-08-08T00:00:00+00:00">
  <meta itemprop="wordCount" content="6259">
  <meta itemprop="image" content="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/frida.png">
  <meta itemprop="keywords" content="Frida"><meta property="og:url" content="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/">
  <meta property="og:site_name" content="夏洛魂的个人博客">
  <meta property="og:title" content="Frida-Windows">
  <meta property="og:description" content="Frida是一个跨平台的Hook框架,支持MacOS、Windows、Linux、IOS以及Android等平台,其官网如下:
https://github.com/frida/frida
frida-tools frida-tools是一个Python包,提供了一些CLI工具,可通过下述命令进行安装.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-08T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-08-08T00:00:00+00:00">
    <meta property="article:tag" content="Frida">
    <meta property="og:image" content="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/frida.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/frida.png">
  <meta name="twitter:title" content="Frida-Windows">
  <meta name="twitter:description" content="Frida是一个跨平台的Hook框架,支持MacOS、Windows、Linux、IOS以及Android等平台,其官网如下:
https://github.com/frida/frida
frida-tools frida-tools是一个Python包,提供了一些CLI工具,可通过下述命令进行安装.">
<meta name="application-name" content="夏洛魂">
<meta name="apple-mobile-web-app-title" content="夏洛魂"><meta name="theme-color" data-light="#ffffff" data-dark="#ffffff" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" type="text/html" href="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/" title="Frida-Windows   夏洛魂的个人博客" /><link rel="prev" type="text/html" href="https://XiaLuoHun.top/posts/android/unidbg/06unidbg%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/" title="Unidbg生产环境部署" /><link rel="next" type="text/html" href="https://XiaLuoHun.top/posts/python/pyc%E6%B7%B7%E6%B7%86%E8%A7%A3%E5%AF%86-%E6%98%A0%E5%B0%84%E8%A1%A8%E8%BF%98%E5%8E%9F/" title="Pyc混淆解密-映射表还原" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Frida-Windows",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/XiaLuoHun.top\/posts\/windows%E7%9B%B8%E5%85%B3\/fridawindows\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/XiaLuoHun.top\/posts\/windows%E7%9B%B8%E5%85%B3\/fridawindows\/images\/frida.png",
              "width":  1020 ,
              "height":  195 
            }],"genre": "posts","keywords": "Frida","wordcount":  6259 ,
    "url": "https:\/\/XiaLuoHun.top\/posts\/windows%E7%9B%B8%E5%85%B3\/fridawindows\/","datePublished": "2024-08-08T00:00:00+00:00","dateModified": "2024-08-08T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "夏洛魂"
      },"description": ""
  }
  </script><script src="/js/head/color-scheme.min.js"></script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a class="menu-link" href="/posts/">文章</a></li><li class="menu-item">
              <a class="menu-link" href="/tags/">标签</a></li><li class="menu-item">
              <a class="menu-link" href="/categories/">分类</a></li><li class="menu-item">
              <a class="menu-link" href="/excalidraw/">在线绘图</a></li><li class="menu-item">
              <a class="menu-link" href="/about/">关于作者</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="输入关键词搜索" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="输入关键词搜索" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li class="menu-item"><a class="menu-link" href="/posts/">文章</a></li><li class="menu-item"><a class="menu-link" href="/tags/">标签</a></li><li class="menu-item"><a class="menu-link" href="/categories/">分类</a></li><li class="menu-item"><a class="menu-link" href="/excalidraw/">在线绘图</a></li><li class="menu-item"><a class="menu-link" href="/about/">关于作者</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"><div class="details collection-details open">
      <div class="details-summary collection-summary">
        <i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i>
        <span class="collection-name" title="合集">Win逆向</span>
        <span class="collection-count">8</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></div>
      <div class="details-content collection-content">
        <nav>
          <ul class="collection-list"><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/stl%E5%BA%93%E5%AD%A6%E4%B9%A0/" title="STL库学习">STL库学习</a></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/x86%E9%80%86%E5%90%91/" title="X86逆向">X86逆向</a></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/x64%E9%80%86%E5%90%91/" title="X64逆向">X64逆向</a></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/windows%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF/" title="Windows进程注入技术">Windows进程注入技术</a></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/dll%E5%8A%AB%E6%8C%81%E6%96%B0%E6%80%9D%E8%B7%AF-%E4%BF%AE%E6%94%B9%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" title="DEFCON议题解读｜Dll劫持新思路——修改环境变量">DEFCON议题解读｜Dll劫持新思路——修改环境变量</a></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/net%E7%A8%8B%E5%BA%8Fhook%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E4%BC%98%E9%9B%85%E5%AE%9E%E7%8E%B0/" title=".NET程序hook的另一种优雅实现-C&#43;&#43;/CLI">.NET程序hook的另一种优雅实现-C&#43;&#43;/CLI</a></li><li class="collection-item"><span class="active" title="Frida-Windows">Frida-Windows</span></li><li class="collection-item"><a href="/posts/windows%E7%9B%B8%E5%85%B3/qt6%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%A7%BD%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80%E5%AF%BB%E6%89%BE/" title="Qt6-信号与槽函数地址寻找">Qt6-信号与槽函数地址寻找</a></li></ul>
          <div class="collection-nav-simple"><a href="/posts/windows%E7%9B%B8%E5%85%B3/net%E7%A8%8B%E5%BA%8Fhook%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E4%BC%98%E9%9B%85%E5%AE%9E%E7%8E%B0/" class="collection-nav-item" rel="prev" title=".NET程序hook的另一种优雅实现-C&#43;&#43;/CLI"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i></a><span class="text-secondary">7/8</span><a href="/posts/windows%E7%9B%B8%E5%85%B3/qt6%E4%BF%A1%E5%8F%B7%E4%B8%8E%E6%A7%BD%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80%E5%AF%BB%E6%89%BE/" class="collection-nav-item" rel="next" title="Qt6-信号与槽函数地址寻找"><i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
        </nav>
      </div>
    </div></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Frida-Windows</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img class="avatar" src='/images/Luo.png' alt="夏洛魂" height="16" width="16">&nbsp;夏洛魂</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/win%E7%9B%B8%E5%85%B3/" class="post-category" title="分类 - Win相关"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Win相关</a> 和 <a href="/collections/win%E9%80%86%E5%90%91/" class="post-collection" title="合集 - Win逆向"><i class="fa-solid fa-layer-group fa-fw" aria-hidden="true"></i> Win逆向</a></span></div><div class="post-meta-line"><span title="发布于 2024-08-08 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-08-08">2024-08-08</time></span>&nbsp;<span title="6259 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 6300 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 13 分钟</span>&nbsp;</div>
    </div><div class="featured-image"><img src='/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/frida.png' alt="/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/frida.png"></div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#frida-tools">frida-tools</a>
      <ul>
        <li><a href="#frida">frida</a></li>
        <li><a href="#frida-trace">frida-trace</a></li>
      </ul>
    </li>
    <li><a href="#处理数据类型">处理数据类型</a>
      <ul>
        <li><a href="#字符串读取和分配">字符串读取和分配</a></li>
        <li><a href="#数字">数字</a></li>
        <li><a href="#指针">指针</a></li>
        <li><a href="#偏移量指针">偏移量指针</a></li>
        <li><a href="#获取导出函数地址">获取导出函数地址</a></li>
        <li><a href="#arraybuffer指针">ArrayBuffer指针</a></li>
        <li><a href="#hexdump">Hexdump</a></li>
        <li><a href="#释放已分配内存">释放已分配内存</a></li>
      </ul>
    </li>
    <li><a href="#hook基操">Hook基操</a></li>
    <li><a href="#远程调试">远程调试</a></li>
    <li><a href="#脚本调试">脚本调试</a></li>
    <li><a href="#创建本地函数">创建本地函数</a></li>
    <li><a href="#函数替换">函数替换</a></li>
    <li><a href="#内存扫描">内存扫描</a></li>
    <li><a href="#使用自定义库">使用自定义库</a></li>
    <li><a href="#寄存器读写">寄存器读写</a></li>
    <li><a href="#结构体解析">结构体解析</a></li>
    <li><a href="#cmodule">CModule</a></li>
    <li><a href="#stalker">Stalker</a></li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="「依旧是、江涛如许，雨帆烟笛！」"><p>Frida是一个跨平台的Hook框架,支持MacOS、Windows、Linux、IOS以及Android等平台,其官网如下:</p>
<p><a href="https://github.com/frida/frida"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/frida/frida</a></p>
<h2 id="frida-tools" class="heading-element"><span>frida-tools</span>
  <a href="#frida-tools" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>frida-tools是一个Python包,提供了一些CLI工具,可通过下述命令进行安装.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">frida</span><span class="o">-</span><span class="n">tools</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="frida" class="heading-element"><span>frida</span>
  <a href="#frida" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>frida命令行工具允许向指定进程进行代码注入,其参数说明如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">相关命令</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">-U, &ndash;usb</td>
          <td style="text-align: left">连接到USB设备</td>
      </tr>
      <tr>
          <td style="text-align: left">-H HOST, &ndash;host HOST</td>
          <td style="text-align: left">连接到指定HOST的frida-server</td>
      </tr>
      <tr>
          <td style="text-align: left">-f TARGET, &ndash;file TARGET</td>
          <td style="text-align: left">以spawn模式执行指定路径程序</td>
      </tr>
      <tr>
          <td style="text-align: left">-F, &ndash;attach-frontmost</td>
          <td style="text-align: left">附加最前面的应用程序</td>
      </tr>
      <tr>
          <td style="text-align: left">-p PID, &ndash;attach-pid PID</td>
          <td style="text-align: left">附加指定PID进程</td>
      </tr>
      <tr>
          <td style="text-align: left">-l SCRIPT, &ndash;load SCRIPT</td>
          <td style="text-align: left">加载脚本</td>
      </tr>
      <tr>
          <td style="text-align: left">-C USER_CMODULE, &ndash;cmodule USER_CMODULE</td>
          <td style="text-align: left">加载CMODULE</td>
      </tr>
      <tr>
          <td style="text-align: left">-o LOGFILE, &ndash;output LOGFILE</td>
          <td style="text-align: left">输出日志到文件</td>
      </tr>
      <tr>
          <td style="text-align: left">&ndash;runtime {qjs,v8}</td>
          <td style="text-align: left">script运行引擎选择</td>
      </tr>
      <tr>
          <td style="text-align: left">&ndash;debug</td>
          <td style="text-align: left">开启调试</td>
      </tr>
      <tr>
          <td style="text-align: left">&ndash;pause</td>
          <td style="text-align: left">以spawn模式运行程序,添加该参数可使其暂停,使用<code>%resume</code>可恢复执行</td>
      </tr>
  </tbody>
</table>
<h3 id="frida-trace" class="heading-element"><span>frida-trace</span>
  <a href="#frida-trace" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>frida-trace是一个动态跟踪函数调用的工具,其参数说明如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">相关命令</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">-U, &ndash;usb</td>
          <td style="text-align: left">连接到USB设备</td>
      </tr>
      <tr>
          <td style="text-align: left">-H HOST, &ndash;host HOST</td>
          <td style="text-align: left">连接到指定HOST的frida-server</td>
      </tr>
      <tr>
          <td style="text-align: left">-f TARGET, &ndash;file TARGET</td>
          <td style="text-align: left">以spawn模式执行指定路径程序</td>
      </tr>
      <tr>
          <td style="text-align: left">-F, &ndash;attach-frontmost</td>
          <td style="text-align: left">附加最前面的应用程序</td>
      </tr>
      <tr>
          <td style="text-align: left">-p PID, &ndash;attach-pid PID</td>
          <td style="text-align: left">附加指定PID进程</td>
      </tr>
      <tr>
          <td style="text-align: left">&ndash;runtime {qjs,v8}</td>
          <td style="text-align: left">script运行引擎选择</td>
      </tr>
      <tr>
          <td style="text-align: left">-I MODULE, &ndash;include-module MODULE</td>
          <td style="text-align: left">包含模块</td>
      </tr>
      <tr>
          <td style="text-align: left">-X MODULE, &ndash;exclude-module MODULE</td>
          <td style="text-align: left">排除模块</td>
      </tr>
      <tr>
          <td style="text-align: left">-i FUNCTION, &ndash;include FUNCTION</td>
          <td style="text-align: left">包含函数,可使用通配符*</td>
      </tr>
      <tr>
          <td style="text-align: left">-x FUNCTION, &ndash;exclude FUNCTION</td>
          <td style="text-align: left">排除函数</td>
      </tr>
      <tr>
          <td style="text-align: left">-a MODULE!OFFSET, &ndash;add MODULE!OFFSET</td>
          <td style="text-align: left">添加模块偏移跟踪</td>
      </tr>
      <tr>
          <td style="text-align: left">-j JAVA_METHOD, &ndash;include-java-method JAVA_METHOD</td>
          <td style="text-align: left">包含Java方法</td>
      </tr>
      <tr>
          <td style="text-align: left">-J JAVA_METHOD, &ndash;exclude-java-method JAVA_METHOD</td>
          <td style="text-align: left">排除Java方法</td>
      </tr>
      <tr>
          <td style="text-align: left">-o OUTPUT, &ndash;output OUTPUT</td>
          <td style="text-align: left">输出信息到文件</td>
      </tr>
  </tbody>
</table>
<p>frida-trace使用示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">i</span> <span class="s2">&#34;CreateFile*&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">i</span> <span class="s2">&#34;CreateFileW&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">i</span> <span class="s2">&#34;CreateFileW&#34;</span> <span class="o">-</span><span class="nx">X</span> <span class="s2">&#34;KERNEL32.DLL&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">a</span> <span class="s2">&#34;kernelbase.dll!0x11DAF0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">frida</span><span class="o">-</span><span class="nx">trace</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">a</span> <span class="s2">&#34;kernelbase.dll!0x11DAF0&#34;</span> <span class="o">-</span><span class="nx">a</span> <span class="s2">&#34;kernel32.dll!0x1EA70&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="处理数据类型" class="heading-element"><span>处理数据类型</span>
  <a href="#%e5%a4%84%e7%90%86%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="字符串读取和分配" class="heading-element"><span>字符串读取和分配</span>
  <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e8%af%bb%e5%8f%96%e5%92%8c%e5%88%86%e9%85%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>字符串分配API如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">API</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Memory.allocAnsiString()</td>
          <td style="text-align: left">分配Ansi字符串(仅限Windows)</td>
      </tr>
      <tr>
          <td style="text-align: left">Memory.allocUtf8String()</td>
          <td style="text-align: left">分配UTF8字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">Memory.allocUtf16String()</td>
          <td style="text-align: left">分配UTF16字符串(仅限Windows)</td>
      </tr>
  </tbody>
</table>
<p>分配字符串时,一定要将其设置为常量,以避免字符串在某一时刻从内存中清除,示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">myTestString</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">allocAnsiString</span><span class="p">(</span><span class="s2">&#34;Hello XiaLuoHun!&#34;</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>字符串读取API如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">API</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">{NativePointer}.readCString()</td>
          <td style="text-align: left">读取C风格字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">{NativePointer}.readAnsiString()</td>
          <td style="text-align: left">读取Ansi字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">{NativePointer}.readUtf8String()</td>
          <td style="text-align: left">读取UTF8字符串</td>
      </tr>
      <tr>
          <td style="text-align: left">{NativePointer}.readUtf16String()</td>
          <td style="text-align: left">读取UTF16字符串</td>
      </tr>
  </tbody>
</table>
<p>注意如下:</p>
<ol>
<li>{NativePointer}是一个指针,指向包含字符串的地址.</li>
<li>可以向这些API传递一个数字作为参数,以指定要读取的字节数.</li>
</ol>
<p>使用示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">//myTestString指向Ansi字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">myTestString</span><span class="p">.</span><span class="nx">readAnsiString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//myTestString指向C风格字符串,且字符串长度为1024字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">myTestString</span><span class="p">.</span><span class="nx">readCString</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>接下来使用一个案例来展示字符串读取API的使用.</p>
<p>测试代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WCHAR</span> <span class="n">lpBuffer</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="n">LPWSTR</span><span class="o">*</span> <span class="n">lpFilePart</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">	<span class="n">DWORD</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">result</span> <span class="o">=</span> <span class="n">SearchPathW</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="sa">L</span><span class="s">&#34;c:</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">,</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="n">lpFilePart</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;SearchPath retval: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>SearchPathW说明如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">SearchPathW</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_opt_</span> <span class="n">LPCWSTR</span> <span class="n">lpPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span> <span class="n">LPCWSTR</span> <span class="n">lpFileName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_opt_</span> <span class="n">LPCWSTR</span> <span class="n">lpExtension</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_In_</span> <span class="n">DWORD</span> <span class="n">nBufferLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Out_writes_to_opt_</span><span class="p">(</span><span class="n">nBufferLength</span><span class="p">,</span><span class="k">return</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">LPWSTR</span> <span class="n">lpBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">_Out_opt_</span> <span class="n">LPWSTR</span><span class="o">*</span> <span class="n">lpFilePart</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Frida Js Hook代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">searchPathPtr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="s2">&#34;KERNELBASE.DLL&#34;</span><span class="p">,</span> <span class="s2">&#34;SearchPathW&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">searchPathPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Output: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">readUtf16String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><p>与上述等效的TypeScript代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">searchPathPtr</span>:<span class="kt">NativePointer</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="s2">&#34;KERNELBASE.DLL&#34;</span><span class="p">,</span> <span class="s2">&#34;SearchPathW&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">SearchPathW</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span>:<span class="kt">NativePointer</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Output: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">readUtf16String</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">searchPathPtr</span><span class="p">,</span> <span class="k">new</span> <span class="nx">SearchPathW</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注入命令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">npm</span> <span class="nx">run</span> <span class="nx">watch</span>
</span></span><span class="line"><span class="cl"><span class="nx">frida</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">l</span> <span class="p">.</span><span class="err">\</span><span class="nx">_agent</span><span class="p">.</span><span class="nx">js</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="数字" class="heading-element"><span>数字</span>
  <a href="#%e6%95%b0%e5%ad%97" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>我们需要知道参数是纯数字类型还是其地址,如果不是内存中的地址,我们不能使用Frida的API处理数字类型,否则会导致目标进程出错.</p>
<p>通过<code>值传递</code>的参考代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在Frida中可以使用下述代码进行参数读取:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;a: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toInt32</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;b: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toInt32</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><p>通过<code>指针传递</code>数值的参考代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//a = 1337, b=7331
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Frida提供的读取数值API如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">API</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">{}.readInt()</td>
          <td style="text-align: left">从给定地址读取整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readUInt()</td>
          <td style="text-align: left">从给定地址读取无符号整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readS8()</td>
          <td style="text-align: left">从指定地址读取带符号的8位、16位、32位或64位整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readShort()</td>
          <td style="text-align: left">从给定地址读取短整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readFloat()</td>
          <td style="text-align: left">从给定地址读取浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readDouble()</td>
          <td style="text-align: left">从给定地址读取双浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readLong()</td>
          <td style="text-align: left">从给定地址读取长数字</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readULong()</td>
          <td style="text-align: left">从给定地址读取无符号长数字</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readUShort()</td>
          <td style="text-align: left">从给定地址读取无符号短数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.readUS8()</td>
          <td style="text-align: left">从给定地址读取无符号整数</td>
      </tr>
  </tbody>
</table>
<p>在Frida中可以使用下述代码进行参数读取:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;a: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">readInt</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;b: &#34;</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">readInt</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Frida提供的数值写入API如下:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">API</th>
          <th style="text-align: left">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">{}.writeInt()</td>
          <td style="text-align: left">向给定地址写入整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeUInt()</td>
          <td style="text-align: left">向给定地址写入无符号整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeS8()</td>
          <td style="text-align: left">向给定地址写入带符号的8位、16位、32位或64位整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeShort()</td>
          <td style="text-align: left">向给定地址写入短整数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeFloat()</td>
          <td style="text-align: left">向给定地址写入浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeDouble()</td>
          <td style="text-align: left">向给定地址写入双浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeLong()</td>
          <td style="text-align: left">向给定地址写入长数字</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeULong()</td>
          <td style="text-align: left">向给定地址写入无符号长数字</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeUShort()</td>
          <td style="text-align: left">向给定地址写入无符号短数</td>
      </tr>
      <tr>
          <td style="text-align: left">{}.writeUS8()</td>
          <td style="text-align: left">向给定地址写入无符号整数</td>
      </tr>
  </tbody>
</table>
<p>以上述<code>指针传递</code>参考代码为例,Frida可使用下述代码进行参数修改:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">writeInt</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">writeInt</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="指针" class="heading-element"><span>指针</span>
  <a href="#%e6%8c%87%e9%92%88" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>可以使用readPointer() API读取指针指向的地址.当有一个指向结构体的指针需要读取时,这种用法很有用.</p>
<p>recvfrom声明如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">ssize_t</span> <span class="nf">recvfrom</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Frida代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// ... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">args</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="nx">readPointer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ...
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="偏移量指针" class="heading-element"><span>偏移量指针</span>
  <a href="#%e5%81%8f%e7%a7%bb%e9%87%8f%e6%8c%87%e9%92%88" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Frida示例代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">myBaseAddr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">findBaseAddress</span><span class="p">(</span><span class="s1">&#39;kernel32.dll&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">myOffsetPtr</span> <span class="o">=</span> <span class="nx">myBaseAddr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x76E</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;myBaseAddr:  &#34;</span><span class="o">+</span> <span class="nx">myBaseAddr</span> <span class="o">+</span> <span class="s2">&#34;\nmyOffsetPtr: &#34;</span> <span class="o">+</span> <span class="nx">myOffsetPtr</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上述输出内容如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">myBaseAddr:  0x7ffff0f00000
</span></span><span class="line"><span class="cl">myOffsetPtr: 0x7ffff0f0076e</span></span></code></pre></td></tr></table>
</div>
</div><p>如果我们不知道模块名称或者模块名称与预期不符,可以使用Process.enumerateModulesSync() API,该API会返回模块列表.使用示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModulesSync</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">modules</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Name: &#34;</span> <span class="o">+</span> <span class="nx">module</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Base Address: &#34;</span> <span class="o">+</span> <span class="nx">module</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Size: &#34;</span> <span class="o">+</span> <span class="nx">module</span><span class="p">.</span><span class="nx">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;Path: &#34;</span> <span class="o">+</span> <span class="nx">module</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;-------------------------------&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="获取导出函数地址" class="heading-element"><span>获取导出函数地址</span>
  <a href="#%e8%8e%b7%e5%8f%96%e5%af%bc%e5%87%ba%e5%87%bd%e6%95%b0%e5%9c%b0%e5%9d%80" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在Frida中可以通过下述两种方式获取模块导出函数地址:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">//var MessageBoxA = Module.findExportByName(&#39;user32.dll&#39;, &#39;MessageBoxA&#39;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">MessageBoxA</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="s1">&#39;user32.dll&#39;</span><span class="p">,</span> <span class="s1">&#39;MessageBoxA&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;MessageBoxA:&#34;</span><span class="p">,</span> <span class="nx">MessageBoxA</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当找不到导出函数地址时:</p>
<ul>
<li>findExportByName返回NULL</li>
<li>getExportByName抛异常</li>
</ul>
<p>故建议使用getExportByName,如果想使用findExportByName,请务必检查返回值.</p>
<h3 id="arraybuffer指针" class="heading-element"><span>ArrayBuffer指针</span>
  <a href="#arraybuffer%e6%8c%87%e9%92%88" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在分配字符串时,返回的是一个指针,拿到这个指针就可以调用read或write API对其内容进行修改.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">allocUtf8String</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;0x1e9f5446be0&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但是对于不返回地址的ArrayBuffer就不同了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">0000</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>                     <span class="p">..........</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这种情况下,可以调用unwrap函数,返回指向ArrayBuffer的第一个元素指针</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;0x1e9f5447210&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>有时候为了保证脚本的可移植性,需要考虑指针的大小,可以调用下述API返回被检测进程的指针大小</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Process.pointerSize</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hexdump" class="heading-element"><span>Hexdump</span>
  <a href="#hexdump" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>Hexdump在给定一个NativePointer或ArrayBuffer时,返回16进制试图,其语法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">hexdump</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="p">[,</span> <span class="nx">options</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//options值如下:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">offset</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">length</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">header</span><span class="o">:</span> <span class="kc">true</span><span class="o">|</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ansi</span><span class="o">:</span> <span class="kc">true</span><span class="o">|</span><span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModules</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;base&#34;</span><span class="o">:</span> <span class="s2">&#34;0x7ff78ef10000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="o">:</span> <span class="s2">&#34;luoDst.exe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;path&#34;</span><span class="o">:</span> <span class="s2">&#34;E:\\SoftWareWork\\VSWork\\luoDst\\x64\\Debug\\luoDst.exe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;size&#34;</span><span class="o">:</span> <span class="mi">2744320</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//---
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hexdump</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="mh">0x7ff78ef10000</span><span class="p">),</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">offset</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">length</span><span class="o">:</span><span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="p">}))</span>
</span></span><span class="line"><span class="cl">               <span class="mi">0</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="nx">A</span>  <span class="nx">B</span>  <span class="nx">C</span>  <span class="nx">D</span>  <span class="nx">E</span>  <span class="nx">F</span>  <span class="mi">0123456789</span><span class="nx">ABCDEF</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10000</span>  <span class="mi">4</span><span class="nx">d</span> <span class="mi">5</span><span class="nx">a</span> <span class="mi">90</span> <span class="mi">00</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">04</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="nx">ff</span> <span class="nx">ff</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="nx">MZ</span><span class="p">..............</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10010</span>  <span class="nx">b8</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">40</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">........</span><span class="err">@</span><span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10020</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">................</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10030</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="nx">f8</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">................</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10040</span>  <span class="mi">0</span><span class="nx">e</span> <span class="mi">1</span><span class="nx">f</span> <span class="nx">ba</span> <span class="mi">0</span><span class="nx">e</span> <span class="mi">00</span> <span class="nx">b4</span> <span class="mi">09</span> <span class="nx">cd</span> <span class="mi">21</span> <span class="nx">b8</span> <span class="mi">01</span> <span class="mi">4</span><span class="nx">c</span> <span class="nx">cd</span> <span class="mi">21</span> <span class="mi">54</span> <span class="mi">68</span>  <span class="p">........</span><span class="o">!</span><span class="p">..</span><span class="nx">L</span><span class="p">.</span><span class="o">!</span><span class="nx">Th</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10050</span>  <span class="mi">69</span> <span class="mi">73</span> <span class="mi">20</span> <span class="mi">70</span> <span class="mi">72</span> <span class="mi">6</span><span class="nx">f</span> <span class="mi">67</span> <span class="mi">72</span> <span class="mi">61</span> <span class="mi">6</span><span class="nx">d</span> <span class="mi">20</span> <span class="mi">63</span> <span class="mi">61</span> <span class="mi">6</span><span class="nx">e</span> <span class="mi">6</span><span class="nx">e</span> <span class="mi">6</span><span class="nx">f</span>  <span class="nx">is</span> <span class="nx">program</span> <span class="nx">canno</span>
</span></span><span class="line"><span class="cl"><span class="mi">7</span><span class="nx">ff78ef10060</span>  <span class="mi">74</span> <span class="mi">20</span> <span class="mi">62</span> <span class="mi">65</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="释放已分配内存" class="heading-element"><span>释放已分配内存</span>
  <a href="#%e9%87%8a%e6%94%be%e5%b7%b2%e5%88%86%e9%85%8d%e5%86%85%e5%ad%98" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>在调用Memory.alloc API时,当完成有效任务后,如何释放已分配的内存?</p>
<p>最好的做法就是对上述保存alloc地址的变量重新赋值,从而允许Frida释放它.示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span>  <span class="nx">t</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">alloc</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;0x1a482928170&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span>  <span class="nx">t</span><span class="p">.</span><span class="nx">writeUtf8String</span><span class="p">(</span><span class="s1">&#39;Hello XiaLuoHun!&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;0x1a482928170&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hexdump</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">              <span class="mi">0</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="nx">A</span>  <span class="nx">B</span>  <span class="nx">C</span>  <span class="nx">D</span>  <span class="nx">E</span>  <span class="nx">F</span>  <span class="mi">0123456789</span><span class="nx">ABCDEF</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928170</span>  <span class="mi">48</span> <span class="mi">65</span> <span class="mi">6</span><span class="nx">c</span> <span class="mi">6</span><span class="nx">c</span> <span class="mi">6</span><span class="nx">f</span> <span class="mi">20</span> <span class="mi">58</span> <span class="mi">69</span> <span class="mi">61</span> <span class="mi">4</span><span class="nx">c</span> <span class="mi">75</span> <span class="mi">6</span><span class="nx">f</span> <span class="mi">48</span> <span class="mi">75</span> <span class="mi">6</span><span class="nx">e</span> <span class="mi">21</span>  <span class="nx">Hello</span> <span class="nx">XiaLuoHun</span><span class="o">!</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928180</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">................</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928190</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">63</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">........</span><span class="nx">c</span><span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281a0</span>  <span class="mi">07</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">80</span> <span class="mi">01</span> <span class="mi">3</span><span class="nx">e</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">......</span><span class="o">&gt;</span><span class="p">.........</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281b0</span>  <span class="mi">20</span> <span class="mi">81</span> <span class="mi">92</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">10</span> <span class="nx">e8</span> <span class="mi">91</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>   <span class="p">...............</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281c0</span>  <span class="nx">f0</span> <span class="mi">23</span> <span class="mi">92</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">40</span> <span class="mi">8</span><span class="nx">b</span> <span class="mi">90</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">.</span><span class="err">#</span><span class="p">......</span><span class="err">@</span><span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281d0</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="nx">a0</span> <span class="nx">ae</span> <span class="nx">a3</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">................</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281e0</span>  <span class="nx">d0</span> <span class="mi">67</span> <span class="mi">90</span> <span class="mi">82</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">22</span> <span class="mi">70</span> <span class="mi">61</span> <span class="mi">79</span> <span class="mi">6</span><span class="nx">c</span> <span class="mi">6</span><span class="nx">f</span> <span class="mi">61</span> <span class="mi">64</span>  <span class="p">.</span><span class="nx">g</span><span class="p">......</span><span class="err">&#34;</span><span class="nx">payload</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281f0</span>  <span class="mi">60</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">73</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="sb">`.......s.......
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928200  01 00 00 00 00 01 0c 00 00 00 00 00 00 00 00 00  ................
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928210  70 59 92 82 a4 01 00 00 20 c3 90 82 a4 01 00 00  pY...... .......
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928220  10 95 8f 82 a4 01 00 00 10 70 92 82 a4 01 00 00  .........p......
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928230  00 00 00 00 00 00 00 00 20 f7 8e 82 a4 01 00 00  ........ .......
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928240  88 b1 9a 5d ff 7f 00 00 01 01 00 00 a4 01 00 00  ...]............
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928250  70 82 92 82 a4 01 08 00 00 00 00 00 00 00 00 00  p...............
</span></span></span><span class="line"><span class="cl"><span class="sb">1a482928260  70 00 00 00 00 00 00 00 63 00 00 00 00 00 00 00  p.......c.......
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当t为null时,内存区域值如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">t</span><span class="o">=</span><span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="nx">Local</span><span class="p">]</span><span class="o">-&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hexdump</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="mh">0x1a482928170</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">              <span class="mi">0</span>  <span class="mi">1</span>  <span class="mi">2</span>  <span class="mi">3</span>  <span class="mi">4</span>  <span class="mi">5</span>  <span class="mi">6</span>  <span class="mi">7</span>  <span class="mi">8</span>  <span class="mi">9</span>  <span class="nx">A</span>  <span class="nx">B</span>  <span class="nx">C</span>  <span class="nx">D</span>  <span class="nx">E</span>  <span class="nx">F</span>  <span class="mi">0123456789</span><span class="nx">ABCDEF</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928170</span>  <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">62</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">78</span> <span class="mi">01</span> <span class="nx">fe</span> <span class="mi">80</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">....</span><span class="nx">b</span><span class="p">...</span><span class="nx">x</span><span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928180</span>  <span class="mi">00</span> <span class="mi">01</span> <span class="mi">6</span><span class="nx">f</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">5</span><span class="nx">b</span> <span class="mi">22</span> <span class="mi">66</span> <span class="mi">72</span> <span class="mi">69</span> <span class="mi">64</span> <span class="mi">61</span> <span class="mi">3</span><span class="nx">a</span>  <span class="p">..</span><span class="nx">o</span><span class="p">.....[</span><span class="s2">&#34;frida:
</span></span></span><span class="line"><span class="cl"><span class="s2">1a482928190  72 70 63 22 2c 20 32 34 2c 20 22 63 61 6c 6c 22  rpc&#34;</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="s2">&#34;call&#34;</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281a0</span>  <span class="mi">2</span><span class="nx">c</span> <span class="mi">20</span> <span class="mi">22</span> <span class="mi">66</span> <span class="mi">72</span> <span class="mi">69</span> <span class="mi">64</span> <span class="mi">61</span> <span class="mi">45</span> <span class="mi">76</span> <span class="mi">61</span> <span class="mi">6</span><span class="nx">c</span> <span class="mi">75</span> <span class="mi">61</span> <span class="mi">74</span> <span class="mi">65</span>  <span class="p">,</span> <span class="s2">&#34;fridaEvaluate
</span></span></span><span class="line"><span class="cl"><span class="s2">1a4829281b0  45 78 70 72 65 73 73 69 6f 6e 22 2c 20 5b 22 63  Expression&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;c
</span></span></span><span class="line"><span class="cl"><span class="s2">1a4829281c0  6f 6e 73 6f 6c 65 2e 6c 6f 67 28 68 65 78 64 75  onsole.log(hexdu
</span></span></span><span class="line"><span class="cl"><span class="s2">1a4829281d0  6d 70 28 70 74 72 28 30 78 31 61 34 38 32 39 32  mp(ptr(0x1a48292
</span></span></span><span class="line"><span class="cl"><span class="s2">1a4829281e0  38 31 37 30 29 29 29 22 5d 5d 00 00 00 00 00 00  8170)))&#34;</span><span class="p">]]......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a4829281f0</span>  <span class="mi">90</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">73</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">........</span><span class="nx">s</span><span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928200</span>  <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">0</span><span class="nx">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">................</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928210</span>  <span class="mi">70</span> <span class="mi">59</span> <span class="mi">92</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">20</span> <span class="nx">c3</span> <span class="mi">90</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="nx">pY</span><span class="p">......</span> <span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928220</span>  <span class="mi">10</span> <span class="mi">95</span> <span class="mi">8</span><span class="nx">f</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">10</span> <span class="mi">70</span> <span class="mi">92</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">.........</span><span class="nx">p</span><span class="p">......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928230</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">20</span> <span class="nx">f7</span> <span class="mi">8</span><span class="nx">e</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">........</span> <span class="p">.......</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928240</span>  <span class="mi">88</span> <span class="nx">b1</span> <span class="mi">9</span><span class="nx">a</span> <span class="mi">5</span><span class="nx">d</span> <span class="nx">ff</span> <span class="mi">7</span><span class="nx">f</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="p">...]............</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928250</span>  <span class="mi">70</span> <span class="mi">82</span> <span class="mi">92</span> <span class="mi">82</span> <span class="nx">a4</span> <span class="mi">01</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="nx">p</span><span class="p">...............</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span><span class="nx">a482928260</span>  <span class="mi">70</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">63</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="nx">p</span><span class="p">.......</span><span class="nx">c</span><span class="p">.......</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="hook基操" class="heading-element"><span>Hook基操</span>
  <a href="#hook%e5%9f%ba%e6%93%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d + %d = %d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">a</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d + %d = %d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida修改函数参数以及返回值的代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F920</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addListener</span> <span class="o">=</span> <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//保存参数0原始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">arg0</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//修改参数0值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retvalue</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//打印参数0原始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//console.log(&#34;[onLeave] arg0Src:&#34;, this.arg0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//修改返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">retvalue</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//取消Hook
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">addListener</span><span class="p">.</span><span class="nx">detach</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="远程调试" class="heading-element"><span>远程调试</span>
  <a href="#%e8%bf%9c%e7%a8%8b%e8%b0%83%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>在目标机运行frida server</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">//假设目标机IP为 192.168.59.129
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span><span class="err">\</span><span class="nx">frida</span><span class="o">-</span><span class="nx">server</span><span class="o">-</span><span class="nx">Win64</span><span class="p">.</span><span class="nx">exe</span> <span class="o">-</span><span class="nx">l</span> <span class="mf">0.0</span><span class="p">.</span><span class="mf">0.0</span><span class="o">:</span><span class="mi">6666</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在本地使用下述命令执行Frida脚本</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">frida</span> <span class="o">-</span><span class="nx">H</span> <span class="mf">192.168</span><span class="p">.</span><span class="mf">59.129</span><span class="o">:</span><span class="mi">8899</span> <span class="o">-</span><span class="nx">p</span> <span class="mi">6280</span> <span class="o">-</span><span class="nx">l</span> <span class="p">.</span><span class="err">\</span><span class="nx">luoHook</span><span class="p">.</span><span class="nx">js</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="脚本调试" class="heading-element"><span>脚本调试</span>
  <a href="#%e8%84%9a%e6%9c%ac%e8%b0%83%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>frida脚本调试示例如下:</p>
<ol>
<li>frida开启调试</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">frida</span> <span class="o">-</span><span class="nx">f</span> <span class="s2">&#34;XXX.exe&#34;</span> <span class="o">-</span><span class="nx">l</span> <span class="p">.</span><span class="err">\</span><span class="nx">luoHook</span><span class="p">.</span><span class="nx">js</span> <span class="o">--</span><span class="nx">runtime</span> <span class="nx">v8</span> <span class="o">--</span><span class="nx">debug</span> <span class="o">--</span><span class="nx">pause</span>
</span></span><span class="line"><span class="cl"><span class="c1">//回显内容如下:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Chrome</span> <span class="nx">Inspector</span> <span class="nx">server</span> <span class="nx">listening</span> <span class="nx">on</span> <span class="nx">port</span> <span class="mi">9229</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>打开<code>chrome://inspect</code>,点击<code>Open dedicated DevTools for Node</code></li>
</ol>
<p><img loading="lazy" src='/posts/windows%E7%9B%B8%E5%85%B3/fridawindows/images/chromeInspect.png' alt="chromeInspect" height="583" width="2168"></p>
<ol start="3">
<li>对代码进行下断</li>
</ol>
<p><img loading="lazy" src='./images/js%E4%BB%A3%E7%A0%81%E4%B8%8B%E6%96%AD.png' alt="js代码下断"></p>
<ol start="4">
<li>frida执行<code>%resume</code>,发现成功断下</li>
</ol>
<p><img loading="lazy" src='./images/js%E6%88%90%E5%8A%9F%E6%96%AD%E4%B8%8B.png' alt="js成功断下"></p>
<h2 id="创建本地函数" class="heading-element"><span>创建本地函数</span>
  <a href="#%e5%88%9b%e5%bb%ba%e6%9c%ac%e5%9c%b0%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Frida 提供了NativeFunctions API可以创建从JS层调用的辅助函数.如果我们想要调用导出函数或目标进程空间内的任意函数,这将十分有用.其语法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">returnType</span><span class="p">,</span> <span class="nx">argTypes</span><span class="p">[,</span> <span class="nx">abi</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//TYPES 可选如下:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">void</span>
</span></span><span class="line"><span class="cl"><span class="nx">pointer</span>
</span></span><span class="line"><span class="cl"><span class="kr">int</span>
</span></span><span class="line"><span class="cl"><span class="nx">uint</span>
</span></span><span class="line"><span class="cl"><span class="kr">long</span>
</span></span><span class="line"><span class="cl"><span class="nx">ulong</span>
</span></span><span class="line"><span class="cl"><span class="kr">char</span>
</span></span><span class="line"><span class="cl"><span class="nx">uchar</span>
</span></span><span class="line"><span class="cl"><span class="nx">size_t</span>
</span></span><span class="line"><span class="cl"><span class="nx">ssize_t</span>
</span></span><span class="line"><span class="cl"><span class="kr">float</span>
</span></span><span class="line"><span class="cl"><span class="kr">double</span>
</span></span><span class="line"><span class="cl"><span class="nx">int8</span>
</span></span><span class="line"><span class="cl"><span class="nx">uint8</span>
</span></span><span class="line"><span class="cl"><span class="nx">int16</span>
</span></span><span class="line"><span class="cl"><span class="nx">uint16</span>
</span></span><span class="line"><span class="cl"><span class="nx">int32</span>
</span></span><span class="line"><span class="cl"><span class="nx">uint32</span>
</span></span><span class="line"><span class="cl"><span class="nx">int64</span>
</span></span><span class="line"><span class="cl"><span class="nx">uint64</span>
</span></span><span class="line"><span class="cl"><span class="nx">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ABIS 可选如下:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">default</span>
</span></span><span class="line"><span class="cl"><span class="nx">Windows</span> <span class="mi">32</span><span class="o">-</span><span class="nx">bit</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sysv</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdcall</span>
</span></span><span class="line"><span class="cl">	<span class="nx">thiscall</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fastcall</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mscdecl</span>
</span></span><span class="line"><span class="cl"><span class="nx">Windows</span> <span class="mi">64</span><span class="o">-</span><span class="nx">bit</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="nx">win64</span>
</span></span><span class="line"><span class="cl"><span class="nx">UNIX</span> <span class="nx">x86</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sysv</span>
</span></span><span class="line"><span class="cl">	<span class="nx">unix64</span>
</span></span><span class="line"><span class="cl"><span class="nx">UNIX</span> <span class="nx">ARM</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sysv</span>
</span></span><span class="line"><span class="cl">	<span class="nx">vfp</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d + %d = %d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida注入代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F920</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">addFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;addFunc:&#34;</span><span class="p">,</span><span class="nx">addFunc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="函数替换" class="heading-element"><span>函数替换</span>
  <a href="#%e5%87%bd%e6%95%b0%e6%9b%bf%e6%8d%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>对于函数替换,Frida为我们提供了两种方法,即使用Interceptor.replace()或Memory.patchCode().</p>
<ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%d + %d = %d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida注入代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F920</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//方式一
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="nx">NativeCallback</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1022</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//方式二
</span></span></span><span class="line"><span class="cl"><span class="c1">// Memory.patchCode(addPtr, Process.pageSize, function (code) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//   const cw = new X86Writer(code, { pc: addPtr });
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.putMovRegU32(&#39;eax&#39;, 1234);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.putRet();
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.flush();
</span></span></span><span class="line"><span class="cl"><span class="c1">// });
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>NativeCallback声明如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">NativeCallback</span><span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">returnType</span><span class="p">,</span> <span class="nx">argTypes</span><span class="p">[,</span> <span class="nx">abi</span><span class="p">])</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="内存扫描" class="heading-element"><span>内存扫描</span>
  <a href="#%e5%86%85%e5%ad%98%e6%89%ab%e6%8f%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>对于内存扫描,Frida提供了以下两个API接口:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">//pattern的格式为由空格分隔的16进制字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Memory</span><span class="p">.</span><span class="nx">scan</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">callbacks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">Memory</span><span class="p">.</span><span class="nx">scanSync</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;XiaLuoHun Hello!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;XiaLuoXXn Hello!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在Frida中编写代码,匹配&quot;XiaLuo__n&quot;如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mainModule</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="s2">&#34;58 69 61 4C 75 6F ?? ?? 6E&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//方式一
</span></span></span><span class="line"><span class="cl"><span class="c1">// var matches  = Memory.scanSync(mainModule.base, mainModule.size, pattern)
</span></span></span><span class="line"><span class="cl"><span class="c1">// matches.forEach(match =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="c1">//     console.log(match.address + &#34;:&#34; + match.address.readCString(match.size));
</span></span></span><span class="line"><span class="cl"><span class="c1">// });
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//方式二
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Memory</span><span class="p">.</span><span class="nx">scan</span><span class="p">(</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="nx">mainModule</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onMatch</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">address</span> <span class="o">+</span> <span class="s2">&#34;:&#34;</span> <span class="o">+</span> <span class="nx">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取当前内存保护属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">oldProtect</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ranges</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateRangesSync</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">protection</span><span class="o">:</span> <span class="s2">&#34;---&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">coalesce</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">ranges</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">ranges</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">address</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">range</span><span class="p">.</span><span class="nx">size</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldProtect</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">protection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//console.log(&#34;oldProtect:&#34;, oldProtect);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">Memory</span><span class="p">.</span><span class="nx">protect</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="s2">&#34;rwx&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//Luo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">address</span><span class="p">.</span><span class="nx">writeByteArray</span><span class="p">([</span><span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">Memory</span><span class="p">.</span><span class="nx">protect</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">oldProtect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="使用自定义库" class="heading-element"><span>使用自定义库</span>
  <a href="#%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e5%ba%93" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>使用下述测试代码进行动态库编译</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">mySub</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在Frida中编写下述代码进行动态库功能调用</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">luoDllMod</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s2">&#34;E:\\VSWork\\luoDll\\x64\\Release\\luoDll.dll&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mySubAddr</span> <span class="o">=</span> <span class="nx">luoDllMod</span><span class="p">.</span><span class="nx">findExportByName</span><span class="p">(</span><span class="s2">&#34;mySub&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mySub</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">mySubAddr</span><span class="p">),</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;mySub:&#34;</span><span class="p">,</span> <span class="nx">mySub</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="寄存器读写" class="heading-element"><span>寄存器读写</span>
  <a href="#%e5%af%84%e5%ad%98%e5%99%a8%e8%af%bb%e5%86%99" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">printf</span><span class="p">(</span><span class="s">&#34;result: %d</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida注入代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">addPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F8F0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">addPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onEnter</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// console.log(&#39;args0:&#39; + args[0]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// console.log(&#39;args1:&#39; + args[1]);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;args1:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">rcx</span><span class="p">.</span><span class="nx">toInt32</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;args2:&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">rdx</span><span class="p">.</span><span class="nx">toInt32</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//修改寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1">// Memory.patchCode(addPtr, Process.pointerSize, function (code) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//   const cw = new X86Writer(code, { pc: addPtr });
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.putMovRegU32(&#39;eax&#39;, 1234);
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.putRet();
</span></span></span><span class="line"><span class="cl"><span class="c1">//   cw.flush();
</span></span></span><span class="line"><span class="cl"><span class="c1">// });
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="结构体解析" class="heading-element"><span>结构体解析</span>
  <a href="#%e7%bb%93%e6%9e%84%e4%bd%93%e8%a7%a3%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>以Windows平台的SYSTEM_INFO为例进行解析:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//win64 结构体成员偏移如下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_SYSTEM_INFO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">dwOemId</span><span class="p">;</span> <span class="c1">//0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">WORD</span> <span class="n">wProcessorArchitecture</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">WORD</span> <span class="n">wReserved</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="n">DUMMYSTRUCTNAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">DUMMYUNIONNAME</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">dwPageSize</span><span class="p">;</span> <span class="c1">//4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPVOID</span> <span class="n">lpMinimumApplicationAddress</span><span class="p">;</span> <span class="c1">//8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LPVOID</span> <span class="n">lpMaximumApplicationAddress</span><span class="p">;</span> <span class="c1">//16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD_PTR</span> <span class="n">dwActiveProcessorMask</span><span class="p">;</span> <span class="c1">//24
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">dwNumberOfProcessors</span><span class="p">;</span> <span class="c1">//32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">dwProcessorType</span><span class="p">;</span> <span class="c1">//36
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">dwAllocationGranularity</span><span class="p">;</span> <span class="c1">//40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">wProcessorLevel</span><span class="p">;</span> <span class="c1">//44
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">wProcessorRevision</span><span class="p">;</span> <span class="c1">//46
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="n">SYSTEM_INFO</span><span class="p">,</span> <span class="o">*</span><span class="n">LPSYSTEM_INFO</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SYSTEM_INFO</span> <span class="n">sysInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetSystemInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysInfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//std::cout &lt;&lt; &#34;sysInfoSize:&#34; &lt;&lt; sizeof(sysInfo) &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;Hardware information: \n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  OEM ID: &#34; &lt;&lt; sysInfo.dwOemId &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Page size: &#34; &lt;&lt; sysInfo.dwPageSize &lt;&lt; &#34; bytes\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Minimum application address: &#34; &lt;&lt; sysInfo.lpMinimumApplicationAddress &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Maximum application address: &#34; &lt;&lt; sysInfo.lpMaximumApplicationAddress &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Active processor mask: &#34; &lt;&lt; sysInfo.dwActiveProcessorMask &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Number of processors: &#34; &lt;&lt; sysInfo.dwNumberOfProcessors &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Processor type: &#34; &lt;&lt; sysInfo.dwProcessorType &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Allocation granularity: &#34; &lt;&lt; sysInfo.dwAllocationGranularity &lt;&lt; &#34; bytes\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Processor level: &#34; &lt;&lt; sysInfo.wProcessorLevel &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//std::cout &lt;&lt; &#34;  Processor revision: &#34; &lt;&lt; sysInfo.wProcessorRevision &lt;&lt; &#34;\n&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida解析结构体代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">getSystemInfoAddr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="s2">&#34;kernelbase.dll&#34;</span><span class="p">,</span> <span class="s2">&#34;GetSystemInfo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flag</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">getSystemInfoAddr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">arg0</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">flag</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">sysInfoPtr</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">arg0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwOemId</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">readInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwPageSize</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nx">readInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">lpMinimumApplicationAddress</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="nx">readU64</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">lpMaximumApplicationAddress</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="nx">readU64</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwActiveProcessorMask</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">24</span><span class="p">).</span><span class="nx">readU64</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwNumberOfProcessors</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">32</span><span class="p">).</span><span class="nx">readInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwProcessorType</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">readInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">dwAllocationGranularity</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">40</span><span class="p">).</span><span class="nx">readInt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">wProcessorLevel</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">44</span><span class="p">).</span><span class="nx">readU16</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">wProcessorRevision</span> <span class="o">=</span> <span class="nx">sysInfoPtr</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mi">46</span><span class="p">).</span><span class="nx">readU16</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwOemId:&#34;</span><span class="p">,</span> <span class="nx">dwOemId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwPageSize:&#34;</span><span class="p">,</span> <span class="nx">dwPageSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;lpMinimumApplicationAddress:&#34;</span><span class="p">,</span> <span class="nx">lpMinimumApplicationAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;lpMaximumApplicationAddress:&#34;</span><span class="p">,</span> <span class="nx">lpMaximumApplicationAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwActiveProcessorMask:&#34;</span><span class="p">,</span> <span class="nx">dwActiveProcessorMask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwNumberOfProcessors:&#34;</span><span class="p">,</span> <span class="nx">dwNumberOfProcessors</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwProcessorType:&#34;</span><span class="p">,</span> <span class="nx">dwProcessorType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;dwAllocationGranularity:&#34;</span><span class="p">,</span> <span class="nx">dwAllocationGranularity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;wProcessorLevel:&#34;</span><span class="p">,</span> <span class="nx">wProcessorLevel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;wProcessorRevision:&#34;</span><span class="p">,</span> <span class="nx">wProcessorRevision</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cmodule" class="heading-element"><span>CModule</span>
  <a href="#cmodule" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>通过CModule API,我们可以传递一串C代码,并在内存中将其编译为机器代码.但需要注意的是该功能在tinycc下编译,因此有一定的局限性.</p>
<p>CModule语法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="nx">code</span><span class="p">[,</span> <span class="nx">symbols</span><span class="p">,</span> <span class="nx">options</span><span class="p">])</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">SYSTEMTIME</span> <span class="n">localTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">GetLocalTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">localTime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida注入代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    #include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">    typedef unsigned short  WORD;
</span></span></span><span class="line"><span class="cl"><span class="sb">    typedef struct _SYSTEMTIME {
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wYear;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wMonth;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wDayOfWeek;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wDay;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wHour;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wMinute;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wSecond;
</span></span></span><span class="line"><span class="cl"><span class="sb">    WORD wMilliseconds;
</span></span></span><span class="line"><span class="cl"><span class="sb">} SYSTEMTIME, *PSYSTEMTIME, *LPSYSTEMTIME;
</span></span></span><span class="line"><span class="cl"><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">  void PrintSystemTime(const SYSTEMTIME* pTime) {
</span></span></span><span class="line"><span class="cl"><span class="sb">	printf(&#34;Current local time is: %04d-%02d-%02d %02d:%02d:%02d.%03d\n&#34;,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wYear,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wMonth,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wDay,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wHour,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wMinute,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wSecond,
</span></span></span><span class="line"><span class="cl"><span class="sb">		pTime-&gt;wMilliseconds);
</span></span></span><span class="line"><span class="cl"><span class="sb">}
</span></span></span><span class="line"><span class="cl"><span class="sb">`</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">cmMod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CModule</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">//console.log(JSON.stringify(cmMod))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">printSystemTimeAddr</span> <span class="o">=</span> <span class="nx">cmMod</span><span class="p">.</span><span class="nx">PrintSystemTime</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">printSystemTimeFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NativeFunction</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">printSystemTimeAddr</span><span class="p">),</span> <span class="s1">&#39;void&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pointer&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">getLocalTimeAddr</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">getExportByName</span><span class="p">(</span><span class="s2">&#34;kernelbase.dll&#34;</span><span class="p">,</span> <span class="s2">&#34;GetLocalTime&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">getLocalTimeAddr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">arg0</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">printSystemTimeFunc</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">arg0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="stalker" class="heading-element"><span>Stalker</span>
  <a href="#stalker" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>Stalker是一个代码跟踪引擎,可以跟踪线程并捕获调用的每个函数、代码块和指令.其语法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">([</span><span class="nx">threadId</span><span class="p">,</span> <span class="nx">options</span><span class="p">])</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>threadId:要跟踪的线程ID,可通过<code>Process.enumerateThreadsSync()</code>或函数内部的<code>this.threadId</code>获取</p>
</li>
<li>
<p>options:用于启用事件跟踪的选项</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">call</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// CALL instructions: yes please
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ret</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// RET instructions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">exec</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// all instructions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">block</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// block executed: coarse execution trace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">compile</span><span class="o">:</span> <span class="kc">false</span> <span class="c1">// block compiled: useful for coverage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>目标进程,测试代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;code.dat&#34;</span><span class="p">,</span> <span class="s">&#34;r+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;File opening failed</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">printf</span><span class="p">(</span><span class="s">&#34;File opened successfully</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Frida 跟踪函数调用关系代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mainPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F960</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">modBase</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span>
</span></span><span class="line"><span class="cl"><span class="c1">//console.log(&#34;modBase:&#34;, modBase)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">moduleName</span> <span class="o">=</span> <span class="s2">&#34;luoDst.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">mainPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">threadId</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">call</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ret</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">exec</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">block</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">compile</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onReceive</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">eventsData</span> <span class="o">=</span> <span class="nx">Stalker</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">events</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">annotate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">stringify</span><span class="o">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">eventsData</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 调用的流程,地址1是哪里发生的调用,地址2是调用到了哪里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="kd">var</span> <span class="nx">dataSp</span> <span class="o">=</span> <span class="nx">eventsData</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">          <span class="kd">var</span> <span class="nx">addr1</span> <span class="o">=</span> <span class="nx">dataSp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">          <span class="kd">var</span> <span class="nx">addr2</span> <span class="o">=</span> <span class="nx">dataSp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">          <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">module1</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">getModuleByAddress</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">addr1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">module1</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="kd">var</span> <span class="nx">module2</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">getModuleByAddress</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">addr2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">module1</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34;!&#34;</span> <span class="o">+</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">addr1</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">module1</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34; -&gt; &#34;</span> <span class="o">+</span> <span class="nx">module2</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34;!&#34;</span> <span class="o">+</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">addr2</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">module2</span><span class="p">.</span><span class="nx">base</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//console.log(dataSp);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onCallSummary</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">summary</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//console.log(JSON.stringify(summary, null, 4));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Stalker</span><span class="p">.</span><span class="nx">unfollow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">threadId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='./images/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB%E8%B7%9F%E8%B8%AA.png' alt="函数调用关系跟踪"></p>
<ol start="3">
<li>Frida 进行指令跟踪代码如下:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mainPtr</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="mh">0x16F960</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">modBase</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">mainModule</span><span class="p">.</span><span class="nx">base</span>
</span></span><span class="line"><span class="cl"><span class="c1">//console.log(&#34;modBase:&#34;, modBase)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">moduleName</span> <span class="o">=</span> <span class="s2">&#34;luoDst.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">moduleStart</span> <span class="o">=</span> <span class="nx">mainPtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">moduleEnd</span> <span class="o">=</span> <span class="nx">modBase</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">preRegs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">GetDiffRegs</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">preRegs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//preRegs是调用之前的寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">var</span> <span class="nx">diffRegs</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// console.log(Object.keys(JSON.parse(JSON.stringify(context))));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="p">[</span><span class="nx">regName</span><span class="p">,</span> <span class="nx">regValue</span><span class="p">]</span> <span class="k">of</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">context</span><span class="p">))))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">regName</span> <span class="o">!=</span> <span class="s2">&#34;pc&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">preRegs</span><span class="p">[</span><span class="nx">regName</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">regValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">preRegs</span><span class="p">[</span><span class="nx">regName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">regValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">diffRegs</span><span class="p">[</span><span class="nx">regName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">regValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">diffRegs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">mainPtr</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEnter</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Stalker</span><span class="p">.</span><span class="nx">follow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">threadId</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">call</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ret</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">exec</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">block</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">compile</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">transform</span><span class="p">(</span><span class="nx">iterator</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">instruction</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">startAddress</span> <span class="o">=</span> <span class="nx">instruction</span><span class="p">.</span><span class="nx">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">isModuleCode</span> <span class="o">=</span> <span class="nx">startAddress</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">moduleStart</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">startAddress</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">moduleEnd</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//在模块起始地址才打印
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="nx">isModuleCode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// console.log(startAddress, instruction);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//指令执行之后调用，context寄存器上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">iterator</span><span class="p">.</span><span class="nx">putCallout</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="kd">var</span> <span class="nx">pc</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">pc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="kd">var</span> <span class="nx">module</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">findModuleByAddress</span><span class="p">(</span><span class="nx">pc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="nx">module</span> <span class="o">&amp;&amp;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kd">var</span> <span class="nx">diffRegs</span> <span class="o">=</span> <span class="nx">GetDiffRegs</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">preRegs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&#34;!&#34;</span> <span class="o">+</span> <span class="nx">ptr</span><span class="p">(</span><span class="nx">pc</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">base</span><span class="p">),</span> <span class="nx">Instruction</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">pc</span><span class="p">)),</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">diffRegs</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="nx">iterator</span><span class="p">.</span><span class="nx">keep</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="nx">instruction</span> <span class="o">=</span> <span class="nx">iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">())</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onLeave</span><span class="p">(</span><span class="nx">retval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Stalker</span><span class="p">.</span><span class="nx">unfollow</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">threadId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src='./images/%E6%8C%87%E4%BB%A4%E8%B7%9F%E8%B8%AA.png' alt="指令跟踪"></p>
<h2 id="参考链接" class="heading-element"><span>参考链接</span>
  <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://learnfrida.info"target="_blank" rel="external nofollow noopener noreferrer">Frida HandBook</a></p>
<p><a href="https://frida.re/docs/javascript-api"target="_blank" rel="external nofollow noopener noreferrer">Frida JavaScript API</a></p>
</div><hr class="awesome-hr" />
    <h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/posts/android/android-hook/frida/objection%E4%BD%BF%E7%94%A8/" title="Objection使用">Objection使用</a></li><li>
          <a href="/posts/android/android-hook/frida/frida%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/" title="Frida源码编译">Frida源码编译</a></li><li>
          <a href="/posts/android/android-hook/frida/frida-hook%E5%A4%A7%E5%85%A8/" title="Frida Hook大全">Frida Hook大全</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-08-08 00:00:00">更新于 2024-08-08&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/frida/" class="post-tag" title="标签 - Frida">Frida</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/android/unidbg/06unidbg%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/" class="post-nav-item" rel="prev" title="Unidbg生产环境部署"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Unidbg生产环境部署</a><a href="/posts/python/pyc%E6%B7%B7%E6%B7%86%E8%A7%A3%E5%AF%86-%E6%98%A0%E5%B0%84%E8%A1%A8%E8%BF%98%E5%8E%9F/" class="post-nav-item" rel="next" title="Pyc混淆解密-映射表还原">Pyc混淆解密-映射表还原<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">夏洛魂</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/pace/themes/purple/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"enable":false},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":true,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":1,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"version":"v0.3.17-8212d6fd"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
