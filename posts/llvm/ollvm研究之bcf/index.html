<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>OLLVM研究之BCF - 夏洛魂的个人博客</title><meta name="author" content="夏洛魂">
<meta name="author-link" content="">
<meta name="description" content="概述 BCF即虚假控制流,将原程序基本块进行拆分和克隆,利用不透明谓词将克隆的基本块作为不可达分支用来混淆静态代码,达到迷惑攻击者的目的. 这里" /><meta name="keywords" content='LLVM' />
  <meta itemprop="name" content="OLLVM研究之BCF">
  <meta itemprop="description" content="概述 BCF即虚假控制流,将原程序基本块进行拆分和克隆,利用不透明谓词将克隆的基本块作为不可达分支用来混淆静态代码,达到迷惑攻击者的目的. 这里">
  <meta itemprop="datePublished" content="2023-04-19T00:00:00+00:00">
  <meta itemprop="dateModified" content="2023-04-19T00:00:00+00:00">
  <meta itemprop="wordCount" content="3904">
  <meta itemprop="image" content="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf/images/%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E5%AE%9E%E7%8E%B0.png">
  <meta itemprop="keywords" content="LLVM"><meta property="og:url" content="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf/">
  <meta property="og:site_name" content="夏洛魂的个人博客">
  <meta property="og:title" content="OLLVM研究之BCF">
  <meta property="og:description" content="概述 BCF即虚假控制流,将原程序基本块进行拆分和克隆,利用不透明谓词将克隆的基本块作为不可达分支用来混淆静态代码,达到迷惑攻击者的目的. 这里">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2023-04-19T00:00:00+00:00">
    <meta property="article:tag" content="LLVM">
    <meta property="og:image" content="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf/images/%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E5%AE%9E%E7%8E%B0.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf/images/%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E5%AE%9E%E7%8E%B0.png">
  <meta name="twitter:title" content="OLLVM研究之BCF">
  <meta name="twitter:description" content="概述 BCF即虚假控制流,将原程序基本块进行拆分和克隆,利用不透明谓词将克隆的基本块作为不可达分支用来混淆静态代码,达到迷惑攻击者的目的. 这里">
<meta name="application-name" content="夏洛魂">
<meta name="apple-mobile-web-app-title" content="夏洛魂"><meta name="theme-color" data-light="#ffffff" data-dark="#ffffff" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bfla/" /><link rel="next" href="https://XiaLuoHun.github.io/posts/windows%E7%9B%B8%E5%85%B3/net%E7%A8%8B%E5%BA%8Fhook%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E4%BC%98%E9%9B%85%E5%AE%9E%E7%8E%B0/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "OLLVM研究之BCF",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/XiaLuoHun.github.io\/posts\/llvm\/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/XiaLuoHun.github.io\/posts\/llvm\/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf\/images\/%E8%99%9A%E5%81%87%E6%8E%A7%E5%88%B6%E6%B5%81%E5%AE%9E%E7%8E%B0.png",
              "width":  1429 ,
              "height":  465 
            }],"genre": "posts","keywords": "LLVM","wordcount":  3904 ,
    "url": "https:\/\/XiaLuoHun.github.io\/posts\/llvm\/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bbcf\/","datePublished": "2023-04-19T00:00:00+00:00","dateModified": "2023-04-19T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "夏洛魂"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="fixed" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/excalidraw/"
                
                
              >在线绘图</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于作者</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/excalidraw/"
                  
                  
                >在线绘图</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于作者</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>OLLVM研究之BCF</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/Luo.png" alt="夏洛魂" data-title="夏洛魂" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;夏洛魂</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/llvm/" class="post-category" title="分类 - LLVM"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> LLVM</a></span></div><div class="post-meta-line"><span title="发布于 2023-04-19 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-04-19">2023-04-19</time></span>&nbsp;<span title="3904 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 4000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 8 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#概述">概述</a></li>
        <li><a href="#测试文件">测试文件</a></li>
        <li><a href="#流程分析">流程分析</a>
          <ul>
            <li><a href="#入口函数">入口函数</a></li>
            <li><a href="#虚假控制流构造">虚假控制流构造</a></li>
            <li><a href="#替换永真表达式">替换永真表达式</a></li>
          </ul>
        </li>
        <li><a href="#参考链接">参考链接</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="概述" class="heading-element"><span>概述</span>
  <a href="#%e6%a6%82%e8%bf%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>BCF即虚假控制流,将原程序基本块进行拆分和克隆,利用不透明谓词将克隆的基本块作为不可达分支用来混淆静态代码,达到迷惑攻击者的目的.</p>
<p>这里的不透明谓词是指一个表达式,它的值在执行到某处时,对代码编写者来说是确定的,但是由于某种原因,编译器或者静态分析器无法推断出这个值,只能在运行时确定.</p>
<p>其技术实现过程如下:</p>
<p><img loading="lazy" src="./images/%e8%99%9a%e5%81%87%e6%8e%a7%e5%88%b6%e6%b5%81%e5%ae%9e%e7%8e%b0.png" alt="虚假控制流实现" srcset="./images/%e8%99%9a%e5%81%87%e6%8e%a7%e5%88%b6%e6%b5%81%e5%ae%9e%e7%8e%b0.png?size=small, ./images/%e8%99%9a%e5%81%87%e6%8e%a7%e5%88%b6%e6%b5%81%e5%ae%9e%e7%8e%b0.png?size=medium 1.5x, ./images/%e8%99%9a%e5%81%87%e6%8e%a7%e5%88%b6%e6%b5%81%e5%ae%9e%e7%8e%b0.png?size=large 2x" data-title="虚假控制流实现" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>虚假控制流后,在IDA中的示例如下:</p>
<p><img loading="lazy" src="./images/IDA%e7%a4%ba%e4%be%8b.png" alt="IDA示例" srcset="./images/IDA%e7%a4%ba%e4%be%8b.png?size=small, ./images/IDA%e7%a4%ba%e4%be%8b.png?size=medium 1.5x, ./images/IDA%e7%a4%ba%e4%be%8b.png?size=large 2x" data-title="IDA示例" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="测试文件" class="heading-element"><span>测试文件</span>
  <a href="#%e6%b5%8b%e8%af%95%e6%96%87%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//luoTst.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="流程分析" class="heading-element"><span>流程分析</span>
  <a href="#%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="入口函数" class="heading-element"><span>入口函数</span>
  <a href="#%e5%85%a5%e5%8f%a3%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ol>
<li>bcf的声明在ollvm/include/llvm/Transforms/Obfuscation/BogusControlFlow.h</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">Pass</span> <span class="o">*</span><span class="nf">createBogus</span> <span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Pass</span> <span class="o">*</span><span class="nf">createBogus</span> <span class="p">(</span><span class="kt">bool</span> <span class="n">flag</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>bcf的入口函数是runOnFunction,在ollvm/lib/Transforms/Obfuscation/BogusControlFlow.cpp</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">runOnFunction</span><span class="p">(</span><span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Check if the percentage is correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">ObfTimes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">errs</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&#34;BogusControlFlow application number -bcf_loop=x must be x &gt; 0&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Check if the number of applications is correct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="n">ObfProbRate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ObfProbRate</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">errs</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&#34;BogusControlFlow application basic blocks percentage -bcf_prob=x must be 0 &lt; x &lt;= 100&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">orginalBBs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// check for compatible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="n">BasicBlock</span> <span class="o">&amp;</span><span class="nl">bb</span> <span class="p">:</span> <span class="n">F</span><span class="p">.</span><span class="n">getBasicBlockList</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">InvokeInst</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bb</span><span class="p">.</span><span class="n">getTerminator</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// If fla annotations
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span><span class="n">toObfuscate</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span><span class="s">&#34;bcf&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bogus</span><span class="p">(</span><span class="n">F</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">doF</span><span class="p">(</span><span class="o">*</span><span class="n">F</span><span class="p">.</span><span class="n">getParent</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">// end of runOnFunction()
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ObfTimes是通过以下参数进行传递的,默认是1</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//进行3次bcf混淆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">-</span><span class="n">mllvm</span> <span class="o">-</span><span class="n">bcf_loop</span><span class="o">=</span><span class="mi">3</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ObfProbRate是通过以下参数进行传递的,默认是30</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//每个基本块有40%的概率进行bcf混淆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">-</span><span class="n">mllvm</span> <span class="o">-</span><span class="n">bcf_prob</span><span class="o">=</span><span class="mi">40</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>toObfuscate函数用于判断是否需要进行bcf</li>
</ol>
<p><img loading="lazy" src="./images/toObfuscate%e5%87%bd%e6%95%b0.png" alt="toObfuscate函数" srcset="./images/toObfuscate%e5%87%bd%e6%95%b0.png?size=small, ./images/toObfuscate%e5%87%bd%e6%95%b0.png?size=medium 1.5x, ./images/toObfuscate%e5%87%bd%e6%95%b0.png?size=large 2x" data-title="toObfuscate函数" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="虚假控制流构造" class="heading-element"><span>虚假控制流构造</span>
  <a href="#%e8%99%9a%e5%81%87%e6%8e%a7%e5%88%b6%e6%b5%81%e6%9e%84%e9%80%a0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>bogus函数内部会遍历函数的所有基本块,然后调用addBogusFlow函数进行虚假控制流的添加,其关键逻辑代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">bogus</span><span class="p">(</span><span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//①通过命令行传参(-mllvm -bcf_loop=3)来构建循环体,决定进行多少次bcf混淆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">NumObfTimes</span> <span class="o">=</span> <span class="n">ObfTimes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//②保存该函数所有基本块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">BasicBlock</span> <span class="o">*&gt;</span> <span class="n">basicBlocks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="n">Function</span><span class="o">::</span><span class="n">iterator</span> <span class="n">i</span><span class="o">=</span><span class="n">F</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="n">i</span><span class="o">!=</span><span class="n">F</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">basicBlocks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="c1">//③遍历所有基本块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">basicBlocks</span><span class="p">.</span><span class="n">empty</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//④通过随机产生100以内的数来和命令行传参(-mllvm -bcf_prob=40)进行比较,决定该基本块是否进行bcf混淆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">llvm</span><span class="o">::</span><span class="n">cryptoutils</span><span class="o">-&gt;</span><span class="n">get_range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">ObfProbRate</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//⑤调用addBogusFlow进行虚假控制流的添加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">basicBlock</span> <span class="o">=</span> <span class="n">basicBlocks</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="n">addBogusFlow</span><span class="p">(</span><span class="n">basicBlock</span><span class="p">,</span> <span class="n">F</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// remove the block from the list
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">basicBlocks</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="c1">// end of while(!basicBlocks.empty())
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">NumObfTimes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>接下来我们分析下进行bcf混淆的核心函数<strong>addBogusFlow</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">virtual</span> <span class="kt">void</span> <span class="n">addBogusFlow</span><span class="p">(</span><span class="n">BasicBlock</span> <span class="o">*</span> <span class="n">basicBlock</span><span class="p">,</span> <span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>进行基本块的分割</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//获取基本块中的第一个非PHI、非调试信息、非生命周期传递指令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Instruction</span> <span class="o">*</span><span class="n">i1</span> <span class="o">=</span> <span class="o">&amp;*</span><span class="n">basicBlock</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span><span class="p">(</span><span class="n">basicBlock</span><span class="o">-&gt;</span><span class="n">getFirstNonPHIOrDbgOrLifetime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="n">i1</span> <span class="o">=</span> <span class="n">basicBlock</span><span class="o">-&gt;</span><span class="n">getFirstNonPHIOrDbgOrLifetime</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">//调用splitBasicBlock,进行基本块的分割
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">Twine</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">var</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;originalBB&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">originalBB</span> <span class="o">=</span> <span class="n">basicBlock</span><span class="o">-&gt;</span><span class="n">splitBasicBlock</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="o">*</span><span class="n">var</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>假设要处理的基本块IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span></span></span></code></pre></td></tr></table>
</div>
</div><p>经过上述分割后的基本块IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>进行基本块的克隆</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//仿originalBB进行基本块的克隆
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Twine</span> <span class="o">*</span> <span class="n">var3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;alteredBB&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BasicBlock</span> <span class="o">*</span><span class="n">alteredBB</span> <span class="o">=</span> <span class="n">createAlteredBasicBlock</span><span class="p">(</span><span class="n">originalBB</span><span class="p">,</span> <span class="o">*</span><span class="n">var3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBBalteredBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retvalalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">aalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retvalalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidxalteredBB</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidxalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">callalteredBB</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">callalteredBB</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmpalteredBB</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmpalteredBB</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>移除基本块的最后一条指令(通常来说是分支或返回指令),即删除其与后继块的关系</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">alteredBB</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">basicBlock</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">	  
</span></span><span class="line"><span class="cl"><span class="n">originalBBalteredBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retvalalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">aalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retvalalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidxalteredBB</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidxalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">callalteredBB</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">callalteredBB</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmpalteredBB</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>构建一个永真条件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">Value</span> <span class="o">*</span> <span class="n">LHS</span> <span class="o">=</span> <span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getFloatTy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Value</span> <span class="o">*</span> <span class="n">RHS</span> <span class="o">=</span> <span class="n">ConstantFP</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getFloatTy</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_WITH_TYPE</span><span class="p">(</span><span class="s">&#34;gen&#34;</span><span class="p">,</span> <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;bcf: Value LHS and RHS created</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//在第一个块即上述entry块处插入永真条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Twine</span> <span class="o">*</span> <span class="n">var4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;condition&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FCmpInst</span> <span class="o">*</span> <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FCmpInst</span><span class="p">(</span><span class="o">*</span><span class="n">basicBlock</span><span class="p">,</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="n">FCMP_TRUE</span> <span class="p">,</span> <span class="n">LHS</span><span class="p">,</span> <span class="n">RHS</span><span class="p">,</span> <span class="o">*</span><span class="n">var4</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>构建跳转逻辑</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">//在basicBlock即上述entry块处创建分支判断,条件为真则跳转到originalBB处,否则跳转到alteredBB块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BranchInst</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">alteredBB</span><span class="p">,</span> <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">condition</span><span class="p">,</span> <span class="n">basicBlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//在alteredBB块末尾添加分支指令,无条件跳转到originalBB块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BranchInst</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">alteredBB</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此时的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">condition</span> <span class="o">=</span> <span class="n">fcmp</span> <span class="bp">true</span> <span class="ne">float</span> <span class="mf">1.000000e+00</span><span class="p">,</span> <span class="mf">1.000000e+00</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">condition</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBalteredBB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBBalteredBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retvalalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">aalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retvalalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidxalteredBB</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidxalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">callalteredBB</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">callalteredBB</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmpalteredBB</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>分割originalBB</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">BasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">originalBB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//以originalBB块的最后一条指令为界进行分割
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Twine</span> <span class="o">*</span> <span class="n">var5</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;originalBBpart2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BasicBlock</span> <span class="o">*</span> <span class="n">originalBBpart2</span> <span class="o">=</span> <span class="n">originalBB</span><span class="o">-&gt;</span><span class="n">splitBasicBlock</span><span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="p">,</span> <span class="o">*</span><span class="n">var5</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>originalBB块的原始IR指令如上,经过分割后的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBpart2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBBpart2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>删除originalBB块经过分割后的最后一条指令,即割断originalBB块和originalBBpart2块的联系</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">originalBB</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>在originalBB块后构建永真条件,跳转为真则跳向originalBBpart2块,否则跳向alteredBB块</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">Twine</span> <span class="o">*</span> <span class="n">var6</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;condition2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FCmpInst</span> <span class="o">*</span> <span class="n">condition2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FCmpInst</span><span class="p">(</span><span class="o">*</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">CmpInst</span><span class="o">::</span><span class="n">FCMP_TRUE</span> <span class="p">,</span> <span class="n">LHS</span><span class="p">,</span> <span class="n">RHS</span><span class="p">,</span> <span class="o">*</span><span class="n">var6</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">BranchInst</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">originalBBpart2</span><span class="p">,</span> <span class="n">alteredBB</span><span class="p">,</span> <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">condition2</span><span class="p">,</span> <span class="n">originalBB</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如上面假设要处理的基本块是entry,经过上述处理后的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">condition</span> <span class="o">=</span> <span class="n">fcmp</span> <span class="bp">true</span> <span class="ne">float</span> <span class="mf">1.000000e+00</span><span class="p">,</span> <span class="mf">1.000000e+00</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">condition</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBalteredBB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retval</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retval</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidx</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidx</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">call</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">call</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmp</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">condition2</span> <span class="o">=</span> <span class="n">fcmp</span> <span class="bp">true</span> <span class="ne">float</span> <span class="mf">1.000000e+00</span><span class="p">,</span> <span class="mf">1.000000e+00</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">condition2</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBpart2</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBalteredBB</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBBpart2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="n">cmp</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="n">then</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="k">if</span><span class="o">.</span><span class="k">else</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">originalBBalteredBB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">retvalalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">aalteredBB</span> <span class="o">=</span> <span class="n">alloca</span> <span class="n">i32</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">retvalalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">argc</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">argc</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">argv</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">**</span><span class="p">,</span> <span class="n">i8</span><span class="o">***</span> <span class="o">%</span><span class="n">argv</span><span class="o">.</span><span class="n">addralteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">arrayidxalteredBB</span> <span class="o">=</span> <span class="n">getelementptr</span> <span class="n">inbounds</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">i64</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i8</span><span class="o">*</span><span class="p">,</span> <span class="n">i8</span><span class="o">**</span> <span class="o">%</span><span class="n">arrayidxalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">callalteredBB</span> <span class="o">=</span> <span class="n">call</span> <span class="n">i32</span> <span class="err">@</span><span class="n">atoi</span><span class="p">(</span><span class="n">i8</span><span class="o">*</span> <span class="o">%</span><span class="mi">5</span><span class="p">)</span> <span class="c1">#2</span>
</span></span><span class="line"><span class="cl">  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">callalteredBB</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">aalteredBB</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">cmpalteredBB</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="替换永真表达式" class="heading-element"><span>替换永真表达式</span>
  <a href="#%e6%9b%bf%e6%8d%a2%e6%b0%b8%e7%9c%9f%e8%a1%a8%e8%be%be%e5%bc%8f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>接下来看下最后一个函数doF,其函数声明如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">doF</span><span class="p">(</span><span class="n">Module</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数主要是找到当前模块中的永真表达式,并将其替换为如下的表达式.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">||</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到这个表达式也是个永真表达式,只是相对复杂一点.</p>
<ol>
<li>创建全局变量x和y</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">Twine</span> <span class="o">*</span> <span class="n">varX</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;x&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Twine</span> <span class="o">*</span> <span class="n">varY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Twine</span><span class="p">(</span><span class="s">&#34;y&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Value</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">=</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Value</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">=</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GlobalVariable</span> 	<span class="o">*</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GlobalVariable</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">GlobalValue</span><span class="o">::</span><span class="n">CommonLinkage</span><span class="p">,</span> <span class="p">(</span><span class="n">Constant</span> <span class="o">*</span> <span class="p">)</span><span class="n">x1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">varX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">GlobalVariable</span> 	<span class="o">*</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GlobalVariable</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">GlobalValue</span><span class="o">::</span><span class="n">CommonLinkage</span><span class="p">,</span> <span class="p">(</span><span class="n">Constant</span> <span class="o">*</span> <span class="p">)</span><span class="n">y1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">varY</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>找到表达式中的永真表达式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">*&gt;</span> <span class="n">toEdit</span><span class="p">,</span> <span class="n">toDelete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">BinaryOperator</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span><span class="o">*</span><span class="n">op1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">LoadInst</span> <span class="o">*</span> <span class="n">opX</span> <span class="p">,</span> <span class="o">*</span> <span class="n">opY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">ICmpInst</span> <span class="o">*</span> <span class="n">condition</span><span class="p">,</span> <span class="o">*</span> <span class="n">condition2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Looking for the conditions and branches to transform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span><span class="p">(</span><span class="n">Module</span><span class="o">::</span><span class="n">iterator</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">me</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">mi</span> <span class="o">!=</span> <span class="n">me</span><span class="p">;</span> <span class="o">++</span><span class="n">mi</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">Function</span><span class="o">::</span><span class="n">iterator</span> <span class="n">fi</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">fe</span> <span class="o">=</span> <span class="n">mi</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span> <span class="n">fi</span> <span class="o">!=</span> <span class="n">fe</span><span class="p">;</span> <span class="o">++</span><span class="n">fi</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Instruction</span> <span class="o">*</span> <span class="n">tbb</span><span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">getTerminator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">tbb</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">Br</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">BranchInst</span> <span class="o">*</span> <span class="n">br</span> <span class="o">=</span> <span class="p">(</span><span class="n">BranchInst</span> <span class="o">*</span><span class="p">)(</span><span class="n">tbb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span><span class="n">br</span><span class="o">-&gt;</span><span class="n">isConditional</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">        <span class="n">FCmpInst</span> <span class="o">*</span> <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">FCmpInst</span> <span class="o">*</span><span class="p">)</span><span class="n">br</span><span class="o">-&gt;</span><span class="n">getCondition</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="n">opcode</span> <span class="o">=</span> <span class="n">cond</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="n">Instruction</span><span class="o">::</span><span class="n">FCmp</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">cond</span><span class="o">-&gt;</span><span class="n">getPredicate</span><span class="p">()</span> <span class="o">==</span> <span class="n">FCmpInst</span><span class="o">::</span><span class="n">FCMP_TRUE</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">DEBUG_WITH_TYPE</span><span class="p">(</span><span class="s">&#34;gen&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">errs</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&#34;bcf: an always true predicate !</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">toDelete</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">cond</span><span class="p">);</span> <span class="c1">// The condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">toEdit</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tbb</span><span class="p">);</span>    <span class="c1">// The branch using the condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>创建永真表达式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">i</span> <span class="o">=</span><span class="n">toEdit</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="n">i</span><span class="o">!=</span><span class="n">toEdit</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//if y &lt; 10 || x*(x+1) % 2 == 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">opX</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoadInst</span> <span class="p">((</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">opY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoadInst</span> <span class="p">((</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">y</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">op</span> <span class="o">=</span> <span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">Instruction</span><span class="o">::</span><span class="n">Sub</span><span class="p">,</span> <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">opX</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">false</span><span class="p">),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">op1</span> <span class="o">=</span> <span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">Instruction</span><span class="o">::</span><span class="n">Mul</span><span class="p">,</span> <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">opX</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">op</span> <span class="o">=</span> <span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">Instruction</span><span class="o">::</span><span class="n">URem</span><span class="p">,</span> <span class="n">op1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">false</span><span class="p">),</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">condition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ICmpInst</span><span class="p">((</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="n">ICMP_EQ</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">false</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">condition2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ICmpInst</span><span class="p">((</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ICmpInst</span><span class="o">::</span><span class="n">ICMP_SLT</span><span class="p">,</span> <span class="n">opY</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">getContext</span><span class="p">()),</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nb">false</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">op1</span> <span class="o">=</span> <span class="n">BinaryOperator</span><span class="o">::</span><span class="n">Create</span><span class="p">(</span><span class="n">Instruction</span><span class="o">::</span><span class="n">Or</span><span class="p">,</span> <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">condition</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span><span class="n">condition2</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BranchInst</span><span class="o">::</span><span class="n">Create</span><span class="p">(((</span><span class="n">BranchInst</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="n">BranchInst</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSuccessor</span><span class="p">(</span><span class="mi">1</span><span class="p">),(</span><span class="n">Value</span> <span class="o">*</span><span class="p">)</span> <span class="n">op1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">((</span><span class="n">BranchInst</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span> <span class="c1">// erase the branch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上述操作就是在指令i前创建如下表达式并构造分支跳转:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(y &lt; 10 || x * (x + 1) % 2 == 0)</span></span></code></pre></td></tr></table>
</div>
</div><p>假设要处理的基本块IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">entry:
</span></span><span class="line"><span class="cl">  %condition = fcmp true float 1.000000e+00, 1.000000e+00
</span></span><span class="line"><span class="cl">  br i1 %condition, label %originalBB, label %originalBBalteredBB</span></span></code></pre></td></tr></table>
</div>
</div><p>创建永真表达式后的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="n">condition</span> <span class="o">=</span> <span class="n">fcmp</span> <span class="bp">true</span> <span class="ne">float</span> <span class="mf">1.000000e+00</span><span class="p">,</span> <span class="mf">1.000000e+00</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="err">@</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="err">@</span><span class="n">y</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">sub</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">mul</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">urem</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">slt</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">7</span> <span class="o">=</span> <span class="ow">or</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">5</span><span class="p">,</span> <span class="o">%</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">7</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBalteredBB</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>删除原永真条件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">i</span> <span class="o">=</span><span class="n">toDelete</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="n">i</span><span class="o">!=</span><span class="n">toDelete</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">DEBUG_WITH_TYPE</span><span class="p">(</span><span class="s">&#34;gen&#34;</span><span class="p">,</span> <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;bcf: Erase condition instruction:&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="p">((</span><span class="n">Instruction</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">&lt;&lt;</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>假设要处理的基本块IR指令如上,则经过doF函数处理后的IR指令如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">@</span><span class="n">x</span> <span class="o">=</span> <span class="n">common</span> <span class="n">global</span> <span class="n">i32</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">y</span> <span class="o">=</span> <span class="n">common</span> <span class="n">global</span> <span class="n">i32</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">entry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="err">@</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="nb">load</span> <span class="n">i32</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="err">@</span><span class="n">y</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">sub</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">mul</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">urem</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">eq</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">icmp</span> <span class="n">slt</span> <span class="n">i32</span> <span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">  <span class="o">%</span><span class="mi">7</span> <span class="o">=</span> <span class="ow">or</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">5</span><span class="p">,</span> <span class="o">%</span><span class="mi">6</span>
</span></span><span class="line"><span class="cl">  <span class="n">br</span> <span class="n">i1</span> <span class="o">%</span><span class="mi">7</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBB</span><span class="p">,</span> <span class="n">label</span> <span class="o">%</span><span class="n">originalBBalteredBB</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考链接" class="heading-element"><span>参考链接</span>
  <a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><a href="https://github.com/obfuscator-llvm/obfuscator/blob/llvm-4.0/lib/Transforms/Obfuscation/BogusControlFlow.cpp"target="_blank" rel="external nofollow noopener noreferrer" class="card-link"><span class="cl-backdrop" style="--cl-bg-url: url(/images/fixit.min.svg);"></span>
    <span class="cl-content">
      <span class="cl-text">
        <span class="cl-title">BogusControlFlow.cpp</span>
        <span class="cl-meta">
          <svg class="cl-icon-link" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M574 665.4c-3.1-3.1-8.2-3.1-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8c-3.1-3.1-8.2-3.1-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zM832.6 191.4c-84.6-84.6-221.5-84.6-306 0L410.3 307.6c-3.1 3.1-3.1 8.2 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6c-3.1 3.1-3.1 8.2 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1z" fill="#a9a9b3"></path><path d="M610.1 372.3c-3.1-3.1-8.2-3.1-11.3 0L372.3 598.7c-3.1 3.1-3.1 8.2 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z" fill="#a9a9b3"></path></svg>
          <span class="cl-url">https://github.com/obfuscator-llvm/obfuscator/blob/llvm-4.0/lib/Transforms/Obfuscation/BogusControlFlow.cpp</span>
        </span>
      </span><svg class="cl-shortcut-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M960 512c0 249.408-203.2 448-448 448-244.778667 0-448-198.592-448-448S262.592 64 512 64s448 198.592 448 448" fill="#2196F3"></path><path d="M507.52 718.08c0-8.96-4.48-13.44-13.44-17.92-26.88-8.96-53.76-8.96-76.16-31.381333-4.48-8.96-4.48-17.92-8.96-26.88-8.96-8.96-31.36-13.44-44.8-17.92h-89.6c-13.44-4.48-22.4-22.4-31.36-35.84 0-4.48 0-13.461333-8.96-13.461334-8.96-4.458667-17.92 4.501333-26.88 0-4.48-4.458667-4.48-8.96-4.48-13.418666 0-13.461333 8.96-26.901333 17.92-35.861334 13.44-8.96 26.88 4.48 40.32 4.48 4.48 0 4.48 0 8.96 4.48 13.44 4.48 17.92 22.4 17.92 35.861334v8.96c0 4.48 4.48 4.48 8.96 4.48 4.48-22.4 4.48-44.821333 8.96-67.2 0-26.88 26.88-53.781333 49.28-62.72 8.96-4.458667 13.44 4.501333 22.4 0 26.88-8.96 94.08-35.84 80.64-71.658667-8.96-31.381333-35.84-62.698667-71.68-58.24-8.96 4.501333-13.44 8.96-22.4 13.461333-13.44 8.96-40.32 35.84-53.76 35.84-22.4-4.48-22.4-35.84-17.92-49.301333 4.48-17.92 44.8-76.138667 71.68-67.178667l17.92 17.92c8.96 4.48 22.4 4.48 35.84 4.48 4.48 0 8.96 0 13.44-4.48 4.48-4.48 4.48-4.48 4.48-8.96 0-13.44-13.44-26.901333-22.4-35.861333s-22.4-17.92-35.84-22.378667c-44.8-13.461333-116.48 4.458667-152.32 35.84-35.84 31.36-62.72 85.12-80.64 129.92-8.96 26.88-17.92 62.698667-22.4 94.08-4.48 22.4-8.96 40.32 4.48 62.698667 13.44 26.88 40.32 53.781333 67.2 71.68 17.92 13.44 53.76 13.44 71.68 35.84 13.44 17.941333 8.96 40.32 8.96 62.72 0 26.88 17.92 49.28 26.88 71.658667 4.48 13.461333 8.96 31.381333 13.44 44.821333 0 4.48 4.48 31.36 4.48 35.84 26.88 13.44 49.28 26.901333 80.64 35.861333 4.48 0 22.4-26.901333 22.4-31.381333 13.44-13.44 22.4-31.36 35.84-40.32 8.96-4.48 17.92-8.96 26.88-17.941333 8.96-8.96 13.44-26.88 17.92-40.32 4.48-8.938667 8.96-26.858667 4.48-40.298667M516.48 305.92c4.48 0 8.96-4.48 17.92-8.96 13.44-8.96 26.901333-22.4 40.32-31.36 13.461333-8.96 26.901333-22.4 35.861333-31.36 13.44-8.96 22.4-26.88 26.88-40.341333 4.48-8.96 17.941333-26.88 13.44-40.32-4.48-8.96-26.88-13.44-35.84-17.92C579.2 126.698667 547.84 122.24 512 122.24c-13.44 0-31.36 4.458667-35.84 17.92-4.48 22.4 13.44 17.92 31.36 22.4 0 0 4.48 35.84 4.48 40.32 4.48 22.421333-8.96 35.84-8.96 58.24 0 13.44 0 35.84 8.96 44.8h4.48zM892.8 619.52c4.501333-8.96 4.501333-22.4 8.96-31.36 4.501333-22.421333 4.501333-44.8 4.501333-67.2 0-44.8-4.501333-89.578667-17.92-129.92-8.96-13.44-13.461333-26.88-17.941333-40.341333-8.96-22.378667-22.4-44.8-40.32-62.698667-17.92-22.4-40.341333-85.12-80.64-67.2-13.44 4.501333-22.4 22.421333-31.36 31.381333l-26.88 40.32c-4.501333 4.48-8.96 13.44-4.501333 17.92 0 4.48 4.501333 4.48 8.96 4.48 8.96 4.501333 13.461333 4.501333 22.421333 8.96 4.48 0 8.96 4.501333 4.48 8.96 0 0 0 4.501333-4.48 4.501334-22.421333 22.4-44.8 40.32-67.2 62.698666-4.48 4.48-8.96 13.44-8.96 17.92s4.48 4.48 4.48 8.96c0 4.501333-4.48 4.501333-8.96 8.96-8.96 4.501333-17.92 8.96-22.4 13.461334-4.48 8.96 0 22.4-4.48 31.36-4.48 22.4-17.941333 40.32-26.901333 62.72-8.96 13.418667-13.418667 26.88-22.378667 40.32 0 17.92-4.501333 31.36 4.458667 44.8 22.421333 31.36 62.72 13.44 94.08 26.901333 8.96 4.458667 17.92 4.458667 22.421333 13.418667 13.418667 13.461333 13.418667 35.861333 17.92 49.301333 4.458667 17.92 8.96 35.84 17.92 53.76 4.48 22.421333 13.44 44.821333 17.92 62.72 40.341333-31.36 76.16-67.178667 103.04-112 26.88-31.424 40.341333-67.242667 53.76-103.104" fill="#CDDC39"></path></svg></span></a>
<a href="https://blog.csdn.net/suningning/article/details/103307501"target="_blank" rel="external nofollow noopener noreferrer" class="card-link"><span class="cl-backdrop" style="--cl-bg-url: url(/images/fixit.min.svg);"></span>
    <span class="cl-content">
      <span class="cl-text">
        <span class="cl-title">OLLVM混淆研究之BCF篇</span>
        <span class="cl-meta">
          <svg class="cl-icon-link" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M574 665.4c-3.1-3.1-8.2-3.1-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8c-3.1-3.1-8.2-3.1-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zM832.6 191.4c-84.6-84.6-221.5-84.6-306 0L410.3 307.6c-3.1 3.1-3.1 8.2 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6c-3.1 3.1-3.1 8.2 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1z" fill="#a9a9b3"></path><path d="M610.1 372.3c-3.1-3.1-8.2-3.1-11.3 0L372.3 598.7c-3.1 3.1-3.1 8.2 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z" fill="#a9a9b3"></path></svg>
          <span class="cl-url">https://blog.csdn.net/suningning/article/details/103307501</span>
        </span>
      </span><svg class="cl-shortcut-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M960 512c0 249.408-203.2 448-448 448-244.778667 0-448-198.592-448-448S262.592 64 512 64s448 198.592 448 448" fill="#2196F3"></path><path d="M507.52 718.08c0-8.96-4.48-13.44-13.44-17.92-26.88-8.96-53.76-8.96-76.16-31.381333-4.48-8.96-4.48-17.92-8.96-26.88-8.96-8.96-31.36-13.44-44.8-17.92h-89.6c-13.44-4.48-22.4-22.4-31.36-35.84 0-4.48 0-13.461333-8.96-13.461334-8.96-4.458667-17.92 4.501333-26.88 0-4.48-4.458667-4.48-8.96-4.48-13.418666 0-13.461333 8.96-26.901333 17.92-35.861334 13.44-8.96 26.88 4.48 40.32 4.48 4.48 0 4.48 0 8.96 4.48 13.44 4.48 17.92 22.4 17.92 35.861334v8.96c0 4.48 4.48 4.48 8.96 4.48 4.48-22.4 4.48-44.821333 8.96-67.2 0-26.88 26.88-53.781333 49.28-62.72 8.96-4.458667 13.44 4.501333 22.4 0 26.88-8.96 94.08-35.84 80.64-71.658667-8.96-31.381333-35.84-62.698667-71.68-58.24-8.96 4.501333-13.44 8.96-22.4 13.461333-13.44 8.96-40.32 35.84-53.76 35.84-22.4-4.48-22.4-35.84-17.92-49.301333 4.48-17.92 44.8-76.138667 71.68-67.178667l17.92 17.92c8.96 4.48 22.4 4.48 35.84 4.48 4.48 0 8.96 0 13.44-4.48 4.48-4.48 4.48-4.48 4.48-8.96 0-13.44-13.44-26.901333-22.4-35.861333s-22.4-17.92-35.84-22.378667c-44.8-13.461333-116.48 4.458667-152.32 35.84-35.84 31.36-62.72 85.12-80.64 129.92-8.96 26.88-17.92 62.698667-22.4 94.08-4.48 22.4-8.96 40.32 4.48 62.698667 13.44 26.88 40.32 53.781333 67.2 71.68 17.92 13.44 53.76 13.44 71.68 35.84 13.44 17.941333 8.96 40.32 8.96 62.72 0 26.88 17.92 49.28 26.88 71.658667 4.48 13.461333 8.96 31.381333 13.44 44.821333 0 4.48 4.48 31.36 4.48 35.84 26.88 13.44 49.28 26.901333 80.64 35.861333 4.48 0 22.4-26.901333 22.4-31.381333 13.44-13.44 22.4-31.36 35.84-40.32 8.96-4.48 17.92-8.96 26.88-17.941333 8.96-8.96 13.44-26.88 17.92-40.32 4.48-8.938667 8.96-26.858667 4.48-40.298667M516.48 305.92c4.48 0 8.96-4.48 17.92-8.96 13.44-8.96 26.901333-22.4 40.32-31.36 13.461333-8.96 26.901333-22.4 35.861333-31.36 13.44-8.96 22.4-26.88 26.88-40.341333 4.48-8.96 17.941333-26.88 13.44-40.32-4.48-8.96-26.88-13.44-35.84-17.92C579.2 126.698667 547.84 122.24 512 122.24c-13.44 0-31.36 4.458667-35.84 17.92-4.48 22.4 13.44 17.92 31.36 22.4 0 0 4.48 35.84 4.48 40.32 4.48 22.421333-8.96 35.84-8.96 58.24 0 13.44 0 35.84 8.96 44.8h4.48zM892.8 619.52c4.501333-8.96 4.501333-22.4 8.96-31.36 4.501333-22.421333 4.501333-44.8 4.501333-67.2 0-44.8-4.501333-89.578667-17.92-129.92-8.96-13.44-13.461333-26.88-17.941333-40.341333-8.96-22.378667-22.4-44.8-40.32-62.698667-17.92-22.4-40.341333-85.12-80.64-67.2-13.44 4.501333-22.4 22.421333-31.36 31.381333l-26.88 40.32c-4.501333 4.48-8.96 13.44-4.501333 17.92 0 4.48 4.501333 4.48 8.96 4.48 8.96 4.501333 13.461333 4.501333 22.421333 8.96 4.48 0 8.96 4.501333 4.48 8.96 0 0 0 4.501333-4.48 4.501334-22.421333 22.4-44.8 40.32-67.2 62.698666-4.48 4.48-8.96 13.44-8.96 17.92s4.48 4.48 4.48 8.96c0 4.501333-4.48 4.501333-8.96 8.96-8.96 4.501333-17.92 8.96-22.4 13.461334-4.48 8.96 0 22.4-4.48 31.36-4.48 22.4-17.941333 40.32-26.901333 62.72-8.96 13.418667-13.418667 26.88-22.378667 40.32 0 17.92-4.501333 31.36 4.458667 44.8 22.421333 31.36 62.72 13.44 94.08 26.901333 8.96 4.458667 17.92 4.458667 22.421333 13.418667 13.418667 13.461333 13.418667 35.861333 17.92 49.301333 4.458667 17.92 8.96 35.84 17.92 53.76 4.48 22.421333 13.44 44.821333 17.92 62.72 40.341333-31.36 76.16-67.178667 103.04-112 26.88-31.424 40.341333-67.242667 53.76-103.104" fill="#CDDC39"></path></svg></span></a>
<a href="https://bbs.kanxue.com/thread-266201.htm"target="_blank" rel="external nofollow noopener noreferrer" class="card-link"><span class="cl-backdrop" style="--cl-bg-url: url(/images/fixit.min.svg);"></span>
    <span class="cl-content">
      <span class="cl-text">
        <span class="cl-title">OLLVM虚假控制流源码学习笔记</span>
        <span class="cl-meta">
          <svg class="cl-icon-link" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M574 665.4c-3.1-3.1-8.2-3.1-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8c-3.1-3.1-8.2-3.1-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zM832.6 191.4c-84.6-84.6-221.5-84.6-306 0L410.3 307.6c-3.1 3.1-3.1 8.2 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6c-3.1 3.1-3.1 8.2 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1z" fill="#a9a9b3"></path><path d="M610.1 372.3c-3.1-3.1-8.2-3.1-11.3 0L372.3 598.7c-3.1 3.1-3.1 8.2 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z" fill="#a9a9b3"></path></svg>
          <span class="cl-url">https://bbs.kanxue.com/thread-266201.htm</span>
        </span>
      </span><svg class="cl-shortcut-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M960 512c0 249.408-203.2 448-448 448-244.778667 0-448-198.592-448-448S262.592 64 512 64s448 198.592 448 448" fill="#2196F3"></path><path d="M507.52 718.08c0-8.96-4.48-13.44-13.44-17.92-26.88-8.96-53.76-8.96-76.16-31.381333-4.48-8.96-4.48-17.92-8.96-26.88-8.96-8.96-31.36-13.44-44.8-17.92h-89.6c-13.44-4.48-22.4-22.4-31.36-35.84 0-4.48 0-13.461333-8.96-13.461334-8.96-4.458667-17.92 4.501333-26.88 0-4.48-4.458667-4.48-8.96-4.48-13.418666 0-13.461333 8.96-26.901333 17.92-35.861334 13.44-8.96 26.88 4.48 40.32 4.48 4.48 0 4.48 0 8.96 4.48 13.44 4.48 17.92 22.4 17.92 35.861334v8.96c0 4.48 4.48 4.48 8.96 4.48 4.48-22.4 4.48-44.821333 8.96-67.2 0-26.88 26.88-53.781333 49.28-62.72 8.96-4.458667 13.44 4.501333 22.4 0 26.88-8.96 94.08-35.84 80.64-71.658667-8.96-31.381333-35.84-62.698667-71.68-58.24-8.96 4.501333-13.44 8.96-22.4 13.461333-13.44 8.96-40.32 35.84-53.76 35.84-22.4-4.48-22.4-35.84-17.92-49.301333 4.48-17.92 44.8-76.138667 71.68-67.178667l17.92 17.92c8.96 4.48 22.4 4.48 35.84 4.48 4.48 0 8.96 0 13.44-4.48 4.48-4.48 4.48-4.48 4.48-8.96 0-13.44-13.44-26.901333-22.4-35.861333s-22.4-17.92-35.84-22.378667c-44.8-13.461333-116.48 4.458667-152.32 35.84-35.84 31.36-62.72 85.12-80.64 129.92-8.96 26.88-17.92 62.698667-22.4 94.08-4.48 22.4-8.96 40.32 4.48 62.698667 13.44 26.88 40.32 53.781333 67.2 71.68 17.92 13.44 53.76 13.44 71.68 35.84 13.44 17.941333 8.96 40.32 8.96 62.72 0 26.88 17.92 49.28 26.88 71.658667 4.48 13.461333 8.96 31.381333 13.44 44.821333 0 4.48 4.48 31.36 4.48 35.84 26.88 13.44 49.28 26.901333 80.64 35.861333 4.48 0 22.4-26.901333 22.4-31.381333 13.44-13.44 22.4-31.36 35.84-40.32 8.96-4.48 17.92-8.96 26.88-17.941333 8.96-8.96 13.44-26.88 17.92-40.32 4.48-8.938667 8.96-26.858667 4.48-40.298667M516.48 305.92c4.48 0 8.96-4.48 17.92-8.96 13.44-8.96 26.901333-22.4 40.32-31.36 13.461333-8.96 26.901333-22.4 35.861333-31.36 13.44-8.96 22.4-26.88 26.88-40.341333 4.48-8.96 17.941333-26.88 13.44-40.32-4.48-8.96-26.88-13.44-35.84-17.92C579.2 126.698667 547.84 122.24 512 122.24c-13.44 0-31.36 4.458667-35.84 17.92-4.48 22.4 13.44 17.92 31.36 22.4 0 0 4.48 35.84 4.48 40.32 4.48 22.421333-8.96 35.84-8.96 58.24 0 13.44 0 35.84 8.96 44.8h4.48zM892.8 619.52c4.501333-8.96 4.501333-22.4 8.96-31.36 4.501333-22.421333 4.501333-44.8 4.501333-67.2 0-44.8-4.501333-89.578667-17.92-129.92-8.96-13.44-13.461333-26.88-17.941333-40.341333-8.96-22.378667-22.4-44.8-40.32-62.698667-17.92-22.4-40.341333-85.12-80.64-67.2-13.44 4.501333-22.4 22.421333-31.36 31.381333l-26.88 40.32c-4.501333 4.48-8.96 13.44-4.501333 17.92 0 4.48 4.501333 4.48 8.96 4.48 8.96 4.501333 13.461333 4.501333 22.421333 8.96 4.48 0 8.96 4.501333 4.48 8.96 0 0 0 4.501333-4.48 4.501334-22.421333 22.4-44.8 40.32-67.2 62.698666-4.48 4.48-8.96 13.44-8.96 17.92s4.48 4.48 4.48 8.96c0 4.501333-4.48 4.501333-8.96 8.96-8.96 4.501333-17.92 8.96-22.4 13.461334-4.48 8.96 0 22.4-4.48 31.36-4.48 22.4-17.941333 40.32-26.901333 62.72-8.96 13.418667-13.418667 26.88-22.378667 40.32 0 17.92-4.501333 31.36 4.458667 44.8 22.421333 31.36 62.72 13.44 94.08 26.901333 8.96 4.458667 17.92 4.458667 22.421333 13.418667 13.418667 13.461333 13.418667 35.861333 17.92 49.301333 4.458667 17.92 8.96 35.84 17.92 53.76 4.48 22.421333 13.44 44.821333 17.92 62.72 40.341333-31.36 76.16-67.178667 103.04-112 26.88-31.424 40.341333-67.242667 53.76-103.104" fill="#CDDC39"></path></svg></span></a>
<a href="https://www.52pojie.cn/thread-1538085-1-1.html"target="_blank" rel="external nofollow noopener noreferrer" class="card-link"><span class="cl-backdrop" style="--cl-bg-url: url(/images/fixit.min.svg);"></span>
    <span class="cl-content">
      <span class="cl-text">
        <span class="cl-title">代码混淆技术入门</span>
        <span class="cl-meta">
          <svg class="cl-icon-link" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M574 665.4c-3.1-3.1-8.2-3.1-11.3 0L446.5 781.6c-53.8 53.8-144.6 59.5-204 0-59.5-59.5-53.8-150.2 0-204l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3l-39.8-39.8c-3.1-3.1-8.2-3.1-11.3 0L191.4 526.5c-84.6 84.6-84.6 221.5 0 306s221.5 84.6 306 0l116.2-116.2c3.1-3.1 3.1-8.2 0-11.3L574 665.4zM832.6 191.4c-84.6-84.6-221.5-84.6-306 0L410.3 307.6c-3.1 3.1-3.1 8.2 0 11.3l39.7 39.7c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c53.8-53.8 144.6-59.5 204 0 59.5 59.5 53.8 150.2 0 204L665.3 562.6c-3.1 3.1-3.1 8.2 0 11.3l39.8 39.8c3.1 3.1 8.2 3.1 11.3 0l116.2-116.2c84.5-84.6 84.5-221.5 0-306.1z" fill="#a9a9b3"></path><path d="M610.1 372.3c-3.1-3.1-8.2-3.1-11.3 0L372.3 598.7c-3.1 3.1-3.1 8.2 0 11.3l39.6 39.6c3.1 3.1 8.2 3.1 11.3 0l226.4-226.4c3.1-3.1 3.1-8.2 0-11.3l-39.5-39.6z" fill="#a9a9b3"></path></svg>
          <span class="cl-url">https://www.52pojie.cn/thread-1538085-1-1.html</span>
        </span>
      </span><svg class="cl-shortcut-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="64" height="64"><path d="M960 512c0 249.408-203.2 448-448 448-244.778667 0-448-198.592-448-448S262.592 64 512 64s448 198.592 448 448" fill="#2196F3"></path><path d="M507.52 718.08c0-8.96-4.48-13.44-13.44-17.92-26.88-8.96-53.76-8.96-76.16-31.381333-4.48-8.96-4.48-17.92-8.96-26.88-8.96-8.96-31.36-13.44-44.8-17.92h-89.6c-13.44-4.48-22.4-22.4-31.36-35.84 0-4.48 0-13.461333-8.96-13.461334-8.96-4.458667-17.92 4.501333-26.88 0-4.48-4.458667-4.48-8.96-4.48-13.418666 0-13.461333 8.96-26.901333 17.92-35.861334 13.44-8.96 26.88 4.48 40.32 4.48 4.48 0 4.48 0 8.96 4.48 13.44 4.48 17.92 22.4 17.92 35.861334v8.96c0 4.48 4.48 4.48 8.96 4.48 4.48-22.4 4.48-44.821333 8.96-67.2 0-26.88 26.88-53.781333 49.28-62.72 8.96-4.458667 13.44 4.501333 22.4 0 26.88-8.96 94.08-35.84 80.64-71.658667-8.96-31.381333-35.84-62.698667-71.68-58.24-8.96 4.501333-13.44 8.96-22.4 13.461333-13.44 8.96-40.32 35.84-53.76 35.84-22.4-4.48-22.4-35.84-17.92-49.301333 4.48-17.92 44.8-76.138667 71.68-67.178667l17.92 17.92c8.96 4.48 22.4 4.48 35.84 4.48 4.48 0 8.96 0 13.44-4.48 4.48-4.48 4.48-4.48 4.48-8.96 0-13.44-13.44-26.901333-22.4-35.861333s-22.4-17.92-35.84-22.378667c-44.8-13.461333-116.48 4.458667-152.32 35.84-35.84 31.36-62.72 85.12-80.64 129.92-8.96 26.88-17.92 62.698667-22.4 94.08-4.48 22.4-8.96 40.32 4.48 62.698667 13.44 26.88 40.32 53.781333 67.2 71.68 17.92 13.44 53.76 13.44 71.68 35.84 13.44 17.941333 8.96 40.32 8.96 62.72 0 26.88 17.92 49.28 26.88 71.658667 4.48 13.461333 8.96 31.381333 13.44 44.821333 0 4.48 4.48 31.36 4.48 35.84 26.88 13.44 49.28 26.901333 80.64 35.861333 4.48 0 22.4-26.901333 22.4-31.381333 13.44-13.44 22.4-31.36 35.84-40.32 8.96-4.48 17.92-8.96 26.88-17.941333 8.96-8.96 13.44-26.88 17.92-40.32 4.48-8.938667 8.96-26.858667 4.48-40.298667M516.48 305.92c4.48 0 8.96-4.48 17.92-8.96 13.44-8.96 26.901333-22.4 40.32-31.36 13.461333-8.96 26.901333-22.4 35.861333-31.36 13.44-8.96 22.4-26.88 26.88-40.341333 4.48-8.96 17.941333-26.88 13.44-40.32-4.48-8.96-26.88-13.44-35.84-17.92C579.2 126.698667 547.84 122.24 512 122.24c-13.44 0-31.36 4.458667-35.84 17.92-4.48 22.4 13.44 17.92 31.36 22.4 0 0 4.48 35.84 4.48 40.32 4.48 22.421333-8.96 35.84-8.96 58.24 0 13.44 0 35.84 8.96 44.8h4.48zM892.8 619.52c4.501333-8.96 4.501333-22.4 8.96-31.36 4.501333-22.421333 4.501333-44.8 4.501333-67.2 0-44.8-4.501333-89.578667-17.92-129.92-8.96-13.44-13.461333-26.88-17.941333-40.341333-8.96-22.378667-22.4-44.8-40.32-62.698667-17.92-22.4-40.341333-85.12-80.64-67.2-13.44 4.501333-22.4 22.421333-31.36 31.381333l-26.88 40.32c-4.501333 4.48-8.96 13.44-4.501333 17.92 0 4.48 4.501333 4.48 8.96 4.48 8.96 4.501333 13.461333 4.501333 22.421333 8.96 4.48 0 8.96 4.501333 4.48 8.96 0 0 0 4.501333-4.48 4.501334-22.421333 22.4-44.8 40.32-67.2 62.698666-4.48 4.48-8.96 13.44-8.96 17.92s4.48 4.48 4.48 8.96c0 4.501333-4.48 4.501333-8.96 8.96-8.96 4.501333-17.92 8.96-22.4 13.461334-4.48 8.96 0 22.4-4.48 31.36-4.48 22.4-17.941333 40.32-26.901333 62.72-8.96 13.418667-13.418667 26.88-22.378667 40.32 0 17.92-4.501333 31.36 4.458667 44.8 22.421333 31.36 62.72 13.44 94.08 26.901333 8.96 4.458667 17.92 4.458667 22.421333 13.418667 13.418667 13.461333 13.418667 35.861333 17.92 49.301333 4.458667 17.92 8.96 35.84 17.92 53.76 4.48 22.421333 13.44 44.821333 17.92 62.72 40.341333-31.36 76.16-67.178667 103.04-112 26.88-31.424 40.341333-67.242667 53.76-103.104" fill="#CDDC39"></path></svg></span></a>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-04-19 00:00:00">更新于 2023-04-19&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/llvm/" class="post-tag" title="标签 - LLVM">LLVM</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/llvm/ollvm%E7%A0%94%E7%A9%B6%E4%B9%8Bfla/" class="post-nav-item" rel="prev" title="OLLVM研究之FLA"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>OLLVM研究之FLA</a>
      <a href="/posts/windows%E7%9B%B8%E5%85%B3/net%E7%A8%8B%E5%BA%8Fhook%E7%9A%84%E5%8F%A6%E4%B8%80%E7%A7%8D%E4%BC%98%E9%9B%85%E5%AE%9E%E7%8E%B0/" class="post-nav-item" rel="next" title=".NET程序hook的另一种优雅实现-C&#43;&#43;/CLI">.NET程序hook的另一种优雅实现-C&#43;&#43;/CLI<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">夏洛魂</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{"enable":false},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"version":"v0.3.8-RC"};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
