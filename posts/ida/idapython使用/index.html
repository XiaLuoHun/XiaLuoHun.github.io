<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>IDAPython使用笔记   夏洛魂的个人博客</title><meta name="author" content="夏洛魂">
<meta name="description" content="简介 IDAPython核心有如下3个Python模块: idc:负责提供idc中所有的函数功能. idautils:提供大量的实用函数,其中许多"><meta name="keywords" content='IDA'>
  <meta itemprop="name" content="IDAPython使用笔记">
  <meta itemprop="description" content="简介 IDAPython核心有如下3个Python模块: idc:负责提供idc中所有的函数功能. idautils:提供大量的实用函数,其中许多">
  <meta itemprop="datePublished" content="2021-08-26T00:00:00+00:00">
  <meta itemprop="dateModified" content="2021-08-26T00:00:00+00:00">
  <meta itemprop="wordCount" content="12940">
  <meta itemprop="image" content="https://XiaLuoHun.top/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png">
  <meta itemprop="keywords" content="IDA"><meta property="og:url" content="https://XiaLuoHun.top/posts/ida/idapython%E4%BD%BF%E7%94%A8/">
  <meta property="og:site_name" content="夏洛魂的个人博客">
  <meta property="og:title" content="IDAPython使用笔记">
  <meta property="og:description" content="简介 IDAPython核心有如下3个Python模块: idc:负责提供idc中所有的函数功能. idautils:提供大量的实用函数,其中许多">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-08-26T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-08-26T00:00:00+00:00">
    <meta property="article:tag" content="IDA">
    <meta property="og:image" content="https://XiaLuoHun.top/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://XiaLuoHun.top/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png">
  <meta name="twitter:title" content="IDAPython使用笔记">
  <meta name="twitter:description" content="简介 IDAPython核心有如下3个Python模块: idc:负责提供idc中所有的函数功能. idautils:提供大量的实用函数,其中许多">
<meta name="application-name" content="夏洛魂">
<meta name="apple-mobile-web-app-title" content="夏洛魂"><meta name="theme-color" data-light="#ffffff" data-dark="#ffffff" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" type="text/html" href="https://XiaLuoHun.top/posts/ida/idapython%E4%BD%BF%E7%94%A8/" title="IDAPython使用笔记   夏洛魂的个人博客" /><link rel="prev" type="text/html" href="https://XiaLuoHun.top/posts/windows%E7%9B%B8%E5%85%B3/stl%E5%BA%93%E5%AD%A6%E4%B9%A0/" title="STL库学习" /><link rel="next" type="text/html" href="https://XiaLuoHun.top/posts/android/android%E5%9F%BA%E7%A1%80/arm/" title="Arm指令" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "IDAPython使用笔记",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/XiaLuoHun.top\/posts\/ida\/idapython%E4%BD%BF%E7%94%A8\/"
    },"image": [{
              "@type": "ImageObject",
              "url": "https:\/\/XiaLuoHun.top\/posts\/ida\/idapython%E4%BD%BF%E7%94%A8\/images\/VSCode%E8%B0%83%E8%AF%95.png",
              "width":  723 ,
              "height":  381 
            }],"genre": "posts","keywords": "IDA","wordcount":  12940 ,
    "url": "https:\/\/XiaLuoHun.top\/posts\/ida\/idapython%E4%BD%BF%E7%94%A8\/","datePublished": "2021-08-26T00:00:00+00:00","dateModified": "2021-08-26T00:00:00+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "夏洛魂"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              >标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              >分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/excalidraw/"
                
                
              >在线绘图</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              >关于作者</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="输入关键词搜索" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="夏洛魂的个人博客"><span class="header-title-text">夏洛魂</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="输入关键词搜索" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                >标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                >分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/excalidraw/"
                  
                  
                >在线绘图</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                >关于作者</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>IDAPython使用笔记</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/Luo.png" alt="夏洛魂" data-title="夏洛魂" width="20" height="20" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;夏洛魂</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/ida/" class="post-category" title="分类 - IDA"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> IDA</a></span></div><div class="post-meta-line"><span title="发布于 2021-08-26 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2021-08-26">2021-08-26</time></span>&nbsp;<span title="12940 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 13000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 26 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#配置调试环境">配置调试环境</a></li>
        <li><a href="#配置python代码自动补全">配置Python代码自动补全</a></li>
        <li><a href="#基本操作">基本操作</a></li>
        <li><a href="#段操作">段操作</a></li>
        <li><a href="#函数">函数</a></li>
        <li><a href="#指令">指令</a></li>
        <li><a href="#操作数">操作数</a></li>
        <li><a href="#交叉引用xrefs">交叉引用(Xrefs)</a></li>
        <li><a href="#搜索">搜索</a></li>
        <li><a href="#数据提取">数据提取</a></li>
        <li><a href="#注释和重命名">注释和重命名</a></li>
        <li><a href="#访问原始数据">访问原始数据</a></li>
        <li><a href="#补丁">补丁</a></li>
        <li><a href="#输入输出">输入输出</a></li>
        <li><a href="#批生成文件">批生成文件</a></li>
        <li><a href="#可执行脚本">可执行脚本</a></li>
        <li><a href="#流程图">流程图</a></li>
        <li><a href="#函数栈帧的访问">函数栈帧的访问</a></li>
        <li><a href="#调试">调试</a></li>
        <li><a href="#同类总结参考">同类总结参考</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content" data-end-flag="「依旧是、江涛如许，雨帆烟笛！」"><h2 id="简介" class="heading-element"><span>简介</span>
  <a href="#%e7%ae%80%e4%bb%8b" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>IDAPython核心有如下3个Python模块:</p>
<ul>
<li><strong>idc</strong>:负责提供idc中所有的函数功能.</li>
<li><strong>idautils</strong>:提供大量的实用函数,其中许多函数可生成各种数据库相关对象(如函数或交叉引用)的python列表.</li>
<li><strong>idaapi</strong>:允许使用者通过类的形式,访问更多底层的数据.</li>
</ul>
<p>IDAPython会自动导入idc和idautils模块,idaapi模块需要自己手工导入.
为了使用的清晰性,建议在开头都进行手工的import这三个模块.</p>
<p>注意事项:由于IDAPython的升级,有些之前的函数名发生了变化,新旧关系的对应在文件<strong>idc_bc695.py</strong>,可以进行对照说明.</p>
<h2 id="配置调试环境" class="heading-element"><span>配置调试环境</span>
  <a href="#%e9%85%8d%e7%bd%ae%e8%b0%83%e8%af%95%e7%8e%af%e5%a2%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>配置Python,安装必备的库</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">tornado</span>
</span></span><span class="line"><span class="cl"><span class="n">pip</span> <span class="n">install</span> <span class="n">debugpy</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>配置环境变量</li>
</ol>
<p>修改<strong>PYTHONPATH</strong>环境变量.安装Python时,默认是不会自动进行配置的,所以如果没有的话要先新建一个.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nl">D</span><span class="p">:</span><span class="err">\</span><span class="n">LuoHackTools</span><span class="err">\</span><span class="n">Tools</span><span class="err">\</span><span class="n">Disassemblers</span><span class="err">\</span><span class="n">IDA_Pro_v7</span><span class="mf">.5</span><span class="err">\</span><span class="n">python</span><span class="err">\</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="nl">D</span><span class="p">:</span><span class="err">\</span><span class="n">LuoHackTools</span><span class="err">\</span><span class="n">Tools</span><span class="err">\</span><span class="n">Disassemblers</span><span class="err">\</span><span class="n">IDA_Pro_v7</span><span class="mf">.5</span><span class="err">\</span><span class="n">plugins</span></span></span></code></pre></td></tr></table>
</div>
</div><p>修改ida_idaapi.py文件:</p>
<p>这里我修改的路径为:</p>
<p>D:/LuoHackTools/Tools/Disassemblers/IDA_Pro_v7.5/python/3/ida_idaapi.py</p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9ida_idaapi%E6%96%87%E4%BB%B6.png" alt="修改ida_idaapi文件" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9ida_idaapi%E6%96%87%E4%BB%B6.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9ida_idaapi%E6%96%87%E4%BB%B6.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9ida_idaapi%E6%96%87%E4%BB%B6.png?size=large 2x" data-title="修改ida_idaapi文件" style="--width: 759px;--aspect-ratio: 759 / 136;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol start="3">
<li>配置VSCode</li>
</ol>
<ul>
<li>安装IDACode</li>
</ul>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VS%E5%AE%89%E8%A3%85IDACode.png" alt="VS安装IDACode" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VS%E5%AE%89%E8%A3%85IDACode.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VS%E5%AE%89%E8%A3%85IDACode.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VS%E5%AE%89%E8%A3%85IDACode.png?size=large 2x" data-title="VS安装IDACode" style="--width: 267px;--aspect-ratio: 267 / 234;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ul>
<li>配置IDACode,本机调试,默认即可</li>
</ul>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E9%85%8D%E7%BD%AEIDACode.png" alt="配置IDACode" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E9%85%8D%E7%BD%AEIDACode.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E9%85%8D%E7%BD%AEIDACode.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E9%85%8D%E7%BD%AEIDACode.png?size=large 2x" data-title="配置IDACode" style="--width: 923px;--aspect-ratio: 923 / 645;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol start="4">
<li>配置IDA</li>
</ol>
<ul>
<li>安装IDACode插件</li>
</ul>
<p><a href="https://github.com/ioncodes/idacode/releases"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/ioncodes/idacode/releases</a></p>
<ul>
<li>修改idacode_utils/settings.py文件,将Python路径设置为IDA所用的Python路径</li>
</ul>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9idacode%E6%96%87%E4%BB%B6.png" alt="修改idacode文件" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9idacode%E6%96%87%E4%BB%B6.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9idacode%E6%96%87%E4%BB%B6.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9idacode%E6%96%87%E4%BB%B6.png?size=large 2x" data-title="修改idacode文件" style="--width: 1030px;--aspect-ratio: 1030 / 171;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>此时已经配置好调试环境了,打开IDA,查看输出窗口是否有如下提示,若有则说明成功!</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="p">[</span><span class="n">IDACode</span><span class="p">]</span> <span class="n">Plugin</span> <span class="n">version</span> <span class="mf">0.3.0</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">IDACode</span><span class="p">]</span> <span class="n">Plugin</span> <span class="n">loaded</span><span class="p">,</span> <span class="n">use</span> <span class="n">Edit</span> <span class="o">-&gt;</span> <span class="n">Plugins</span> <span class="o">-&gt;</span> <span class="n">IDACode</span> <span class="n">to</span> <span class="n">start</span> <span class="n">the</span> <span class="n">server</span></span></span></code></pre></td></tr></table>
</div>
</div><p>使用示例:</p>
<p>测试代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Hello IDAPython&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>IDA启用IDACode插件</li>
</ol>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDA%E5%90%AF%E5%8A%A8IDACode%E6%8F%92%E4%BB%B6.png" alt="IDA启动IDACode插件" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDA%E5%90%AF%E5%8A%A8IDACode%E6%8F%92%E4%BB%B6.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDA%E5%90%AF%E5%8A%A8IDACode%E6%8F%92%E4%BB%B6.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDA%E5%90%AF%E5%8A%A8IDACode%E6%8F%92%E4%BB%B6.png?size=large 2x" data-title="IDA启动IDACode插件" style="--width: 756px;--aspect-ratio: 756 / 129;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDACode%E7%9B%91%E5%90%AC.png" alt="IDACode监听" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDACode%E7%9B%91%E5%90%AC.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDACode%E7%9B%91%E5%90%AC.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/IDACode%E7%9B%91%E5%90%AC.png?size=large 2x" data-title="IDACode监听" style="--width: 389px;--aspect-ratio: 389 / 63;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol start="2">
<li>VSCode连接IDA</li>
</ol>
<p>设置工作区:</p>
<p>将Python脚本所在文件夹添加到工作区</p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E5%8C%BA.png" alt="添加工作区" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E5%8C%BA.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E5%8C%BA.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%B7%BB%E5%8A%A0%E5%B7%A5%E4%BD%9C%E5%8C%BA.png?size=large 2x" data-title="添加工作区" style="--width: 353px;--aspect-ratio: 353 / 441;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>连接IDA:</p>
<p>Ctrl + Shift + P, 调出命令窗口</p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%BF%9E%E6%8E%A5IDA.png" alt="VSCode连接IDA" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%BF%9E%E6%8E%A5IDA.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%BF%9E%E6%8E%A5IDA.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%BF%9E%E6%8E%A5IDA.png?size=large 2x" data-title="VSCode连接IDA" style="--width: 708px;--aspect-ratio: 708 / 145;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>调试的话,就选带debugger的.</p>
<p>出错情况应对:</p>
<p>此时VSCode可能会出现两种错误</p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%991.png" alt="VSCode出错1" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%991.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%991.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%991.png?size=large 2x" data-title="VSCode出错1" style="--width: 383px;--aspect-ratio: 383 / 118;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%992.png" alt="VSCode出错2" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%992.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%992.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E5%87%BA%E9%94%992.png?size=large 2x" data-title="VSCode出错2" style="--width: 558px;--aspect-ratio: 558 / 134;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><strong>解决方法如下</strong>:</p>
<p>重启IDA,保证VSCode有且只有一个工作区文件夹.</p>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%9C%89%E4%B8%94%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E6%96%87%E4%BB%B6%E5%A4%B9.png" alt="有且只有一个工作区文件夹" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%9C%89%E4%B8%94%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E6%96%87%E4%BB%B6%E5%A4%B9.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%9C%89%E4%B8%94%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E6%96%87%E4%BB%B6%E5%A4%B9.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E6%9C%89%E4%B8%94%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E6%96%87%E4%BB%B6%E5%A4%B9.png?size=large 2x" data-title="有且只有一个工作区文件夹" style="--width: 630px;--aspect-ratio: 630 / 528;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol start="3">
<li>运行脚本</li>
</ol>
<p>由于插件有保存后直接发送到IDA中运行的功能,所以按下Ctrl+S就能看到脚本被执行.</p>
<ol start="4">
<li>调试</li>
</ol>
<p>由于我们并不是直接在VSCode环境中运行脚本,所以传统方式设置的断点是断不到的,应该采用如下的方式设置断点.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Hello IDAPython&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Befor breakpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">breakpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;After breakpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="mi">10</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png" alt="VSCode调试" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E8%B0%83%E8%AF%95.png?size=large 2x" data-title="VSCode调试" style="--width: 723px;--aspect-ratio: 723 / 381;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">不要将breakpoint放到文件末尾,因为调试的时候,他会断在breakpoint的下条语句.</div>
    </div>
  </div>
<h2 id="配置python代码自动补全" class="heading-element"><span>配置Python代码自动补全</span>
  <a href="#%e9%85%8d%e7%bd%aepython%e4%bb%a3%e7%a0%81%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>VSCode下载<strong>Visual Studio IntelliCode</strong>插件</li>
<li>安装<strong>微软Python语言服务</strong></li>
</ol>
<p>第1步执行完后,当进行编码时,VSCode会自动提醒你安装 微软Python语言服务(不安装的话,每次打开vscode都会提醒你安装),点击 Enable it and Reload Window 按钮,接下来就是比较漫长的等待.</p>
<ol start="3">
<li>打开VSCode的setting.json</li>
</ol>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E7%9A%84setting.png" alt="VSCode的setting" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E7%9A%84setting.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E7%9A%84setting.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/VSCode%E7%9A%84setting.png?size=large 2x" data-title="VSCode的setting" style="--width: 967px;--aspect-ratio: 967 / 591;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol start="4">
<li>修改Setting文件,添加需要自动补全代码的Python文件所在路径.</li>
</ol>
<p><img loading="lazy" src="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9settings%E6%96%87%E4%BB%B6.png" alt="修改settings文件" srcset="/posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9settings%E6%96%87%E4%BB%B6.png?size=small, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9settings%E6%96%87%E4%BB%B6.png?size=medium 1.5x, /posts/ida/idapython%E4%BD%BF%E7%94%A8/images/%E4%BF%AE%E6%94%B9settings%E6%96%87%E4%BB%B6.png?size=large 2x" data-title="修改settings文件" style="--width: 1011px;--aspect-ratio: 1011 / 451;background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>接下来,在VSCode中书写IDAPython代码就会自动补全代码了.</p>
<h2 id="基本操作" class="heading-element"><span>基本操作</span>
  <a href="#%e5%9f%ba%e6%9c%ac%e6%93%8d%e4%bd%9c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>获取当前地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_screen_ea</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取当前地址空间的最小地址和最大地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">MinEA</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">MaxEA</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在ida的反汇编窗口中,下面的每一个信息都可以用函数获取到.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">0043375</span><span class="nf">E</span>                 <span class="no">mov</span>     <span class="no">esi</span><span class="p">,</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;.text&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span> <span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;mov     esi, [eax+0Ch]&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;mov&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">print_operand</span><span class="p">(</span><span class="n">here</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;esi&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">print_operand</span><span class="p">(</span><span class="n">here</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;[eax+0Ch]&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="段操作" class="heading-element"><span>段操作</span>
  <a href="#%e6%ae%b5%e6%93%8d%e4%bd%9c" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>打印一行数据好像并没什么卵用,但是IDAPython的强大之处在于它能遍历所有的指令,
所有的交叉引用地址,还有搜索所有的代码和数据.后面两项功能稍后再做介绍,我们
先从<strong>遍历所有段的指令</strong>开始讲起.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Segments</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">get_segm_name</span><span class="p">(</span><span class="n">seg</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">get_segm_start</span><span class="p">(</span><span class="n">seg</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">get_segm_end</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="函数" class="heading-element"><span>函数</span>
  <a href="#%e5%87%bd%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>遍历所有函数</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">idc</span><span class="o">.</span><span class="n">get_func_name</span><span class="p">(</span><span class="n">func</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Functions()将返回一个保存着已知函数首地址的数组,同样此函数也可以用来查找在指定地址范围的函数列表.</p>
<p>get_func_name(ea)用来获取函数名,ea这个参数可以是处于函数中的任何地址.</p>
<p>idaapi.get_func_qty()获取此binary中识别的函数的个数.</p>
<p>idaapi.getn_func(1)获取第1个函数的对象.</p>
<p><strong>获取函数的边界信息</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">ida_funcs</span><span class="o">.</span><span class="n">func_t</span><span class="p">;</span> <span class="n">proxy</span> <span class="n">of</span> <span class="o">&lt;</span><span class="n">Swig</span> <span class="n">Object</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">&#39;func_t *&#39;</span> <span class="n">at</span> <span class="mh">0x0000026DF330AE40</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">here</span><span class="p">())</span><span class="o">.</span><span class="n">start_ea</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x43371b</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">here</span><span class="p">())</span><span class="o">.</span><span class="n">end_ea</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x4337c4</span></span></span></code></pre></td></tr></table>
</div>
</div><p>同时也可以使用idc.get_next_func(ea)和idc.get_prev_func(ea)获取ea地址的后一个函数和前一个函数,ea 的值需要在被分析的函数地址之内.在枚举函数的时候,只有IDA将这段代码标记为函数的时候才行,不然会在枚举的过程中被跳过.没有被标记为函数的代码将在图例(ida顶部的彩色条)中标为红色.当然我们可以手工的修复这些无法被标记为函数的代码.</p>
<p>还可以使用如下两个api来获取函数的边界地址:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">here</span><span class="p">(),</span> <span class="n">FUNCATTR_START</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x43371b</span>
</span></span><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">here</span><span class="p">(),</span> <span class="n">FUNCATTR_END</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x4337c4</span></span></span></code></pre></td></tr></table>
</div>
</div><p>get_func_attr的第二个参数有如下值:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">FUNCATTR_START</span>   <span class="o">=</span>  <span class="mi">0</span>     <span class="c1"># readonly: function start address</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_END</span>     <span class="o">=</span>  <span class="mi">4</span>     <span class="c1"># readonly: function end address</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_FLAGS</span>   <span class="o">=</span>  <span class="mi">8</span>     <span class="c1"># function flags</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_FRAME</span>   <span class="o">=</span> <span class="mi">16</span>     <span class="c1"># readonly: function frame id</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_FRSIZE</span>  <span class="o">=</span> <span class="mi">20</span>     <span class="c1"># readonly: size of local variables</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_FRREGS</span>  <span class="o">=</span> <span class="mi">24</span>     <span class="c1"># readonly: size of saved registers area</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_ARGSIZE</span> <span class="o">=</span> <span class="mi">28</span>     <span class="c1"># readonly: number of bytes purged from the stack</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_FPD</span>     <span class="o">=</span> <span class="mi">32</span>     <span class="c1"># frame pointer delta</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_COLOR</span>   <span class="o">=</span> <span class="mi">36</span>     <span class="c1"># function color code</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_OWNER</span>   <span class="o">=</span> <span class="mi">16</span>     <span class="c1"># readonly: chunk owner (valid only for tail chunks)</span>
</span></span><span class="line"><span class="cl"><span class="n">FUNCATTR_REFQTY</span>  <span class="o">=</span> <span class="mi">20</span>     <span class="c1"># readonly: number of chunk parents (valid only for tail chunks)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>利用函数名获取一个函数的地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">Python</span><span class="o">&gt;</span><span class="n">idc</span><span class="o">.</span><span class="n">get_name_ea_simple</span><span class="p">(</span><span class="s2">&#34;sub_43371B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x43371b</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>遍历函数的所有指令</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">start</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">(),</span><span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_START</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">end</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">(),</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_END</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">curr_addr</span> <span class="o">=</span> <span class="n">start</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">curr_addr</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">curr_addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span><span class="n">end</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>idc.next_head(curr_addr,end)返回处于curr_addr和end之间的下一条指令的地址,如果没有指令则返回idc.BADADDR.这种方法的一个缺陷是它依赖于指令被包含在函数开始和结束的边界内.打个比方说,函数内有个jmp指令,它跳转到比这个函数结束地址还要高的地址中去,意思是这个函数的所有指令可能并不是线性的,它可能会通过jmp跳出函数边界(起始地址和结束地址),但其实这段指令仍是属于这个函数的,那么我们使用上述的方法就不能够遍历到该函数要执行的所有指令.这种跳转在代码混淆中非常的常见,所以说我们最好还是使用idautils.FuncItems(ea)来循环函数内的指令.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">items</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">item</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取ea地址的上一条指令的地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>关于函数的详细信息有如下几个函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#可在idc_bc695.py中查看</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetFrame</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func_attr</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">FUNCATTR_FRAME</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetFrameLvarSize</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func_attr</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">FUNCATTR_FRSIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetFrameRegsSize</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func_attr</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">FUNCATTR_FRREGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetFrameArgsSize</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func_attr</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">FUNCATTR_ARGSIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">GetFunctionFlags</span><span class="p">(</span><span class="n">ea</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func_attr</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">FUNCATTR_FLAGS</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>例如用如下代码<strong>获取函数的标志</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_NORET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_NORET&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_FAR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_FAR&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_LIB&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_STATIC</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_STATIC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_FRAME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_FRAME&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_USERFAR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_USERFAR&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_HIDDEN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_HIDDEN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_THUNK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_THUNK&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="p">),</span> <span class="s2">&#34;FUNC_BOTTOMBP&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>各种标志的含义如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">FUNC_NORET:</span> <span class="err">这个标志表示某个函数是否有返回值.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_FAR:</span> <span class="err">这个标志非常少的出现,标志程序是否使用分段内存.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_USERFAR:</span> <span class="err">这个标志也非常少见,也很少有文档,</span><span class="nf">HexRays把它描述为</span><span class="err">“</span><span class="no">user</span> <span class="no">has</span> <span class="no">specified</span> <span class="no">far-ness</span> <span class="no">of</span> <span class="no">the</span> <span class="no">function</span><span class="err">”</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_LIB:</span> <span class="err">这个表示用于寻找库函数的代码</span><span class="nf">.识别库函数代码是非常有必要的</span><span class="p">,</span><span class="err">因为我们在分析的</span>
</span></span><span class="line"><span class="cl"><span class="err">时候一般将其跳过</span><span class="nf">.下面的例子展示了如何使用这个标志.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">for</span> <span class="no">func</span> <span class="no">in</span> <span class="no">idautils.Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nf">flags</span> <span class="err">=</span> <span class="no">idc.get_func_attr</span><span class="p">(</span><span class="no">func</span><span class="p">,</span> <span class="no">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">if</span> <span class="no">flags</span> <span class="err">&amp;</span> <span class="no">FUNC_LIB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(</span><span class="no">func</span><span class="p">),</span> <span class="err">&#34;</span><span class="no">FUNC_LIB</span><span class="err">&#34;</span><span class="p">,</span><span class="no">get_func_name</span><span class="p">(</span><span class="no">func</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_STATIC:</span> <span class="err">这个标志作用在于识别该函数在编译的是否是一个静态函数</span><span class="nf">.在C语言中静态函数被默认为是全局的.如果作者把这个函数定义为静态函数</span><span class="p">,</span><span class="err">那么这个函数只能被本文件中的函数访问</span><span class="no">.利用静态函数的判定我们可以更好的理解源代码的结构.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_FRAME:</span> <span class="err">这个标志表示函数是否使用了</span><span class="nf">ebp寄存器</span><span class="p">(</span><span class="err">帧指针</span><span class="p">),</span><span class="err">使用</span><span class="no">ebp寄存器的函数通常有如下的语法设定</span><span class="p">,</span><span class="err">目的是为了保存栈帧</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00404</span><span class="nf">C90</span>                 <span class="no">push</span>    <span class="no">ebp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00404</span><span class="nf">C91</span>                 <span class="no">mov</span>     <span class="no">ebp</span><span class="p">,</span> <span class="no">esp</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00404</span><span class="nf">C96</span>                 <span class="no">sub</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">65</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_BOTTOMBP:</span> <span class="err">和</span> <span class="nf">FUNC_FRAME</span> <span class="err">一样</span><span class="p">,</span><span class="err">该标志用于跟踪帧指针</span><span class="p">(</span><span class="no">ebp</span><span class="p">).</span><span class="err">它作用是识别函数中帧指针是否等于堆栈指针</span><span class="p">(</span><span class="no">esp</span><span class="p">).</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_HIDDEN:</span> <span class="err">带有</span> <span class="nf">FUNC_HIDDEN</span> <span class="err">标志的函数意味着它们是隐藏的</span><span class="p">,</span><span class="err">这个函数需要展开才能查看</span><span class="no">.如果我们跳转到一个标记为</span> <span class="no">HIDDEN</span> <span class="err">的地址的话</span><span class="p">,</span><span class="err">它会自动的展开</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">FUNC_THUNK:</span> <span class="err">表示这个函数是否是一个</span> <span class="nf">thunk</span> <span class="err">函数</span><span class="p">,</span><span class="no">thunk</span> <span class="err">函数表示的是一个简单的跳转函数</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">1</span><span class="nf">A710606</span> <span class="no">Process32Next</span> <span class="no">proc</span> <span class="no">near</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">1</span><span class="nf">A710606</span> <span class="no">jmp</span> <span class="no">ds</span><span class="p">:</span><span class="no">__imp_Process32Next</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">1</span><span class="nf">A710606</span> <span class="no">Process32Next</span> <span class="no">endp</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">需要注意的是一个函数可能拥有多个标志的组合.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="指令" class="heading-element"><span>指令</span>
  <a href="#%e6%8c%87%e4%bb%a4" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>如果我们拥有一个函数中的指令地址,我们可以使用<strong>idautils.FuncItems(ea)<strong>来获</strong>取该函数中所有指令地址的集合</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">items</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">item</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">item</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取ea这个地址所在函数的所有指令的地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#返回一个迭代器</span></span></span></code></pre></td></tr></table>
</div>
</div><p>现在我们已经完全掌握了如何循环遍历程序中的段,函数和指令,那我们就开始 show 一个非常有用的例子.有时候我们会逆向一段加壳的代码,这时知道代码中哪里进行了动态调用对分析是非常有帮助的.一个动态的调用可能是由 call 或者 jmp 加上一个操作数来实现的,比如说 call eax或者 jmp edi.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_THUNK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">dism_addr</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dism_addr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_insn_mnem</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s2">&#34;call&#34;</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">==</span> <span class="s2">&#34;jmp&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">op</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">idc</span><span class="o">.</span><span class="n">o_reg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">line</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">line</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取操作数类型</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">get_operand_type</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#n=0表示第一个操作数,n=1表示第二个操作数.</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取当前指令的下一个指令的地址和上一个指令的地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">prev_head</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="c1">#这两个函数的功能获取的是下一条指令的地址而不是下一个地址</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取下一个地址或者上一个</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">next_addr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">prev_addr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">())</span></span></span></code></pre></td></tr></table>
</div>
</div><p>区别如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005772</span><span class="nf">A9</span>                 <span class="no">add</span>     <span class="no">esi</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005772</span><span class="nf">AC</span>                 <span class="no">cmp</span>     <span class="no">esi</span><span class="p">,</span> <span class="no">offset</span> <span class="no">unk_5D53BC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.next_head</span><span class="p">(</span><span class="mi">0x005772A9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x5772ac</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.next_addr</span><span class="p">(</span><span class="mi">0x005772A9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x5772aa</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="操作数" class="heading-element"><span>操作数</span>
  <a href="#%e6%93%8d%e4%bd%9c%e6%95%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>操作数在逆向分析中经常被使用,所以说了解所有的操作数类型对逆向分析是非常有帮助的.在前面文中提到我们可以使用idc.get_operand_type(ea,n)来获取操作数类型,ea 是一个地址,n 是一个索引.操作数总共有八种不同的类型.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">o_void:</span> <span class="err">如果指令没有任何操作数,它将返回</span> <span class="err">0.</span>
</span></span><span class="line"><span class="cl"><span class="nl">o_reg:</span> <span class="err">如果操作数是寄存器,则返回这种类型,它的值为</span> <span class="err">1.</span>
</span></span><span class="line"><span class="cl"><span class="nl">o_mem:</span> <span class="err">如果操作数是直接寻址的内存,那么返回这种类型,它的值是</span> <span class="err">2,这种类型对寻找</span><span class="nf">DATA的引用非常有帮助.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()),</span> <span class="no">idc.GetDisasm</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x40f576</span> <span class="no">cmp</span>     <span class="no">dword_5D0E44</span><span class="p">,</span> <span class="no">edi</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.GetOpType</span><span class="p">(</span><span class="no">idc.here</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">o_phrase:</span> <span class="err">如果操作数是利用基址寄存器和变址寄存器的寻址操作的话,那么返回该类型,值为3.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()),</span> <span class="no">idc.GetDisasm</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x1000b8c2</span> <span class="no">mov</span> <span class="p">[</span><span class="no">edi</span><span class="err">+</span><span class="no">ecx</span><span class="p">],</span> <span class="no">eax</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.GetOpType</span><span class="p">(</span><span class="no">idc.here</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">o_displ:</span> <span class="err">如果操作数是利用寄存器和位移的寻址操作的话,返回该类型,值为4,位移指的是像如下代码中的</span> <span class="err">0</span><span class="nf">x18</span><span class="p">,</span><span class="err">这在获取结构体中的某个数据是非常常见的</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()),</span> <span class="no">idc.GetDisasm</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x40f6ec</span> <span class="no">mov</span>     <span class="no">ebx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="mi">0</span><span class="no">Ch</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.GetOpType</span><span class="p">(</span><span class="no">idc.here</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">o_imm:</span> <span class="err">如果操作数是一个确定的数值的话,那么返回类型,值为5.</span>
</span></span><span class="line"><span class="cl"><span class="err">-------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">print</span><span class="p">(</span><span class="no">hex</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()),</span> <span class="no">idc.GetDisasm</span><span class="p">(</span><span class="no">idc.here</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">xa05da1</span> <span class="no">add</span> <span class="no">esp</span><span class="p">,</span> <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.GetOpType</span><span class="p">(</span><span class="no">idc.here</span><span class="p">(),</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x5</span>
</span></span><span class="line"><span class="cl"><span class="err">-------------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="nl">o_far:</span> <span class="err">这种返回类型在</span><span class="nf">x86</span> <span class="err">和</span> <span class="no">x86_64的逆向中不常见.它用来判断直接访问远端地址的操作数</span><span class="p">,</span><span class="err">值为</span><span class="mi">6</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="nl">o_near:</span> <span class="err">这种返回类型在</span><span class="nf">x86和x86_64的逆向中不常见.它用来判断直接访问近端地址的操作数</span><span class="p">,</span><span class="err">值为</span><span class="mi">7</span><span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>例1</li>
</ol>
<p>当我们在逆向一个可执行文件的时候,我们可能会注意到一些代码会不断的重复使用某个偏移量.这种操作感觉上是代码在传递某个结构体给不同的函数使用.接下来的这个例子的目的是创建一个python的字典,字典包含了可执行文件中使用的所有偏移量,让偏移量作为字典的key,而每个key对应的value存储着所有使用该偏移量的地址.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">displace</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_THUNK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">dism_addr</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dism_addr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">op</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># 定义结果结构来解析当前的指令</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">insn_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">idaapi</span><span class="o">.</span><span class="n">decode_insn</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">Op1</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">o_displ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">op</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">tmp</span><span class="o">.</span><span class="n">Op2</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">o_displ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">op</span> <span class="o">=</span> <span class="mi">2</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;bp&#34;</span> <span class="ow">in</span>  <span class="n">idc</span><span class="o">.</span><span class="n">print_operand</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;bp&#34;</span> <span class="ow">in</span> <span class="n">idc</span><span class="o">.</span><span class="n">print_operand</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">Op1</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">Op2</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span><span class="mi">1</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">Op1</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">Op2</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">displace</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">hex</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">displace</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>idaapi.decode_insn(tmp,line)是解析指令的另一种底层的方法.</p>
<p>我们已经获取了操作符的字符串表示,那么我们检查操作符中是否包含了“bp”字符串,这是一个快速判断操作符的中寄存器是否为bp,ebp或者rbp的方法.检查”bp”字符串的目的在于确定偏移量是否是一个负数.我们使用idaapi.cmd.Op1.addr来获取偏移量,这个方法会返回一个字符串.然后我们把他转换成为一个 integer类型,如果需要的话把它转换为正数,然后我们把它放进脚本最开始定义的字典display中去.这样就完成了我们的操作,之后如果你想要查找使用某个偏移量的所有地址,直接读取就可以了.</p>
<ol start="2">
<li>例2</li>
</ol>
<p>有时候我们在逆向分析一个可执行文件的内存转储的时候,有些操作数就不是一个偏移量了.看如下代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">push</span> <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nf">push</span> <span class="mi">0</span><span class="no">BC10B8h</span>
</span></span><span class="line"><span class="cl"><span class="nf">push</span> <span class="p">[</span><span class="no">esp</span><span class="err">+</span><span class="mi">10</span><span class="no">h</span><span class="err">+</span><span class="no">arg_0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nf">call</span> <span class="no">ds</span><span class="p">:</span><span class="no">_strnicmp</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第二个被push的值是一个存在内存中的偏移.如果我们通过右键把这个偏移定义为data类型,我们可以看到这个偏移其实是一个字符串,当然完成这个定义操作很简单,但是,有时候这种操作太多了话就需要写一个脚本来自动完成这件事情.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">min</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MIN_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">max</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MAX_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># for each known function</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># skip library &amp; thunk functions</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span> <span class="ow">or</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_THUNK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">dism_addr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">curr_addr</span> <span class="ow">in</span> <span class="n">dism_addr</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> \
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nb">min</span> <span class="o">&lt;</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">idc</span><span class="o">.</span><span class="n">op_plain_offset</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print(hex(curr_addr))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_type</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">min</span> <span class="o">&lt;</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">idc</span><span class="o">.</span><span class="n">op_plain_offset</span><span class="p">(</span><span class="n">curr_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># print( hex(curr_addr) )</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取操作数的值</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_operand_value</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>将操作数转换为一个偏移地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">op_plain_offset</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数一:ea为地址.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数二:n为操作数的索引.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数三:是基地址,该例子中只需要设置为0即可.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="交叉引用xrefs" class="heading-element"><span>交叉引用(Xrefs)</span>
  <a href="#%e4%ba%a4%e5%8f%89%e5%bc%95%e7%94%a8xrefs" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>能够定位data段和code段的交叉引用非常重要,交叉引用的重要性在于它能够提供某个确定的数据或者某个函数被调用的位置.举个例子,如果我们想要知道哪些地址调用了WriteFile()函数,我们所要做的就是在导入表中找到 WriteFile()函数,然后查看其交叉引用即可.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_name_ea_simple</span><span class="p">(</span><span class="s2">&#34;WriteFile&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">i</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取API函数的地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_name_ea_simple</span><span class="p">(</span><span class="s2">&#34;WriteFile&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取该API的所有交叉引用</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">CodeRefsTo</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">flow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数一:ea是我们想要寻找交叉引用的地址.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数二:flow是一个bool值,它用于指定是否遵循正常的代码流.</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但有一点要注意:使用idautils.CodeRefsTo(ea，flow)的限制是,动态导入并手动重命名的API不会
显示为代码交叉引用.比如下面我们利用idc.MakeName(ea,name)将一个dword的地址重命名为&quot;RtlCompareMemory&quot;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">MakeName</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="s2">&#34;RtlCompareMemory&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>IDA并不会将这些API标记为交叉引用代码,稍后我们将会使用一个通用的技术来获得所有的交叉引用.</p>
<p><strong>获取在IDA中任何API和被重命名的函数的相关信息</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">Names</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">#返回一个类型为(ea, str_name)的元组.</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取任意地址所引用的代码</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautisl</span><span class="o">.</span><span class="n">CodeRefsFrom</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">flow</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>下面的例子展示<strong>获取某地址的引用信息</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">CodeRefsFrom</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">i</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>查找数据的交叉引用或者调用</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">DataRefsTo</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#返回该数据地址的所有交叉引用(迭代器)</span>
</span></span><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">DataRefsFrom</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#返回该地址所引用的数据地址</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在查找数据和代码的交叉引用的时候可能会有一些困惑,这里我们使用前面所提到的有一种更加通用的方法来获取交叉引用,该方法调用两个函数就能完成获取所有交叉引用地址和调用地址的效果,这两个函数就是 idautils.XrefsTo(ea,flags=0)和idautils.XrefsFrom(ea,flags=0).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">type</span><span class="p">,</span><span class="n">idautils</span><span class="o">.</span><span class="n">XrefTypeName</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">type</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">frm</span><span class="p">),</span><span class="nb">hex</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">to</span><span class="p">),</span><span class="n">xref</span><span class="o">.</span><span class="n">iscode</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idautils</span><span class="o">.</span><span class="n">XrefsTo</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#idc.ida_xref.XREF_ALL=0 (default)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#idc.ida_xref.XREF_FAR=1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#idc.ida_xref.XREF_DATA=2</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>xref.type</strong>来指明该交叉引用的类型.
idautils.XrefTypeName(xref.t ype)用来打印表示该类型的含义,这其中有十二种不同的类型.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#可在idautils.py文件中查看</span>
</span></span><span class="line"><span class="cl"><span class="n">_ref_types</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_U</span>  <span class="p">:</span> <span class="s1">&#39;Data_Unknown&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">dr_O</span>  <span class="p">:</span> <span class="s1">&#39;Data_Offset&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">dr_W</span>  <span class="p">:</span> <span class="s1">&#39;Data_Write&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">dr_R</span>  <span class="p">:</span> <span class="s1">&#39;Data_Read&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">dr_T</span>  <span class="p">:</span> <span class="s1">&#39;Data_Text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">dr_I</span>  <span class="p">:</span> <span class="s1">&#39;Data_Informational&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_CF</span> <span class="p">:</span> <span class="s1">&#39;Code_Far_Call&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_CN</span> <span class="p">:</span> <span class="s1">&#39;Code_Near_Call&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_JF</span> <span class="p">:</span> <span class="s1">&#39;Code_Far_Jump&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_JN</span> <span class="p">:</span> <span class="s1">&#39;Code_Near_Jump&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mi">20</span>             <span class="p">:</span> <span class="s1">&#39;Code_User&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ida_xref</span><span class="o">.</span><span class="n">fl_F</span>  <span class="p">:</span> <span class="s1">&#39;Ordinary_Flow&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>xref.frm</strong> 打印出该地址的交叉引用.
<strong>xref.to</strong> 打印出该地址本身.
<strong>xref.iscode</strong> 打印出该交叉引用是否在代码段中.
上述的代码我们使用了idautils.XrefsTo(ea, 1)并将其flag位设为了1,如果我们将flag设为0,那么它将会显示该地址的任意交叉引用.设置flag为0获取的交叉引用不只是来自于分支跳转指令,同时还会来自正常的指令流程,设置flag为1可以略过正常指令流程造成的交叉引用.</p>
<h2 id="搜索" class="heading-element"><span>搜索</span>
  <a href="#%e6%90%9c%e7%b4%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>我们其实已经能够通过遍历所有已知的函数及其指令来达到一种基本的搜索效果,这当然很有用,但是有时候我们需要搜索一些特定的字节,比如说 0x55,0x8b,0xec 这种字节序列,这3个字节其实代表的汇编代码为 push ebp, mov ebp, esp.所以我们可以使用idc.find_binary(ea,flag,searchstr,radix=16)来进行字节或者二进制的搜索.
ea代表啥就不说了,flag代表搜索方向或者条件.flag有好几种不同的类型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#可在idc.py中查看</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_UP</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_DOWN</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_NEXT</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_CASE</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_REGEX</span> <span class="o">=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_NOBRK</span> <span class="o">=</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl"><span class="n">SEARCH_NOSHOW</span> <span class="o">=</span> <span class="mi">32</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面的类型不必要都看一遍,但是还是要看看一些常用的类型:</p>
<ul>
<li><strong>SEARCH_UP</strong> 和<strong>SEARCH_DOWN</strong> 用来指明搜索的方向.</li>
<li><strong>SEARCH_NEXT</strong> 用来获取下一个已经找到的对象</li>
<li><strong>SEARCH_CASE</strong> 用来指明是否区分大小写</li>
<li><strong>SEARCH_NOSHOW</strong> 用来指明是否显示搜索的进度</li>
</ul>
<p>searchstr 是我们要查找的内容,radix 参数在写处理器模块时使用,这超出本书要讲解的范围,所以我推荐你去看一看 Chris Eagle 的“The IDA Pro Book”的第 19 章,所以这里我们把radix参数留空.现在让我们来实现刚才提到的那三个字节的搜索好了:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#这是一个错误示例 地址并没有增加</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&#34;55 8B EC&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MIN_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">idc</span><span class="o">.</span><span class="n">SEARCH_DOWN</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">addr</span><span class="o">!=</span> <span class="n">idc</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第一行我们定义了要搜索的形式,搜索形式可以是16进制格式,比如 0x55 0x8B 0xEC和 55 8B EC都是可以的,\x55\x8B\xEC 这种格式可不行,除非你使用idc.find_text(ea, flag,y, x, searchstr)这个函数.</p>
<p>但是我们搜索的时候,地址并没有增长,那是因为我们写程序的时候没有增加SEARCH_NEXT这个标记.正确的写法如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pattern</span> <span class="o">=</span> <span class="s2">&#34;55 8B EC&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MIN_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">find_binary</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">idc</span><span class="o">.</span><span class="n">SEARCH_DOWN</span> <span class="o">|</span> <span class="n">idc</span><span class="o">.</span><span class="n">SEARCH_NEXT</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">addr</span><span class="o">!=</span> <span class="n">idc</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span><span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>搜索字符串</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">find_text</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">searchstr</span><span class="p">,</span> <span class="n">from_bc695</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数一:ea是地址.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数二:flag是搜索方向和搜索类型.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数三:y是从ea开始搜索的行数,通常置0.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数四:x是行中的坐标,通常置0.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数五:searchstr是要搜索的字符串.</span></span></span></code></pre></td></tr></table>
</div>
</div><p>现在我们开始查找字符串“NoRun”的出现的次数.当然你可以换换其他的字符串,可以从字符串窗口(shift+F12)获得.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MIN_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">end</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_inf_attr</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">INF_MAX_EA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">find_text</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">SEARCH_DOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;NoRun&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">idc</span><span class="o">.</span><span class="n">BADADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">idc</span><span class="o">.</span><span class="n">GetDisasm</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">next_head</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>因为我们利用了idc.NextHead(ea)使当前地址不断增长,所以就不需要在idc. FindText()中添加 SEARCH_NEXT的标志.为什么我们要手动的增加地址呢,因为一行字符串中可能出现多次要查找的字符串,往上翻认真阅读 SEARCH_NEXT的标志的意思.</p>
<p><strong>判断一个地址的类型</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#下述这些api返回bool值,true或者false.</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">is_code</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>    <span class="c1"># 判断是否是代码.</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">is_data</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>    <span class="c1"># 判断是否是数据.</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">is_tail</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>    <span class="c1"># 判断 IDA 是否将其判定为尾部.</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">is_unknown</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="c1"># 判断 IDA 是否将其判定为未知,即既不是数据,也不是代码.</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">is_head</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>    <span class="c1"># 判断 IDA 是否将其判定为头部.</span></span></span></code></pre></td></tr></table>
</div>
</div><p>f这个参数是新出现的,相比起于传递地址,我们还要先通过idc.get_full_flags(ea)获取地址的内部标志表示,然后再传给idc.is系列函数当参数,代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ea</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_full_flags</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">isCode</span><span class="p">(</span><span class="n">f</span><span class="p">))</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>寻找被标志为代码的下一个地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">find_code</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上述API我们想要查找数据块的末尾是很有帮助的.如果ea是代码地址,那么上述函数返回下一个代码地址,flag参数看前面的idc.find_text就可以了.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00577821</span>                 <span class="nf">push</span>    <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">00577823</span>                 <span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">offset</span> <span class="no">loc_56B690</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">Python</span><span class="err">&gt;</span><span class="no">idc.find_code</span><span class="p">(</span><span class="mi">0x00577821</span><span class="p">,</span> <span class="no">idc.SEARCH_DOWN</span> <span class="err">|</span> <span class="no">idc.SEARCH_NEXT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x577823</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数会跳过一些数据段的地址,得到最近的一个代码段的首地址.</p>
<p>idc.find_data(ea,flag)和上面的find_code函数差不多,不过它返回的是数据段的地址.</p>
<p>idc.find_unknown(ea,flag)该功能用于查找IDA未识别为代码或数据的字节地址,未知类型需要通过观察或脚本进一步手动分析.</p>
<p>idc.find_defined(ea, flag)它用于查找IDA标识为代码或数据的地址.</p>
<p>idc.find_imm(ea, flag, value)用来寻找立即数.例如:相比于寻找一些类型,我们有些时候其实更希望能够找到特定的值,举个例子,你感觉代码里面肯定是用了 rand()函数来产生随机数的,但是你就是找不到它,咋办? 如果我们知道这个 rand()函数采用了0x343fd作为种子那么我们就可以去寻找这个值.</p>
<h2 id="数据提取" class="heading-element"><span>数据提取</span>
  <a href="#%e6%95%b0%e6%8d%ae%e6%8f%90%e5%8f%96" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><strong>获取用户鼠标选中部分的起始和结束地址</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">read_selection_start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">read_selection_end</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p>注意idc.read_selection_end()获取的的并不是选中部分代码的末尾地址,而是选中部分的最后一条指令的下一条指令的起始地址.</p>
<p>函数idaapi.read_selection()也可以实现上面的效果.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p0</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">twinpos_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">p1</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">twinpos_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">view</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_current_viewer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idaapi</span><span class="o">.</span><span class="n">read_selection</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;start:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">p0</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">view</span><span class="p">)</span><span class="o">.</span><span class="n">ea</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;end:&#34;</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">view</span><span class="p">)</span><span class="o">.</span><span class="n">ea</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1">#注意此处,hex(p1.place(view).ea)是选中部分的最后一条指令的地址</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="注释和重命名" class="heading-element"><span>注释和重命名</span>
  <a href="#%e6%b3%a8%e9%87%8a%e5%92%8c%e9%87%8d%e5%91%bd%e5%90%8d" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>注释一共有两种:</p>
<ul>
<li>常规注释</li>
<li>重复性注释</li>
</ul>
<p>重复性注释会因为某些地址引用了当前地址的内容,而会自动添加上注释.</p>
<p><strong>添加注释</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">set_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>添加重复性注释</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">set_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取常规注释</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取重复性注释</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>函数添加获取注释</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">set_func_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">cmt</span><span class="p">,</span> <span class="n">repeatable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数一:ea可以是函数中的任何地址</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数二:cmt就是我们要添加的注释</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数三:repeatable是否为重复性注释</span>
</span></span><span class="line"><span class="cl"><span class="c1">#将函数的注释标记为可重复性的话,那么它会在任何调用该函数的地方添加注释</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_func_cmt</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">repeatable</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>重命名某个地址的函数</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#可在idc_bc695.py文件中查看</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">MakeName</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">MakeNameEx</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">使用idc.MakeName的话,如果某一个函数名称已经被使用了,那么ida会抛出一个警告的对话.为了跳过该对话框,我们使用idc.MakeNameEx,将flag的值设置为256或者SN_NOWARN即可.</div>
    </div>
  </div>
<h2 id="访问原始数据" class="heading-element"><span>访问原始数据</span>
  <a href="#%e8%ae%bf%e9%97%ae%e5%8e%9f%e5%a7%8b%e6%95%b0%e6%8d%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在逆向工程中获取原始数据是非常重要的,原始数据是16进制的字节,它们被解释为数据或代码,ida中我们可以在反汇编窗口的左侧可以看到这些原始数据.(IDA中显示的设置方法:菜单栏–&gt;选项–&gt;常规–&gt;反汇编–&gt;机器码字节数，填入一个数就ok了–&gt;确定).</p>
<p><strong>获取指定地址数据</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_wide_byte</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>  <span class="c1">#获取1字节</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_wide_word</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>  <span class="c1">#获取2字节</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_wide_dword</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> <span class="c1">#获取4字节</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_qword</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span>      <span class="c1">#获取8字节</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">GetFloat</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">GetDouble</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>获取指定地址指定字节数</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_bytes</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">use_dbg</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#返回bytes类型</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="补丁" class="heading-element"><span>补丁</span>
  <a href="#%e8%a1%a5%e4%b8%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>有时候我们在逆向一个恶意软件的时候,样本会有被加密的字符串.这会阻碍我们分析的过程和阻止我们通过字符串来定位关键点.这种情况下给idb文件打补丁就很有用了.</p>
<p><strong>Patch相关函数</strong>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">patch_byte</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">patch_word</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">patch_dword</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">patch_qword</span><span class="p">(</span><span class="n">ea</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="输入输出" class="heading-element"><span>输入输出</span>
  <a href="#%e8%be%93%e5%85%a5%e8%be%93%e5%87%ba" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在IDAPython中,当我们并不知道文件的位置或者并不知道用户想要把他们的数据存储在什么地方,输入输出文件就很重要了.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ida_kernwin</span><span class="o">.</span><span class="n">ask_file</span><span class="p">(</span><span class="n">for_saving</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数一:forsave 0,打开一个文件对话框;1,打开一个文件保存对话框.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数二:mask用来指定文件后缀或者模式,如:&#34;*.dll&#34;.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#参数三:prompt 窗口的名字.</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="批生成文件" class="heading-element"><span>批生成文件</span>
  <a href="#%e6%89%b9%e7%94%9f%e6%88%90%e6%96%87%e4%bb%b6" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>有时,为目录中的所有文件创建IDB或ASM可能很有用.在分析属于同一系列恶意软件的一组样本时,这可以帮助节省时间,比起手工做这件事情,写一个批处理文件会容易许多,我们只需要将-B 该参数传给 idat.exe即可.下面的代码可以被复制到包含我们想为其生成文件的所有文件的目录中.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">D:/LuoHackTools/Tools/Disassemblers/IDA_Pro_v7.5/idat.exe -B </span></span></code></pre></td></tr></table>
</div>
</div><h2 id="可执行脚本" class="heading-element"><span>可执行脚本</span>
  <a href="#%e5%8f%af%e6%89%a7%e8%a1%8c%e8%84%9a%e6%9c%ac" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>IDAPython脚本可以在命令行中执行,我们也可以使用下面计算IDB拥有指令个数的脚本,然后将其个数写进一个叫做“instru_count.txt”文件中.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">idaapi</span><span class="o">.</span><span class="n">auto_wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">Functions</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_func_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNCATTR_FLAGS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">idc</span><span class="o">.</span><span class="n">FUNC_LIB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">instru</span> <span class="ow">in</span> <span class="n">idautils</span><span class="o">.</span><span class="n">FuncItems</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;instru_count.t&#34;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">writeContent</span> <span class="o">=</span> <span class="s2">&#34;Instruction count is </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">writeContent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writeContent</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">qexit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>上面两个十分重要的函数,一个是<strong>idaapi.auto_wait()</strong>,一个是<strong>idc.qexit(0)</strong>,当ida打开一个文件的时候,等待IDA分析完成是很重要的,因为IDA分析一个文件需要花大量的时间.这时候你不能执行 IDAPython 脚本,所以你可使用idaapi.auto_wait()来等待IDA文件分析结束,它会在IDA分析完成之前一直等待,一旦分析完成,控制权就会交到脚本身上.然后我们同样需要使用idc.qexit(0)来结束脚本的执行,如果不这么做的话,IDB可以会在关闭的时候出问题.</p>
<h2 id="流程图" class="heading-element"><span>流程图</span>
  <a href="#%e6%b5%81%e7%a8%8b%e5%9b%be" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>使用IDAPython生成CFG图.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span> 
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">cls_main</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">FlowChart</span><span class="p">(</span><span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%x</span><span class="s2"> - </span><span class="si">%x</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">]:&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">succ_block</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">succs</span><span class="p">():</span> <span class="c1"># 获取后继节点</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;  succs: </span><span class="si">%x</span><span class="s2"> - </span><span class="si">%x</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">]:&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">succ_block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">succ_block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">,</span> <span class="n">succ_block</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pred_block</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">preds</span><span class="p">():</span> <span class="c1"># 获取前驱节点</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;  preds:</span><span class="si">%x</span><span class="s2"> - </span><span class="si">%x</span><span class="s2"> [</span><span class="si">%d</span><span class="s2">]:&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pred_block</span><span class="o">.</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">pred_block</span><span class="o">.</span><span class="n">end_ea</span><span class="p">,</span> <span class="n">pred_block</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="n">cls_main</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="函数栈帧的访问" class="heading-element"><span>函数栈帧的访问</span>
  <a href="#%e5%87%bd%e6%95%b0%e6%a0%88%e5%b8%a7%e7%9a%84%e8%ae%bf%e9%97%ae" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>在x86程序中,EBP寄存器通常专门用做栈帧指针,例外gun/g++提供 -fomit-frame-pointer编译选项,可以生成不依赖于固定帧指针寄存器的函数.</p>
<p>基于ebp做栈帧指针的函数,正偏移是函数参数,负偏移是则用于访问函数的局部变量.</p>
<p>很明显函数的栈帧是一个运行时的概念,没有栈和运行时的程序,栈帧就不可能存在.话虽如此,但是并不意味者ida在做静态的分析的时候就会忽略掉栈帧的概念.二进制文件中包含配置每个函数栈帧所需的所有代码,通过仔细分析这些代码,我们就可以深入了解任何函数的栈帧结构,即使这个函数并未运行.在IDA中也会有一些复杂的分析来确定IDA反汇编的每个函数的栈帧布局.在分析的过程中,IDA会记住每一次push/pop操作,以及其他的任何可能改变栈指针的运算,如增加或者减去常量,尽可能的去观察栈指针在函数执行时的行为.</p>
<p>IDA提供一个摘要视图,列出了栈帧内被直接引用的每一个变量,以及变量的大小和与它们与帧指针的偏移距离.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="c1">; int __stdcall WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">_WinMain@16</span>     <span class="no">proc</span> <span class="no">near</span>               <span class="c1">; CODE XREF: __scrt_common_main_seh(void)+F3↑p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">var_4</span>           <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span> <span class="p">-</span><span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">hInstance</span>       <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">8</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">hPrevInstance</span>   <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">0</span><span class="no">Ch</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">lpCmdLine</span>       <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">10</span><span class="no">h</span>
</span></span><span class="line"><span class="cl"><span class="nl">.text:</span><span class="err">005680</span><span class="nf">D7</span> <span class="no">nShowCmd</span>        <span class="err">=</span> <span class="no">dword</span> <span class="no">ptr</span>  <span class="mi">14</span><span class="no">h</span></span></span></code></pre></td></tr></table>
</div>
</div><p>idapython也提供获取此函数栈帧的api,获取到之后是一个结构体,操作结构体成员就可以获取到函数栈帧内的所有变量.相关的函数说明如下:</p>
<ul>
<li><strong>idaapi.get_func(ea)</strong>: retrieves the func_t structure for the function at ea.</li>
<li><strong>idaapi.get_frame(func_t foo)</strong>: returns the struct_t structure for the function frame specified by foo.</li>
<li><strong>idautils.DecodeInstruction(ea)</strong>: returns the inst_t representing instruction at ea,和函数idaapi.decode_insn功能相同.</li>
<li><strong>idaapi.get_stkvar(op_t op, sval_t v)</strong>: op is a reference to an instruction, v is the immediate value in the operand. Usually you just use op.addr. It returns a tuple, (member_t, val). member_t is a pointer to the stack variable, which is what we need. val is the same value as the soff field in the member_t for the stack var. More on this later.</li>
<li><strong>idaapi.xreflist_t()</strong>: creates a new xreflist of xreflist_entry_t.</li>
<li><strong>idaapi.build_stkvar_xrefs(xreflist_t xrefs, func_t func, member_t member)</strong>: fills xrefs with xreflist_entry_t‘s that represent the stack var xrefs given by member in func.</li>
<li><strong>struct_t.get_member(x)</strong>: You can use this method to iterate all stack variables in a frame to retrieve all member_t‘s. If you want to build xrefs for all stack variables, this is usually easier.</li>
<li><strong>idc.get_member_name(id, member_offset)</strong>: id is the struct sid，member_offset. get the member name defined in the name.</li>
<li><strong>idc.get_member_offset(id,name)</strong>：Get offset.</li>
</ul>
<p>下面对iautils.DecodeInstruction(ea)指令进行一个简单的说明,这是一个指令解码的API,如果解码失败返回None,否则将返回一个包含该指令及其操作数的指令对象.</p>
<p>比较重要的指令属性如下:</p>
<ul>
<li><strong>inst.itype</strong>:标志当前指令的类型,是一个整数,不同的opcode可能有相同的itype,但是opcode不是itype.</li>
<li><strong>inst.size</strong>:表示解码后的指令长度.</li>
<li><strong>inst.ops[]</strong>:以0为索引的数组,用来保存操作数的相关信息.</li>
<li><strong>inst.Op1&hellip;inst.OpN</strong>:以1位索引起始操作数组别名,和inst.ops[n+1]等价.</li>
<li><strong>inst.ea</strong>:指令的线性地址.</li>
</ul>
<p>你可能会想知道opcode和它的itype之间到底是什么关系.其实很简单,在IDA中,开源数据库处理器模块负责根据opcode来填充itype字段.在IDA SDK中,你可以找到一个allins.hpp的头文件.该头文件包含了所有支持的处理器模块的枚举数据其中包含了受支持的所有指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="c1">// allins.hpp
</span></span></span><span class="line"><span class="cl"><span class="c1">// x86/x64 itypes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">enum</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">NN_null</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1">// Unknown Operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_aaa</span><span class="p">,</span>                 <span class="c1">// ASCII Adjust after Addition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_aad</span><span class="p">,</span>                 <span class="c1">// ASCII Adjust AX before Division
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_aam</span><span class="p">,</span>                 <span class="c1">// ASCII Adjust AX after Multiply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_aas</span><span class="p">,</span>                 <span class="c1">// ASCII Adjust AL after Subtraction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">NN_jz</span><span class="p">,</span>                  <span class="c1">// Jump if Zero (ZF=1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_jmp</span><span class="p">,</span>                 <span class="c1">// Jump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_jmpfi</span><span class="p">,</span>               <span class="c1">// Indirect Far Jump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_jmpni</span><span class="p">,</span>               <span class="c1">// Indirect Near Jump
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_jmpshort</span><span class="p">,</span>            <span class="c1">// Jump Short (not used)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_lahf</span><span class="p">,</span>                <span class="c1">// Load Flags into AH Register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Pentium III Pseudo instructions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_cmpeqps</span><span class="p">,</span>             <span class="c1">// Packed Single-FP Compare EQ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_cmpltps</span><span class="p">,</span>             <span class="c1">// Packed Single-FP Compare LT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_cmpleps</span><span class="p">,</span>             <span class="c1">// Packed Single-FP Compare LE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NN_cmpunordps</span><span class="p">,</span>          <span class="c1">// Packed Single-FP Compare UNORD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不知道为什么,反正NN_前缀用来表示x86/x64处理器上的指令.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># .text:00568113 jz short loc_56812E</span>
</span></span><span class="line"><span class="cl"><span class="n">inst</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">DecodeInstruction</span><span class="p">(</span><span class="mh">0x00568113</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;YES&#34;</span> <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">itype</span> <span class="o">==</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">NN_jz</span> <span class="k">else</span> <span class="s2">&#34;NO&#34;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>至于操作数,可以通过访问inst.Operands[]或者inst.OpN来访问.要获取被解码指令使用的操作数数量不应依赖Operands数组的长度,因为它总是被解析成UA_MAXOP==8（参阅ida.hpp）.因此应该使用遍历每个操作数并检查操作数的类型是否是o_void类型.</p>
<p>操作数的定义是ua.hpp中的op_t结构.</p>
<ul>
<li>
<p><strong>op.flags</strong>：操作数的标志.</p>
</li>
<li>
<p><strong>op.dtype</strong>：操作数的长度类型.idaapi.dt_xxx常量,可以通过该常量来获取操作数的字节大小（1 == idaapi.dt_byte,2 == idaapi.dt_word等等）.</p>
</li>
<li>
<p><strong>op.type</strong>：操作数类型.idc.o_xxx常量.</p>
</li>
<li>
<p><strong>specflags1…specflags4</strong>：处理器相关标志.</p>
</li>
</ul>
<p>以下是受支持的操作数类型(o_xxx):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">o_void</span><span class="err">：没有该操作数</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">o_reg</span><span class="err">：该操作数是寄存器</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">al</span><span class="p">,</span><span class="n">es</span><span class="p">,</span><span class="n">ds等等</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">o_mem</span><span class="err">：直接寻址</span><span class="p">(</span><span class="err">数据</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">o_phrase</span><span class="err">：</span><span class="p">[</span><span class="err">基址</span><span class="o">+</span><span class="err">变址</span><span class="p">]</span><span class="err">寻址</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">o_displ</span><span class="err">：</span><span class="p">[</span><span class="err">基址</span><span class="o">+</span><span class="err">变址</span><span class="o">+</span><span class="err">偏移</span><span class="p">]</span><span class="err">寻址</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">o_imm</span><span class="err">：立即数</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">o_far</span><span class="err">：直接远地址</span><span class="p">(</span><span class="n">far</span> <span class="n">address</span><span class="p">,</span><span class="err">代码</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">o_near</span><span class="err">：直接近地址</span><span class="p">(</span><span class="n">near</span> <span class="n">address</span><span class="p">,</span><span class="err">代码</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">o_dispspec0</span><span class="p">...</span><span class="n">o_dispspec5</span><span class="err">：处理器相关标志</span><span class="p">.</span></span></span></code></pre></td></tr></table>
</div>
</div><p>还有一些操作数成员的含义因操作数的类型而异:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">op_reg</span><span class="err">：寄存器编号</span><span class="p">(</span><span class="n">o_reg</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">op_phrase</span><span class="err">：内存访问中的索引寄存器</span><span class="p">(</span><span class="n">o_phrase</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">op_value</span><span class="err">：立即数（</span><span class="n">o_imm</span><span class="err">）或偏移</span><span class="p">(</span><span class="n">o_displ</span><span class="p">).</span>
</span></span><span class="line"><span class="cl"><span class="n">op_addr</span><span class="err">：操作数使用的内存地址</span><span class="p">(</span><span class="n">o_mem</span><span class="p">,</span><span class="n">o_far</span><span class="p">,</span><span class="n">o_displ</span><span class="p">,</span><span class="n">o_near</span><span class="p">).</span></span></span></code></pre></td></tr></table>
</div>
</div><p>当操作数的类型是o_reg或者o_phrase的时候,op_reg/op_phrase值包含了对应寄存器的枚举值.就像NN_xxx专有标签,IDA SDK同样提供了寄存器的名称常量,以及其对应的值;但是,这只适用于x86/x64处理器模块.我从intel.hpp中摘抄了一部分:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="k">enum</span> <span class="nc">RegNo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_ax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_cx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_dx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_bx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_sp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_bp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_si</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">R_di</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>不幸的是,这些值并没有被IDAPython导出,但是至少我们知道了足够多的信息来定义下边的一些数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="line"><span class="cl"><span class="n">REG_EAX</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">REG_EDX</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">REG_EBP</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">REG_NAMES</span> <span class="o">=</span> <span class="p">{</span> <span class="nl">REG_EAX</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">eax</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">REG_EDX</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">edx</span><span class="err">&#39;</span><span class="p">,</span> <span class="nl">REG_EBP</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">ebp</span><span class="err">&#39;</span> <span class="p">...}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以利用如下代码获取某个函数栈帧的所有成员以及偏移.注意获取的frame不仅包括函数栈帧还包括返回地址以及形参.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">func</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">frame</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">dictMem</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="o">.</span><span class="n">memqty</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_member_name</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">soff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">dictMem</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">idc</span><span class="o">.</span><span class="n">get_member_offset</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">dictMem</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>获得的结果如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;var_4&#39;</span><span class="p">:</span> <span class="s1">&#39;0x0&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39; s&#39;</span><span class="p">:</span> <span class="s1">&#39;0x4&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39; r&#39;</span><span class="p">:</span> <span class="s1">&#39;0x8&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hInstance&#39;</span><span class="p">:</span> <span class="s1">&#39;0xc&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;hPrevInstance&#39;</span><span class="p">:</span> <span class="s1">&#39;0x10&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;lpCmdLine&#39;</span><span class="p">:</span> <span class="s1">&#39;0x14&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="s1">&#39;nShowCmd&#39;</span><span class="p">:</span> <span class="s1">&#39;0x18&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>此偏移都是相对于当前栈帧的栈底(也就是ebp)来说的.注意两个非常重要的成员&rsquo; r&rsquo;和&rsquo; s&rsquo;,其中&rsquo; r&rsquo;代表返回地址存储的偏移,&rsquo; s&rsquo;代表当前函数栈帧中ebp距离esp的位置(也就是函数栈帧的大小).</p>
<p>也可以利用此frame的结构来获取x86中当前函数参数的字节数.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">func</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">frame</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ret_off</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_member_offset</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34; r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">first_arg_off</span> <span class="o">=</span> <span class="n">ret_off</span> <span class="o">+</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">args_size</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">get_struc_size</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">-</span> <span class="n">first_arg_off</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">args_size</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>获取某个函数的某一条指令中引用的函数栈帧变量的名字以及在frame中的偏移,并获取其他地方引用此变量的地址.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 0x00404C90 is the function address</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0x00404CA4 is an instruction address referencing</span>
</span></span><span class="line"><span class="cl"><span class="c1"># a stack variable. It looks like:</span>
</span></span><span class="line"><span class="cl"><span class="c1"># .text:00404CA4  mov     [esp+668h+StackCookie], eax</span>
</span></span><span class="line"><span class="cl"><span class="c1"># .text:00404CBF  mov     ecx, [esp+668h+StackCookie] ; StackCookie</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pFunc</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="mh">0x00404C90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pFrame</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">pFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">inst</span> <span class="o">=</span> <span class="n">idautils</span><span class="o">.</span><span class="n">DecodeInstruction</span><span class="p">(</span><span class="mh">0x00404CA4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">op</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#获取第一个操作数,注意此操作数必须有栈帧变量的引用,否则下条指令会报错</span>
</span></span><span class="line"><span class="cl"><span class="n">pMember</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_stkvar</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span><span class="n">op</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span> <span class="c1"># pMember 是frame结构体中的成员,val是在frame中的偏移量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">xrefs</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">xreflist_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idaapi</span><span class="o">.</span><span class="n">build_stkvar_xrefs</span><span class="p">(</span><span class="n">xrefs</span><span class="p">,</span> <span class="n">pFunc</span><span class="p">,</span> <span class="n">pMember</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">xrefs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">ea</span><span class="p">))</span> <span class="c1">#print xref address</span></span></span></code></pre></td></tr></table>
</div>
</div><p>也可以使用如下代码找具体的某个栈帧变量在函数中的引用.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idc</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idautils</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">idaapi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">addr</span> <span class="o">=</span> <span class="n">idc</span><span class="o">.</span><span class="n">here</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">pFunc</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_func</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">pFrame</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">get_frame</span><span class="p">(</span><span class="n">pFunc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">dictMem</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">pFrame</span><span class="o">.</span><span class="n">memqty</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dictMem</span><span class="p">[</span><span class="n">idc</span><span class="o">.</span><span class="n">get_member_name</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFrame</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFrame</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">soff</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pFrame</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="c1"># given var name you can now use the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># dictionary to grab the member_t to pass</span>
</span></span><span class="line"><span class="cl"><span class="c1"># to build_stkvar_xrefs</span>
</span></span><span class="line"><span class="cl"><span class="n">pMem</span> <span class="o">=</span> <span class="n">dictMem</span><span class="p">[</span><span class="s2">&#34;hInstance&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">xrefs</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">xreflist_t</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">idaapi</span><span class="o">.</span><span class="n">build_stkvar_xrefs</span><span class="p">(</span><span class="n">xrefs</span><span class="p">,</span> <span class="n">pFunc</span><span class="p">,</span> <span class="n">pMem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">xref</span> <span class="ow">in</span> <span class="n">xrefs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">xref</span><span class="o">.</span><span class="n">ea</span><span class="p">))</span>  <span class="c1">#print xrefs to var_4</span></span></span></code></pre></td></tr></table>
</div>
</div><p>程序入口点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 获取入口点个数</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_entry_qty</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 获取入口点地址</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_entry_ordinal</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 入口名</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_entry_name</span><span class="p">(</span><span class="n">ordinal</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="调试" class="heading-element"><span>调试</span>
  <a href="#%e8%b0%83%e8%af%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>安装调试的hook使用如下api:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">debugger</span> <span class="o">=</span> <span class="n">idaapi</span><span class="o">.</span><span class="n">DBG_Hooks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">debugger</span><span class="o">.</span><span class="n">hook</span><span class="p">()</span></span></span></code></pre></td></tr></table>
</div>
</div><p>现在运行调试器,hook会捕捉所有的调试事件,这样就能非常精确的控制IDA调试器.下面的函数在调试的时候非常有用:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 在指定的地点设置软件断点</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">add_bpt</span><span class="p">(</span> <span class="n">long</span> <span class="n">Address</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 返回当前设置的断点数量</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_bpt_qty</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="c1"># 获取寄存器的值,dbg必须处于运行状态</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">get_reg_value</span><span class="p">(</span><span class="n">string</span> <span class="n">Register</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 通过寄存器名获得寄存器值</span>
</span></span><span class="line"><span class="cl"><span class="n">idc</span><span class="o">.</span><span class="n">set_reg_Value</span><span class="p">(</span><span class="n">long</span> <span class="n">Value</span><span class="p">,</span> <span class="n">string</span> <span class="n">Register</span><span class="p">)</span> </span></span></code></pre></td></tr></table>
</div>
</div><h2 id="同类总结参考" class="heading-element"><span>同类总结参考</span>
  <a href="#%e5%90%8c%e7%b1%bb%e6%80%bb%e7%bb%93%e5%8f%82%e8%80%83" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><a href="https://www.52pojie.cn/forum.php?mod=viewthread&amp;tid=1117330&amp;highlight=%D7%DC%BD%E1idapython%D4%DA%C4%E6%CF%F2%D6%D0%B5%C4%D3%A6%D3%C3"target="_blank" rel="external nofollow noopener noreferrer">总结IDAPython在逆向中的应用</a></p>
</div><hr class="awesome-hr" />
    <h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/posts/windows%E7%9B%B8%E5%85%B3/stl%E5%BA%93%E5%AD%A6%E4%B9%A0/" title="STL库学习">STL库学习</a></li></ul><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2021-08-26 00:00:00">更新于 2021-08-26&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"></div>
        <div class="post-info-share">
          <span></span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/ida/" class="post-tag" title="标签 - IDA">IDA</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div><div class="post-nav"><a href="/posts/windows%E7%9B%B8%E5%85%B3/stl%E5%BA%93%E5%AD%A6%E4%B9%A0/" class="post-nav-item" rel="prev" title="STL库学习"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>STL库学习</a>
      <a href="/posts/android/android%E5%9F%BA%E7%A1%80/arm/" class="post-nav-item" rel="next" title="Arm指令">Arm指令<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2020 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">夏洛魂</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;--bg-progress: #0076ff;--bg-progress-dark: #fff;"></div><noscript>
    <div class="noscript-warning">该网站在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/pace/themes/purple/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":200},"comment":{"enable":false},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":true,"fuseIndexURL":"/search.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":1,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"version":"v0.3.11"};</script><script src="/js/theme.min.js" defer></script><script src="/js/custom.min.js" defer></script></body>
</html>
