<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>IDA插件开发 - 夏洛魂的个人博客</title><meta name="Description" content="个人笔记本"><meta property="og:title" content="IDA插件开发" />
<meta property="og:description" content="IDA插件开发 IDASDK 在线帮助文档:https://hex-rays.com/products/ida/support/sdkdoc/index." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://XiaLuoHun.github.io/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/ida/ida%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-08-23T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="IDA插件开发"/>
<meta name="twitter:description" content="IDA插件开发 IDASDK 在线帮助文档:https://hex-rays.com/products/ida/support/sdkdoc/index."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="canonical" href="https://XiaLuoHun.github.io/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/ida/ida%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91/" /><link rel="prev" href="https://XiaLuoHun.github.io/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/x64dbg/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "IDA插件开发",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/XiaLuoHun.github.io\/posts\/%E6%8F%92%E4%BB%B6%E5%8C%BA\/ida\/ida%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91\/"
        },"genre": "posts","keywords": "IDA","wordcount":  12766 ,
        "url": "https:\/\/XiaLuoHun.github.io\/posts\/%E6%8F%92%E4%BB%B6%E5%8C%BA\/ida\/ida%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91\/","datePublished": "2021-08-23T00:00:00+00:00","dateModified": "2021-08-23T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "夏洛魂"},"author": {
                "@type": "Person",
                "name": "夏洛魂"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="夏洛魂的个人博客">主页</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于作者 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="夏洛魂的个人博客">主页</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于作者</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">IDA插件开发</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>夏洛魂</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%8F%92%E4%BB%B6%E5%8C%BA/"><i class="far fa-folder fa-fw"></i>插件区</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-08-23">2021-08-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 12766 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 26 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ida插件开发">IDA插件开发</a>
      <ul>
        <li><a href="#idasdk">IDASDK</a>
          <ul>
            <li><a href="#windows下开发环境配置">Windows下开发环境配置</a>
              <ul>
                <li><a href="#插件模板介绍">插件模板介绍</a></li>
              </ul>
            </li>
            <li><a href="#autohpp-ida自动分析器">auto.hpp IDA自动分析器</a></li>
            <li><a href="#byteshpp-反汇编字节相关">bytes.hpp 反汇编字节相关</a>
              <ul>
                <li><a href="#获取指定地址的数据">获取指定地址的数据</a></li>
                <li><a href="#修改指定地址的数据">修改指定地址的数据</a></li>
                <li><a href="#反汇编窗口添加注释或者获取注释内容">反汇编窗口添加注释或者获取注释内容</a></li>
                <li><a href="#二进制搜索">二进制搜索</a></li>
              </ul>
            </li>
            <li><a href="#文件读写">文件读写</a>
              <ul>
                <li><a href="#获取ida自身相关目录">获取IDA自身相关目录</a></li>
                <li><a href="#读写文件">读写文件</a></li>
              </ul>
            </li>
            <li><a href="#nalthpp-导入函数相关">nalt.hpp 导入函数相关</a>
              <ul>
                <li><a href="#遍历导入函数示例">遍历导入函数示例</a></li>
              </ul>
            </li>
            <li><a href="#entryhpp-导出函数相关">entry.hpp 导出函数相关</a>
              <ul>
                <li><a href="#遍历导出函数示例">遍历导出函数示例</a></li>
              </ul>
            </li>
            <li><a href="#kernwinhpp-注册菜单">kernwin.hpp 注册菜单</a>
              <ul>
                <li><a href="#创建菜单">创建菜单</a></li>
                <li><a href="#注册动作">注册动作</a></li>
                <li><a href="#将动作绑定到菜单上">将动作绑定到菜单上</a></li>
                <li><a href="#注册一个简单的菜单示例">注册一个简单的菜单示例</a></li>
              </ul>
            </li>
            <li><a href="#enumhpp-枚举类型">enum.hpp 枚举类型</a>
              <ul>
                <li><a href="#遍历枚举类型示例">遍历枚举类型示例</a></li>
              </ul>
            </li>
            <li><a href="#funcshpp-函数相关">funcs.hpp 函数相关</a>
              <ul>
                <li><a href="#获取和设置函数的注释">获取和设置函数的注释</a></li>
                <li><a href="#创建新的函数">创建新的函数</a></li>
                <li><a href="#遍历ida中所有的函数示例">遍历IDA中所有的函数示例</a></li>
              </ul>
            </li>
            <li><a href="#kernwinhpp-内核与界面相关">kernwin.hpp 内核与界面相关</a>
              <ul>
                <li><a href="#输出窗口相关">输出窗口相关</a></li>
                <li><a href="#弹框提示信息相关">弹框提示信息相关</a></li>
                <li><a href="#弹出一个等待框或隐藏当前的等待框">弹出一个等待框或隐藏当前的等待框</a></li>
                <li><a href="#获取当前屏幕光标处的地址">获取当前屏幕光标处的地址</a></li>
                <li><a href="#创建一个选择窗口">创建一个选择窗口</a></li>
              </ul>
            </li>
            <li><a href="#namehpp-名称相关">name.hpp 名称相关</a>
              <ul>
                <li><a href="#设置或者删除指定地址处的项目名称">设置或者删除指定地址处的项目名称</a></li>
                <li><a href="#获取指定地址的名称">获取指定地址的名称</a></li>
                <li><a href="#对名称进行解码">对名称进行解码</a></li>
              </ul>
            </li>
            <li><a href="#proh-公共函数">pro.h 公共函数</a>
              <ul>
                <li><a href="#内存相关函数">内存相关函数</a></li>
                <li><a href="#字符串相关函数">字符串相关函数</a></li>
                <li><a href="#改变文本字符串的编码">改变文本字符串的编码</a></li>
              </ul>
            </li>
            <li><a href="#segmenthpp-区段相关">segment.hpp 区段相关</a>
              <ul>
                <li><a href="#遍历程序的区段">遍历程序的区段</a></li>
                <li><a href="#获取线性地址所在的区段">获取线性地址所在的区段</a></li>
              </ul>
            </li>
            <li><a href="#structhpp-结构体类型">struct.hpp 结构体类型</a>
              <ul>
                <li><a href="#创建结构体">创建结构体</a></li>
                <li><a href="#通过结构体的名称来索引到对应的结构体标识符">通过结构体的名称来索引到对应的结构体标识符</a></li>
                <li><a href="#根据结构体标识符来索引到对应的结构体名称">根据结构体标识符来索引到对应的结构体名称</a></li>
                <li><a href="#设置结构体的注释和获取结构体的注释">设置结构体的注释和获取结构体的注释</a></li>
                <li><a href="#通过标识符tid_t索引得到对应的结构体类型信息struc_t">通过标识符tid_t索引得到对应的结构体类型信息struc_t</a></li>
                <li><a href="#获取一个结构体的大小">获取一个结构体的大小</a></li>
                <li><a href="#给结构体添加成员">给结构体添加成员</a></li>
                <li><a href="#设置结构体某个成员的名称">设置结构体某个成员的名称</a></li>
                <li><a href="#设置变量的类型">设置变量的类型</a></li>
                <li><a href="#扩充或者收缩一个结构体">扩充或者收缩一个结构体</a></li>
                <li><a href="#代码示例">代码示例</a>
                  <ul>
                    <li><a href="#创建一个结构体">创建一个结构体</a></li>
                    <li><a href="#遍历一个结构体的成员">遍历一个结构体的成员</a></li>
                    <li><a href="#初始化一个结构体">初始化一个结构体</a></li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><a href="#typeinfhpp-声明类型">typeinf.hpp 声明类型</a>
              <ul>
                <li><a href="#获取ida内部的声明类型库">获取IDA内部的声明类型库</a></li>
                <li><a href="#解析多条声明并将它们存储至声明类型库">解析多条声明,并将它们存储至声明类型库</a></li>
                <li><a href="#导入声明类型至idb中">导入声明类型至IDB中</a></li>
                <li><a href="#修改指定地址的声明">修改指定地址的声明</a></li>
              </ul>
            </li>
            <li><a href="#uahpp-反汇编引擎">ua.hpp 反汇编引擎</a>
              <ul>
                <li><a href="#判断指定地址的字节是否可以被解码为一条有效指令">判断指定地址的字节是否可以被解码为一条有效指令</a></li>
                <li><a href="#对指定地址进行反汇编">对指定地址进行反汇编</a></li>
                <li><a href="#对指定地址的上一条指令进行反汇编">对指定地址的上一条指令进行反汇编</a></li>
                <li><a href="#示例代码">示例代码</a></li>
              </ul>
            </li>
            <li><a href="#xrefhpp-交叉引用">xref.hpp 交叉引用</a>
              <ul>
                <li><a href="#示例代码-1">示例代码</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#hexrays-sdk">HexRays SDK</a>
          <ul>
            <li><a href="#ctree">CTree</a>
              <ul>
                <li><a href="#cfunc_tcfunc_t">cfunc_t:cfunc_t</a></li>
                <li><a href="#cinsn_tcinsn_t">cinsn_t:cinsn_t</a></li>
                <li><a href="#cexpr_tcexpr_t">cexpr_t:cexpr_t</a></li>
                <li><a href="#citem_tcitem_t">citem_t:citem_t</a></li>
                <li><a href="#代码示例-1">代码示例</a></li>
              </ul>
            </li>
            <li><a href="#cfunc">CFunc</a>
              <ul>
                <li><a href="#获取指定位置的ctree-item">获取指定位置的ctree item</a></li>
                <li><a href="#示例代码-2">示例代码</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#idc脚本简介">IDC脚本简介</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="ida插件开发">IDA插件开发</h1>
<h2 id="idasdk">IDASDK</h2>
<p>在线帮助文档:https://hex-rays.com/products/ida/support/sdkdoc/index.html</p>
<h3 id="windows下开发环境配置">Windows下开发环境配置</h3>
<ol>
<li>
<p>建立一个空的Visual Studio项目,添加IDADemo.cpp文件.</p>
</li>
<li>
<p>由于7.0版本以后的IDA插件必须都是64位的,因此编译平台选择x64.</p>
</li>
<li>
<p>进行如下设置</p>
<ol>
<li>
<p>配置属性-&gt;常规:更改&quot;配置类型&quot;为<strong>动态库(.dll)</strong>.</p>
</li>
<li>
<p>配置属性-&gt;VC++目录:在&quot;包含目录&quot;<strong>添加idasdk的include路径</strong>. 如:D:\idasdk75\include</p>
</li>
<li>
<p>配置属性-&gt;VC++目录:在&quot;库目录&quot;<strong>添加idasdk的lib库路径</strong>.</p>
<p>针对ida.exe所写的插件添加D:\idasdk75\lib\x64_win_vc_32,</p>
<p>针对ida64.exe所写的插件添加D:\idasdk75\lib\x64_win_vc_64</p>
</li>
<li>
<p>C/C++ -&gt; 预处理器:<strong>添加NT</strong>.</p>
</li>
<li>
<p>C/C++ -&gt; 代码生成:更改&quot;安全检查&quot;为<strong>禁用安全检查(/GS-)</strong>.</p>
</li>
<li>
<p>链接器 -&gt; 附加依赖项:<strong>添加ida.lib</strong>.</p>
</li>
</ol>
</li>
</ol>
<p>这样一个IDA插件开发环境就搭建好了.</p>
<h4 id="插件模板介绍">插件模板介绍</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">//以上是导入的SDK头文件
</span><span class="c1"></span>
<span class="n">plugmod_t</span><span class="o">*</span> <span class="n">idaapi</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//IDA在启动的时候会调用每个插件的init函数。
</span><span class="c1"></span>	<span class="c1">//返回值有三种选项:
</span><span class="c1"></span>	<span class="c1">//PLUGIN_SKIP适合那些不支持的插件，IDA将不会加载该插件
</span><span class="c1"></span>	<span class="c1">//PLUGIN_OK适合那些执行一次性功能的插件
</span><span class="c1"></span>	<span class="c1">//PLUGIN_KEEP适合那些需要一直保持功能的插件
</span><span class="c1"></span>	<span class="k">return</span> <span class="n">PLUGIN_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">idaapi</span> <span class="nf">term</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//当结束插件时，一般您可以在此添加一点任务清理的代码。
</span><span class="c1"></span>	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//当按下热键时候,执行功能的入口函数
</span><span class="c1"></span>	<span class="n">warning</span><span class="p">(</span><span class="s">&#34;Hello, world!&#34;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">comment</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;This is a test plug-in !&#34;</span><span class="p">;</span>

<span class="n">plugin_t</span> <span class="n">PLUGIN</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">IDP_INTERFACE_VERSION</span><span class="p">,</span>
  <span class="mi">0</span><span class="p">,</span>                    <span class="c1">// 插件的一些属性,一般为0即可
</span><span class="c1"></span>  <span class="n">init</span><span class="p">,</span>                 <span class="c1">// initialize
</span><span class="c1"></span>  <span class="n">term</span><span class="p">,</span>                 <span class="c1">// terminate. this pointer may be NULL.
</span><span class="c1"></span>  <span class="n">run</span><span class="p">,</span>                  <span class="c1">// invoke plugin
</span><span class="c1"></span>  <span class="n">comment</span><span class="p">,</span>              <span class="c1">// 插件的说明,会显示在IDA下方的状态栏中
</span><span class="c1"></span>  <span class="s">&#34;&#34;</span><span class="p">,</span>                   <span class="c1">// multiline help about the plugin
</span><span class="c1"></span>  <span class="s">&#34;Hello, world&#34;</span><span class="p">,</span>		<span class="c1">// 插件在列表中显示的名称
</span><span class="c1"></span>  <span class="s">&#34;Alt-F1&#34;</span>              <span class="c1">// 插件想要注册的功能快捷键
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>当IDA加载文件后,会生成一个idainfo信息,该信息存在于数据库文件中(即IDB文件).</p>
<p>idainfo结构体定义在&lt;ida.hpp&gt;文件中,下面列出一部分值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">idainfo</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>		<span class="c1">//固定为&#39;IDA&#39;
</span><span class="c1"></span>	<span class="kt">char</span> <span class="n">zero</span><span class="p">;</span>		    <span class="c1">//没用
</span><span class="c1"></span>	<span class="n">ushort</span> <span class="n">version</span><span class="p">;</span>		<span class="c1">//数据库版本
</span><span class="c1"></span>	<span class="kt">char</span> <span class="n">procname</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="c1">//当前处理器名称
</span><span class="c1"></span>
	<span class="p">...</span>
	<span class="n">ushort</span> <span class="n">filetype</span><span class="p">;</span>   <span class="c1">// 被反汇编的文件类型,例如f_PE,f_ELF,参考filetype_t
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">startIP</span><span class="p">;</span>	   <span class="c1">// 程序开始运行时,[E]IP寄存器的值
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">startSP</span><span class="p">;</span>	   <span class="c1">// 程序开始运行时,[E]SP寄存器的值
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">main</span><span class="p">;</span>		   <span class="c1">// IDA解析出的主函数入口点的线性地址
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">minEA</span><span class="p">;</span>		   <span class="c1">// 程序的最小线性地址
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">maxEA</span><span class="p">;</span>		   <span class="c1">// 程序的最大线性地址
</span><span class="c1"></span>	<span class="p">...</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>该结构体以全局变量inf的形式定义在&lt;ida.hpp&gt;头文件中,我们可以直接使用.</p>
<p>比方说,我们想要编写的插件,只想处理Intel x86处理器类型下的PE和ELF两种格式的文件,编写以下代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">plugmod_t</span><span class="o">*</span> <span class="n">idaapi</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qstring</span> <span class="n">ProcName</span> <span class="o">=</span> <span class="n">inf</span><span class="p">.</span><span class="n">procname</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ProcName</span> <span class="o">!=</span> <span class="s">&#34;metapc&#34;</span> <span class="o">||</span> <span class="p">(</span><span class="n">inf</span><span class="p">.</span><span class="n">filetype</span> <span class="o">!=</span> <span class="n">f_ELF</span> <span class="o">&amp;&amp;</span> <span class="n">inf</span><span class="p">.</span><span class="n">filetype</span> <span class="o">!=</span> <span class="n">f_PE</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="n">PLUGIN_SKIP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PLUGIN_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这样遇到不符合的文件,插件将不会载入.</p>
<h3 id="autohpp-ida自动分析器">auto.hpp IDA自动分析器</h3>
<p>在<strong>auto.hpp</strong>中,包含了关于IDA自动分析引擎相关的一些函数.
当加载一个新的二进制文件的时候,IDA的自动分析引擎便会开始工作.
IDA的自动分析器包含多个分析队列,每个队列有各自的优先级.当所有的分析队列都为空的时候IDA就会结束自动分析.
通过头文件中提供的接口,我们可以对自动分析器进行一些控制.此接口一般来说用的比较少&hellip;</p>
<p>有的时候我们需要对自动分析引擎的状态进行判断,因为自动分析引擎的结果可能会影响到插件的使用.
这个时候可以使用<strong>auto_is_ok</strong>,该函数作用为判断分析队列是否全部为空.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">auto_is_ok</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>示例代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;auto.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auto_is_ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ask_yn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;The autoanalysis has not finished yet.</span><span class="se">\n</span><span class="s">Do you want to continue?&#34;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//To do...执行功能
</span><span class="c1"></span>	<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[IDADemo]:Test</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>还有一种情况是我们通过其它的API,比如使用add_func在某处汇编代码处生成了函数或者修改了某个导入函数的参数类型,这会使得自动分析队列添加新的分析任务.
这个时候我们想要等待自动分析引擎结束工作后,再执行插件的后续步骤,可以使用如下接口.
该函数的作用是阻塞等待,直到分析队列为空.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">auto_wait</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>由于此函数阻塞后会使得IDA处于假死状态,我们可以在调用该函数前加上一个提示窗,示例代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;auto.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//添加某个函数使得分析队列不为空
</span><span class="c1"></span>    <span class="n">add_func</span><span class="p">(</span><span class="mh">0x405670</span><span class="p">);</span>

    <span class="n">show_wait_box</span><span class="p">(</span><span class="s">&#34;Add some Function&#34;</span><span class="p">);</span>
    <span class="n">auto_wait</span><span class="p">();</span>
    <span class="n">hide_wait_box</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="byteshpp-反汇编字节相关">bytes.hpp 反汇编字节相关</h3>
<p>在<strong>bytes.hpp</strong>中提供的接口代表着IDA对二进制代码反汇编字节分析的一些结果.</p>
<h4 id="获取指定地址的数据">获取指定地址的数据</h4>
<p><strong>get_byte</strong>、<strong>get_word</strong>、<strong>get_dword</strong>等函数.其中<strong>get_bytes</strong>函数用来获取指定大小的连续数据.</p>
<h4 id="修改指定地址的数据">修改指定地址的数据</h4>
<p><strong>patch_byte</strong>、<strong>patch_word</strong>、<strong>patch_dword</strong>等函数.</p>
<h4 id="反汇编窗口添加注释或者获取注释内容">反汇编窗口添加注释或者获取注释内容</h4>
<p><strong>set_cmt</strong>、<strong>append_cmt</strong>、<strong>get_cmt</strong>等函数.</p>
<h4 id="二进制搜索">二进制搜索</h4>
<p><strong>bin_search2</strong>,有两种调用方法,两种方法其实本质是一样的,官方推荐的做法可能是第一种文本模板,文本语法与IDA官方的Alt+B功能相似.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">ea_t</span> <span class="nf">bin_search2</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">start_ea</span><span class="p">,</span><span class="n">ea_t</span> <span class="n">end_ea</span><span class="p">,</span><span class="k">const</span> <span class="n">compiled_binpat_vec_t</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="n">ea_t</span> <span class="nf">bin_search2</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">start_ea</span><span class="p">,</span><span class="n">ea_t</span> <span class="n">end_ea</span><span class="p">,</span><span class="k">const</span> <span class="n">uchar</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span><span class="k">const</span> <span class="n">uchar</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span><span class="n">size_t</span> <span class="n">len</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>使用示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;bytes.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">compiled_binpat_vec_t</span> <span class="n">binPat</span><span class="p">;</span>
	<span class="n">parse_binpat_str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">binPat</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="s">&#34;55 8B EC&#34;</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ea_t</span> <span class="n">SearchStartAddr</span> <span class="o">=</span> <span class="mh">0x401000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">SearchStartAddr</span><span class="o">=</span> <span class="n">bin_search2</span><span class="p">(</span><span class="n">SearchStartAddr</span><span class="p">,</span> <span class="mh">0x500000</span><span class="p">,</span> <span class="n">binPat</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SearchStartAddr</span> <span class="o">==</span> <span class="n">BADADDR</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[SearchResult]:%a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SearchStartAddr</span><span class="p">);</span>
		<span class="n">SearchStartAddr</span> <span class="o">=</span> <span class="n">SearchStartAddr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="文件读写">文件读写</h3>
<p>官方是不建议我们在插件中使用C语言的文件读写接口的.
读写文件相关接口定义在**&lt;diskio.hpp&gt;**和**&lt;fpro.h&gt;**中</p>
<h4 id="获取ida自身相关目录">获取IDA自身相关目录</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ida_export</span> <span class="nf">idadir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">subdir</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>subdir</strong>其实只有固定的选择,有以下几种</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#define CFG_SUBDIR &#34;cfg&#34;
</span><span class="cp">#define IDC_SUBDIR &#34;idc&#34;
</span><span class="cp">#define IDS_SUBDIR &#34;ids&#34;
</span><span class="cp">#define IDP_SUBDIR &#34;procs&#34;
</span><span class="cp">#define LDR_SUBDIR &#34;loaders&#34;
</span><span class="cp">#define SIG_SUBDIR &#34;sig&#34;
</span><span class="cp">#define TIL_SUBDIR &#34;til&#34;
</span><span class="cp">#define PLG_SUBDIR &#34;plugins&#34;
</span><span class="cp">#define THM_SUBDIR &#34;themes&#34;
</span></code></pre></td></tr></table>
</div>
</div><h4 id="读写文件">读写文件</h4>
<p>官方提供了一组几乎和C语言完全一样的接口,供我们读写文件.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">FILE</span><span class="o">*</span>    <span class="nf">qfopen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">);</span>
<span class="n">ssize_t</span>  <span class="nf">qfread</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">);</span>
<span class="n">ssize_t</span>  <span class="nf">qfwrite</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">);</span>
<span class="n">qoff64_t</span> <span class="nf">qftell</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="kt">int</span>      <span class="nf">qfseek</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">qoff64_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whence</span><span class="p">);</span>
<span class="kt">int</span>      <span class="nf">qfclose</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="kt">int</span>      <span class="nf">qflush</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="p">......</span>
</code></pre></td></tr></table>
</div>
</div><p>此外,IDA还封装了一些额外的API供我们使用,毕竟光上面那些根本不够用.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//此函数一般用来逐行读取文本。
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="nf">qgetline</span> <span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="nalthpp-导入函数相关">nalt.hpp 导入函数相关</h3>
<p>在<strong>nalt.hpp</strong>中包含一些与导入函数相关的函数.</p>
<h4 id="遍历导入函数示例">遍历导入函数示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;name.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">enumIMPORTS</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">ea</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">uval_t</span> <span class="n">ord</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qstring</span> <span class="n">FuncName</span><span class="p">;</span>
	<span class="c1">//有时候导入表中只有序号,没有导入函数名称
</span><span class="c1"></span>	<span class="c1">//这个时候可以尝试去获取IDA解析的结果
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">get_ea_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FuncName</span><span class="p">,</span> <span class="n">ea</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">FuncName</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[order--addr--name]:%d--%a--%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ord</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">FuncName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="c1">//函数返回&lt;=0的值,则终止遍历
</span><span class="c1"></span>	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">num</span> <span class="o">=</span> <span class="n">get_import_module_qty</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">qstring</span> <span class="n">Module_Name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_import_module_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Module_Name</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span><span class="c1">//获取模块名称失败
</span><span class="c1"></span>		<span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[Module]:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Module_Name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
		<span class="n">enum_import_names</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">enumIMPORTS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="entryhpp-导出函数相关">entry.hpp 导出函数相关</h3>
<p>IDA内部维护着一组entry point数据,其中每个entry point:</p>
<ul>
<li>有一个地址</li>
<li>有一个名称</li>
<li>可能包含一个序号</li>
</ul>
<p>导出函数被视为entry point,同时程序的执行入口点和TLS回调函数入口也被视为entry point.</p>
<p><strong>entry.hpp</strong>中提供了对entry point列表的一些操作</p>
<h4 id="遍历导出函数示例">遍历导出函数示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;entry.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//获取entry point个数
</span><span class="c1"></span>	<span class="n">size_t</span> <span class="n">entryCount</span> <span class="o">=</span> <span class="n">get_entry_qty</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">entryCount</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//根据下标来获取序号
</span><span class="c1"></span>		<span class="n">uval_t</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_entry_ordinal</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

		<span class="n">ea_t</span> <span class="n">FuncAddr</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
		<span class="n">qstring</span> <span class="n">FuncName</span><span class="p">;</span>
		<span class="n">get_entry_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FuncName</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

		<span class="c1">//根据序号与函数地址是否相等来判断是否为导出函数
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="n">FuncAddr</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[NotExportFunc]:%s--%a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">FuncName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">FuncAddr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[ExportFunc]:%s--%a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">FuncName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">FuncAddr</span><span class="p">);</span>
		<span class="p">}</span>
 	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="kernwinhpp-注册菜单">kernwin.hpp 注册菜单</h3>
<p>注册菜单的相关函数位于<strong>kernwin.hpp</strong>中.
在IDA中,菜单的功能和界面是分离的.比如说我们想创建一个菜单,在点击该菜单后便会执行某个动作,那么我们要做三件事情:</p>
<ol>
<li>创建菜单</li>
<li>注册动作</li>
<li>将动作绑定到对应的菜单上</li>
</ol>
<h4 id="创建菜单">创建菜单</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">create_menu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">menupath</span><span class="o">=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="c1">//参数一:name为菜单在IDA中的内部名称,必须是独一无二的.
</span><span class="c1">//参数二:label为菜单实际显示的名称.
</span><span class="c1">//参数三:menupath用于指示菜单插入的位置,可为空.
</span><span class="c1">//返回为真表示菜单成功.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="注册动作">注册动作</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">register_action</span><span class="p">(</span><span class="k">const</span> <span class="n">action_desc_t</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>其中<strong>参数desc</strong>属于类型<strong>action_desc_t</strong>,是一个用来描述要注册动作的结构体,结构体如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">action_desc_t</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">cb</span><span class="p">;</span>                    <span class="c1">//当前结构体大小
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>          <span class="c1">//动作的内部名称,必须独一无二
</span><span class="c1"></span>                             <span class="c1">//有一个降低名称冲突的好办法是使用
</span><span class="c1"></span>                             <span class="c1">//前后缀的方式命名动作,例如&#34;某某插件:某某动作&#34;
</span><span class="c1"></span>    
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>         <span class="c1">//动作所显示的标签名称,可以包含加速键(例如 &#34;~J~ump&#34;)
</span><span class="c1"></span>  
  <span class="n">action_handler_t</span> <span class="o">*</span><span class="n">handler</span><span class="p">;</span> <span class="c1">//动作处理对象指针，用来管理注册动作的行为
</span><span class="c1"></span>
  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>         <span class="c1">//可为空,参考 ACTION_DESC_LITERAL_PLUGMOD
</span><span class="c1"></span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shortcut</span><span class="p">;</span>      <span class="c1">//额外的快捷键，例如&#34;Ctrl+Enter&#34;
</span><span class="c1"></span>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tooltip</span><span class="p">;</span>       <span class="c1">//额外的提示文本
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">icon</span><span class="p">;</span>                  <span class="c1">//额外的图标ID
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>                 <span class="c1">//参考 ADF_
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中<strong>action_handler_t</strong>这个结构体如下表示,我们需要重写<strong>activate</strong>和<strong>update</strong>这两个函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">action_handler_t</span>
<span class="p">{</span>
  <span class="n">action_handler_t</span><span class="p">(</span><span class="kt">int</span> <span class="n">_f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">flags</span><span class="p">(</span><span class="n">_f</span><span class="p">)</span> <span class="p">{</span> <span class="n">flags</span> <span class="o">|=</span> <span class="n">AHF_VERSION</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">//通过重写这个函数来实现动作的核心行为
</span><span class="c1"></span>  <span class="c1">//返回非0值,则所有的IDA窗口都会刷新
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">int</span> <span class="n">idaapi</span> <span class="nf">activate</span><span class="p">(</span><span class="n">action_activation_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">//更新动作
</span><span class="c1"></span>  <span class="c1">//当界面的上下文环境发生改变,此函数将会被调用.这个时候我们可以更新动作的一些属性(例如标签，图标...)
</span><span class="c1"></span>
  <span class="c1">//另外这个函数还可以通过设置不同的返回值来控制动作功能的开启与关闭
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="n">action_state_t</span> <span class="n">idaapi</span> <span class="nf">update</span><span class="p">(</span><span class="n">action_update_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="将动作绑定到菜单上">将动作绑定到菜单上</h4>
<p>菜单类型有<strong>IDA选项菜单</strong>、<strong>IDA弹出菜单</strong>、<strong>工具栏菜单</strong>三种:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">attach_action_to_menu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">menupath</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">bool</span> <span class="nf">attach_action_to_popup</span><span class="p">(</span><span class="n">TWidget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span><span class="n">TPopupMenu</span> <span class="o">*</span><span class="n">popup_handle</span><span class="p">,</span>
                            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">popuppath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">bool</span> <span class="nf">attach_action_to_toolbar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toolbar_name</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>


<span class="kt">bool</span> <span class="nf">detach_action_from_menu</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">menupath</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="kt">bool</span> <span class="nf">detach_action_from_popup</span><span class="p">(</span><span class="n">TWidget</span> <span class="o">*</span><span class="n">widget</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="kt">bool</span> <span class="nf">detach_action_from_toolbar</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">toolbar_name</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="注册一个简单的菜单示例">注册一个简单的菜单示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">//动作和菜单都需要有一个独一的名称
</span><span class="c1"></span><span class="cp">#define MyActionName &#34;ActionName&#34;
</span><span class="cp">#define MyMenuName &#34;MenuName&#34;
</span><span class="cp"></span>
<span class="k">struct</span> <span class="nc">TestActionHandler</span> <span class="o">:</span><span class="k">public</span> <span class="n">action_handler_t</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">idaapi</span> <span class="nf">activate</span><span class="p">(</span><span class="n">action_activation_ctx_t</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//执行具体的功能
</span><span class="c1"></span>        <span class="n">msg</span><span class="p">(</span><span class="s">&#34;TestActionHandler OK</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">action_state_t</span> <span class="n">idaapi</span> <span class="nf">update</span><span class="p">(</span><span class="n">action_update_ctx_t</span><span class="o">*</span> <span class="n">ctx</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//表示菜单永远可以点击使用
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">AST_ENABLE_ALWAYS</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="k">struct</span> <span class="nc">plugin_ctx_t</span> <span class="o">:</span> <span class="k">public</span> <span class="n">plugmod_t</span>
<span class="p">{</span>
    <span class="n">TestActionHandler</span> <span class="n">MyTestHandler</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="o">~</span><span class="n">plugin_ctx_t</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//卸载插件的时候,把菜单和动作也卸载掉
</span><span class="c1"></span>        <span class="n">detach_action_from_menu</span><span class="p">(</span><span class="s">&#34;MenuLabel/MenuA&#34;</span><span class="p">,</span> <span class="n">MyActionName</span><span class="p">);</span>
        <span class="n">unregister_action</span><span class="p">(</span><span class="n">MyActionName</span><span class="p">);</span>
        <span class="n">delete_menu</span><span class="p">(</span><span class="n">MyMenuName</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">idaapi</span> <span class="n">plugin_ctx_t</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">create_menu</span><span class="p">(</span><span class="n">MyMenuName</span><span class="p">,</span> <span class="s">&#34;MenuLabel&#34;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">action_desc_t</span> <span class="n">Dest</span> <span class="o">=</span> <span class="n">ACTION_DESC_LITERAL</span><span class="p">(</span><span class="n">MyActionName</span><span class="p">,</span> <span class="s">&#34;ActionLabel&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">MyTestHandler</span><span class="p">,</span> <span class="s">&#34;Alt+Q&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">register_action</span><span class="p">(</span><span class="n">Dest</span><span class="p">);</span>
	<span class="n">attach_action_to_menu</span><span class="p">(</span><span class="s">&#34;MenuLabel/MenuA&#34;</span><span class="p">,</span> <span class="n">MyActionName</span><span class="p">,</span> <span class="n">SETMENU_FIRST</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="k">static</span> <span class="n">plugmod_t</span><span class="o">*</span> <span class="n">idaapi</span> <span class="nf">init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="n">plugin_ctx_t</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="n">plugin_t</span> <span class="n">PLUGIN</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">IDP_INTERFACE_VERSION</span><span class="p">,</span>
  <span class="n">PLUGIN_MULTI</span><span class="p">,</span>          <span class="c1">//含有注册菜单功能的插件需要长久留在IDA中,因此和PLUGIN_UNL是冲突的
</span><span class="c1"></span>  <span class="n">init</span><span class="p">,</span>
  <span class="k">nullptr</span><span class="p">,</span>
  <span class="k">nullptr</span><span class="p">,</span>
  <span class="k">nullptr</span><span class="p">,</span>
  <span class="k">nullptr</span><span class="p">,</span>
  <span class="s">&#34;MenuTest&#34;</span><span class="p">,</span>
  <span class="k">nullptr</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="enumhpp-枚举类型">enum.hpp 枚举类型</h3>
<p><strong>enum.hpp</strong>包含了IDA中枚举信息相关的接口.</p>
<p>枚举类型或者位域(bit fields)表示为enum_t,实际上等价于tid_t,代表着一种数据类型的标识符.
IDA内部推测维护着一个枚举类型列表.</p>
<h4 id="遍历枚举类型示例">遍历枚举类型示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;enum.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="nc">MyVisitor</span><span class="o">:</span><span class="k">public</span> <span class="n">enum_member_visitor_t</span>
<span class="p">{</span>
	<span class="c1">//函数返回非0值,代表终止遍历枚举类型
</span><span class="c1"></span>	<span class="k">virtual</span> <span class="kt">int</span> <span class="n">idaapi</span> <span class="nf">visit_enum_member</span><span class="p">(</span><span class="n">const_t</span> <span class="n">cid</span><span class="p">,</span> <span class="n">uval_t</span> <span class="n">value</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">qstring</span> <span class="n">MemberName</span><span class="p">;</span>
		<span class="n">get_enum_member_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MemberName</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;Member:%s----%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">MemberName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//获取enum_t个数
</span><span class="c1"></span>	<span class="n">size_t</span> <span class="n">enumCount</span> <span class="o">=</span> <span class="n">get_enum_qty</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">enumCount</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">enum_t</span> <span class="n">enumId</span> <span class="o">=</span> <span class="n">getn_enum</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

		<span class="n">qstring</span> <span class="n">enumName</span> <span class="o">=</span> <span class="n">get_enum_name</span><span class="p">(</span><span class="n">enumId</span><span class="p">);</span>

		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">enumName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

		<span class="n">MyVisitor</span> <span class="n">EnumVisitor</span><span class="p">;</span>
		<span class="n">for_all_enum_members</span><span class="p">(</span><span class="n">enumId</span><span class="p">,</span> <span class="n">EnumVisitor</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;----</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
 	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="funcshpp-函数相关">funcs.hpp 函数相关</h3>
<p>首先要说明的就是,<strong>funcs.hpp</strong>中所围绕的主体<strong>func_t结构</strong>,指的是IDA主程序在汇编代码级别上提取的信息,这些信息是有限的,而IDA F5插件则是在这些信息基础之上更进一步的语义解析,二者有所不同.</p>
<h4 id="获取和设置函数的注释">获取和设置函数的注释</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">ssize_t</span> <span class="nf">get_func_cmt</span><span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">func_t</span> <span class="o">*</span><span class="n">pfn</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">repeatable</span><span class="p">);</span>
<span class="kt">bool</span> <span class="nf">set_func_cmt</span><span class="p">(</span><span class="k">const</span> <span class="n">func_t</span> <span class="o">*</span><span class="n">pfn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmt</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">repeatable</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建新的函数">创建新的函数</h4>
<p>可以使用如下函数,作用可以参考IDA在某处汇编代码处按下P键创建函数的功能.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">add_func</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">ea1</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">ea2</span><span class="o">=</span><span class="n">BADADDR</span><span class="p">);</span>
<span class="c1">//参数一:ea1为函数的起始地址.
</span><span class="c1">//参数二:ea2为函数的结束地址,如果不填则表示自动探测函数范围.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="遍历ida中所有的函数示例">遍历IDA中所有的函数示例</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;funcs.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">size_t</span> <span class="n">funcCount</span><span class="o">=</span> <span class="n">get_func_qty</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">funcCount</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">func_t</span><span class="o">*</span> <span class="n">pFunc</span> <span class="o">=</span> <span class="n">getn_func</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

		<span class="n">qstring</span> <span class="n">FuncName</span><span class="p">;</span>
		<span class="n">get_func_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FuncName</span><span class="p">,</span> <span class="n">pFunc</span><span class="o">-&gt;</span><span class="n">start_ea</span><span class="p">);</span>

		<span class="c1">//库函数
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">((</span><span class="n">pFunc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FUNC_LIB</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">msg</span><span class="p">(</span><span class="s">&#34;LibFunc:%a--%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pFunc</span><span class="o">-&gt;</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">FuncName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;Func:%a--%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pFunc</span><span class="o">-&gt;</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">FuncName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="kernwinhpp-内核与界面相关">kernwin.hpp 内核与界面相关</h3>
<p><strong>kernwin.hpp</strong>中定义了IDA的内核与界面之间的接口.</p>
<h4 id="输出窗口相关">输出窗口相关</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//清空输出窗口内容
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">msg_clear</span><span class="p">();</span>
<span class="c1">//将输出窗口内容保存到文件中
</span><span class="c1"></span><span class="kt">bool</span> <span class="nf">msg_save</span><span class="p">(</span><span class="n">qstring</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
<span class="c1">//打印格式化文本至输出窗口,类似于printf
</span><span class="c1"></span><span class="kt">int</span> <span class="nf">msg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="弹框提示信息相关">弹框提示信息相关</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//弹出一个错误窗口，然后退出IDA
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
<span class="c1">//弹出一个警告窗口
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">warning</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
<span class="c1">//弹出一个信息窗口
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">info</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="弹出一个等待框或隐藏当前的等待框">弹出一个等待框或隐藏当前的等待框</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">void</span> <span class="nf">show_wait_box</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="kt">void</span> <span class="nf">hide_wait_box</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>需要注意的是</strong>,如果多次调用show_wait_box函数,那么IDA会将当前文本存储到堆栈中然后显示出新的文本,因此show_wait_box和hide_wait_box函数必须成对出现,否则弹出的等待框会使得IDA界面无法进行任何交互.</p>
<p>跳转函数如下,其余的可选参数基本没什么用&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#define 	UIJMP_ACTIVATE   0x0001
</span><span class="cp">#define 	UIJMP_DONTPUSH   0x0002
</span><span class="cp">#define 	UIJMP_IDAVIEW    0x0004
</span><span class="cp"></span><span class="kt">bool</span> <span class="nf">jumpto</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">ea</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opnum</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uijmp_flags</span><span class="o">=</span><span class="n">UIJMP_ACTIVATE</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="获取当前屏幕光标处的地址">获取当前屏幕光标处的地址</h4>
<p>这个函数也算是一个交互函数吧,比如可以用来获取用户指向的代码/数据位置.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">ea_t</span> <span class="nf">get_screen_ea</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="创建一个选择窗口">创建一个选择窗口</h4>
<p>可以使用choose函数,可以参考官方的choose.cpp示例,这里只介绍一些关键点</p>
<ul>
<li>我们需要自定义一个结构体,然后继承chooser_t.</li>
<li>重写类chooser_t的get_count函数,用来设置所显示列表的行数.</li>
<li>重写类chooser_t的get_row函数,用来输出每一行内容.</li>
<li>(可选)重写类chooser_t的enter函数,用来设置双击选项执行的动作.</li>
<li>申请chooser结构体变量必须使用new来创建,关闭选择窗口内存会自动释放.</li>
</ul>
<h3 id="namehpp-名称相关">name.hpp 名称相关</h3>
<p><strong>name.hpp</strong>中包含一些用于处理名称的函数.</p>
<h4 id="设置或者删除指定地址处的项目名称">设置或者删除指定地址处的项目名称</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">set_name</span> <span class="p">(</span><span class="n">ea_t</span> <span class="n">ea</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//参数一:为线性地址.
</span><span class="c1">//参数二:为设置的新名称,如果为&#34;&#34;,则表示删除名称.
</span><span class="c1">//返回真表示函数执行成功.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="获取指定地址的名称">获取指定地址的名称</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">ssize_t</span> <span class="nf">get_ea_name</span> <span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">ea</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gtn_flags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">getname_info_t</span> <span class="o">*</span><span class="n">gtni</span><span class="o">=</span><span class="nb">NULL</span><span class="p">);</span>
<span class="c1">//参数一:用于接收返回的名称.
</span><span class="c1">//参数二:为指定的地址.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="对名称进行解码">对名称进行解码</h4>
<p>此函数一般用来解码C++的符号</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">qstring</span> <span class="nf">demangle_name</span><span class="p">(</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
        <span class="n">uint32</span> <span class="n">disable_mask</span><span class="p">,</span>
        <span class="n">demreq_type_t</span> <span class="n">demreq</span><span class="o">=</span><span class="n">DQT_FULL</span><span class="p">)</span>
<span class="n">int32</span> <span class="n">demangle_name</span><span class="p">(</span>
        <span class="n">qstring</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
        <span class="n">uint32</span> <span class="n">disable_mask</span><span class="p">,</span>
        <span class="n">demreq_type_t</span> <span class="n">demreq</span><span class="o">=</span><span class="n">DQT_FULL</span><span class="p">);</span>
<span class="c1">//参数一:name是解码的文本.
</span><span class="c1">//参数二:disable_mask是解码的一些选项，和IDA主程序Options-&gt;Demangled names里面的选项差不多.
</span><span class="c1">//参数三:demreq是想要得到的解码结果.
</span></code></pre></td></tr></table>
</div>
</div><h3 id="proh-公共函数">pro.h 公共函数</h3>
<p><strong>pro.h</strong>是IDA工程中被包含的第一个头文件.
此接口定义了最通用的一些类型,函数和数据.</p>
<h4 id="内存相关函数">内存相关函数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//malloc
</span><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">qalloc</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="c1">//realloc
</span><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">qrealloc</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">alloc</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">newsize</span><span class="p">);</span>
<span class="c1">//calloc
</span><span class="c1"></span><span class="kt">void</span><span class="o">*</span> <span class="nf">qcalloc</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">nitems</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">itemsize</span><span class="p">);</span>
<span class="c1">//free
</span><span class="c1"></span><span class="kt">void</span>  <span class="nf">qfree</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">alloc</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="字符串相关函数">字符串相关函数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">char</span><span class="o">*</span> <span class="nf">qstrncpy</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">dstsize</span><span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">qstpncpy</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">dstsize</span><span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">qstrncat</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">dstsize</span><span class="p">);</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">qstrtok</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">save_ptr</span><span class="p">);</span>
<span class="kt">int</span>   <span class="nf">qsnprintf</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
<span class="kt">int</span>   <span class="nf">qsscanf</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,...);</span>
</code></pre></td></tr></table>
</div>
</div><p>IDA还重新实现了STL模板库里面的一些类,例如</p>
<p><strong>qstring</strong>、<strong>qvector</strong>、<strong>qlist</strong>、<strong>qstack</strong>,大多数情况下是可以替代STL库的,在无法满足我们需求的情况下可以使用STL库,例如IDA没有提供std::map模板类.</p>
<h4 id="改变文本字符串的编码">改变文本字符串的编码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">change_codepage</span><span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span><span class="kt">int</span> <span class="n">incp</span><span class="p">,</span><span class="kt">int</span> <span class="n">outcp</span><span class="p">);</span>
<span class="c1">//参数一:out为返回的文本内容结果.
</span><span class="c1">//参数二:in为输入的文本内容.
</span><span class="c1">//参数三:incp为输入的文本的编码.
</span><span class="c1">//参数四:outcp为输出的文本的编码.
</span><span class="c1">//返回值表示转换是否成功.
</span></code></pre></td></tr></table>
</div>
</div><p>IDA特意为我们封装了一个ASCII转换为UTF8的函数,如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">acp_utf8</span><span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">change_codepage</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">CP_ACP</span><span class="p">,</span> <span class="n">CP_UTF8</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为在IDA中显示在界面上的文本是基于UTF8的,因此如果我们想要在IDA的界面上显示中文,需使用此函数将ASCII文本转换为UTF8编码.</p>
<h3 id="segmenthpp-区段相关">segment.hpp 区段相关</h3>
<p><strong>segment.hpp</strong>包含用来处理程序区段的一些函数.</p>
<h4 id="遍历程序的区段">遍历程序的区段</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;segment.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//获取区段个数
</span><span class="c1"></span>	<span class="kt">int</span> <span class="n">segCount</span> <span class="o">=</span> <span class="n">get_segm_qty</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">segCount</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//根据区段索引来获取区段结构体
</span><span class="c1"></span>		<span class="n">segment_t</span><span class="o">*</span> <span class="n">pSegment</span> <span class="o">=</span> <span class="n">getnseg</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		
		<span class="c1">//获取区段名称
</span><span class="c1"></span>		<span class="n">qstring</span> <span class="n">SectionName</span><span class="p">;</span>
		<span class="n">get_segm_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SectionName</span><span class="p">,</span> <span class="n">pSegment</span><span class="p">);</span>

		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;segment:%s from %a to %a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SectionName</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">pSegment</span><span class="o">-&gt;</span><span class="n">start_ea</span><span class="p">,</span> <span class="n">pSegment</span><span class="o">-&gt;</span><span class="n">end_ea</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="获取线性地址所在的区段">获取线性地址所在的区段</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">segment_t</span><span class="o">*</span> <span class="nf">getseg</span><span class="p">(</span><span class="n">ea_t</span> <span class="n">ea</span><span class="p">);</span>
<span class="c1">//参数一:ea为程序中的任何一个线性地址,返回线性地址所在区段的结构体指针.
</span></code></pre></td></tr></table>
</div>
</div><h3 id="structhpp-结构体类型">struct.hpp 结构体类型</h3>
<p>IDA内部维护着一个结构体列表,IDA中的Structures窗口可以看到结构体列表的信息.</p>
<h4 id="创建结构体">创建结构体</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">tid_t</span> <span class="nf">add_struc</span><span class="p">(</span><span class="n">uval_t</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_union</span><span class="o">=</span><span class="nb">false</span><span class="p">);</span>
<span class="c1">//参数一:idx为结构体的索引,代表所插入的结构体在IDA存储的列表中的顺序,如果idx为-1,表示添加结构体到列表末尾.
</span><span class="c1">//参数二:name为结构体的名称,不能为不合法名称,也不可以与数据库已有的名称重复.
</span><span class="c1">//返回值tid_t实际上就是个整数,用于标识唯一的结构体类型.如果返回-1,代表创建结构体失败.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="通过结构体的名称来索引到对应的结构体标识符">通过结构体的名称来索引到对应的结构体标识符</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">tid_t</span> <span class="nf">get_struc_id</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="根据结构体标识符来索引到对应的结构体名称">根据结构体标识符来索引到对应的结构体名称</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">qstring</span> <span class="nf">get_struc_name</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">id</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="设置结构体的注释和获取结构体的注释">设置结构体的注释和获取结构体的注释</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">set_struc_cmt</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmt</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">repeatable</span><span class="p">);</span>
<span class="n">ssize_t</span> <span class="nf">get_struc_cmt</span><span class="p">(</span><span class="n">qstring</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">tid_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">repeatable</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="通过标识符tid_t索引得到对应的结构体类型信息struc_t">通过标识符tid_t索引得到对应的结构体类型信息struc_t</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">struc_t</span><span class="o">*</span> <span class="nf">get_struc</span><span class="p">(</span><span class="n">tid_t</span> <span class="n">id</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="获取一个结构体的大小">获取一个结构体的大小</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">asize_t</span> <span class="nf">get_struc_size</span> <span class="p">(</span><span class="k">const</span> <span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">);</span>
<span class="n">asize_t</span> <span class="nf">get_struc_size</span> <span class="p">(</span><span class="n">tid_t</span> <span class="n">id</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="给结构体添加成员">给结构体添加成员</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">struc_error_t</span>  <span class="nf">add_struc_member</span><span class="p">(</span>
        <span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fieldname</span><span class="p">,</span>
        <span class="n">ea_t</span> <span class="n">offset</span><span class="p">,</span>
        <span class="n">flags_t</span> <span class="n">flag</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">opinfo_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span>
        <span class="n">asize_t</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="c1">//参数一:sptr为要添加成员的结构体.
</span><span class="c1">//参数二:fieldname为要添加的成员名称.
</span><span class="c1">//参数三:offset为要添加的成员在结构体中的偏移.
</span><span class="c1">//参数四:flag为结构体的类型标记,可在bytes.hpp中找到如下定义
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">byte_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>     <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_BYTE</span><span class="p">;</span> <span class="p">}</span>      <span class="c1">///&lt; Get a flags_t representing a byte
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">word_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>     <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_WORD</span><span class="p">;</span> <span class="p">}</span>      <span class="c1">///&lt; Get a flags_t representing a word
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">dword_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_DWORD</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a double word
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">qword_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_QWORD</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a quad word
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">oword_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_OWORD</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a octaword
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">yword_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_YWORD</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a ymm word
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">zword_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_ZWORD</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a zmm word
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">tbyte_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_TBYTE</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a tbyte
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">strlit_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>   <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_STRLIT</span><span class="p">;</span> <span class="p">}</span>    <span class="c1">///&lt; Get a flags_t representing a string literal
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">stru_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>     <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_STRUCT</span><span class="p">;</span> <span class="p">}</span>    <span class="c1">///&lt; Get a flags_t representing a struct
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">cust_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>     <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_CUSTOM</span><span class="p">;</span> <span class="p">}</span>    <span class="c1">///&lt; Get a flags_t representing custom type data
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">align_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_ALIGN</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing an alignment directive
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">float_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>    <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_FLOAT</span><span class="p">;</span> <span class="p">}</span>     <span class="c1">///&lt; Get a flags_t representing a float
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">double_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>   <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_DOUBLE</span><span class="p">;</span> <span class="p">}</span>    <span class="c1">///&lt; Get a flags_t representing a double
</span><span class="c1"></span><span class="n">flags_t</span> <span class="n">idaapi</span> <span class="nf">packreal_flag</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">FF_DATA</span><span class="o">|</span><span class="n">FF_PACKREAL</span><span class="p">;</span> <span class="p">}</span>  <span class="c1">///&lt; Get a flags_t representing a packed decimal real
</span><span class="c1"></span>
<span class="c1">//参数五:mt为要添加的成员类型的额外信息,只有当成员类型为结构体、偏移、枚举、字符串、结构体偏移以上一种时有效.
</span><span class="c1">//参数六:nbytes为要添加的成员的大小,大小必须和flag对应,例如当参数flag填dword_flag()时,nbytes应该填4.当填0的时候,该成员会表示成一个变量结构体(即大小不确定).
</span></code></pre></td></tr></table>
</div>
</div><h4 id="设置结构体某个成员的名称">设置结构体某个成员的名称</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">set_member_name</span><span class="p">(</span><span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">offset</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="c1">//参数一:sptr为要目标成员的结构体.
</span><span class="c1">//参数二:offset为目标成员所处在结构体的偏移大小.
</span><span class="c1">//参数三:name为目标成员要设置的名称.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="设置变量的类型">设置变量的类型</h4>
<p>该函数可用于设置成员为一些基础类型(byte,word,dword&hellip;),参数和add_struc_member差不多</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">set_member_type</span><span class="p">(</span><span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">flags_t</span> <span class="n">flag</span><span class="p">,</span><span class="k">const</span> <span class="n">opinfo_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span> <span class="n">asize_t</span> <span class="n">nbytes</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>如果要<strong>将结构体成员设置为类型库中的其它类型</strong>,可使用以下函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">smt_code_t</span> <span class="nf">set_member_tinfo</span><span class="p">(</span>
        <span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span>
        <span class="n">member_t</span> <span class="o">*</span><span class="n">mptr</span><span class="p">,</span>
        <span class="n">uval_t</span> <span class="n">memoff</span><span class="p">,</span>
        <span class="k">const</span> <span class="n">tinfo_t</span> <span class="o">&amp;</span><span class="n">tif</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="c1">//参数一:sptr为成员所在的结构体.
</span><span class="c1">//参数二:mptr为目标成员.
</span><span class="c1">//参数三:memoff成员内部的偏移.
</span><span class="c1">//参数四:tif为要设置的成员类型.
</span><span class="c1">//参数五:flags为设置的一些参数,有如下选择
</span><span class="c1"></span><span class="cp">#define SET_MEMTI_MAY_DESTROY 0x0001 </span><span class="c1">///&lt; may destroy other members
</span><span class="c1"></span><span class="cp">#define SET_MEMTI_COMPATIBLE  0x0002 </span><span class="c1">///&lt; new type must be compatible with the old
</span><span class="c1"></span><span class="cp">#define SET_MEMTI_FUNCARG     0x0004 </span><span class="c1">///&lt; mptr is function argument (can not create arrays)
</span><span class="c1"></span><span class="cp">#define SET_MEMTI_BYTIL       0x0008 </span><span class="c1">///&lt; new type was created by the type subsystem
</span><span class="c1"></span><span class="cp">#define SET_MEMTI_USERTI      0x0010 </span><span class="c1">///&lt; user-specified type
</span></code></pre></td></tr></table>
</div>
</div><h4 id="扩充或者收缩一个结构体">扩充或者收缩一个结构体</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">expand_struc</span><span class="p">(</span><span class="n">struc_t</span> <span class="o">*</span><span class="n">sptr</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">adiff_t</span> <span class="n">delta</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">recalc</span><span class="o">=</span><span class="nb">true</span><span class="p">);</span>
<span class="c1">//参数一:sptr表示需要执行操作的结构体.
</span><span class="c1">//参数二:offset表示结构体的偏移.
</span><span class="c1">//参数三:delta表示要扩充的字节大小,如果为负数则表示要移除的字节大小.
</span><span class="c1">//参数四:recalc表示是否重新计算结构体类型被使用的地方.
</span><span class="c1">//返回true表示函数执行成功.
</span></code></pre></td></tr></table>
</div>
</div><p><strong>需要注意的是</strong>,一个空的结构体是无法执行expand_struc函数.</p>
<h4 id="代码示例">代码示例</h4>
<h5 id="创建一个结构体">创建一个结构体</h5>
<p>结构体第一个成员是自身的指针,代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;kernwin.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;struct.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;typeinf.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">til_t</span><span class="o">*</span> <span class="n">idati</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idati</span> <span class="o">=</span> <span class="p">(</span><span class="n">til_t</span><span class="o">*</span><span class="p">)</span><span class="n">get_idati</span><span class="p">();</span>

	<span class="n">tid_t</span> <span class="n">idStruct</span> <span class="o">=</span> <span class="n">add_struc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;TestStruct&#34;</span><span class="p">);</span>
	<span class="n">struc_t</span><span class="o">*</span> <span class="n">pStruct</span> <span class="o">=</span> <span class="n">get_struc</span><span class="p">(</span><span class="n">idStruct</span><span class="p">);</span>

	<span class="n">add_struc_member</span><span class="p">(</span><span class="n">pStruct</span><span class="p">,</span> <span class="s">&#34;member_0&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dword_flag</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="n">tinfo_t</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">type</span><span class="p">.</span><span class="n">create_typedef</span><span class="p">(</span><span class="n">idati</span><span class="p">,</span> <span class="s">&#34;TestStruct&#34;</span><span class="p">);</span>
	<span class="n">type</span><span class="p">.</span><span class="n">create_ptr</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">set_member_tinfo</span><span class="p">(</span><span class="n">pStruct</span><span class="p">,</span> <span class="n">get_member</span><span class="p">(</span><span class="n">pStruct</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">SET_MEMTI_MAY_DESTROY</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="遍历一个结构体的成员">遍历一个结构体的成员</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//要遍历的某个结构体的名称
</span><span class="c1"></span>	<span class="n">struc_t</span><span class="o">*</span> <span class="n">pStruct</span> <span class="o">=</span> <span class="n">get_struc</span><span class="p">(</span><span class="n">get_struc_id</span><span class="p">(</span><span class="s">&#34;GUID&#34;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pStruct</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">pStruct</span><span class="o">-&gt;</span><span class="n">memqty</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">member_t</span> <span class="n">pMember</span> <span class="o">=</span> <span class="n">pStruct</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
		<span class="n">qstring</span> <span class="n">qMemberName</span> <span class="o">=</span> <span class="n">get_member_name</span><span class="p">(</span><span class="n">pMember</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[Member]:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">qMemberName</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="初始化一个结构体">初始化一个结构体</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="c1">//name为结构体的名称,size为结构体的大小
</span><span class="c1"></span><span class="n">tid_t</span> <span class="nf">CreateStructure</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//已存在相同名称的结构体
</span><span class="c1"></span>    <span class="n">tid_t</span> <span class="n">structId</span> <span class="o">=</span> <span class="n">get_struc_id</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">structId</span> <span class="o">!=</span> <span class="n">BADADDR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">structId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">structId</span> <span class="o">=</span> <span class="n">add_struc</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">structId</span> <span class="o">==</span> <span class="n">BADADDR</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">structId</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">struc_t</span><span class="o">*</span> <span class="n">pStruct</span> <span class="o">=</span> <span class="n">get_struc</span><span class="p">(</span><span class="n">structId</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">fieldName</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">qsnprintf</span><span class="p">(</span><span class="n">fieldName</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fieldName</span><span class="p">),</span> <span class="s">&#34;field_%a&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
        <span class="n">add_struc_member</span><span class="p">(</span><span class="n">pStruct</span><span class="p">,</span> <span class="n">fieldName</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">structId</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="typeinfhpp-声明类型">typeinf.hpp 声明类型</h3>
<p>IDA内部记录着一个声明类型库,通过IDA的Local Types窗口我们可以看到里面的声明类型.</p>
<h4 id="获取ida内部的声明类型库">获取IDA内部的声明类型库</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">til_t</span> <span class="o">*</span> <span class="nf">get_idati</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="解析多条声明并将它们存储至声明类型库">解析多条声明,并将它们存储至声明类型库</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">int</span> <span class="nf">parse_decls</span><span class="p">(</span>
        <span class="n">til_t</span> <span class="o">*</span><span class="n">til</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
        <span class="n">printer_t</span> <span class="o">*</span><span class="n">printer</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">hti_flags</span><span class="p">);</span>
<span class="c1">//参数一:til为要存储解析声明结果的声明类型库.
</span><span class="c1">//参数二:input代表声明的文本，如果参数四hti_flags为HTI_FIL，则代表包含声明的文件路径.
</span><span class="c1">//参数三:printer为一个回调函数指针，用于输出解析过程的一些信息.
</span><span class="c1">//参数四:hti_flags用来设置如何解析声明的一些标志.
</span></code></pre></td></tr></table>
</div>
</div><p>上述函数<strong>使用频率很高</strong>,示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;typeinf.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">til_t</span><span class="o">*</span> <span class="n">idati</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">Decls</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;\
</span><span class="s">	struct __declspec(align(4)) Tree_nod\
</span><span class="s">	{\
</span><span class="s">		Tree_nod* _Left;\
</span><span class="s">		Tree_nod* _Parent;\
</span><span class="s">		Tree_nod* _Right;\
</span><span class="s">		char _Color;\
</span><span class="s">		char _Isnil;\
</span><span class="s">		int _Myval; \
</span><span class="s">	};\
</span><span class="s">	struct map\
</span><span class="s">	{\
</span><span class="s">		Tree_nod* _MyHead;\
</span><span class="s">		unsigned int _Mysize;\
</span><span class="s">	};&#34;</span><span class="p">;</span>

	<span class="n">idati</span> <span class="o">=</span> <span class="p">(</span><span class="n">til_t</span><span class="o">*</span><span class="p">)</span><span class="n">get_idati</span><span class="p">();</span>
	<span class="n">parse_decls</span><span class="p">(</span><span class="n">idati</span><span class="p">,</span> <span class="n">Decls</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>调用完该函数后,类型声明就存储到了IDA的声明类型库中.</p>
<h4 id="导入声明类型至idb中">导入声明类型至IDB中</h4>
<p>相当于将Local Types窗口中的声明拷贝至Structures窗口.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">tid_t</span> <span class="nf">import_type</span> <span class="p">(</span><span class="k">const</span> <span class="n">til_t</span> <span class="o">*</span><span class="n">til</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//参数一:til为要导入声明的声明类型库.
</span><span class="c1">//参数二:idx为新类型在列表中的位置,一般填-1就行了,表示加入到列表末尾.
</span><span class="c1">//参数三:name为要导入声明的名称.
</span><span class="c1">//参数四:可不填.
</span><span class="c1">//返回值为拷贝得到的结构体的类型ID.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="修改指定地址的声明">修改指定地址的声明</h4>
<p>该函数首先会解析声明文本,然后调用apply_tinfo函数进行修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">apply_cdecl</span><span class="p">(</span><span class="n">til_t</span> <span class="o">*</span><span class="n">til</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">ea</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">decl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">//参数一:til为声明类型库.
</span><span class="c1">//参数二:ea为指定的线性地址.
</span><span class="c1">//参数三:decl为声明文本.
</span><span class="c1">//参数四:flags为附加参数:
</span><span class="c1">//TINFO_GUESSED    告诉IDA这是一个模糊的声明.
</span><span class="c1">//TINFO_DEFINITE   告诉IDA这是一个精确的声明,这会影响到IDA的一些解析.
</span><span class="c1">//TINFO_DELAYFUNC  如果声明的种类为函数声明，但是指定的线性地址不存在函数，则尝试建立函数.
</span><span class="c1">//TINFO_STRICT     在修改声明之前绝不对类型进行转换.
</span></code></pre></td></tr></table>
</div>
</div><p>上述函数,常常被用来<strong>修改函数声明</strong>,示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">til_t</span><span class="o">*</span> <span class="n">idati</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">idati</span> <span class="o">=</span> <span class="p">(</span><span class="n">til_t</span><span class="o">*</span><span class="p">)</span><span class="n">get_idati</span><span class="p">();</span>
	<span class="n">apply_cdecl</span><span class="p">(</span><span class="n">idati</span><span class="p">,</span> <span class="mh">0x401000</span><span class="p">,</span> <span class="s">&#34;int __cdecl sub_401000(int a, int b, int *c);&#34;</span><span class="p">,</span> <span class="n">TINFO_DEFINITE</span><span class="p">);</span>	<span class="c1">//注意声明末尾有一个;号
</span><span class="c1"></span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="uahpp-反汇编引擎">ua.hpp 反汇编引擎</h3>
<p><strong>ua.hpp</strong>包含用来处理程序指令的反汇编相关函数.</p>
<p>一条指令的反汇编由以下三步组成:</p>
<ol>
<li>指令分析:ana.cpp.</li>
<li>模拟分析:emu.cpp.</li>
<li>转换为反汇编文本:out.cpp.</li>
</ol>
<h4 id="判断指定地址的字节是否可以被解码为一条有效指令">判断指定地址的字节是否可以被解码为一条有效指令</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">can_decode</span> <span class="p">(</span><span class="n">ea_t</span> <span class="n">ea</span><span class="p">);</span>
<span class="c1">//参数一:ea表示指定的线性地址.
</span><span class="c1">//返回true表示可以被解码为有效指令.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="对指定地址进行反汇编">对指定地址进行反汇编</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">int</span> <span class="n">decode_insn</span> <span class="p">(</span><span class="n">insn_t</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">ea</span><span class="p">)</span>
<span class="c1">//参数一:out为返回的指令信息结果.
</span><span class="c1">//参数二:ea为要进行反汇编的指令地址.
</span><span class="c1">//返回值为指令的长度,如果为0则表示反汇编失败.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="对指定地址的上一条指令进行反汇编">对指定地址的上一条指令进行反汇编</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">ea_t</span> <span class="n">decode_prev_insn</span> <span class="p">(</span><span class="n">insn_t</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="n">ea_t</span> <span class="n">ea</span><span class="p">)</span>
<span class="c1">//参数一:out为返回的指令信息结果.
</span><span class="c1">//参数二:ea表示要从哪个地址开始反汇编上一条指令.
</span><span class="c1">//返回值为上一条指令的地址,如果返回BADADDR表示反汇编失败.
</span></code></pre></td></tr></table>
</div>
</div><p>insn_t代表着指令的反汇编结果,该结构体部分成员如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">class</span> <span class="nc">insn_t</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">ea_t</span> <span class="n">ea</span><span class="p">;</span>			<span class="c1">//该指令的线性地址
</span><span class="c1"></span>    <span class="n">uint16</span> <span class="n">itype</span><span class="p">;</span>		<span class="c1">//内部指令类型,由IDP来定义
</span><span class="c1"></span>    <span class="n">uint16</span> <span class="n">size</span><span class="p">;</span>		<span class="c1">//指令长度
</span><span class="c1"></span>    <span class="p">...</span>
    <span class="n">op_t</span> <span class="n">ops</span><span class="p">[</span><span class="n">UA_MAXOP</span><span class="p">];</span>	<span class="c1">//操作数数组
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们得到insn_t后,一般先通过判断itype来确定指令的类型,这个itype是个枚举类型,不同的处理器对应的枚举类型都不同,需要自行去allins.hpp中寻找
得到指令的类型后我们就可以通过解析ops数组来进一步得到详细的信息了
ops数组大小固定为8,但大部分指令的有效op并没有这么多</p>
<h4 id="示例代码">示例代码</h4>
<p>现假设在X86平台下,我们需要打印出某个函数里面call Register、call [MemAddr]这两种形式的全部指令.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;ua.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;allins.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">qstring</span> <span class="nf">RegToName</span><span class="p">(</span><span class="n">uint16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qstring</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;eax&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;ecx&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;edx&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;ebx&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;esp&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;ebp&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x6</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;esi&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x7</span><span class="o">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;edi&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//假设函数之间的指令是连续的
</span><span class="c1"></span>
	<span class="c1">//某个函数的起始地址
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">FuncStart</span> <span class="o">=</span> <span class="mh">0x00401180</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="n">insn_t</span> <span class="n">ins</span><span class="p">;</span>
		<span class="n">iLen</span> <span class="o">=</span> <span class="n">decode_insn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ins</span><span class="p">,</span> <span class="n">FuncStart</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">itype</span> <span class="o">==</span> <span class="n">NN_callni</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="c1">//call eax这类的指令
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">o_reg</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">qstring</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">RegToName</span><span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">reg</span><span class="p">);</span>
				<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[Instruction]:%a---call %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">FuncStart</span><span class="p">,</span> <span class="n">Reg</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
				<span class="n">FuncStart</span> <span class="o">+=</span> <span class="n">iLen</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="c1">//call [MemAddr]
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">ins</span><span class="p">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">o_mem</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">msg</span><span class="p">(</span><span class="s">&#34;[Instruction]:%a---call [%a]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">FuncStart</span><span class="p">,</span> <span class="n">ins</span><span class="p">.</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">FuncStart</span> <span class="o">+=</span> <span class="n">iLen</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">FuncStart</span> <span class="o">+=</span> <span class="n">iLen</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">iLen</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="xrefhpp-交叉引用">xref.hpp 交叉引用</h3>
<p><strong>xref.hpp</strong>包括和交叉引用相关的一些函数.
交叉引用分为两种:</p>
<ul>
<li>代码交叉引用.</li>
<li>数据交叉引用.</li>
</ul>
<p>交叉引用会自动进行排序.</p>
<h4 id="示例代码-1">示例代码</h4>
<p>获取某个全局变量所有的交叉引用地址.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;ida.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;idp.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;loader.hpp&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;xref.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="c1">//可以自行输入一个全局变量的地址...
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">GlobalVarAddr</span> <span class="o">=</span> <span class="mh">0x489085</span><span class="p">;</span>

	<span class="c1">//打印所有的代码交叉引用
</span><span class="c1"></span>	<span class="n">ea_t</span> <span class="n">XrefAddr</span> <span class="o">=</span> <span class="n">get_first_cref_to</span><span class="p">(</span><span class="n">GlobalVarAddr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">XrefAddr</span> <span class="o">!=</span> <span class="n">BADADDR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;CodeXrefAddr:%a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">XrefAddr</span><span class="p">);</span>
		<span class="n">XrefAddr</span> <span class="o">=</span> <span class="n">get_next_cref_to</span><span class="p">(</span><span class="n">GlobalVarAddr</span><span class="p">,</span> <span class="n">XrefAddr</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="c1">//打印所有的数据交叉引用
</span><span class="c1"></span>	<span class="n">XrefAddr</span> <span class="o">=</span> <span class="n">get_first_dref_to</span><span class="p">(</span><span class="n">GlobalVarAddr</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">XrefAddr</span> <span class="o">!=</span> <span class="n">BADADDR</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;DataXrefAddr:%a</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">XrefAddr</span><span class="p">);</span>
		<span class="n">XrefAddr</span> <span class="o">=</span> <span class="n">get_next_dref_to</span><span class="p">(</span><span class="n">GlobalVarAddr</span><span class="p">,</span> <span class="n">XrefAddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="hexrays-sdk">HexRays SDK</h2>
<p>IDA反编译器Hex-Rays是作为IDA的插件而存在的,它可以将IDA反汇编代码转换成类C语言伪代码.
同时官方还提供了一组HexRays SDK,供用户使用.
SDK使用方法很简单,只需要将hexrays.hpp文件包含即可.</p>
<p>在HexRays反编译器中二进制代码有两种存在的形式</p>
<ul>
<li>MicroCode:微码,由一条一条的处理器指令组成,由反编译器来进行优化并转换.</li>
<li>CTree:由经过优化过后的微码生成,其内部其实是一个用C语句和表达式构建的类抽象语法树.Ctree可以转换为伪C代码.</li>
</ul>
<p><strong>官方示例代码</strong>如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;hexrays.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="c1">// Hex-Rays API pointer
</span><span class="c1"></span><span class="n">hexdsp_t</span> <span class="o">*</span><span class="n">hexdsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">bool</span> <span class="n">inited</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="kt">int</span> <span class="n">idaapi</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//初始化hexrays插件
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">init_hexrays_plugin</span><span class="p">()</span> <span class="p">)</span>
  <span class="p">{</span>
       <span class="k">return</span> <span class="n">PLUGIN_SKIP</span><span class="p">;</span> <span class="c1">// no decompiler
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="n">inited</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">PLUGIN_KEEP</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="kt">void</span> <span class="n">idaapi</span> <span class="nf">term</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//释放hexrays插件
</span><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span> <span class="n">inited</span> <span class="p">)</span>
  <span class="p">{</span>
     <span class="n">term_hexrays_plugin</span><span class="p">();</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">func_t</span> <span class="o">*</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">get_func</span><span class="p">(</span><span class="n">get_screen_ea</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">pfn</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">warning</span><span class="p">(</span><span class="s">&#34;Please position the cursor within a function&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">hexrays_failure_t</span> <span class="n">hf</span><span class="p">;</span>
  <span class="n">cfuncptr_t</span> <span class="n">cfunc</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hf</span><span class="p">,</span> <span class="n">DECOMP_WARNINGS</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">cfunc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">warning</span><span class="p">(</span><span class="s">&#34;#error </span><span class="se">\&#34;</span><span class="s">%a: %s&#34;</span><span class="p">,</span> <span class="n">hf</span><span class="p">.</span><span class="n">errea</span><span class="p">,</span> <span class="n">hf</span><span class="p">.</span><span class="n">desc</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">msg</span><span class="p">(</span><span class="s">&#34;%a: successfully decompiled</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pfn</span><span class="o">-&gt;</span><span class="n">start_ea</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">strvec_t</span> <span class="o">&amp;</span><span class="n">sv</span> <span class="o">=</span> <span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">get_pseudocode</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">qstring</span> <span class="n">buf</span><span class="p">;</span>
    <span class="n">tag_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">sv</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">line</span><span class="p">);</span>
    <span class="n">msg</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="k">static</span> <span class="kt">char</span> <span class="n">comment</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;Sample1 plugin for Hex-Rays decompiler&#34;</span><span class="p">;</span>

<span class="n">plugin_t</span> <span class="n">PLUGIN</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="n">IDP_INTERFACE_VERSION</span><span class="p">,</span>
  <span class="mi">0</span><span class="p">,</span>                    <span class="c1">// plugin flags
</span><span class="c1"></span>  <span class="n">init</span><span class="p">,</span>                 <span class="c1">// initialize
</span><span class="c1"></span>  <span class="n">term</span><span class="p">,</span>                 <span class="c1">// terminate. this pointer may be NULL.
</span><span class="c1"></span>  <span class="n">run</span><span class="p">,</span>                  <span class="c1">// invoke plugin
</span><span class="c1"></span>  <span class="n">comment</span><span class="p">,</span>              <span class="c1">// long comment about the plugin
</span><span class="c1"></span>                        <span class="c1">// it could appear in the status line
</span><span class="c1"></span>                        <span class="c1">// or as a hint
</span><span class="c1"></span>  <span class="s">&#34;&#34;</span><span class="p">,</span>                   <span class="c1">// multiline help about the plugin
</span><span class="c1"></span>  <span class="s">&#34;Decompile &amp; Print&#34;</span><span class="p">,</span>  <span class="c1">// the preferred short name of the plugin
</span><span class="c1"></span>  <span class="s">&#34;&#34;</span>                    <span class="c1">// the preferred hotkey to run the plugin
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>上述代码的作用就是打印出当前窗口所在函数的伪代码文本.</p>
<p>除了执行上面的代码稍微体验一下HexRays的强大之外,我们还需要知道以下几点：</p>
<ul>
<li>cfunc_t可以理解为操作反编译器API功能的入口,很多功能都要依赖这个类来实现.</li>
<li>decompile函数几乎是我们主动获取cfunc_t的唯一接口.</li>
</ul>
<h3 id="ctree">CTree</h3>
<p>在理解CTree的核心之前,我们还需要认识以下类:</p>
<h4 id="cfunc_tcfunc_t">cfunc_t:cfunc_t</h4>
<p>包含着和反编译代码相关的一些基础信息,cfunc_t中存在一个body成员,是一个cinsn_t类型,代表整个反编译函数的主体.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">cfunc_t</span>
<span class="p">{</span>
  <span class="n">ea_t</span> <span class="n">entry_ea</span><span class="p">;</span>             <span class="c1">///&lt; function entry address
</span><span class="c1"></span>  <span class="n">cinsn_t</span> <span class="n">body</span><span class="p">;</span>              <span class="c1">///&lt; 函数的主体, 一定是个cblock类型
</span><span class="c1"></span>  <span class="c1">//...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cinsn_tcinsn_t">cinsn_t:cinsn_t</h4>
<p>代表着用来组成CTree的每条语句,结构体内的节点主要和流程控制有关.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">cinsn_t</span> <span class="o">:</span> <span class="k">public</span> <span class="n">citem_t</span>
<span class="p">{</span>
  <span class="k">union</span>
  <span class="p">{</span>
    <span class="n">cblock_t</span> <span class="o">*</span><span class="n">cblock</span><span class="p">;</span>   <span class="c1">///&lt; details of block-statement
</span><span class="c1"></span>    <span class="n">cexpr_t</span> <span class="o">*</span><span class="n">cexpr</span><span class="p">;</span>     <span class="c1">///&lt; details of expression-statement
</span><span class="c1"></span>    <span class="n">cif_t</span> <span class="o">*</span><span class="n">cif</span><span class="p">;</span>         <span class="c1">///&lt; details of if-statement
</span><span class="c1"></span>    <span class="n">cfor_t</span> <span class="o">*</span><span class="n">cfor</span><span class="p">;</span>       <span class="c1">///&lt; details of for-statement
</span><span class="c1"></span>    <span class="n">cwhile_t</span> <span class="o">*</span><span class="n">cwhile</span><span class="p">;</span>   <span class="c1">///&lt; details of while-statement
</span><span class="c1"></span>    <span class="n">cdo_t</span> <span class="o">*</span><span class="n">cdo</span><span class="p">;</span>         <span class="c1">///&lt; details of do-statement
</span><span class="c1"></span>    <span class="n">cswitch_t</span> <span class="o">*</span><span class="n">cswitch</span><span class="p">;</span> <span class="c1">///&lt; details of switch-statement
</span><span class="c1"></span>    <span class="n">creturn_t</span> <span class="o">*</span><span class="n">creturn</span><span class="p">;</span> <span class="c1">///&lt; details of return-statement
</span><span class="c1"></span>    <span class="n">cgoto_t</span> <span class="o">*</span><span class="n">cgoto</span><span class="p">;</span>     <span class="c1">///&lt; details of goto-statement
</span><span class="c1"></span>    <span class="n">casm_t</span> <span class="o">*</span><span class="n">casm</span><span class="p">;</span>       <span class="c1">///&lt; details of asm-statement
</span><span class="c1"></span>  <span class="p">};</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="cexpr_tcexpr_t">cexpr_t:cexpr_t</h4>
<p>代表着用来组成每条语句的C语言表达式,可能也是<strong>最常用的一个类</strong>,里面存储着每条表达式的关键信息.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">struct</span> <span class="nc">cexpr_t</span> <span class="o">:</span> <span class="k">public</span> <span class="n">citem_t</span>
<span class="p">{</span>
  <span class="k">union</span>
  <span class="p">{</span>
    <span class="n">cnumber_t</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>     <span class="c1">///&lt; used for \ref cot_num
</span><span class="c1"></span>    <span class="n">fnumber_t</span> <span class="o">*</span><span class="n">fpc</span><span class="p">;</span>   <span class="c1">///&lt; used for \ref cot_fnum
</span><span class="c1"></span>    <span class="k">struct</span>
    <span class="p">{</span>
      <span class="k">union</span>
      <span class="p">{</span>
        <span class="n">var_ref_t</span> <span class="n">v</span><span class="p">;</span>  <span class="c1">///&lt; used for \ref cot_var
</span><span class="c1"></span>        <span class="n">ea_t</span> <span class="n">obj_ea</span><span class="p">;</span>  <span class="c1">///&lt; used for \ref cot_obj
</span><span class="c1"></span>      <span class="p">};</span>
      <span class="kt">int</span> <span class="n">refwidth</span><span class="p">;</span>   <span class="c1">///&lt; how many bytes are accessed? (-1: none)
</span><span class="c1"></span>    <span class="p">};</span>
    <span class="k">struct</span>
    <span class="p">{</span>
      <span class="n">cexpr_t</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>     <span class="c1">///&lt; the first operand of the expression
</span><span class="c1"></span>      <span class="k">union</span>
      <span class="p">{</span>
        <span class="n">cexpr_t</span> <span class="o">*</span><span class="n">y</span><span class="p">;</span>   <span class="c1">///&lt; the second operand of the expression
</span><span class="c1"></span>        <span class="n">carglist_t</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span><span class="c1">///&lt; argument list (used for \ref cot_call)
</span><span class="c1"></span>        <span class="n">uint32</span> <span class="n">m</span><span class="p">;</span>     <span class="c1">///&lt; member offset (used for \ref cot_memptr, \ref cot_memref)
</span><span class="c1"></span>                      <span class="c1">///&lt; for unions, the member number
</span><span class="c1"></span>      <span class="p">};</span>
      <span class="k">union</span>
      <span class="p">{</span>
        <span class="n">cexpr_t</span> <span class="o">*</span><span class="n">z</span><span class="p">;</span>   <span class="c1">///&lt; the third operand of the expression
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">ptrsize</span><span class="p">;</span>  <span class="c1">///&lt; memory access size (used for \ref cot_ptr, \ref cot_memptr)
</span><span class="c1"></span>      <span class="p">};</span>
    <span class="p">};</span>
    <span class="n">cinsn_t</span> <span class="o">*</span><span class="n">insn</span><span class="p">;</span>    <span class="c1">///&lt; an embedded statement, they are prohibited
</span><span class="c1"></span>                      <span class="c1">///&lt; at the final maturity stage (\ref CMAT_FINAL)
</span><span class="c1"></span>    <span class="kt">char</span> <span class="o">*</span><span class="n">helper</span><span class="p">;</span>     <span class="c1">///&lt; helper name (used for \ref cot_helper)
</span><span class="c1"></span>    <span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">;</span>     <span class="c1">///&lt; string constant (used for \ref cot_str)
</span><span class="c1"></span>  <span class="p">};</span>
  <span class="n">tinfo_t</span> <span class="n">type</span><span class="p">;</span>       <span class="c1">///&lt; expression type. must be carefully maintained
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="citem_tcitem_t">citem_t:citem_t</h4>
<p>是cinsn_t和cexpr_t的基类,用来存储一些通用的信息,例如地址、标签.</p>
<h4 id="代码示例-1">代码示例</h4>
<p>为了更进一步地了解CTree,以下代码展示了如何去遍历函数的CTree节点,并且实现了一个C语句表达式的模板化引擎.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;hexrays.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">qstring</span> <span class="nf">GetExprString</span><span class="p">(</span><span class="n">cexpr_t</span><span class="o">*</span> <span class="n">pItem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">qstring</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="nl">cot_add</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;+&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_asg</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;=&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_asgadd</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;+=&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_band</span><span class="p">:</span>
		<span class="k">return</span>  <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;&amp;&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_call</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;call(&#34;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">pItem</span><span class="o">-&gt;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">GetExprString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">at</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#34;,&#34;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span>
		<span class="p">{</span>
			<span class="n">ret</span><span class="p">.</span><span class="n">remove_last</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="s">&#34;)&#34;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_cast</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;(cast)&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_eq</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;==&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_idx</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;[&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;]&#34;</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_mul</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;*&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_num</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;num&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_obj</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;obj&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_ref</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;&amp;&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_var</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="s">&#34;var&#34;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_preinc</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;++&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_ptr</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">qstring</span><span class="p">(</span><span class="s">&#34;*&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">cot_sub</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;-&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_tern</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;?&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_ult</span><span class="p">:</span>
		<span class="k">return</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;&lt;&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">case</span> <span class="nl">cot_xor</span><span class="p">:</span>
		<span class="k">return</span>  <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#34;^&#34;</span> <span class="o">+</span> <span class="n">GetExprString</span><span class="p">(</span><span class="n">pItem</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="c1">//遇到没解析过的类型自行补充就行了
</span><span class="c1"></span>		<span class="n">msg</span><span class="p">(</span><span class="s">&#34;UnHandled Item Type...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//--------------------------------------------------------------------------
</span><span class="c1"></span><span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">func_t</span><span class="o">*</span> <span class="n">pfn</span> <span class="o">=</span> <span class="n">get_func</span><span class="p">(</span><span class="n">get_screen_ea</span><span class="p">());</span>
	<span class="n">hexrays_failure_t</span> <span class="n">hf</span><span class="p">;</span>
	<span class="n">cfuncptr_t</span> <span class="n">cfunc</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hf</span><span class="p">,</span> <span class="n">DECOMP_WARNINGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">warning</span><span class="p">(</span><span class="s">&#34;error&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctree_items_t</span><span class="o">&amp;</span> <span class="n">vec_TreeItem</span> <span class="o">=</span> <span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">treeitems</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">vec_TreeItem</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="c1">//打印出所有的表达式吧
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">vec_TreeItem</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">==</span> <span class="n">cit_expr</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">qstring</span> <span class="n">ExprPatterm</span> <span class="o">=</span> <span class="n">GetExprString</span><span class="p">(((</span><span class="n">cexpr_t</span><span class="o">*</span><span class="p">)</span><span class="n">vec_TreeItem</span><span class="p">[</span><span class="n">n</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">);</span>
			<span class="n">msg</span><span class="p">(</span><span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ExprPatterm</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
		<span class="p">}</span>
	<span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="cfunc">CFunc</h3>
<p>CFunc与反编译的函数有关.cfunc_t结构体用于存储反编译的结果.</p>
<h4 id="获取指定位置的ctree-item">获取指定位置的ctree item</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="kt">bool</span> <span class="nf">get_line_item</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">is_ctree_line</span><span class="p">,</span> <span class="n">ctree_item_t</span> <span class="o">*</span><span class="n">phead</span><span class="p">,</span> <span class="n">ctree_item_t</span> <span class="o">*</span><span class="n">pitem</span><span class="p">,</span> <span class="n">ctree_item_t</span> <span class="o">*</span><span class="n">ptail</span><span class="p">);</span>
<span class="c1">//参数一:line为反编译文本中的某一行.
</span><span class="c1">//参数二:x为反编译文本行中的横坐标.
</span><span class="c1">//参数三:is_ctree_line表示是否在声明语句区域(如果不是,假定为变量声明语句区域).
</span><span class="c1">//参数四:phead为返回的item的头部,于附加块注释,为空.
</span><span class="c1">//参数五:pitem为返回的item,为空.
</span><span class="c1">//参数六:ptail为返回的item的尾部,于附加缩进的注释,为空.
</span><span class="c1">//如果没有获取到pitem,则函数返回值为false.
</span></code></pre></td></tr></table>
</div>
</div><h4 id="示例代码-2">示例代码</h4>
<p>我们可以使用该函数给代码添加注释.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="cp">#include</span> <span class="cpf">&lt;hexrays.hpp&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">bool</span> <span class="n">idaapi</span> <span class="nf">run</span><span class="p">(</span><span class="n">size_t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">func_t</span><span class="o">*</span> <span class="n">pfn</span> <span class="o">=</span> <span class="n">get_func</span><span class="p">(</span><span class="n">get_screen_ea</span><span class="p">());</span>
	<span class="n">hexrays_failure_t</span> <span class="n">hf</span><span class="p">;</span>
	<span class="n">cfuncptr_t</span> <span class="n">cfunc</span> <span class="o">=</span> <span class="n">decompile</span><span class="p">(</span><span class="n">pfn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hf</span><span class="p">,</span> <span class="n">DECOMP_WARNINGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">warning</span><span class="p">(</span><span class="s">&#34;error&#34;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">const</span> <span class="n">strvec_t</span><span class="o">&amp;</span> <span class="n">sv</span> <span class="o">=</span> <span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">sv</span><span class="p">;</span>
	
	<span class="c1">//给函数的每行代码添加注释
</span><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">sv</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ctree_item_t</span> <span class="n">commentItem</span><span class="p">;</span>
		<span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">get_line_item</span><span class="p">(</span><span class="n">sv</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">line</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commentItem</span><span class="p">);</span>

		<span class="n">qstring</span> <span class="n">qComment</span><span class="p">;</span>
		<span class="n">qComment</span><span class="p">.</span><span class="n">sprnt</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">set_user_cmt</span><span class="p">(</span><span class="n">commentItem</span><span class="p">.</span><span class="n">loc</span><span class="p">,</span> <span class="n">qComment</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
	<span class="p">}</span>

	<span class="c1">//添加注释后务必调用此函数保存注释
</span><span class="c1"></span>	<span class="n">cfunc</span><span class="o">-&gt;</span><span class="n">save_user_cmts</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="idc脚本简介">IDC脚本简介</h2>
<p>IDC脚本是由IDA官方提供并维护的功能,语法和C语言比较相似.</p>
<p>在IDA中，我们可以点击菜单File -&gt; Script File来执行一个IDC脚本.
点击菜单File -&gt; Script Command可以开启一个脚本执行窗口,我们可以在这里编写脚本测试运行.</p>
<p>例如编写下列代码后,点击Run按钮</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="n">msg</span><span class="p">(</span><span class="s">&#34;Hello World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>IDA的Output窗口便会输出文本结果</p>
<p>因为是脚本型的语言,如果我们没有定义函数,脚本则默认从头开始执行.
如果我们想要定义函数,那么就得使用下面这种方式:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">static</span> <span class="nf">GetText</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">auto</span> <span class="n">Text</span><span class="o">=</span><span class="s">&#34;Hello World</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">Text</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">msg</span><span class="p">(</span><span class="n">GetText</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>事实上,函数的声明都遵守以下格式:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C++" data-lang="C++"><span class="k">static</span> <span class="n">func</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span><span class="p">,</span><span class="n">arg3</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>而且由于IDC脚本的变量都是auto通用类型,一个变量可以保存任何类型的数据,因此函数没必要定义返回类型,所有函数默认都有返回值.</p>
<p>了解了以上常识,就能解决大部分编写脚本的需求了,下面是一些特殊的点:</p>
<ul>
<li>全局变量使用extern关键字命名,且不可进行初始化赋值.</li>
<li>不支持C语言中的switch case语句,这一点和Python很像.</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-08-23</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ida/">IDA</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/%E6%8F%92%E4%BB%B6%E5%8C%BA/x64dbg/" class="prev" rel="prev" title="x64Dbg插件开发"><i class="fas fa-angle-left fa-fw"></i>x64Dbg插件开发</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">夏洛魂</div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">夏洛魂</a></span>&nbsp;|&nbsp;<span class="license">MIT</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":150},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
